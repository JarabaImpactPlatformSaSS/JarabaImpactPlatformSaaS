# =============================================================================
# NGINX VHOST — pepejaraba.com
# =============================================================================
# Configuracion del virtual host para el dominio de marca personal.
#
# Estructura: Redireccion HTTP→HTTPS, www→non-www, proxy a Drupal.
# Logica: El dominio pepejaraba.com apunta al mismo Drupal 11 SaaS.
#         La resolucion del tenant se hace a nivel de aplicacion via
#         Domain Access + TenantContextService basado en hostname.
# Sintaxis: Nginx 1.24+ con SSL via Let's Encrypt (certbot).
#
# REQUISITOS:
#   1. DNS: A record pepejaraba.com → IP del servidor
#   2. DNS: CNAME www.pepejaraba.com → pepejaraba.com
#   3. SSL: sudo certbot certonly --nginx -d pepejaraba.com -d www.pepejaraba.com
#   4. Copiar este archivo a: /etc/nginx/sites-available/pepejaraba.com
#   5. Enlace simbolico: ln -s /etc/nginx/sites-available/pepejaraba.com /etc/nginx/sites-enabled/
#   6. Recargar: sudo nginx -t && sudo systemctl reload nginx
# =============================================================================

# Redireccion HTTP → HTTPS.
server {
    listen 80;
    listen [::]:80;
    server_name pepejaraba.com www.pepejaraba.com;
    return 301 https://pepejaraba.com$request_uri;
}

# Redireccion www → non-www (HTTPS).
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name www.pepejaraba.com;

    ssl_certificate /etc/letsencrypt/live/pepejaraba.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pepejaraba.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://pepejaraba.com$request_uri;
}

# Servidor principal — pepejaraba.com.
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name pepejaraba.com;

    # SSL Let's Encrypt.
    ssl_certificate /etc/letsencrypt/live/pepejaraba.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pepejaraba.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Raiz del proyecto Drupal.
    root /var/www/jarabaimpactplatformsaas/web;
    index index.php;

    # Logs separados para el dominio.
    access_log /var/log/nginx/pepejaraba.com.access.log;
    error_log /var/log/nginx/pepejaraba.com.error.log;

    # Limites de subida (coherente con php.ini: 64M).
    client_max_body_size 64M;

    # Cabeceras de seguridad.
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Archivos estaticos con cache larga.
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # Bloquear acceso a archivos sensibles.
    location ~ /\. {
        deny all;
    }
    location ~ ^/sites/.*/private/ {
        deny all;
    }
    location ~ ^/sites/[^/]+/files/.*\.php$ {
        deny all;
    }
    location ~ (composer\.json|composer\.lock|\.env|\.git) {
        deny all;
    }

    # Drupal clean URLs.
    location / {
        try_files $uri /index.php?$query_string;
    }

    # PHP-FPM.
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/run/php/php8.4-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTP_HOST $host;
        fastcgi_read_timeout 300;
    }
}
