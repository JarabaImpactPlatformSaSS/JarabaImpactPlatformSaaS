{#
/**
 * @file
 * PERF-02: Theme override for html.html.twig with CSS lazy-loading.
 *
 * When critical CSS is injected inline (via preprocess_html), the main
 * stylesheet is converted to async loading using the print/onload pattern.
 * This eliminates render-blocking CSS and improves LCP/FCP.
 *
 * @see ecosistema_jaraba_theme_preprocess_html()
 * @see stable9/templates/layout/html.html.twig
 */
#}
<!DOCTYPE html>
<html{{ html_attributes }}>
  <head>
    <head-placeholder token="{{ placeholder_token }}">
    <title>{{ head_title|safe_join(' | ') }}</title>
    {# Sprint 13: hreflang tags para SEO internacional #}
    {% include '@ecosistema_jaraba_theme/partials/_hreflang-meta.html.twig' ignore missing %}
    <css-placeholder token="{{ placeholder_token }}">
    <js-placeholder token="{{ placeholder_token }}">
    {# Sprint 11: GTM/GA4 Analytics — Consent Mode v2 + dataLayer #}
    {% include '@ecosistema_jaraba_theme/partials/_gtm-analytics.html.twig' ignore missing with {
      theme_settings: theme_settings|default({})
    } %}
    {# PERF-02: Async CSS loading when critical CSS is inline. #}
    <script>
    (function(){
      if(!document.getElementById('critical-css'))return;
      var links=document.querySelectorAll('link[rel="stylesheet"][href*="ecosistema-jaraba-theme"]');
      for(var i=0;i<links.length;i++){
        var link=links[i];
        link.onload=function(){this.media='all';this.onload=null;};
        link.setAttribute('media','print');
      }
      // Safety: ensure media switches even if onload doesn't fire (cached resources)
      requestAnimationFrame(function(){
        for(var i=0;i<links.length;i++){
          if(links[i].media==='print')links[i].media='all';
        }
      });
    })();
    </script>
    <noscript>
      <link rel="stylesheet" href="/{{ directory }}/css/ecosistema-jaraba-theme.css">
    </noscript>
  </head>
  <body{{ attributes }}>
    {# Sprint 11: GTM noscript fallback #}
    {% set gtm_id = theme_settings.gtm_container_id|default('') %}
    {% if gtm_id %}
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id={{ gtm_id }}" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    {% endif %}
    <a href="#main-content" class="visually-hidden focusable">
      {{ 'Skip to main content'|t }}
    </a>
    {{ page_top }}
    {{ page }}
    {{ page_bottom }}
    {# GAP-AUD-008: Command Bar (Cmd+K) — Global command palette overlay. #}
    {% if command_bar_enabled %}
      {% include '@ecosistema_jaraba_theme/partials/_command-bar.html.twig' %}
    {% endif %}
    <js-bottom-placeholder token="{{ placeholder_token }}">
    
    {# PWA Install Prompt (Fase F10) #}
    {% if pwa_install_prompt %}
      {{ pwa_install_prompt }}
    {% endif %}
  </body>
</html>
