{#
/**
 * @file
 * Template for session booking calendar/interface.
 *
 * Variables:
 * - mentor: MentorProfile entity with display_name, headline, hourly_rate
 * - packages: Array of available packages
 * - availability_slots: Array of available time slots
 * - engagement: Current engagement if user has one
 * - can_book: Boolean if user can book sessions
 */
#}
<div class="session-booking" role="main" aria-label="{{ 'Reserva de sesión de mentoría'|t }}">

  {# Mentor Summary Header #}
  <div class="session-booking__mentor-header">
    <div class="mentor-avatar">
      <div class="avatar-placeholder">
        <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
        </svg>
      </div>
      {% if mentor.certification_level %}
        <span class="certification-badge certification-badge--{{ mentor.certification_level }}">
          {{ mentor.certification_level|capitalize }}
        </span>
      {% endif %}
    </div>
    <div class="mentor-info">
      <h2>{{ mentor.display_name }}</h2>
      <p class="headline">{{ mentor.headline }}</p>
      <div class="mentor-stats">
        <span class="stat">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          {{ mentor.average_rating|number_format(1) }}
        </span>
        <span class="stat">
          <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          {{ mentor.total_sessions }} {{ 'sesiones'|t }}
        </span>
      </div>
    </div>
  </div>

  {# Booking Flow Tabs #}
  <div class="session-booking__tabs">
    <button class="tab-btn active" data-tab="packages">{{ '1. Elegir Paquete'|t }}</button>
    <button class="tab-btn" data-tab="calendar" {% if not engagement %}disabled{% endif %}>{{ '2. Seleccionar Fecha'|t }}</button>
    <button class="tab-btn" data-tab="confirm" disabled>{{ '3. Confirmar'|t }}</button>
  </div>

  {# Step 1: Package Selection #}
  <div class="session-booking__step active" data-step="packages" role="form" aria-label="{{ 'Selección de paquete'|t }}">
    <h3>{{ 'Elige tu paquete de mentoría'|t }}</h3>
    
    {% if engagement and engagement.sessions_remaining > 0 %}
      <div class="active-engagement-notice">
        <div class="notice-icon">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="var(--ej-color-success, #10B981)" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
        </div>
        <div class="notice-content">
          <strong>{{ 'Tienes un paquete activo'|t }}</strong>
          <p>{{ 'Te quedan @sessions sesiones disponibles.'|t({'@sessions': engagement.sessions_remaining}) }}</p>
          <button class="btn btn--primary" data-action="go-to-calendar">
            {{ 'Reservar Sesión'|t }}
          </button>
        </div>
      </div>
    {% endif %}

    <div class="packages-grid">
      {% for package in packages %}
        <article class="package-card {% if package.is_featured %}package-card--featured{% endif %}">
          {% if package.is_featured %}
            <div class="package-card__ribbon">
              <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
              {{ 'Popular'|t }}
            </div>
          {% endif %}
          
          <div class="package-card__header">
            <h4>{{ package.title }}</h4>
            <p class="package-type">{{ package.package_type_label }}</p>
          </div>

          <div class="package-card__body">
            <div class="package-card__price">
              {% if package.discount_percent > 0 %}
                <span class="original-price">€{{ package.original_price|number_format(0) }}</span>
              {% endif %}
              <span class="current-price">€{{ package.price|number_format(0) }}</span>
              {% if package.discount_percent > 0 %}
                <span class="discount-badge">-{{ package.discount_percent }}%</span>
              {% endif %}
            </div>

            <ul class="package-card__features">
              <li>
                <span class="icon">
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                </span>
                <span>{{ package.sessions_included }} {{ 'sesiones'|t }}</span>
              </li>
              <li>
                <span class="icon">
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </span>
                <span>{{ package.session_duration_minutes }} {{ 'min/sesión'|t }}</span>
              </li>
              {% if package.includes_async_support %}
                <li>
                  <span class="icon">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                  </span>
                  <span>{{ 'Soporte asíncrono incluido'|t }}</span>
                </li>
              {% endif %}
            </ul>

            {% if package.description %}
              <p class="package-card__description">{{ package.description|striptags|slice(0, 120) }}...</p>
            {% endif %}
          </div>

          <div class="package-card__footer">
            <button class="btn btn--primary btn--full" data-action="select-package" data-package-id="{{ package.id }}">
              {{ 'Comprar Paquete'|t }}
            </button>
            <p class="price-note">{{ 'Válido 6 meses desde la compra'|t }}</p>
          </div>
        </article>
      {% else %}
        <div class="packages-empty">
          <p>{{ 'Este mentor no tiene paquetes disponibles actualmente.'|t }}</p>
        </div>
      {% endfor %}
    </div>
  </div>

  {# Step 2: Calendar Selection #}
  <div class="session-booking__step" data-step="calendar" role="form" aria-label="{{ 'Selección de fecha'|t }}">
    <h3>{{ 'Selecciona fecha y hora'|t }}</h3>
    
    <div class="calendar-container">
      <div class="calendar-header">
        <button class="btn-icon" data-action="prev-week">◀</button>
        <span class="calendar-title" id="calendar-week-title"></span>
        <button class="btn-icon" data-action="next-week">▶</button>
      </div>

      <div class="calendar-grid" id="availability-calendar">
        {# Days header #}
        <div class="calendar-day-header">{{ 'Lun'|t }}</div>
        <div class="calendar-day-header">{{ 'Mar'|t }}</div>
        <div class="calendar-day-header">{{ 'Mié'|t }}</div>
        <div class="calendar-day-header">{{ 'Jue'|t }}</div>
        <div class="calendar-day-header">{{ 'Vie'|t }}</div>
        <div class="calendar-day-header">{{ 'Sáb'|t }}</div>
        <div class="calendar-day-header">{{ 'Dom'|t }}</div>

        {# Slots will be populated via JavaScript #}
        {% for slot in availability_slots %}
          <button class="calendar-slot {% if slot.is_available %}available{% else %}unavailable{% endif %}"
                  data-datetime="{{ slot.datetime }}"
                  {% if not slot.is_available %}disabled{% endif %}>
            <span class="slot-time">{{ slot.time }}</span>
            {% if slot.is_available %}
              <span class="slot-status">{{ 'Libre'|t }}</span>
            {% else %}
              <span class="slot-status">{{ 'Ocupado'|t }}</span>
            {% endif %}
          </button>
        {% endfor %}
      </div>

      <div class="calendar-legend">
        <span class="legend-item"><span class="dot available"></span> {{ 'Disponible'|t }}</span>
        <span class="legend-item"><span class="dot unavailable"></span> {{ 'No disponible'|t }}</span>
        <span class="legend-item"><span class="dot selected"></span> {{ 'Seleccionado'|t }}</span>
      </div>
    </div>

    <div class="selected-slot-summary" id="selected-slot-summary" style="display: none;">
      <h4>{{ 'Sesión seleccionada'|t }}</h4>
      <div class="summary-datetime">
        <span class="icon">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        </span>
        <span id="selected-date"></span>
        <span id="selected-time"></span>
      </div>
      <button class="btn btn--primary" data-action="go-to-confirm">
        {{ 'Continuar'|t }}
      </button>
    </div>
  </div>

  {# Step 3: Confirmation #}
  <div class="session-booking__step" data-step="confirm" role="form" aria-label="{{ 'Confirmación de reserva'|t }}">
    <h3>{{ 'Confirmar reserva'|t }}</h3>

    <div class="confirmation-card">
      <div class="confirmation-section">
        <h4>{{ 'Detalles de la sesión'|t }}</h4>
        <dl class="details-list">
          <dt>{{ 'Mentor'|t }}</dt>
          <dd>{{ mentor.display_name }}</dd>
          
          <dt>{{ 'Fecha y hora'|t }}</dt>
          <dd id="confirm-datetime">-</dd>
          
          <dt>{{ 'Duración'|t }}</dt>
          <dd>60 {{ 'minutos'|t }}</dd>
          
          <dt>{{ 'Modalidad'|t }}</dt>
          <dd>{{ 'Videollamada (Jitsi)'|t }}</dd>
        </dl>
      </div>

      <div class="confirmation-section">
        <h4>{{ 'Prepara tu sesión'|t }}</h4>
        <label for="session-agenda" class="form-label">
          {{ '¿Qué temas quieres tratar? (opcional)'|t }}
        </label>
        <textarea id="session-agenda" class="form-textarea" aria-label="{{ '¿Qué temas quieres tratar?'|t }}"
                  placeholder="{{ 'Describe brevemente tus objetivos para esta sesión...'|t }}"
                  rows="4"></textarea>
      </div>

      <div class="confirmation-actions">
        <button class="btn btn--secondary" data-action="back-to-calendar">
          {{ '← Volver'|t }}
        </button>
        <button class="btn btn--primary btn--large" data-action="confirm-booking">
          {{ '✓ Confirmar Reserva'|t }}
        </button>
      </div>
    </div>
  </div>

  {# Success Modal (hidden by default) #}
  <div class="booking-success-modal" id="booking-success" style="display: none;">
    <div class="modal-content">
      <div class="success-icon">
        <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="var(--ej-color-success, #10B981)" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/>
        </svg>
      </div>
      <h3>{{ '¡Sesión reservada!'|t }}</h3>
      <p>{{ 'Recibirás un email de confirmación con el enlace de videollamada.'|t }}</p>
      <div class="modal-actions">
        <a href="/mis-sesiones" class="btn btn--primary">{{ 'Ver mis sesiones'|t }}</a>
        <a href="/mentors" class="btn btn--secondary">{{ 'Explorar mentores'|t }}</a>
      </div>
    </div>
  </div>

</div>

{# Attach JavaScript for booking flow #}
{{ attach_library('jaraba_mentoring/session_booking') }}
