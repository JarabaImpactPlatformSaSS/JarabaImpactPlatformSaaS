<?php

/**
 * @file
 * Módulo Jaraba Referral — Programa de Referidos SaaS.
 *
 * ESTRUCTURA:
 * Módulo principal que registra los hooks de integración con Drupal:
 * hook_help, hook_theme (registra 3 templates) y hook_preprocess_html
 * (body classes para las páginas frontend del módulo).
 *
 * LÓGICA:
 * - hook_theme: registra referral_dashboard, referral_my_code y referral_landing.
 * - hook_preprocess_html: inyecta clases CSS en <body> por ruta activa:
 *   page--referidos, page--referido-mi-codigo, page--referido-landing.
 * - NO usa attributes.addClass() en templates (directriz del proyecto).
 *
 * RELACIONES:
 * - jaraba_referral.module -> templates/*.html.twig (registra)
 * - jaraba_referral.module -> jaraba_referral.routing.yml (lee rutas)
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function jaraba_referral_help(string $route_name, RouteMatchInterface $route_match): string {
  if ($route_name === 'help.page.jaraba_referral') {
    return '<p>' . t('Módulo del programa de referidos de la plataforma Jaraba Impact SaaS. Permite generar códigos únicos de referido, rastrear conversiones y gestionar recompensas por tenant.') . '</p>';
  }
  return '';
}

/**
 * Implements hook_theme().
 */
function jaraba_referral_theme(): array {
  return [
    'referral_dashboard' => [
      'variables' => [
        'kpis' => [],
        'referrals' => [],
      ],
      'template' => 'referral-dashboard',
      'path' => \Drupal::service('extension.list.module')->getPath('jaraba_referral') . '/templates',
    ],
    'referral_my_code' => [
      'variables' => [
        'code' => NULL,
        'share_url' => NULL,
        'user_name' => NULL,
      ],
      'template' => 'referral-my-code',
      'path' => \Drupal::service('extension.list.module')->getPath('jaraba_referral') . '/templates',
    ],
    'referral_landing' => [
      'variables' => [
        'code' => NULL,
        'valid' => FALSE,
        'referrer_name' => NULL,
      ],
      'template' => 'referral-landing',
      'path' => \Drupal::service('extension.list.module')->getPath('jaraba_referral') . '/templates',
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK() for html.html.twig.
 */
function jaraba_referral_preprocess_html(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();

  $route_classes = [
    'jaraba_referral.dashboard' => ['page--referidos', 'page--referido-dashboard'],
    'jaraba_referral.my_code' => ['page--referidos', 'page--referido-mi-codigo'],
    'jaraba_referral.landing' => ['page--referido-landing'],
  ];

  if (isset($route_classes[$route_name])) {
    foreach ($route_classes[$route_name] as $class) {
      $variables['attributes']['class'][] = $class;
    }
  }
}
