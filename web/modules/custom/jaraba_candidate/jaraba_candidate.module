<?php

/**
 * @file
 * Jaraba Candidate - Perfil de Candidato y CV Builder.
 *
 * MÃ³dulo para gestiÃ³n del perfil profesional del candidato
 * en el vertical de Empleabilidad.
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function jaraba_candidate_theme(): array {
  return [
    'my_profile_empty' => [
      'variables' => [],
      'template' => 'my-profile-empty',
    ],
    'candidate_profile_view' => [
      'variables' => [
        'profile' => NULL,
        'is_own_profile' => FALSE,
      ],
      'template' => 'candidate-profile-view',
    ],
    'career_dashboard' => [
      'variables' => [
        'phase_name' => '',
        'phase_emoji' => '',  // SVG icon handled in template
        'phase_number' => 1,
        'completeness' => 0,
        'tutor_message' => '',
        'gaps' => [],
        'itineraries' => [],
        'suggested_products' => [],
        'next_action_label' => '',
        'next_action_url' => '',
        'next_action_icon' => '',
        'quick_actions' => [],
        'user_name' => '',
      ],
      'template' => 'career-dashboard',
    ],
    // === Copilot Insights Dashboard (Autoaprendizaje IA) ===
    'copilot_insights_dashboard' => [
      'variables' => [
        'metrics' => [],
        'topics' => [],
        'popular_questions' => [],
        'unresolved_queries' => [],
      ],
      'template' => 'copilot-insights-dashboard',
    ],
    // === My Profile - Experience Management ===
    'my_profile_experience' => [
      'variables' => [
        'experiences' => [],
      ],
      'template' => 'my-profile-experience',
    ],
    // === My Profile - Education Management ===
    'my_profile_education' => [
      'variables' => [
        'educations' => [],
      ],
      'template' => 'my-profile-education',
    ],
    // === My Profile - Languages Management ===
    'my_profile_languages' => [
      'variables' => [
        'languages' => [],
      ],
      'template' => 'my-profile-languages',
    ],
    // === My Profile - Skills Management ===
    'my_profile_skills' => [
      'variables' => [
        'user_skills' => [],
        'categories' => [],
      ],
      'template' => 'my-profile-skills',
    ],
    // === CV Builder ===
    'cv_builder' => [
      'variables' => [
        'profile' => NULL,
        'templates' => [],
      ],
      'template' => 'cv-builder',
    ],
    // === CV Templates (for preview/download rendering) ===
    // Each variant has its own template with a distinct CSS modifier class.
    'cv_template_modern' => [
      'variables' => ['cv_data' => []],
      'template' => 'cv-template-modern',
    ],
    'cv_template_classic' => [
      'variables' => ['cv_data' => []],
      'template' => 'cv-template-classic',
    ],
    'cv_template_creative' => [
      'variables' => ['cv_data' => []],
      'template' => 'cv-template-creative',
    ],
    'cv_template_minimal' => [
      'variables' => ['cv_data' => []],
      'template' => 'cv-template-minimal',
    ],
    'cv_template_tech' => [
      'variables' => ['cv_data' => []],
      'template' => 'cv-template-tech',
    ],
    // === JobSeeker Dashboard ===
    'jobseeker_dashboard' => [
      'variables' => [
        'profile' => NULL,
        'applications' => [],
        'applications_count' => 0,
        'learning' => [],
        'recommendations' => [],
        'stats' => [],
        'quick_actions' => [],
        'cross_vertical_bridges' => [],
      ],
      'template' => 'jobseeker-dashboard',
    ],
    // === JobSeeker Recommendations ===
    'jobseeker_recommendations' => [
      'variables' => [
        'jobs' => [],
      ],
      'template' => 'jobseeker-recommendations',
    ],
  ];
}


/**
 * Implements hook_page_attachments_alter().
 *
 * - Adjunta la librerÃ­a modal-system a las rutas del mÃ³dulo candidato.
 * - Adds Open Graph meta tags for public candidate profiles.
 */
function jaraba_candidate_page_attachments_alter(array &$attachments): void {
  $route_match = \Drupal::routeMatch();
  $route = $route_match->getRouteName() ?: '';

  if (str_starts_with($route, 'jaraba_candidate.')) {
    $attachments['#attached']['library'][] = 'jaraba_candidate/modal-actions';
  }

  // Open Graph meta tags for public candidate profile.
  if ($route === 'jaraba_candidate.profile_view') {
    $profile = $route_match->getParameter('candidate_profile');
    if ($profile && $profile->isPublic()) {
      $title = $profile->getFullName() . ' - ' . ($profile->getHeadline() ?: t('Candidate Profile'));
      $description = mb_substr(strip_tags($profile->getSummary()), 0, 160);
      $url = \Drupal::request()->getSchemeAndHttpHost() . '/profile/' . $profile->id();

      $meta_tags = [
        ['og:title', $title],
        ['og:description', $description],
        ['og:type', 'profile'],
        ['og:url', $url],
        ['twitter:card', 'summary'],
        ['twitter:title', $title],
        ['twitter:description', $description],
      ];

      foreach ($meta_tags as [$property, $content]) {
        $tag = [
          '#tag' => 'meta',
          '#attributes' => [
            'property' => $property,
            'content' => $content,
          ],
        ];
        $attachments['#attached']['html_head'][] = [$tag, 'jaraba_cp_' . $property];
      }
    }
  }
}

/**
 * Implements hook_entity_presave().
 *
 * Geocodes the candidate's location using OpenStreetMap/Nominatim.
 */
function jaraba_candidate_entity_presave(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'candidate_profile') {
    return;
  }

  // Check if city or country changed.
  $city = $entity->get('city')->value ?? '';
  $country = $entity->get('country')->value ?? '';

  if (empty($city) || empty($country)) {
    return;
  }

  // Skip if location already set and city/country haven't changed.
  $original = $entity->original ?? NULL;
  if ($original) {
    $originalCity = $original->get('city')->value ?? '';
    $originalCountry = $original->get('country')->value ?? '';
    $hasLocation = !$entity->get('location')->isEmpty();
    
    if ($hasLocation && $originalCity === $city && $originalCountry === $country) {
      return;
    }
  }

  // Map country codes to names for better geocoding.
  $countryNames = [
    'ES' => 'Spain',
    'PT' => 'Portugal',
    'FR' => 'France',
    'DE' => 'Germany',
    'IT' => 'Italy',
    'GB' => 'United Kingdom',
    'US' => 'United States',
    'MX' => 'Mexico',
    'AR' => 'Argentina',
    'CO' => 'Colombia',
    'CL' => 'Chile',
    'PE' => 'Peru',
    'BR' => 'Brazil',
  ];

  $countryName = $countryNames[$country] ?? $country;
  $address = "$city, $countryName";

  try {
    /** @var \Drupal\geocoder\GeocoderInterface $geocoder */
    $geocoder = \Drupal::service('geocoder');
    
    // Use OpenStreetMap/Nominatim provider (free, no API key needed).
    $result = $geocoder->geocode($address, ['nominatim']);
    
    if ($result && !$result->isEmpty()) {
      $coordinates = $result->first()->getCoordinates();
      $entity->set('location', [
        'lat' => $coordinates->getLatitude(),
        'lon' => $coordinates->getLongitude(),
      ]);
      
      \Drupal::logger('jaraba_candidate')->info(
        'Geocoded @address to @lat, @lon',
        [
          '@address' => $address,
          '@lat' => $coordinates->getLatitude(),
          '@lon' => $coordinates->getLongitude(),
        ]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_candidate')->warning(
      'Failed to geocode @address: @error',
      ['@address' => $address, '@error' => $e->getMessage()]
    );
  }
}
