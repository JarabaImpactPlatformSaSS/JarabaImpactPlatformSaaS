<?php

/**
 * @file
 * jaraba_legal_billing.module â€” Facturacion Legal JarabaLex.
 *
 * Estructura: Hooks de modulo para facturacion, time tracking y presupuestos.
 * Logica: hook_theme, hook_preprocess_html, hook_preprocess_page,
 *   hook_entity_insert, hook_entity_update.
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function jaraba_legal_billing_theme(): array {
  return [
    'jaraba_legal_billing_dashboard' => [
      'variables' => [],
      'template' => 'partials/billing-dashboard',
    ],
    'jaraba_legal_billing_invoice_card' => [
      'variables' => [
        'invoice' => NULL,
      ],
      'template' => 'partials/invoice-card',
    ],
    'jaraba_legal_billing_time_entry' => [
      'variables' => [
        'entry' => NULL,
      ],
      'template' => 'partials/time-entry',
    ],
    'jaraba_legal_billing_quote_card' => [
      'variables' => [
        'quote' => NULL,
      ],
      'template' => 'partials/quote-card',
    ],
  ];
}

/**
 * Implements hook_preprocess_html().
 *
 * LEGAL-BODY-001: body classes solo desde hook_preprocess_html.
 */
function jaraba_legal_billing_preprocess_html(array &$variables): void {
  $route = \Drupal::routeMatch()->getRouteName();
  if ($route && str_starts_with($route, 'jaraba_legal_billing.')) {
    $variables['attributes']['class'][] = 'page--legal-billing';
    if ($route === 'jaraba_legal_billing.dashboard') {
      $variables['attributes']['class'][] = 'page--legal-billing-dashboard';
    }
  }
}

/**
 * Implements hook_preprocess_page().
 *
 * ZERO-REGION-001: Inyecta datos via drupalSettings para el dashboard.
 */
function jaraba_legal_billing_preprocess_page(array &$variables): void {
  $route = \Drupal::routeMatch()->getRouteName();
  if ($route !== 'jaraba_legal_billing.dashboard') {
    return;
  }

  $variables['#attached']['library'][] = 'jaraba_legal_billing/global';
  $variables['#attached']['library'][] = 'jaraba_legal_billing/dashboard';

  try {
    /** @var \Drupal\jaraba_legal_billing\Service\InvoiceManagerService $invoiceManager */
    $invoiceManager = \Drupal::service('jaraba_legal_billing.invoice_manager');
    $invoices = $invoiceManager->listInvoices([], 10, 0);

    $variables['#attached']['drupalSettings']['jarabaLegalBilling'] = [
      'apiBase' => '/api/v1/legal/billing',
      'recentInvoices' => $invoices['items'] ?? [],
      'totalInvoices' => $invoices['total'] ?? 0,
    ];
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_legal_billing')->error('Dashboard data error: @msg', ['@msg' => $e->getMessage()]);
    $variables['#attached']['drupalSettings']['jarabaLegalBilling'] = [
      'apiBase' => '/api/v1/legal/billing',
      'recentInvoices' => [],
      'totalInvoices' => 0,
    ];
  }
}

/**
 * Implements hook_entity_insert().
 *
 * Registra actividad cuando se crea una factura, vinculandola al timeline
 * del expediente via jaraba_legal_cases si esta disponible.
 */
function jaraba_legal_billing_entity_insert(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'legal_invoice') {
    return;
  }

  $caseId = $entity->get('case_id')->target_id ?? NULL;
  if (!$caseId) {
    return;
  }

  try {
    if (\Drupal::hasService('jaraba_legal_cases.activity_logger')) {
      /** @var object $activityLogger */
      $activityLogger = \Drupal::service('jaraba_legal_cases.activity_logger');
      if (method_exists($activityLogger, 'log')) {
        $activityLogger->log($caseId, 'invoice_created', [
          'invoice_id' => $entity->id(),
          'invoice_number' => $entity->get('invoice_number')->value,
          'total' => $entity->get('total')->value,
        ]);
      }
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_legal_billing')->error('Activity log error: @msg', ['@msg' => $e->getMessage()]);
  }
}

/**
 * Implements hook_entity_update().
 *
 * Registra cambios de estado relevantes en facturas.
 */
function jaraba_legal_billing_entity_update(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'legal_invoice') {
    return;
  }

  $original = $entity->original ?? NULL;
  if (!$original) {
    return;
  }

  $oldStatus = $original->get('status')->value;
  $newStatus = $entity->get('status')->value;

  if ($oldStatus === $newStatus) {
    return;
  }

  $caseId = $entity->get('case_id')->target_id ?? NULL;
  if (!$caseId) {
    return;
  }

  try {
    if (\Drupal::hasService('jaraba_legal_cases.activity_logger')) {
      $activityLogger = \Drupal::service('jaraba_legal_cases.activity_logger');
      if (method_exists($activityLogger, 'log')) {
        $activityLogger->log($caseId, 'invoice_status_changed', [
          'invoice_id' => $entity->id(),
          'invoice_number' => $entity->get('invoice_number')->value,
          'old_status' => $oldStatus,
          'new_status' => $newStatus,
        ]);
      }
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_legal_billing')->error('Activity log error: @msg', ['@msg' => $e->getMessage()]);
  }
}
