<?php

/**
 * @file
 * Archivo principal del m√≥dulo Ecosistema Jaraba Core.
 *
 * Este archivo contiene los hooks de Drupal necesarios para:
 * - Registrar templates Twig personalizados
 * - Definir configuraciones de email
 * - Implementar los hooks del m√≥dulo
 *
 * @see https://www.drupal.org/docs/8/creating-custom-modules
 */

use Drupal\Core\Hook\Attribute\LegacyHook;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 *
 * Proporciona informaci√≥n de ayuda para el m√≥dulo en la p√°gina de ayuda
 * de Drupal (/admin/help).
 */
function ecosistema_jaraba_core_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.ecosistema_jaraba_core':
      $output = '<h3>' . t('Acerca de Ecosistema Jaraba Core') . '</h3>';
      $output .= '<p>' . t('Este m√≥dulo proporciona las funcionalidades core de la plataforma Ecosistema Jaraba SaaS, incluyendo:') . '</p>';
      $output .= '<ul>';
      $output .= '<li>' . t('Gesti√≥n de Verticales de negocio') . '</li>';
      $output .= '<li>' . t('Gesti√≥n de Tenants (multi-tenancy)') . '</li>';
      $output .= '<li>' . t('Planes de suscripci√≥n SaaS') . '</li>';
      $output .= '<li>' . t('Firma digital de documentos') . '</li>';
      $output .= '<li>' . t('Integraci√≥n con Stripe para pagos') . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 *
 * Registra los templates Twig personalizados del m√≥dulo.
 * Cada template tiene sus propias variables disponibles documentadas.
 */
function ecosistema_jaraba_core_theme($existing, $type, $theme, $path) {
  return [
    // =========================================================================
    // API DOCUMENTATION (Q1 2027)
    // =========================================================================
    
    // Swagger UI para documentaci√≥n interactiva de la API
    // Ruta: /api/docs
    'api_docs' => [
      'variables' => [
        'title' => 'API Documentation',
      ],
      'template' => 'api-docs',
      'path' => $path . '/templates',
    ],

    // Template del formulario de registro de nuevos tenants
    // Ruta: /registro/{vertical}
    'ecosistema_jaraba_register_form' => [
      'variables' => [
        'vertical' => NULL,
        'plans' => [],
        'theme_settings' => [],
      ],
      'template' => 'ecosistema-jaraba-register-form',
      'path' => $path . '/templates',
    ],

    // Template de selecci√≥n de plan durante onboarding
    // Ruta: /onboarding/seleccionar-plan
    'ecosistema_jaraba_select_plan' => [
      'variables' => [
        'tenant' => NULL,
        'vertical' => NULL,
        'plans' => [],
        'current_plan' => NULL,
      ],
      'template' => 'ecosistema-jaraba-select-plan',
      'path' => $path . '/templates',
    ],

    // Template de configuraci√≥n de pago con Stripe
    // Ruta: /onboarding/configurar-pago
    'ecosistema_jaraba_setup_payment' => [
      'variables' => [
        'tenant' => NULL,
        'plan' => NULL,
        'stripe_public_key' => '',
      ],
      'template' => 'ecosistema-jaraba-setup-payment',
      'path' => $path . '/templates',
    ],

    // Template de bienvenida post-onboarding
    // Ruta: /onboarding/bienvenida
    'ecosistema_jaraba_welcome' => [
      'variables' => [
        'tenant' => NULL,
        'vertical' => NULL,
        'plan' => NULL,
        'trial_days_remaining' => NULL,
        'tenant_url' => '',
        'next_steps' => [],
      ],
      'template' => 'ecosistema-jaraba-welcome',
      'path' => $path . '/templates',
    ],

    // Dashboard de administraci√≥n para Tenant Admins
    // Ruta: /tenant/dashboard
    // Muestra estado de suscripci√≥n, m√©tricas de uso y acciones r√°pidas
    'ecosistema_jaraba_tenant_dashboard' => [
      'variables' => [
        'tenant' => NULL,
        'plan' => NULL,
        'group' => NULL,
        'domain' => NULL,
        'vertical' => NULL,
        'metrics' => [],
        'subscription_status' => 'active',
        'subscription_status_label' => '',
        'is_on_trial' => FALSE,
        'trial_days_remaining' => 0,
        'quick_actions' => [],
        'ai_usage' => [],
      ],
      'template' => 'ecosistema-jaraba-tenant-dashboard',
      'path' => $path . '/templates',
    ],

    // P√°gina de cambio de plan (upgrade/downgrade)
    // Ruta: /tenant/change-plan
    // Muestra planes disponibles para que el tenant pueda cambiar
    'ecosistema_jaraba_change_plan' => [
      'variables' => [
        'tenant' => NULL,
        'current_plan' => NULL,
        'plans' => [],
        'back_url' => NULL,
      ],
      'template' => 'ecosistema-jaraba-change-plan',
      'path' => $path . '/templates',
    ],

    // Dashboard de Salud de la Plataforma
    // Ruta: /admin/health
    // Muestra estado de servicios, m√©tricas y health checks recientes
    'health_dashboard' => [
      'variables' => [
        'services' => [],
        'metrics' => [],
        'recent_checks' => [],
        'last_updated' => NULL,
      ],
      'template' => 'health-dashboard',
      'path' => $path . '/templates',
    ],

    // Dashboard FinOps (Cost Optimization)
    // Ruta: /admin/finops
    // Muestra costes por tenant, proyecciones y recomendaciones de ahorro
    'finops_dashboard' => [
      'variables' => [
        'tenants' => [],
        'totals' => [],
        'projections' => [],
        'alerts' => [],
        'recommendations' => [],
        'help_info' => [],
        'data_sources' => [],
        'revenue' => [],
        'net_results' => [],
        'feature_costs' => [],
        'unit_economics' => [],
        'vertical_profitability' => [],
        'last_updated' => NULL,
      ],
      'template' => 'finops-dashboard',
      'path' => $path . '/templates',
    ],

    // Dashboard Self-Service para Tenants
    // Ruta: /my-dashboard
    // Permite a los tenants ver sus propias m√©tricas sin acceso admin
    'tenant_self_service_dashboard' => [
      'variables' => [
        'tenant' => NULL,
        'metrics' => [],
        'subscription_info' => [],
        'recent_activity' => [],
      ],
      'template' => 'tenant-self-service-dashboard',
      'path' => $path . '/templates',
    ],

    // Configuraci√≥n Self-Service del Tenant
    // Ruta: /my-settings
    'tenant_self_service_settings' => [
      'variables' => [
        'tenant' => NULL,
        'current_plan' => NULL,
        'settings_sections' => [],
      ],
      'template' => 'tenant-self-service-settings',
      'path' => $path . '/templates',
    ],

    // ---------------------------------------------------------------------------
    // MARKETPLACE - PHASE 13
    // ---------------------------------------------------------------------------

    // Landing page del Marketplace
    // Ruta: /marketplace
    'marketplace_landing' => [
      'variables' => [
        'featured_products' => [],
        'categories' => [],
        'active_tenants' => [],
        'stats' => [],
      ],
      'template' => 'marketplace-landing',
      'path' => $path . '/templates',
    ],

    // P√°gina de b√∫squeda del Marketplace
    // Ruta: /marketplace/search
    'marketplace_search' => [
      'variables' => [
        'query' => '',
        'category' => '',
        'products' => [],
        'categories' => [],
      ],
      'template' => 'marketplace-search',
      'path' => $path . '/templates',
    ],

    // Vista de producto individual en Marketplace
    // Ruta: /marketplace/product/{id}
    'marketplace_product' => [
      'variables' => [
        'product' => [],
        'related' => [],
      ],
      'template' => 'marketplace-product',
      'path' => $path . '/templates',
    ],

    // ---------------------------------------------------------------------------
    // Q1 2027: DEMO INTERACTIVA - TIME-TO-VALUE < 60s
    // ---------------------------------------------------------------------------

    // Landing de selecci√≥n de demo
    // Ruta: /demo
    'demo_landing' => [
      'variables' => [
        'profiles' => [],
      ],
      'template' => 'demo-landing',
      'path' => $path . '/templates',
    ],

    // Dashboard de demo interactiva
    // Ruta: /demo/start/{profileId}, /demo/dashboard/{sessionId}
    'demo_dashboard' => [
      'variables' => [
        'session_id' => '',
        'profile' => [],
        'tenant_name' => '',
        'metrics' => [],
        'products' => [],
        'sales_history' => [],
        'magic_actions' => [],
        'tour' => NULL,
      ],
      'template' => 'demo-dashboard',
      'path' => $path . '/templates',
    ],

    // Vista ampliada del dashboard demo
    // Ruta: /demo/dashboard/{sessionId}
    'demo_dashboard_view' => [
      'variables' => [
        'session' => [],
      ],
      'template' => 'demo-dashboard',
      'path' => $path . '/templates',
    ],

    // Demo de storytelling con IA
    // Ruta: /demo/ai/storytelling/{sessionId}
    'demo_ai_storytelling' => [
      'variables' => [
        'session' => [],
        'generated_story' => '',
      ],
      'template' => 'demo-ai-storytelling',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // HERO LANDING - HOMEPAGE (2026-01-24)
    // =========================================================================
    
    // Hero Landing para homepage con Progressive Profiling
    // Ruta: / (homepage)
    'hero_landing' => [
      'variables' => [
        'eyebrow' => NULL,
        'title' => NULL,
        'subtitle' => NULL,
        'dark' => FALSE,
        'intentions' => [],
        'cta_primary' => [],
        'cta_secondary' => [],
      ],
      'template' => 'page/hero-landing',
      'path' => \Drupal::service('extension.list.theme')->getPath('ecosistema_jaraba_theme') . '/templates',
    ],

    // =========================================================================
    // CONTEXTUAL COPILOT FAB (Q1 2027)
    // =========================================================================
    
    // FAB de Copiloto contextual reutilizable para todos los avatares
    // Se configura por avatar: jobseeker, recruiter, entrepreneur, producer, mentor
    'contextual_copilot_fab' => [
      'variables' => [
        'agent_context' => 'general_copilot',
        'greeting' => NULL,
        'avatar_type' => 'general',
        'fab_color' => '#FF8C42',
        'quick_actions' => [],
        'user' => NULL,
      ],
      'template' => 'contextual-copilot-fab',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // VERTICAL LANDING PAGES (Q1 2027)
    // =========================================================================
    
    // Contenido de landing pages de verticales (empleo, talento, emprender, etc.)
    // Usa jaraba_icon() para iconos SVG
    'vertical_landing_content' => [
      'variables' => [
        'vertical_data' => [],
      ],
      'template' => 'partials/vertical-landing-content',
      'path' => \Drupal::service('extension.list.theme')->getPath('ecosistema_jaraba_theme') . '/templates',
    ],

    // =========================================================================
    // ADMIN CENTER - RBAC MATRIX (D.2)
    // =========================================================================
    
    // Matriz visual RBAC para gesti√≥n de permisos
    // Ruta: /admin/people/rbac-matrix
    'rbac_matrix' => [
      'variables' => [
        'roles' => [],
        'permissions' => [],
        'matrix' => [],
        'modules' => [],
        'module_groups' => [],
      ],
      'template' => 'rbac-matrix',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // USAGE DASHBOARD - G111 / f111
    // =========================================================================

    // Dashboard de uso y facturaci√≥n para tenants
    // Ruta: /mi-cuenta/uso
    'usage_dashboard' => [
      'variables' => [
        'tenant' => NULL,
        'period' => '',
        'metrics' => [],
        'bill' => [],
        'forecast' => [],
        'alerts' => [],
        'budget' => 0,
      ],
      'template' => 'usage-dashboard',
      'path' => $path . '/templates',
    ],

    // Estado vac√≠o del dashboard de uso
    'usage_dashboard_empty' => [
      'variables' => [
        'message' => '',
      ],
      'template' => 'usage-dashboard-empty',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // COMPLIANCE DASHBOARD (G115-1)
    // =========================================================================

    'compliance_dashboard' => [
      'variables' => [
        'controls' => [],
        'recent_events' => [],
        'security_headers' => [],
        'stats' => [],
      ],
      'template' => 'compliance-dashboard',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // RESELLER PORTAL (G117-4)
    // =========================================================================

    // Portal de partner/reseller con dashboard de comisiones y tenants
    // Ruta: /partner-portal
    'reseller_portal' => [
      'variables' => [
        'reseller' => NULL,
        'managed_tenants' => [],
        'commissions' => [],
        'metrics' => [],
      ],
      'template' => 'reseller-portal',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // LEAD MAGNETS PUBLICOS (F3 Doc 178)
    // =========================================================================

    // Lead Magnet: Calculadora de Madurez Digital (Emprendimiento)
    // Ruta publica: /emprendimiento/calculadora-madurez
    'lead_magnet_calculadora_madurez' => [
      'variables' => [
        'magnet_data' => [],
      ],
      'template' => 'lead-magnet-calculadora-madurez',
      'path' => $path . '/templates',
    ],

    // Lead Magnet: Guia Vende Online (AgroConecta)
    // Ruta publica: /agroconecta/guia-vende-online
    'lead_magnet_guia_agro' => [
      'variables' => [
        'magnet_data' => [],
      ],
      'template' => 'lead-magnet-guia-agro',
      'path' => $path . '/templates',
    ],

    // Lead Magnet: Auditoria SEO Local (ComercioConecta)
    // Ruta publica: /comercioconecta/auditoria-seo
    'lead_magnet_auditoria_seo' => [
      'variables' => [
        'magnet_data' => [],
      ],
      'template' => 'lead-magnet-auditoria-seo',
      'path' => $path . '/templates',
    ],

    // Lead Magnet: Template Propuesta Profesional (ServiciosConecta)
    // Ruta publica: /serviciosconecta/template-propuesta
    'lead_magnet_template_propuesta' => [
      'variables' => [
        'magnet_data' => [],
      ],
      'template' => 'lead-magnet-template-propuesta',
      'path' => $path . '/templates',
    ],

    // Admin Center Dashboard (F6 Doc 181 / Spec f104)
    // Ruta: /admin/jaraba/center
    'admin_center_dashboard' => [
      'variables' => [
        'kpis' => [],
        'alerts' => [],
        'tenant_stats' => [],
        'quick_links' => [],
        'activity' => [],
      ],
      'template' => 'admin-center-dashboard',
      'path' => $path . '/templates',
    ],

    // Admin Center Tenants (F6 Doc 181 / Spec f104 ¬ßFASE 2)
    // Ruta: /admin/jaraba/center/tenants
    'admin_center_tenants' => [
      'variables' => [],
      'template' => 'admin-center-tenants',
      'path' => $path . '/templates',
    ],

    // Admin Center Tenant Detail ‚Äî Slide-Panel 360 (Spec f104 ¬ßFASE 2)
    'admin_center_tenant_detail' => [
      'variables' => [
        'tenant' => [],
      ],
      'template' => 'admin-center-tenant-detail',
      'path' => $path . '/templates',
    ],

    // Admin Center Users (F6 Doc 181 / Spec f104 ¬ßFASE 3)
    // Ruta: /admin/jaraba/center/users
    'admin_center_users' => [
      'variables' => [],
      'template' => 'admin-center-users',
      'path' => $path . '/templates',
    ],

    // Admin Center User Detail ‚Äî Slide-Panel 360 (Spec f104 ¬ßFASE 3)
    'admin_center_user_detail' => [
      'variables' => [
        'user_data' => [],
      ],
      'template' => 'admin-center-user-detail',
      'path' => $path . '/templates',
    ],

    // Centro Financiero ‚Äî Finance Dashboard (F6 Doc 181 / Spec f104 ¬ßFASE 4).
    'admin_center_finance' => [
      'variables' => [],
      'template' => 'admin-center-finance',
      'path' => $path . '/templates',
    ],

    // Alertas y Playbooks ‚Äî Alerts Dashboard (F6 Doc 181 / Spec f104 ¬ßFASE 5).
    'admin_center_alerts' => [
      'variables' => [],
      'template' => 'admin-center-alerts',
      'path' => $path . '/templates',
    ],

    // Alert Detail ‚Äî Slide-Panel de detalle de alerta (Spec f104 ¬ßFASE 5).
    'admin_center_alert_detail' => [
      'variables' => [
        'alert' => [],
      ],
      'template' => 'admin-center-alert-detail',
      'path' => $path . '/templates',
    ],

    // Analytics Dashboard ‚Äî Charts + AI Telemetry (F6 Doc 181 / Spec f104 ¬ßFASE 6).
    'admin_center_analytics' => [
      'variables' => [],
      'template' => 'admin-center-analytics',
      'path' => $path . '/templates',
    ],

    // Activity Logs ‚Äî Visor de Audit + System logs (F6 Doc 181 / Spec f104 ¬ßFASE 6).
    'admin_center_logs' => [
      'variables' => [],
      'template' => 'admin-center-logs',
      'path' => $path . '/templates',
    ],

    // Configuraci√≥n Global ‚Äî Settings page (F6 Doc 181 / Spec f104 ¬ßFASE 7).
    'admin_center_settings' => [
      'variables' => [],
      'template' => 'admin-center-settings',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // ADMIN STRUCTURE ENHANCED (UX Improvement)
    // =========================================================================

    // P√°gina /admin/structure con secciones categorizadas y b√∫squeda
    'admin_structure_overview' => [
      'variables' => [
        'categories' => [],
        'total_items' => 0,
      ],
      'template' => 'admin-structure-overview',
      'path' => $path . '/templates',
    ],

    // P√°gina /admin/content con secciones categorizadas y b√∫squeda
    'admin_content_overview' => [
      'variables' => [
        'categories' => [],
        'total_items' => 0,
      ],
      'template' => 'admin-content-overview',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // COMPLIANCE PANEL UNIFICADO (Stack Compliance Legal N1 ‚Äî FASE 12)
    // =========================================================================

    // Panel cross-modulo: agrega KPIs de jaraba_privacy, jaraba_legal, jaraba_dr
    // Ruta: /admin/jaraba/compliance
    'compliance_panel' => [
      'variables' => [
        'score' => 0,
        'grade' => 'F',
        'kpis' => [],
        'alerts' => [],
        'modules' => [],
      ],
      'template' => 'compliance-panel',
      'path' => $path . '/templates',
    ],

    // =========================================================================
    // FISCAL COMPLIANCE DASHBOARD (FASE 11)
    // =========================================================================

    // Dashboard fiscal unificado ‚Äî zero-region page template.
    // Ruta: /admin/jaraba/fiscal
    'page__fiscal' => [
      'template' => 'page--fiscal',
      'path' => $path . '/templates',
      'variables' => [
        'fiscal_compliance' => [],
        'fiscal_installed_modules' => [],
        'fiscal_verifactu_stats' => [],
        'fiscal_facturae_stats' => [],
        'fiscal_einvoice_stats' => [],
        'fiscal_certificate_status' => [],
        'fiscal_tenant_id' => '',
      ],
    ],

    // =========================================================================
    // P√ÅGINAS LEGALES E INFORMATIVAS
    // =========================================================================

    // Template gen√©rico reutilizable para p√°ginas legales (privacidad, t√©rminos, cookies).
    // Contenido configurable desde theme settings.
    'legal_page' => [
      'variables' => [
        'page_type' => '',
        'title' => '',
        'content' => '',
        'last_updated' => '',
        'theme_settings' => [],
      ],
      'template' => 'legal-page',
      'path' => $path . '/templates',
    ],

    // P√°gina Sobre Nosotros.
    'info_page_about' => [
      'variables' => [
        'content' => '',
        'theme_settings' => [],
      ],
      'template' => 'info-page-about',
      'path' => $path . '/templates',
    ],

    // P√°gina de Contacto.
    'info_page_contact' => [
      'variables' => [
        'content' => '',
        'contact_email' => '',
        'contact_phone' => '',
        'contact_address' => '',
        'theme_settings' => [],
      ],
      'template' => 'info-page-contact',
      'path' => $path . '/templates',
    ],

    // Premium Form Wrapper ‚Äî full-page (non-AJAX) entity form with back nav.
    'premium_form_wrapper' => [
      'variables' => [
        'form' => NULL,
        'title' => '',
        'back_url' => '',
        'back_label' => '',
        'entity_type_label' => '',
      ],
      'template' => 'premium-form-wrapper',
      'path' => $path . '/templates',
    ],
  ];


}

/**
 * Implements hook_page_attachments().
 *
 * Adjunta la librer√≠a "back-to-top" en todas las p√°ginas de administraci√≥n.
 */
function ecosistema_jaraba_core_page_attachments(array &$attachments): void {
  $route = \Drupal::routeMatch()->getRouteObject();
  if ($route && \Drupal::service('router.admin_context')->isAdminRoute($route)) {
    $attachments['#attached']['library'][] = 'ecosistema_jaraba_core/back-to-top';
  }
}

/**
 * Implements hook_mail().
 *
 * Define las plantillas de correo electr√≥nico del m√≥dulo.
 * Los emails se env√≠an en formato HTML con texto plano alternativo.
 */
function ecosistema_jaraba_core_mail($key, &$message, $params) {
  switch ($key) {
    // Email de bienvenida para nuevos tenants
    case 'tenant_welcome':
      $message['subject'] = t('¬°Bienvenido a @vertical!', [
        '@vertical' => $params['vertical_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('Tu organizaci√≥n <strong>@tenant</strong> ha sido creada exitosamente en la plataforma @vertical.', [
        '@tenant' => $params['tenant_name'],
        '@vertical' => $params['vertical_name'],
      ]);

      $message['body'][] = t('Tu URL de acceso es: @url', [
        '@url' => $params['access_url'],
      ]);

      $message['body'][] = t('Tu periodo de prueba gratuita termina el: @date', [
        '@date' => $params['trial_ends'],
      ]);

      $message['body'][] = t('Para empezar, inicia sesi√≥n en tu panel de control y completa la configuraci√≥n de tu organizaci√≥n.');

      $message['body'][] = '---';
      $message['body'][] = t('El equipo de Ecosistema Jaraba');
      break;

    // Email de recordatorio de fin de trial
    case 'trial_ending_reminder':
      $message['subject'] = t('Tu periodo de prueba en @vertical termina pronto', [
        '@vertical' => $params['vertical_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('Tu periodo de prueba en @tenant termina en @days d√≠as.', [
        '@tenant' => $params['tenant_name'],
        '@days' => $params['days_remaining'],
      ]);

      $message['body'][] = t('Para seguir disfrutando de todas las funcionalidades, a√±ade un m√©todo de pago antes de que termine el periodo de prueba.');

      $message['body'][] = t('Accede a tu cuenta: @url', [
        '@url' => $params['access_url'],
      ]);
      break;

    // Email de confirmaci√≥n de pago
    case 'payment_confirmation':
      $message['subject'] = t('Confirmaci√≥n de pago - @tenant', [
        '@tenant' => $params['tenant_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('Hemos recibido tu pago de @amount para el plan @plan.', [
        '@amount' => $params['amount'],
        '@plan' => $params['plan_name'],
      ]);

      $message['body'][] = t('Pr√≥xima facturaci√≥n: @date', [
        '@date' => $params['next_billing_date'],
      ]);

      $message['body'][] = t('Gracias por confiar en nosotros.');
      break;

    // Email de alerta de pago fallido
    case 'payment_failed':
      $message['subject'] = t('‚ö†Ô∏è Problema con tu pago - @tenant', [
        '@tenant' => $params['tenant_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('No hemos podido procesar tu pago de @amount para el plan @plan.', [
        '@amount' => $params['amount'],
        '@plan' => $params['plan_name'],
      ]);

      $message['body'][] = t('Por favor, verifica tu m√©todo de pago para evitar la suspensi√≥n de tu cuenta.');

      $message['body'][] = t('Actualizar m√©todo de pago: @url', [
        '@url' => $params['payment_url'],
      ]);
      break;

    // Email de alerta de l√≠mite de uso
    case 'usage_limit_alert':
      $message['subject'] = t('üìä Alerta de uso (@percent%) - @tenant', [
        '@percent' => $params['percentage'],
        '@tenant' => $params['tenant_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      if ($params['percentage'] >= 100) {
        $message['body'][] = t('Has alcanzado el 100% del l√≠mite de @type en tu plan.', [
          '@type' => $params['limit_type'],
        ]);
        $message['body'][] = t('Uso actual: @current de @max permitidos.', [
          '@current' => $params['current'],
          '@max' => $params['max'],
        ]);
        $message['body'][] = t('Para continuar a√±adiendo m√°s @type, necesitas actualizar tu plan.', [
          '@type' => $params['limit_type'],
        ]);
      } else {
        $message['body'][] = t('Has alcanzado el @percent% del l√≠mite de @type en tu plan.', [
          '@percent' => $params['percentage'],
          '@type' => $params['limit_type'],
        ]);
        $message['body'][] = t('Uso actual: @current de @max permitidos.', [
          '@current' => $params['current'],
          '@max' => $params['max'],
        ]);
        $message['body'][] = t('Te recomendamos revisar tu plan antes de alcanzar el l√≠mite.');
      }

      $message['body'][] = t('Actualizar plan: @url', [
        '@url' => $params['upgrade_url'],
      ]);
      break;

    // =========================================================================
    // REVERSE TRIAL EMAILS (Q1 2027)
    // =========================================================================

    // Email de recordatorio de reverse trial expirando
    case 'reverse_trial_expiring':
      if ($params['days_remaining'] == 0) {
        $message['subject'] = t('‚ö†Ô∏è Tu acceso Pro termina HOY - @tenant', [
          '@tenant' => $params['tenant_name'],
        ]);
      } else {
        $message['subject'] = t('‚è∞ Te quedan @days d√≠as de acceso Pro - @tenant', [
          '@days' => $params['days_remaining'],
          '@tenant' => $params['tenant_name'],
        ]);
      }

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      if ($params['days_remaining'] == 0) {
        $message['body'][] = t('Tu per√≠odo de prueba Pro en @tenant termina HOY.', [
          '@tenant' => $params['tenant_name'],
        ]);
        $message['body'][] = t('Si no a√±ades un m√©todo de pago, ma√±ana tu cuenta cambiar√° autom√°ticamente al plan Starter (gratuito).');
      } elseif ($params['days_remaining'] == 1) {
        $message['body'][] = t('Tu per√≠odo de prueba Pro en @tenant termina MA√ëANA.', [
          '@tenant' => $params['tenant_name'],
        ]);
        $message['body'][] = t('Esta es tu √∫ltima oportunidad para mantener todas las funcionalidades Pro.');
      } else {
        $message['body'][] = t('Tu per√≠odo de prueba Pro en @tenant termina en @days d√≠as.', [
          '@tenant' => $params['tenant_name'],
          '@days' => $params['days_remaining'],
        ]);
      }

      $message['body'][] = '';
      $message['body'][] = t('üöÄ Con el plan Pro tienes acceso a:');
      $message['body'][] = t('‚Ä¢ Agentes IA completos');
      $message['body'][] = t('‚Ä¢ Trazabilidad avanzada');
      $message['body'][] = t('‚Ä¢ Soporte prioritario');
      $message['body'][] = t('‚Ä¢ Anal√≠ticas avanzadas');

      $message['body'][] = '';
      $message['body'][] = t('üëâ Mant√©n tu acceso Pro: @url', [
        '@url' => $params['upgrade_url'],
      ]);

      $message['body'][] = '---';
      $message['body'][] = t('El equipo de Jaraba Impact Platform');
      break;

    // =========================================================================
    // USER WELCOME EMAIL ‚Äî World-Class HTML (inline CSS)
    // =========================================================================
    case 'user_welcome':
      $account = $params['account'] ?? NULL;
      $avatarType = $params['avatar'] ?? 'pending';
      $displayName = $params['display_name'] ?? ($account ? $account->getDisplayName() : 'Usuario');

      // Avatar-specific content map.
      $avatarConfig = _ecosistema_jaraba_core_get_avatar_email_config($avatarType);

      // Build the base URL for CTA links.
      $baseUrl = \Drupal::request()->getSchemeAndHttpHost();
      $ctaUrl = $baseUrl . $avatarConfig['cta_url'];

      // Set subject.
      $message['subject'] = '¬°Bienvenido/a a Jaraba! ' . $avatarConfig['subject_suffix'];

      // Set headers for HTML.
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';

      // Build HTML body with inline CSS.
      $html = _ecosistema_jaraba_core_build_welcome_email_html(
        $displayName,
        $avatarConfig,
        $ctaUrl,
        $account ? $account->getEmail() : ''
      );

      $message['body'][] = \Drupal\Core\Render\Markup::create($html);
      break;

    // Email de confirmaci√≥n de downgrade
    case 'reverse_trial_downgraded':
      $message['subject'] = t('üìã Tu cuenta ha cambiado a @plan - @tenant', [
        '@plan' => $params['new_plan'],
        '@tenant' => $params['tenant_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('Tu per√≠odo de prueba Pro ha terminado. Tu cuenta @tenant ha cambiado autom√°ticamente al plan @plan.', [
        '@tenant' => $params['tenant_name'],
        '@plan' => $params['new_plan'],
      ]);

      $message['body'][] = '';
      $message['body'][] = t('Con el plan @plan puedes:', [
        '@plan' => $params['new_plan'],
      ]);
      $message['body'][] = t('‚Ä¢ Gestionar hasta 3 productos');
      $message['body'][] = t('‚Ä¢ Usar trazabilidad b√°sica');
      $message['body'][] = t('‚Ä¢ Acceder al marketplace');

      $message['body'][] = '';
      $message['body'][] = t('¬øQuieres recuperar todas las funcionalidades Pro?');
      $message['body'][] = t('üëâ Actualizar ahora: @url', [
        '@url' => $params['upgrade_url'],
      ]);

      $message['body'][] = '---';
      $message['body'][] = t('El equipo de Jaraba Impact Platform');
      break;

    // =========================================================================
    // AI COST ALERTS (Q1 2027)
    // =========================================================================
    case 'ai_cost_alert':
      $level = $params['level'] ?? 'warning';
      $emoji = $level === 'critical' ? 'üö®' : '‚ö†Ô∏è';

      $message['subject'] = t('@emoji Alerta de costes IA (@level) - Jaraba Impact Platform', [
        '@emoji' => $emoji,
        '@level' => strtoupper($level),
      ]);

      $message['body'][] = t('Alerta de costes de Inteligencia Artificial');
      $message['body'][] = '';
      $message['body'][] = t('Nivel: @level', ['@level' => strtoupper($level)]);
      $message['body'][] = t('Coste diario actual: ‚Ç¨@cost', ['@cost' => number_format($params['daily_cost'] ?? 0, 2)]);
      $message['body'][] = t('Umbral configurado: ‚Ç¨@threshold', ['@threshold' => number_format($params['threshold'] ?? 0, 2)]);
      $message['body'][] = '';
      $message['body'][] = t('Desglose por proveedor:');

      foreach ($params['breakdown'] ?? [] as $provider => $data) {
        $message['body'][] = t('  - @provider: ‚Ç¨@cost (@tokens tokens)', [
          '@provider' => ucfirst($provider),
          '@cost' => number_format($data['cost'] ?? 0, 2),
          '@tokens' => number_format($data['tokens'] ?? 0),
        ]);
      }

      $message['body'][] = '';
      $message['body'][] = t('Acciones recomendadas:');
      $message['body'][] = t('  1. Revisar el Dashboard FinOps: @url', [
        '@url' => $params['dashboard_url'] ?? '/admin/finops',
      ]);
      $message['body'][] = t('  2. Considerar activar m√°s cach√© de respuestas');
      $message['body'][] = t('  3. Ajustar umbrales en configuraci√≥n si es apropiado');

      $message['body'][] = '';
      $message['body'][] = '---';
      $message['body'][] = t('Sistema de monitorizaci√≥n FinOps - Jaraba Impact Platform');
      break;

    // =========================================================================
    // LEAD MAGNET EMAILS (F3 Doc 178)
    // =========================================================================

    // Email con resultados de la Calculadora de Madurez Digital
    case 'lead_magnet_calculadora':
      $message['subject'] = $params['subject'] ?? t('Tu resultado de Madurez Digital');
      if (!empty($params['body']) && is_array($params['body'])) {
        foreach ($params['body'] as $line) {
          $message['body'][] = $line;
        }
      }
      break;

    // Email con Guia "Vende Online sin Intermediarios"
    case 'lead_magnet_guia':
      $message['subject'] = $params['subject'] ?? t('Tu Guia para Vender Online');
      if (!empty($params['body']) && is_array($params['body'])) {
        foreach ($params['body'] as $line) {
          $message['body'][] = $line;
        }
      }
      break;

    // Email con resultados de Auditoria SEO Local
    case 'lead_magnet_auditoria':
      $message['subject'] = $params['subject'] ?? t('Resultados de tu Auditoria SEO Local');
      if (!empty($params['body']) && is_array($params['body'])) {
        foreach ($params['body'] as $line) {
          $message['body'][] = $line;
        }
      }
      break;

    // Email con Template Propuesta Profesional
    case 'lead_magnet_propuesta':
      $message['subject'] = $params['subject'] ?? t('Tu Template de Propuesta Profesional');
      if (!empty($params['body']) && is_array($params['body'])) {
        foreach ($params['body'] as $line) {
          $message['body'][] = $line;
        }
      }
      break;

    // =========================================================================
    // HEALTH ALERTS (Fase 2 Hardening)
    // =========================================================================
    case 'health_alert':
      $status = $params['status'] ?? 'degraded';
      $failedServices = $params['failed_services'] ?? [];

      $message['subject'] = t('üî¥ Alerta de salud de plataforma - Jaraba Impact Platform');

      $message['body'][] = t('El health check autom√°tico ha detectado problemas en la plataforma.');
      $message['body'][] = '';
      $message['body'][] = t('Estado: @status', ['@status' => strtoupper($status)]);
      $message['body'][] = t('Fecha: @timestamp', ['@timestamp' => $params['timestamp'] ?? date('Y-m-d H:i:s')]);
      $message['body'][] = '';
      $message['body'][] = t('Servicios afectados:');

      foreach ($failedServices as $service) {
        $message['body'][] = t('  ‚ùå @service', ['@service' => ucfirst($service)]);
      }

      $message['body'][] = '';
      $message['body'][] = t('Acciones:');
      $message['body'][] = t('  1. Verificar dashboard: /admin/health');
      $message['body'][] = t('  2. Endpoint p√∫blico: /health');
      $message['body'][] = t('  3. Revisar logs del servidor');

      $message['body'][] = '';
      $message['body'][] = '---';
      $message['body'][] = t('Sistema de monitorizaci√≥n autom√°tica - Jaraba Impact Platform');
      break;
  }
}

// ===========================================================================
// Q1 2027: MICRO-AUTOMATIONS (INVISIBLE AI)
// ===========================================================================

/**
 * Implements hook_node_presave().
 *
 * @deprecated in ecosistema_jaraba_core:1.x. Use
 *   \Drupal\ecosistema_jaraba_core\Hook\NodePresaveHooks instead.
 */
#[LegacyHook]
function ecosistema_jaraba_core_node_presave(\Drupal\node\NodeInterface $node) {
  // Solo para productos.
  if ($node->bundle() !== 'product') {
    return;
  }

  // Solo si el producto es nuevo o no tiene tags.
  $hasTags = $node->hasField('field_tags') && !$node->get('field_tags')->isEmpty();
  
  if ($node->isNew() || !$hasTags) {
    try {
      /** @var \Drupal\ecosistema_jaraba_core\Service\MicroAutomationService $microAutomation */
      $microAutomation = \Drupal::service('ecosistema_jaraba_core.micro_automation');
      $suggestedTags = $microAutomation->autoTagProduct($node);
      
      // Guardar tags sugeridos en el campo (si existe y acepta strings).
      if ($node->hasField('field_auto_tags')) {
        $node->set('field_auto_tags', implode(', ', $suggestedTags));
      }
      
      \Drupal::logger('micro_automation')->info(
        'üè∑Ô∏è Auto-tagged product "@title" on save',
        ['@title' => $node->getTitle()]
      );
      
    } catch (\Exception $e) {
      // Silenciosamente ignorar errores para no bloquear guardado.
      \Drupal::logger('micro_automation')->warning(
        'Failed to auto-tag product: @error',
        ['@error' => $e->getMessage()]
      );
    }
  }
}

/**
 * Implements hook_cron().
 *
 * Tareas programadas del m√≥dulo que se ejecutan con cada cron.
 */
function ecosistema_jaraba_core_cron() {
  // BE-05: Encolar tareas pesadas en QueueWorker en vez de ejecutar s√≠ncrono.
  $entityTypeManager = \Drupal::entityTypeManager();
  $tenantStorage = $entityTypeManager->getStorage('tenant');

  // 1. Encolar tenants con trial pr√≥ximo a expirar.
  $thresholdDate = (new \DateTime())->add(new \DateInterval('P3D'))->format('Y-m-d\TH:i:s');
  $now = (new \DateTime())->format('Y-m-d\TH:i:s');
  $expiringIds = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', 'trial')
    ->condition('trial_ends', $now, '>')
    ->condition('trial_ends', $thresholdDate, '<=')
    ->execute();

  $trialsQueue = \Drupal::queue('ecosistema_jaraba_expiring_trials');
  foreach ($expiringIds as $id) {
    $trialsQueue->createItem(['tenant_id' => $id]);
  }

  // 2. Encolar tenants con pagos pendientes (past_due > 7 d√≠as).
  $pastDueThreshold = (new \DateTime())->sub(new \DateInterval('P7D'))->format('Y-m-d\TH:i:s');
  $pastDueIds = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', 'past_due')
    ->condition('changed', strtotime($pastDueThreshold), '<')
    ->execute();

  $pastDueQueue = \Drupal::queue('ecosistema_jaraba_past_due_subscriptions');
  foreach ($pastDueIds as $id) {
    $pastDueQueue->createItem(['tenant_id' => $id]);
  }

  // 3. Encolar verificaci√≥n de l√≠mites de uso por tenant.
  $activeIds = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', ['active', 'trial'], 'IN')
    ->execute();

  $usageQueue = \Drupal::queue('ecosistema_jaraba_usage_limits');
  foreach ($activeIds as $id) {
    $usageQueue->createItem(['tenant_id' => $id]);
  }

  // 4. Reverse Trial: se mantiene s√≠ncrono (opera en batch internamente).
  try {
    /** @var \Drupal\ecosistema_jaraba_core\Service\ReverseTrialService $reverseTrialService */
    $reverseTrialService = \Drupal::service('ecosistema_jaraba_core.reverse_trial');
    $downgraded = $reverseTrialService->processExpiredTrials();
    if ($downgraded > 0) {
      \Drupal::logger('ecosistema_jaraba_core')->info(
        'Reverse Trial: @count tenants downgraded',
        ['@count' => $downgraded]
      );
    }
    $notifications = $reverseTrialService->processTrialNotifications();
    if ($notifications > 0) {
      \Drupal::logger('ecosistema_jaraba_core')->info(
        'Reverse Trial: @count notificaciones enviadas',
        ['@count' => $notifications]
      );
    }
  } catch (\Exception $e) {
    \Drupal::logger('ecosistema_jaraba_core')->error(
      'Error en Reverse Trials: @message',
      ['@message' => $e->getMessage()]
    );
  }

  // 5. AI Cost Monitoring (ligero, con throttling interno de 1h).
  try {
    _ecosistema_jaraba_core_check_ai_costs();
  } catch (\Exception $e) {
    \Drupal::logger('ecosistema_jaraba_core')->error(
      'Error en costes IA: @message',
      ['@message' => $e->getMessage()]
    );
  }

  // 6b. Detecci√≥n de anomal√≠as de uso (G111-3).
  try {
    /** @var \Drupal\ecosistema_jaraba_core\Service\UsageAnomalyDetectorService $anomalyDetector */
    $anomalyDetector = \Drupal::service('ecosistema_jaraba_core.usage_anomaly_detector');
    $anomalies = $anomalyDetector->detectAnomalies();
    if (!empty($anomalies)) {
      $anomalyDetector->notifyAnomalies($anomalies);
      \Drupal::logger('ecosistema_jaraba_core')->info(
        'Anomaly detection: @count anomal√≠as detectadas',
        ['@count' => count($anomalies)]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('ecosistema_jaraba_core')->error(
      'Error en detecci√≥n de anomal√≠as: @message',
      ['@message' => $e->getMessage()]
    );
  }

  // 6. Tareas extendidas: health checks, costes IA peri√≥dicos, verificaciones 6h.
  _ecosistema_jaraba_core_cron_extended();
}

/**
 * Verifica costes de IA y env√≠a alertas si se superan umbrales.
 *
 * Umbrales configurables:
 * - Warning: ‚Ç¨3/d√≠a
 * - Critical: ‚Ç¨5/d√≠a
 *
 * @internal
 */
function _ecosistema_jaraba_core_check_ai_costs() {
  $state = \Drupal::state();
  
  // Throttling: solo verificar una vez por hora
  $lastCheck = $state->get('ai_cost_last_check', 0);
  if (time() - $lastCheck < 3600) {
    return;
  }
  $state->set('ai_cost_last_check', time());
  
  // Obtener m√©tricas del servicio AICostOptimizationService
  try {
    /** @var \Drupal\ecosistema_jaraba_core\Service\AICostOptimizationService $aiCostService */
    $aiCostService = \Drupal::service('ecosistema_jaraba_core.ai_cost_optimization');
    $stats = $aiCostService->getOptimizationStats(0);
    $metrics = [
      'daily_cost' => $stats['usage'] ?? 0,
      'total_calls' => $stats['total_calls'] ?? 0,
      'by_model' => $stats['by_model'] ?? [],
    ];
  } catch (\Throwable $e) {
    // Servicio no disponible, usar State API directamente
    $metrics = _ecosistema_jaraba_core_get_ai_metrics_from_state();
  }
  
  $dailyCost = $metrics['daily_cost'] ?? 0;
  
  // Umbrales (configurables via settings.php)
  $config = \Drupal::config('ecosistema_jaraba_core.settings');
  $warningThreshold = $config->get('ai_cost.warning_threshold') ?? 3.0;
  $criticalThreshold = $config->get('ai_cost.critical_threshold') ?? 5.0;
  
  if ($dailyCost >= $criticalThreshold) {
    _ecosistema_jaraba_core_send_ai_cost_alert('critical', $dailyCost, $criticalThreshold, $metrics);
  } elseif ($dailyCost >= $warningThreshold) {
    _ecosistema_jaraba_core_send_ai_cost_alert('warning', $dailyCost, $warningThreshold, $metrics);
  }
}

/**
 * Obtiene m√©tricas de IA desde State API (fallback).
 *
 * @internal
 */
function _ecosistema_jaraba_core_get_ai_metrics_from_state(): array {
  $state = \Drupal::state();
  $key = 'ai_usage_' . date('Y-m');
  $monthlyData = $state->get($key, []);
  
  $totalCost = 0;
  $totalTokens = 0;
  $breakdown = [];
  
  foreach ($monthlyData as $provider => $data) {
    $cost = $data['cost'] ?? 0;
    $tokens = ($data['tokens_in'] ?? 0) + ($data['tokens_out'] ?? 0);
    $totalCost += $cost;
    $totalTokens += $tokens;
    $breakdown[$provider] = [
      'cost' => $cost,
      'tokens' => $tokens,
      'calls' => $data['calls'] ?? 0,
    ];
  }
  
  // Estimar coste diario (dividir por d√≠a del mes)
  $dayOfMonth = (int) date('d');
  $dailyCost = $dayOfMonth > 0 ? $totalCost / $dayOfMonth : $totalCost;
  
  return [
    'daily_cost' => $dailyCost,
    'monthly_cost' => $totalCost,
    'total_tokens' => $totalTokens,
    'breakdown' => $breakdown,
  ];
}

/**
 * Env√≠a alerta de costes IA por email.
 *
 * @param string $level
 *   Nivel de alerta: 'warning' o 'critical'.
 * @param float $dailyCost
 *   Coste diario actual.
 * @param float $threshold
 *   Umbral superado.
 * @param array $metrics
 *   M√©tricas detalladas.
 *
 * @internal
 */
function _ecosistema_jaraba_core_send_ai_cost_alert(string $level, float $dailyCost, float $threshold, array $metrics) {
  $state = \Drupal::state();
  
  // Throttling: solo una alerta por nivel por d√≠a
  $alertKey = "ai_cost_alert_{$level}_" . date('Y-m-d');
  if ($state->get($alertKey, FALSE)) {
    return; // Ya se envi√≥ hoy
  }
  
  // Obtener email del admin
  $config = \Drupal::config('system.site');
  $adminEmail = $config->get('mail');
  
  if (empty($adminEmail)) {
    \Drupal::logger('ecosistema_jaraba_core')->warning(
      'No se pudo enviar alerta de costes IA: email de admin no configurado'
    );
    return;
  }
  
  $params = [
    'level' => $level,
    'daily_cost' => $dailyCost,
    'threshold' => $threshold,
    'breakdown' => $metrics['breakdown'] ?? [],
    'dashboard_url' => \Drupal\Core\Url::fromRoute('ecosistema_jaraba_core.finops_dashboard', [], ['absolute' => TRUE])->toString(),
  ];
  
  $mailManager = \Drupal::service('plugin.manager.mail');
  $result = $mailManager->mail(
    'ecosistema_jaraba_core',
    'ai_cost_alert',
    $adminEmail,
    'es',
    $params
  );
  
  if ($result['result']) {
    $state->set($alertKey, TRUE);
    \Drupal::logger('ecosistema_jaraba_core')->info(
      'üí∞ AI Cost Alert (@level): ‚Ç¨@cost/d√≠a enviado a @email',
      [
        '@level' => strtoupper($level),
        '@cost' => number_format($dailyCost, 2),
        '@email' => $adminEmail,
      ]
    );
  }
}

/**
 * Verifica y notifica tenants con trial pr√≥ximo a expirar.
 *
 * Esta funci√≥n busca tenants cuyo periodo de prueba termina en los pr√≥ximos
 * 3 d√≠as y env√≠a recordatorios por email.
 *
 * @internal
 */
function _ecosistema_jaraba_core_check_expiring_trials() {
  $entityTypeManager = \Drupal::entityTypeManager();
  $tenantStorage = $entityTypeManager->getStorage('tenant');

  // Buscar tenants en trial que expiran en 3 d√≠as o menos
  $thresholdDate = (new \DateTime())->add(new \DateInterval('P3D'))->format('Y-m-d\TH:i:s');
  $now = (new \DateTime())->format('Y-m-d\TH:i:s');

  $query = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', 'trial')
    ->condition('trial_ends', $now, '>')
    ->condition('trial_ends', $thresholdDate, '<=');

  $tenantIds = $query->execute();

  foreach ($tenantIds as $tenantId) {
    $tenant = $tenantStorage->load($tenantId);
    if ($tenant && !$tenant->get('trial_reminder_sent')->value) {
      // Enviar email de recordatorio de fin de trial.
      try {
        $adminUser = $tenant->getAdminUser();
        if ($adminUser && $adminUser->getEmail()) {
          \Drupal::service('plugin.manager.mail')->mail(
            'ecosistema_jaraba_core',
            'trial_ending_reminder',
            $adminUser->getEmail(),
            $adminUser->getPreferredLangcode(),
            [
              'tenant_name' => $tenant->getName(),
              'trial_end_date' => $tenant->get('trial_ends')->value ?? '',
              'upgrade_url' => '/admin/subscription/upgrade',
            ]
          );
        }
      }
      catch (\Exception $e) {
        \Drupal::logger('ecosistema_jaraba_core')->error(
          'Failed to send trial reminder for tenant @tenant: @error',
          ['@tenant' => $tenant->getName(), '@error' => $e->getMessage()]
        );
      }

      \Drupal::logger('ecosistema_jaraba_core')->info(
        'üìß Recordatorio de trial enviado a tenant @tenant',
        ['@tenant' => $tenant->getName()]
      );

      // Marcar como enviado para no repetir
      $tenant->set('trial_reminder_sent', TRUE);
      $tenant->save();
    }
  }
}

/**
 * Verifica tenants con pagos pendientes para posible suspensi√≥n.
 *
 * Los tenants que llevan m√°s de 7 d√≠as en estado past_due se suspenden.
 *
 * @internal
 */
function _ecosistema_jaraba_core_check_past_due_subscriptions() {
  $entityTypeManager = \Drupal::entityTypeManager();
  $tenantStorage = $entityTypeManager->getStorage('tenant');

  // Buscar tenants en past_due desde hace m√°s de 7 d√≠as
  $thresholdDate = (new \DateTime())->sub(new \DateInterval('P7D'))->format('Y-m-d\TH:i:s');

  $query = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', 'past_due')
    ->condition('changed', strtotime($thresholdDate), '<');

  $tenantIds = $query->execute();

  $tenantManager = \Drupal::service('ecosistema_jaraba_core.tenant_manager');

  foreach ($tenantIds as $tenantId) {
    $tenant = $tenantStorage->load($tenantId);
    if ($tenant) {
      // Suspender el tenant
      $tenantManager->suspendTenant($tenant, 'payment_overdue');

      \Drupal::logger('ecosistema_jaraba_core')->warning(
        '‚ö†Ô∏è Tenant @tenant suspendido por pago pendiente',
        ['@tenant' => $tenant->getName()]
      );
    }
  }
}

/**
 * Verifica tenants que se acercan a sus l√≠mites de uso.
 *
 * Env√≠a alertas cuando un tenant alcanza el 80% o 100% de sus l√≠mites:
 * - N√∫mero de productores
 * - Almacenamiento utilizado
 *
 * @internal
 */
function _ecosistema_jaraba_core_check_usage_limits() {
  $entityTypeManager = \Drupal::entityTypeManager();
  $tenantStorage = $entityTypeManager->getStorage('tenant');

  // Solo tenants activos
  $query = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', ['active', 'trial'], 'IN');

  $tenantIds = $query->execute();

  /** @var \Drupal\ecosistema_jaraba_core\Service\TenantContextService $tenantContext */
  // @todo CONS-N10: Move to service class for proper DI.
  $tenantContext = \Drupal::service('ecosistema_jaraba_core.tenant_context');

  $alertThreshold80 = 0.80;
  $alertThreshold100 = 1.00;

  foreach ($tenantIds as $tenantId) {
    $tenant = $tenantStorage->load($tenantId);
    if (!$tenant) {
      continue;
    }

    $plan = $tenant->getSubscriptionPlan();
    if (!$plan) {
      continue;
    }

    $limits = $plan->getLimits();
    $metrics = $tenantContext->getUsageMetrics($tenant);

    // Verificar l√≠mite de productores
    $maxProductores = $limits['productores'] ?? 0;
    if ($maxProductores > 0) {
      $currentProductores = $metrics['producers_count'] ?? 0;
      $ratio = $currentProductores / $maxProductores;

      if ($ratio >= $alertThreshold100) {
        _ecosistema_jaraba_core_send_usage_alert($tenant, 'producers', 100, $currentProductores, $maxProductores);
      } elseif ($ratio >= $alertThreshold80) {
        _ecosistema_jaraba_core_send_usage_alert($tenant, 'producers', 80, $currentProductores, $maxProductores);
      }
    }

    // Verificar l√≠mite de almacenamiento
    $maxStorageMb = $limits['almacenamiento_mb'] ?? 0;
    if ($maxStorageMb > 0) {
      $currentStorageMb = $metrics['storage_mb'] ?? 0;
      $ratio = $currentStorageMb / $maxStorageMb;

      if ($ratio >= $alertThreshold100) {
        _ecosistema_jaraba_core_send_usage_alert($tenant, 'storage', 100, $currentStorageMb, $maxStorageMb);
      } elseif ($ratio >= $alertThreshold80) {
        _ecosistema_jaraba_core_send_usage_alert($tenant, 'storage', 80, $currentStorageMb, $maxStorageMb);
      }
    }
  }
}

/**
 * Env√≠a alerta de uso al administrador del tenant.
 *
 * @param \Drupal\ecosistema_jaraba_core\Entity\TenantInterface $tenant
 *   El tenant que ha alcanzado el l√≠mite.
 * @param string $limitType
 *   Tipo de l√≠mite: 'producers' o 'storage'.
 * @param int $percentage
 *   Porcentaje alcanzado: 80 o 100.
 * @param int $current
 *   Valor actual.
 * @param int $max
 *   Valor m√°ximo permitido.
 */
function _ecosistema_jaraba_core_send_usage_alert($tenant, $limitType, $percentage, $current, $max) {
  $adminUser = $tenant->getAdminUser();
  if (!$adminUser || !$adminUser->getEmail()) {
    return;
  }

  // Crear clave para evitar spam (solo 1 alerta por tipo/nivel/d√≠a)
  $alertKey = "usage_alert_{$tenant->id()}_{$limitType}_{$percentage}";
  $state = \Drupal::state();
  $lastAlert = $state->get($alertKey, 0);
  $oneDayAgo = time() - 86400;

  if ($lastAlert > $oneDayAgo) {
    // Ya se envi√≥ alerta hoy, no repetir
    return;
  }

  $limitLabels = [
    'producers' => t('productores'),
    'storage' => t('almacenamiento'),
  ];

  $params = [
    'tenant_name' => $tenant->getName(),
    'admin_name' => $adminUser->getDisplayName(),
    'limit_type' => $limitLabels[$limitType] ?? $limitType,
    'percentage' => $percentage,
    'current' => $current,
    'max' => $max,
    'upgrade_url' => \Drupal\Core\Url::fromRoute('ecosistema_jaraba_core.tenant.change_plan', [], ['absolute' => TRUE])->toString(),
  ];

  // Enviar email
  $mailManager = \Drupal::service('plugin.manager.mail');
  $result = $mailManager->mail(
    'ecosistema_jaraba_core',
    'usage_limit_alert',
    $adminUser->getEmail(),
    $adminUser->getPreferredLangcode(),
    $params,
    NULL,
    TRUE
  );

  if ($result['result']) {
    $state->set($alertKey, time());
    \Drupal::logger('ecosistema_jaraba_core')->info(
      'üìä Alerta de uso (@percent%) enviada a @tenant: @type = @current/@max',
      [
        '@percent' => $percentage,
        '@tenant' => $tenant->getName(),
        '@type' => $limitType,
        '@current' => $current,
        '@max' => $max,
      ]
    );
  }
}

/**
 * Implements hook_page_attachments_alter().
 *
 * @deprecated in ecosistema_jaraba_core:1.x. Use
 *   \Drupal\ecosistema_jaraba_core\Hook\PageAttachmentsHooks instead.
 */
#[LegacyHook]
function ecosistema_jaraba_core_page_attachments_alter(array &$attachments) {
  // ---------------------------------------------------------------------------
  // PWA META TAGS Y SERVICE WORKER
  // ---------------------------------------------------------------------------
  
  // Web App Manifest
  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'link',
      '#attributes' => [
        'rel' => 'manifest',
        'href' => '/manifest.webmanifest',
      ],
    ],
    'pwa_manifest',
  ];
  
  // Theme Color
  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'meta',
      '#attributes' => [
        'name' => 'theme-color',
        'content' => '#3b82f6',
      ],
    ],
    'pwa_theme_color',
  ];
  
  // Apple Mobile Web App Capable
  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'meta',
      '#attributes' => [
        'name' => 'apple-mobile-web-app-capable',
        'content' => 'yes',
      ],
    ],
    'pwa_apple_capable',
  ];
  
  // Apple Status Bar Style
  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'meta',
      '#attributes' => [
        'name' => 'apple-mobile-web-app-status-bar-style',
        'content' => 'black-translucent',
      ],
    ],
    'pwa_apple_status_bar',
  ];
  
  // Apple Mobile Web App Title
  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'meta',
      '#attributes' => [
        'name' => 'apple-mobile-web-app-title',
        'content' => 'Jaraba',
      ],
    ],
    'pwa_apple_title',
  ];
  
  // Apple Touch Icon
  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'link',
      '#attributes' => [
        'rel' => 'apple-touch-icon',
        'href' => '/themes/custom/ecosistema_jaraba_theme/images/icons/icon-192x192.png',
      ],
    ],
    'pwa_apple_touch_icon',
  ];
  
  // Service Worker Registration Script
  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'script',
      '#value' => "
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', function() {
            navigator.serviceWorker.register('/service-worker.js')
              .then(function(registration) {
                console.log('[PWA] Service Worker registrado:', registration.scope);
              })
              .catch(function(error) {
                console.log('[PWA] Error al registrar Service Worker:', error);
              });
          });
        }
      ",
    ],
    'pwa_service_worker',
  ];
  
  // ---------------------------------------------------------------------------
  // VISITOR JOURNEY TRACKING (F3 Doc 178)
  // ---------------------------------------------------------------------------
  // Deteccion de vertical del visitante + tracking AIDA del funnel.
  // Solo en paginas frontend (no admin).

  $route_obj = \Drupal::routeMatch()->getRouteObject();
  $is_admin_route = $route_obj && $route_obj->getOption('_admin_route');

  if (!$is_admin_route) {
    $attachments['#attached']['library'][] = 'ecosistema_jaraba_core/visitor-journey';

    // Pass detected vertical from backend to JS for enrichment.
    if (\Drupal::hasService('ecosistema_jaraba_core.avatar_detection')) {
      try {
        $detection = \Drupal::service('ecosistema_jaraba_core.avatar_detection')->detect();
        if ($detection && $detection->vertical) {
          $attachments['#attached']['drupalSettings']['jarabaVertical'] = [
            'detected' => $detection->vertical,
            'source' => $detection->detectionSource,
          ];
        }
      }
      catch (\Exception $e) {
        // Non-blocking: detection failure should not break the page.
      }
    }
  }

  // ---------------------------------------------------------------------------
  // ESTILOS PREMIUM PARA ESTRUCTURA ADMIN
  // ---------------------------------------------------------------------------

  // Obtener el path actual (sin el prefijo de idioma)
  $current_path = \Drupal::service('path.current')->getPath();
  
  // Paths de estructura que necesitan UX Premium
  $premium_paths = [
    '/admin/structure/tenants',
    '/admin/structure/verticales',
    '/admin/structure/features',
    '/admin/structure/ai-agents',
    '/admin/structure/saas-plans',
  ];
  
  $load_premium = FALSE;
  foreach ($premium_paths as $path) {
    if (strpos($current_path, $path) === 0) {
      $load_premium = TRUE;
      break;
    }
  }
  
  // ---------------------------------------------------------------------------
  // FIX PARA PESTA√ëAS ADMIN QUE TRUNCAN TEXTO EN ESPA√ëOL
  // ---------------------------------------------------------------------------
  // Cargar siempre en p√°ginas /admin/content para evitar rotura de tabs
  if (strpos($current_path, '/admin/content') === 0 || strpos($current_path, '/es/admin/content') !== FALSE) {
    $attachments['#attached']['library'][] = 'ecosistema_jaraba_core/admin-tabs-fix';
  }
  
  if ($load_premium) {
    $attachments['#attached']['library'][] = 'ecosistema_jaraba_core/global';
    // CSS simplificado sin min-height que causa gaps
    $attachments['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'style',
        '#value' => '
          /* UX Premium para p√°ginas de estructura - v2 sin gaps */
          body.path-admin {
            background: #0f172a !important;
          }
          
          body.path-admin .layout-container {
            background: #0f172a !important;
          }
          
          body.path-admin .gin-layer-wrapper,
          body.path-admin .region-content,
          body.path-admin main.page-content {
            background: #0f172a !important;
            color: #e2e8f0 !important;
            padding: 1rem 2rem !important;
          }
          
          /* Eliminar gap del header - extender fondo a todo ancho */
          body.path-admin .region-header,
          body.path-admin .layout-container > header,
          body.path-admin .gin-secondary-toolbar,
          body.path-admin .region-sticky,
          body.path-admin .region-breadcrumb {
            background: #0f172a !important;
            margin: 0 !important;
            padding-left: 1rem !important;
            padding-right: 1rem !important;
          }
          
          /* Contenedor a ancho completo */
          body.path-admin .layout-container,
          body.path-admin .gin-layer-wrapper {
            margin: 0 !important;
            padding: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
            background: #0f172a !important;
          }
          
          body.path-admin .region-content {
            background: #0f172a !important;
            color: #e2e8f0 !important;
            padding: 1rem 2rem !important;
            margin: 0 !important;
          }
          
          /* Breadcrumb con margen izquierdo */
          body.path-admin .breadcrumb,
          body.path-admin .gin-breadcrumb-wrapper {
            padding-left: 1rem !important;
            background: #0f172a !important;
          }
          
          /* T√≠tulo con estilo gradient y margen izquierdo */
          body.path-admin h1.page-title,
          body.path-admin .block-page-title-block h1 {
            color: #e2e8f0 !important;
            background: linear-gradient(135deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem !important;
            margin-top: 0 !important;
            margin-left: 2rem !important;
            padding-left: 0 !important;
            font-size: 1.75rem;
          }
          
          /* Contenedor t√≠tulo con padding */
          body.path-admin .block-page-title-block {
            padding-left: 0 !important;
          }
          
          /* Bloques sin m√°rgenes extra */
          body.path-admin .block-page-title-block,
          body.path-admin .block-local-tasks-block,
          body.path-admin .block-local-actions-block,
          body.path-admin .region-content > *,
          body.path-admin .view-content,
          body.path-admin .views-element-container {
            margin-top: 0 !important;
            margin-bottom: 0.75rem !important;
          }
          
          body.path-admin table {
            background: rgba(30, 41, 59, 0.8) !important;
            border: 1px solid rgba(238, 238, 238, 0.3) !important;
            border-radius: 12px !important;
            overflow: hidden;
            border-collapse: separate !important;
            margin-top: 1rem !important;
          }
          
          body.path-admin table thead tr {
            background: rgba(30, 41, 59, 0.95) !important;
          }
          
          body.path-admin table thead th {
            background: rgba(30, 41, 59, 0.95) !important;
            color: #94a3b8 !important;
            border-bottom: 1px solid rgba(238, 238, 238, 0.3) !important;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 1rem !important;
          }
          
          body.path-admin table tbody tr {
            background: rgba(30, 41, 59, 0.6) !important;
          }
          
          body.path-admin table tbody td {
            color: #e2e8f0 !important;
            border-bottom: 1px solid rgba(148, 163, 184, 0.15) !important;
            background: rgba(30, 41, 59, 0.6) !important;
            padding: 0.875rem 1rem !important;
          }
          
          body.path-admin table tbody tr:hover td {
            background: rgba(30, 41, 59, 0.9) !important;
          }
          
          /* Botones sin subrayado y con estilo premium */
          body.path-admin .action-links a,
          body.path-admin a.button--primary,
          body.path-admin .button--primary,
          body.path-admin .btn.btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: white !important;
            border-radius: 8px !important;
            padding: 0.75rem 1.5rem !important;
            border: none !important;
            text-decoration: none !important;
            display: inline-block;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
          }
          
          body.path-admin .action-links a:hover,
          body.path-admin a.button--primary:hover,
          body.path-admin .btn.btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8) !important;
            transform: translateY(-1px);
            text-decoration: none !important;
          }
          
          /* Todos los botones con esquinas redondeadas */
          body.path-admin .button,
          body.path-admin button.button,
          body.path-admin a.button,
          body.path-admin input[type="submit"],
          body.path-admin .form-actions .button {
            border-radius: 8px !important;
            padding: 0.75rem 1.5rem !important;
            font-weight: 500 !important;
            text-decoration: none !important;
            border: none !important;
          }
          
          /* Bot√≥n Eliminar - fondo transparente con borde rojo */
          body.path-admin .button--danger,
          body.path-admin a.button--danger,
          body.path-admin .button--delete,
          body.path-admin a.button--delete,
          body.path-admin input.button--danger,
          body.path-admin button.button--danger,
          body.path-admin .form-actions a[href*="delete"] {
            background: transparent !important;
            color: #ef4444 !important;
            border: 2px solid #ef4444 !important;
            border-radius: 8px !important;
          }
          
          body.path-admin .button--danger:hover,
          body.path-admin a.button--danger:hover,
          body.path-admin .button--delete:hover,
          body.path-admin a.button--delete:hover,
          body.path-admin .form-actions a[href*="delete"]:hover {
            background: rgba(239, 68, 68, 0.1) !important;
            transform: translateY(-1px);
          }
          
          /* Links sin subrayado en botones */
          body.path-admin a.btn,
          body.path-admin .premium-header__actions a {
            text-decoration: none !important;
          }
          
          body.path-admin a:not(.button):not(.btn) {
            color: #60a5fa;
          }
          
          body.path-admin .dropbutton-wrapper .dropbutton-widget {
            background: rgba(30, 41, 59, 0.95) !important;
            border: 1px solid rgba(238, 238, 238, 0.3) !important;
            border-radius: 8px !important;
          }
          
          body.path-admin .dropbutton-wrapper .dropbutton-widget button,
          body.path-admin .dropbutton-wrapper .dropbutton-widget a {
            color: #e2e8f0 !important;
            background: transparent !important;
            text-decoration: none !important;
          }
          
          body.path-admin .dropbutton-wrapper .dropbutton-widget a:hover {
            background: rgba(96, 165, 250, 0.2) !important;
          }
          
          /* Dropbutton - mantener estilos originales de Gin */
          
          /* Panel dropdown con fondo s√≥lido oscuro */
          body.path-admin .dropbutton-wrapper .secondary-action {
            background: #1e293b !important;
            border: 1px solid rgba(238, 238, 238, 0.3) !important;
          }
          
          body.path-admin .dropbutton-wrapper .secondary-action a {
            background: #1e293b !important;
            color: #e2e8f0 !important;
            padding: 0.5rem 1rem !important;
          }
          
          body.path-admin .dropbutton-wrapper .secondary-action a:hover {
            background: #334155 !important;
          }
          
          /* Dropdown menu lista completa */
          body.path-admin .dropbutton .dropbutton-widget ul {
            background: #1e293b !important;
            border: 1px solid rgba(238, 238, 238, 0.3) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
          }
          
          body.path-admin .dropbutton .dropbutton-widget ul li {
            background: #1e293b !important;
          }
          
          body.path-admin .dropbutton .dropbutton-widget ul li a {
            background: #1e293b !important;
            color: #e2e8f0 !important;
            padding: 0.5rem 1rem !important;
          }
          
          body.path-admin .dropbutton .dropbutton-widget ul li a:hover {
            background: #334155 !important;
          }
          
          body.path-admin .messages {
            border-radius: 8px;
            margin-bottom: 1rem;
          }
          
          body.path-admin .breadcrumb ol li a {
            color: #94a3b8 !important;
            text-decoration: none !important;
          }
          
          body.path-admin .breadcrumb ol li a:hover {
            color: #60a5fa !important;
          }
          
          /* Tabs locales */
          body.path-admin .tabs--primary {
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            margin-bottom: 1rem;
          }
          
          body.path-admin .tabs--primary a {
            color: #94a3b8 !important;
            text-decoration: none !important;
          }
          
          body.path-admin .tabs--primary a.is-active {
            color: #60a5fa !important;
            border-bottom: 2px solid #60a5fa;
          }
        ',
      ],
      'ecosistema_jaraba_premium_structure_styles',
    ];
  }
}

/**
 * Implements hook_cron().
 *
 * Ejecuta tareas operacionales peri√≥dicas del SaaS:
 * - Health checks autom√°ticos (cada hora)
 * - Verificaci√≥n de costes IA (cada hora)
 * - Verificaci√≥n de trials expirando (cada 6h)
 * - Verificaci√≥n de suscripciones pendientes (cada 6h)
 * - Verificaci√≥n de l√≠mites de uso por tenant (cada 6h)
 */
function _ecosistema_jaraba_core_cron_extended() {
  $state = \Drupal::state();

  // -------------------------------------------------------------------------
  // HEALTH CHECK PERI√ìDICO (cada hora)
  // -------------------------------------------------------------------------
  $lastHealthCheck = $state->get('health_check_cron_last', 0);
  if (time() - $lastHealthCheck >= 3600) {
    _ecosistema_jaraba_core_cron_health_check();
    $state->set('health_check_cron_last', time());
  }

  // -------------------------------------------------------------------------
  // VERIFICACI√ìN COSTES IA (cada hora)
  // -------------------------------------------------------------------------
  _ecosistema_jaraba_core_check_ai_costs();

  // -------------------------------------------------------------------------
  // TAREAS CADA 6 HORAS
  // -------------------------------------------------------------------------
  $lastSixHourCheck = $state->get('six_hour_check_last', 0);
  if (time() - $lastSixHourCheck >= 21600) {
    _ecosistema_jaraba_core_check_expiring_trials();
    _ecosistema_jaraba_core_check_past_due_subscriptions();
    _ecosistema_jaraba_core_check_usage_limits();
    $state->set('six_hour_check_last', time());
  }
}

/**
 * Ejecuta health check peri√≥dico desde cron y alerta si hay degradaci√≥n.
 *
 * Utiliza el HealthCheckController para verificar: DB, filesystem, cache, Qdrant.
 * Loguea resultados en health_check_log y env√≠a email si status != 'ok'.
 *
 * @internal
 */
function _ecosistema_jaraba_core_cron_health_check() {
  $logger = \Drupal::logger('ecosistema_jaraba_core');

  try {
    // Ejecutar los mismos checks que el endpoint /health.
    $components = [];
    $healthy = TRUE;

    // Check Database.
    try {
      $start = microtime(TRUE);
      \Drupal::database()->query('SELECT 1')->fetchField();
      $latency = round((microtime(TRUE) - $start) * 1000, 2);
      $components['database'] = ['status' => 'ok', 'latency_ms' => $latency];
    }
    catch (\Exception $e) {
      $components['database'] = ['status' => 'error'];
      $healthy = FALSE;
    }

    // Check Filesystem.
    try {
      $fileSystem = \Drupal::service('file_system');
      $tempFile = $fileSystem->getTempDirectory() . '/health_cron_' . time();
      file_put_contents($tempFile, 'ok');
      $content = file_get_contents($tempFile);
      @unlink($tempFile);
      $components['filesystem'] = ['status' => ($content === 'ok') ? 'ok' : 'error'];
      if ($content !== 'ok') {
        $healthy = FALSE;
      }
    }
    catch (\Exception $e) {
      $components['filesystem'] = ['status' => 'error'];
      $healthy = FALSE;
    }

    // Check Cache.
    try {
      $cache = \Drupal::cache();
      $testKey = 'health_cron_' . time();
      $cache->set($testKey, 'ok', time() + 60);
      $item = $cache->get($testKey);
      $cache->delete($testKey);
      $components['cache'] = ['status' => ($item && $item->data === 'ok') ? 'ok' : 'warning'];
    }
    catch (\Exception $e) {
      $components['cache'] = ['status' => 'warning'];
    }

    $status = $healthy ? 'ok' : 'degraded';

    // Loguear en health_check_log (si existe la tabla).
    try {
      $connection = \Drupal::database();
      if ($connection->schema()->tableExists('health_check_log')) {
        foreach ($components as $service => $data) {
          $connection->insert('health_check_log')
            ->fields([
              'timestamp' => time(),
              'service' => $service,
              'status' => $data['status'],
              'latency' => $data['latency_ms'] ?? NULL,
              'message' => 'Cron health check',
              'overall_health' => $healthy ? 100 : 50,
            ])
            ->execute();
        }
      }
    }
    catch (\Exception $e) {
      // No fallar por errores en logging.
    }

    // Alertar si hay degradaci√≥n.
    if (!$healthy) {
      $state = \Drupal::state();
      $lastAlert = $state->get('health_cron_last_alert', 0);

      // Throttle: m√°ximo 1 alerta cada 30 minutos.
      if (time() - $lastAlert >= 1800) {
        $failedServices = array_keys(array_filter(
          $components,
          fn($c) => $c['status'] !== 'ok'
        ));

        $logger->error('üî¥ Health check degraded via cron. Failed: @services', [
          '@services' => implode(', ', $failedServices),
        ]);

        // Enviar email al admin del sitio.
        $adminEmail = \Drupal::config('system.site')->get('mail');
        if ($adminEmail) {
          $mailManager = \Drupal::service('plugin.manager.mail');
          $mailManager->mail(
            'ecosistema_jaraba_core',
            'health_alert',
            $adminEmail,
            'es',
            [
              'status' => $status,
              'failed_services' => $failedServices,
              'timestamp' => date('Y-m-d H:i:s'),
            ]
          );
        }

        $state->set('health_cron_last_alert', time());
      }
    }
    else {
      $logger->info('‚úÖ Cron health check: all services ok (DB @latency ms)', [
        '@latency' => $components['database']['latency_ms'] ?? '?',
      ]);
    }
  }
  catch (\Exception $e) {
    $logger->error('Cron health check failed: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for user_register_form.
 *
 * USR-003: A√±ade submit handler para mostrar un mensaje de confirmaci√≥n
 * premium post-registro con instrucciones del proceso de verificaci√≥n.
 */
function ecosistema_jaraba_core_form_user_register_form_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state): void {
  // A√±adir nuestro submit handler DESPU√âS de los default de Drupal.
  $form['actions']['submit']['#submit'][] = '_ecosistema_jaraba_core_register_message_submit';
}

/**
 * Submit handler: muestra mensaje de confirmaci√≥n post-registro.
 *
 * Reemplaza el mensaje gen√©rico de Drupal con uno branded que explica
 * los pasos del proceso de creaci√≥n de la cuenta.
 */
function _ecosistema_jaraba_core_register_message_submit(array &$form, \Drupal\Core\Form\FormStateInterface $form_state): void {
  $messenger = \Drupal::messenger();

  // Eliminar mensajes gen√©ricos de Drupal para reemplazarlos.
  $messenger->deleteByType('status');

  // Obtener el email del formulario para mostrarlo en el mensaje.
  $email = $form_state->getValue('mail') ?? '';

  // Construir mensaje HTML premium.
  $message = '<div style="max-width: 540px;">';
  $message .= '<h3 style="margin: 0 0 12px 0; font-size: 18px; font-weight: 700; color: #1A1A2E;">üì¨ ¬°Solicitud de cuenta recibida!</h3>';
  $message .= '<p style="margin: 0 0 16px 0; font-size: 15px; color: #334155; line-height: 1.5;">';
  $message .= 'Hemos enviado un correo de verificaci√≥n a <strong style="color: #233D63;">' . \Drupal\Component\Utility\Html::escape($email) . '</strong>. ';
  $message .= 'Sigue estos pasos para activar tu cuenta:</p>';
  $message .= '<div style="background: #F8FAFC; border-radius: 12px; padding: 16px 20px; margin-bottom: 16px;">';
  $message .= '<div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">';
  $message .= '<span style="display: inline-flex; align-items: center; justify-content: center; min-width: 28px; height: 28px; background: linear-gradient(135deg, #FF8C42, #FF6B1A); border-radius: 8px; color: #fff; font-weight: 700; font-size: 13px;">1</span>';
  $message .= '<span style="font-size: 14px; color: #334155; line-height: 1.5;">Abre tu bandeja de correo electr√≥nico</span>';
  $message .= '</div>';
  $message .= '<div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">';
  $message .= '<span style="display: inline-flex; align-items: center; justify-content: center; min-width: 28px; height: 28px; background: linear-gradient(135deg, #FF8C42, #FF6B1A); border-radius: 8px; color: #fff; font-weight: 700; font-size: 13px;">2</span>';
  $message .= '<span style="font-size: 14px; color: #334155; line-height: 1.5;">Busca el correo de <strong>Jaraba</strong> (revisa spam si no lo encuentras)</span>';
  $message .= '</div>';
  $message .= '<div style="display: flex; align-items: flex-start; gap: 12px;">';
  $message .= '<span style="display: inline-flex; align-items: center; justify-content: center; min-width: 28px; height: 28px; background: linear-gradient(135deg, #FF8C42, #FF6B1A); border-radius: 8px; color: #fff; font-weight: 700; font-size: 13px;">3</span>';
  $message .= '<span style="font-size: 14px; color: #334155; line-height: 1.5;">Haz clic en el enlace de verificaci√≥n para activar tu cuenta</span>';
  $message .= '</div>';
  $message .= '</div>';
  $message .= '<p style="margin: 0; font-size: 13px; color: #64748B;">El enlace de verificaci√≥n es v√°lido por 24 horas. Si no recibes el correo, <a href="/es/user/login" style="color: #FF8C42; text-decoration: underline;">contacta con nuestro equipo</a>.</p>';
  $message .= '</div>';

  $messenger->addStatus(\Drupal\Core\Render\Markup::create($message));

  // Redirigir a la p√°gina de login para que el mensaje se muestre
  // en el template de auth (que ahora renderiza clean_messages).
  // Drupal por defecto redirige a <front> donde el mensaje podr√≠a perderse.
  $form_state->setRedirect('user.login');
}

/**
 * Implements hook_user_insert().
 *
 * USR-001: Flujo post-registro con deteccion de avatar y vinculacion
 * de diagnostico previo. Implementa la automatizacion ECA de registro.
 *
 * Acciones:
 * 1. Crear JourneyState con avatar=pending, state=discovery
 * 2. Detectar vertical via AvatarDetectionService
 * 3. Vincular diagnostico si ?diagnostic=UUID en query
 * 4. Encolar webhook ActiveCampaign
 *
 * SPEC: 20260120a Fases 1-2
 */
function ecosistema_jaraba_core_user_insert(\Drupal\user\UserInterface $account): void {
  $logger = \Drupal::logger('ecosistema_jaraba_core');

  try {
    // 1. Detectar avatar del nuevo usuario.
    $avatarType = 'pending';
    $vertical = NULL;
    $detectionSource = 'default';

    if (\Drupal::hasService('ecosistema_jaraba_core.avatar_detection')) {
      $detection = \Drupal::service('ecosistema_jaraba_core.avatar_detection')->detect();
      if ($detection->isDetected()) {
        $avatarType = $detection->avatarType;
        $vertical = $detection->vertical;
        $detectionSource = $detection->detectionSource;
      }
    }

    // 2. Crear JourneyState si el modulo jaraba_journey existe.
    if (\Drupal::moduleHandler()->moduleExists('jaraba_journey')) {
      try {
        $journeyStorage = \Drupal::entityTypeManager()->getStorage('journey_state');
        $journeyState = $journeyStorage->create([
          'user_id' => $account->id(),
          'avatar' => $avatarType,
          'state' => 'discovery',
          'vertical' => $vertical,
          'detection_source' => $detectionSource,
        ]);
        $journeyState->save();
      }
      catch (\Exception $e) {
        $logger->warning('No se pudo crear JourneyState para usuario @uid: @error', [
          '@uid' => $account->id(),
          '@error' => $e->getMessage(),
        ]);
      }
    }

    // 3. Vincular diagnostico previo si ?diagnostic=UUID viene en la URL.
    $request = \Drupal::requestStack()->getCurrentRequest();
    if ($request) {
      $diagnosticUuid = $request->query->get('diagnostic');
      if ($diagnosticUuid && \Drupal::moduleHandler()->moduleExists('jaraba_diagnostic')) {
        try {
          $diagnostics = \Drupal::entityTypeManager()
            ->getStorage('employability_diagnostic')
            ->loadByProperties(['uuid' => $diagnosticUuid]);

          if (!empty($diagnostics)) {
            $diagnostic = reset($diagnostics);
            // Vincular el diagnostico anonimo al nuevo usuario.
            if (!$diagnostic->getOwnerId() || $diagnostic->getOwnerId() === 0) {
              $diagnostic->setOwnerId((int) $account->id());
              $diagnostic->set('avatar_confirmed', 'jobseeker');
              $diagnostic->save();

              $logger->info('Diagnostico @uuid vinculado a usuario @uid', [
                '@uuid' => $diagnosticUuid,
                '@uid' => $account->id(),
              ]);
            }
          }
        }
        catch (\Exception $e) {
          $logger->warning('Error vinculando diagnostico: @error', [
            '@error' => $e->getMessage(),
          ]);
        }
      }
    }

    // 4. [REMOVED] ActiveCampaign webhook ‚Äî descartado del SaaS.

    $logger->info('USR-001: Usuario @uid registrado. Avatar: @avatar, Vertical: @vertical, Source: @source', [
      '@uid' => $account->id(),
      '@avatar' => $avatarType,
      '@vertical' => $vertical ?? 'none',
      '@source' => $detectionSource,
    ]);
  }
  catch (\Exception $e) {
    $logger->error('Error en hook_user_insert: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_user_login().
 *
 * Detecta primer login post-registro y:
 * 1. Redirige al dashboard contextual seg√∫n avatar detectado.
 * 2. Env√≠a email de bienvenida con ventajas del SaaS.
 */
function ecosistema_jaraba_core_user_login(\Drupal\user\UserInterface $account): void {
  // Solo actuar en primer login (post-registro).
  // getLastAccessedTime() === 0 indica que nunca ha accedido antes.
  if ($account->getLastAccessedTime() > 0) {
    return;
  }

  $logger = \Drupal::logger('ecosistema_jaraba_core');

  try {
    // 1. Detectar avatar para redirecci√≥n contextual.
    $avatarType = 'pending';
    if (\Drupal::hasService('ecosistema_jaraba_core.avatar_detection')) {
      $detection = \Drupal::service('ecosistema_jaraba_core.avatar_detection')->detect();
      if ($detection->isDetected()) {
        $avatarType = $detection->avatarType;
      }
    }

    // 2. Redirecci√≥n por avatar ‚Äî SOLO si NO viene del enlace de uso √∫nico.
    // Durante el reset, Drupal debe llevar al usuario a /user/{uid}/edit
    // para que establezca su contrase√±a. Tras guardarla, el form_alter
    // (ver ecosistema_jaraba_core_form_user_form_alter) lo redirige.
    $route = \Drupal::routeMatch()->getRouteName();
    $isPasswordReset = ($route === 'user.reset.login' || $route === 'user.reset.form');

    if (!$isPasswordReset) {
      $redirectMap = [
        'jobseeker' => '/empleabilidad',
        'entrepreneur' => '/diagnostic-wizard',
        'farmer' => '/agro-dashboard',
        'merchant' => '/comercio-dashboard',
      ];
      $destination = $redirectMap[$avatarType] ?? '/empleabilidad';

      $request = \Drupal::requestStack()->getCurrentRequest();
      if ($request && !$request->query->has('destination')) {
        $request->query->set('destination', $destination);
      }
    }

    // 3. Enviar email de bienvenida SIEMPRE en primer login.
    $mailManager = \Drupal::service('plugin.manager.mail');
    $displayName = $account->getDisplayName() ?: $account->getAccountName();
    $params = [
      'account' => $account,
      'avatar' => $avatarType,
      'display_name' => $displayName,
    ];
    $langcode = $account->getPreferredLangcode();
    $mailManager->mail('ecosistema_jaraba_core', 'user_welcome', $account->getEmail(), $langcode, $params);

    $logger->info('USR-002: Primer login usuario @uid. Avatar: @avatar. Reset: @reset. Welcome email enviado.', [
      '@uid' => $account->id(),
      '@avatar' => $avatarType,
      '@reset' => $isPasswordReset ? 's√≠' : 'no',
    ]);
  }
  catch (\Exception $e) {
    $logger->error('Error en hook_user_login para primer login: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}

// Helper functions for world-class HTML emails are below.

/**
 * Returns avatar-specific email configuration.
 *
 * @param string $avatarType
 *   The detected avatar type.
 *
 * @return array
 *   Configuration array with keys: label, subject_suffix, cta_text,
 *   cta_url, accent_color, benefits.
 */
function _ecosistema_jaraba_core_get_avatar_email_config(string $avatarType): array {
  $configs = [
    'jobseeker' => [
      'label' => 'Buscador de Empleo',
      'subject_suffix' => 'Tu carrera profesional empieza aqu√≠',
      'cta_text' => 'Ir a mi Panel de Empleo ‚Üí',
      'cta_url' => '/empleabilidad',
      'accent_color' => '#00A9A5',
      'benefits' => [
        ['icon' => 'üìÑ', 'title' => 'CV Inteligente con IA', 'desc' => 'Genera un CV ATS-ready optimizado para las ofertas que te interesan.'],
        ['icon' => 'üéØ', 'title' => 'Matching Autom√°tico', 'desc' => 'Conectamos tu perfil con ofertas de empleo alineadas a tus competencias.'],
        ['icon' => 'üéì', 'title' => 'Cursos Certificados', 'desc' => 'Accede a formaci√≥n gratuita para cerrar brechas de empleabilidad.'],
      ],
    ],
    'entrepreneur' => [
      'label' => 'Emprendedor/a',
      'subject_suffix' => 'Tu negocio merece crecer',
      'cta_text' => 'Comenzar mi Diagn√≥stico ‚Üí',
      'cta_url' => '/diagnostic-wizard',
      'accent_color' => '#FF8C42',
      'benefits' => [
        ['icon' => 'üîç', 'title' => 'Diagn√≥stico Empresarial IA', 'desc' => 'Identifica fortalezas y √°reas de mejora de tu negocio en minutos.'],
        ['icon' => 'üìã', 'title' => 'Plan de Acci√≥n Personalizado', 'desc' => 'Recibe recomendaciones concretas para escalar tu emprendimiento.'],
        ['icon' => 'ü§ù', 'title' => 'Red de Mentores', 'desc' => 'Conecta con expertos que te guiar√°n en tu proceso de crecimiento.'],
      ],
    ],
    'farmer' => [
      'label' => 'Agricultor/a',
      'subject_suffix' => 'Tu campo conectado al mercado',
      'cta_text' => 'Ir a AgroConecta ‚Üí',
      'cta_url' => '/agro-dashboard',
      'accent_color' => '#556B2F',
      'benefits' => [
        ['icon' => 'üìä', 'title' => 'Precios del Mercado en Tiempo Real', 'desc' => 'Consulta precios actualizados para tomar mejores decisiones de venta.'],
        ['icon' => 'üå§Ô∏è', 'title' => 'Alertas Clim√°ticas', 'desc' => 'Recibe pron√≥sticos y alertas para proteger tus cultivos.'],
        ['icon' => 'üõí', 'title' => 'Conexi√≥n Directa con Compradores', 'desc' => 'Vende tus productos sin intermediarios a trav√©s de AgroConecta.'],
      ],
    ],
    'merchant' => [
      'label' => 'Comerciante',
      'subject_suffix' => 'Digitaliza tu negocio hoy',
      'cta_text' => 'Ir a mi Tienda ‚Üí',
      'cta_url' => '/comercio-dashboard',
      'accent_color' => '#FF8C42',
      'benefits' => [
        ['icon' => 'üè™', 'title' => 'Tienda Online en Minutos', 'desc' => 'Publica tus productos y empieza a vender en l√≠nea de inmediato.'],
        ['icon' => 'üßæ', 'title' => 'Facturaci√≥n Electr√≥nica', 'desc' => 'Genera facturas legales autom√°ticas con cada venta.'],
        ['icon' => 'üì¶', 'title' => 'Gesti√≥n de Inventario', 'desc' => 'Controla tu stock y recibe alertas cuando sea necesario reabastecer.'],
      ],
    ],
  ];

  return $configs[$avatarType] ?? [
    'label' => 'Usuario/a',
    'subject_suffix' => 'Tu ecosistema de impacto te espera',
    'cta_text' => 'Explorar la Plataforma ‚Üí',
    'cta_url' => '/empleabilidad',
    'accent_color' => '#00A9A5',
    'benefits' => [
      ['icon' => '‚ú®', 'title' => 'Empleabilidad', 'desc' => 'CV inteligente, matching de empleo y cursos para tu carrera profesional.'],
      ['icon' => 'üöÄ', 'title' => 'Emprendimiento', 'desc' => 'Diagn√≥stico empresarial, planes de acci√≥n y red de mentores expertos.'],
      ['icon' => 'üå±', 'title' => 'AgroConecta', 'desc' => 'Precios de mercado, alertas clim√°ticas y venta directa para el campo.'],
      ['icon' => 'üè™', 'title' => 'ComercioConecta', 'desc' => 'Digitaliza tu tienda local. Cat√°logo online, gesti√≥n de pedidos y pagos integrados.'],
      ['icon' => 'üîß', 'title' => 'ServiciosConecta', 'desc' => 'Gestiona citas y clientes. Agenda online, facturaci√≥n y fidelizaci√≥n para profesionales.'],
      ['icon' => '‚öñÔ∏è', 'title' => 'JarabaLex', 'desc' => 'Para abogados, gestores y asesores. Gesti√≥n de expedientes, plazos y copiloto jur√≠dico IA.'],
    ],
  ];
}

/**
 * Builds the HTML body for the welcome email.
 *
 * Uses table-based layout with inline styles for maximum email client
 * compatibility (Gmail, Outlook, Apple Mail, Yahoo).
 *
 * @param string $displayName
 *   The user display name.
 * @param array $config
 *   Avatar-specific email config from _get_avatar_email_config().
 * @param string $ctaUrl
 *   Full absolute URL for the CTA button.
 * @param string $email
 *   User's email address.
 *
 * @return string
 *   Complete HTML string for the email body.
 */
function _ecosistema_jaraba_core_build_welcome_email_html(
  string $displayName,
  array $config,
  string $ctaUrl,
  string $email
): string {
  // Escape user-provided values to prevent XSS in HTML email.
  $displayName = \Drupal\Component\Utility\Html::escape($displayName);
  $email = \Drupal\Component\Utility\Html::escape($email);
  $accentColor = $config['accent_color'];
  $benefitsHtml = '';

  foreach ($config['benefits'] as $benefit) {
    $benefitsHtml .= <<<BENEFIT
    <tr>
      <td style="padding: 0 0 16px 0;">
        <table width="100%" cellpadding="0" cellspacing="0" role="presentation" style="background-color: #F8FAFC; border-radius: 12px; border-left: 4px solid {$accentColor};">
          <tr>
            <td style="padding: 20px 24px;">
              <table width="100%" cellpadding="0" cellspacing="0" role="presentation">
                <tr>
                  <td width="48" style="vertical-align: top; padding-right: 16px;">
                    <div style="font-size: 28px; line-height: 1; width: 44px; height: 44px; background-color: #FFFFFF; border-radius: 10px; text-align: center; padding-top: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">{$benefit['icon']}</div>
                  </td>
                  <td style="vertical-align: top;">
                    <p style="margin: 0 0 4px 0; font-family: 'Outfit', 'Segoe UI', Arial, sans-serif; font-size: 16px; font-weight: 600; color: #1A1A2E; line-height: 1.3;">{$benefit['title']}</p>
                    <p style="margin: 0; font-family: 'Outfit', 'Segoe UI', Arial, sans-serif; font-size: 14px; color: #64748B; line-height: 1.5;">{$benefit['desc']}</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </td>
    </tr>
BENEFIT;
  }

  // CTA button color from theme config.
  $themeSettings = \Drupal::config('ecosistema_jaraba_theme.settings');
  $colorPrimary = $themeSettings->get('color_primary') ?? '#FF8C42';

  // Translatable strings.
  $t = \Drupal::translation();
  $greeting = $t->translate('¬°Bienvenido/a, @name!', ['@name' => $displayName]);
  $accountReady = $t->translate('Tu cuenta como <strong style="color: @color;">@label</strong> est√° lista. Esto es lo que puedes hacer ahora:', ['@color' => $accentColor, '@label' => $config['label']]);

  // Body content only ‚Äî header, footer and wrapper are provided by email-wrap.html.twig.
  return <<<HTML
<!-- Greeting -->
<h1 style="margin: 0 0 8px 0; font-family: 'Outfit', 'Segoe UI', Arial, sans-serif; font-size: 28px; font-weight: 700; color: #1A1A2E; line-height: 1.2;">{$greeting}</h1>
<p style="margin: 0 0 32px 0; font-family: 'Outfit', 'Segoe UI', Arial, sans-serif; font-size: 16px; color: #64748B; line-height: 1.5;">
  {$accountReady}
</p>

<!-- Benefits -->
<table width="100%" cellpadding="0" cellspacing="0" role="presentation">
  {$benefitsHtml}
</table>

<!-- CTA Button -->
<table width="100%" cellpadding="0" cellspacing="0" role="presentation" style="padding-top: 16px;">
  <tr>
    <td style="text-align: center; padding: 8px 0;">
      <table cellpadding="0" cellspacing="0" role="presentation" style="margin: 0 auto;">
        <tr>
          <td style="background: linear-gradient(135deg, {$colorPrimary} 0%, #FF6B1A 100%); border-radius: 12px; box-shadow: 0 4px 16px rgba(255,140,66,0.35);">
            <a href="{$ctaUrl}" target="_blank" style="display: inline-block; padding: 16px 48px; font-family: 'Outfit', 'Segoe UI', Arial, sans-serif; font-size: 16px; font-weight: 600; color: #FFFFFF; text-decoration: none; letter-spacing: 0.3px;">{$config['cta_text']}</a>
          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
HTML;
}

// ===========================================================================
// F2: FIRST SALE UPGRADE TRIGGER (Doc 183)
// ===========================================================================

/**
 * Implements hook_entity_update().
 *
 * Detects when a tenant's first successful order happens (Commerce order
 * transitions to 'completed') and fires the 'first_sale' upgrade trigger
 * via UpgradeTriggerService.
 *
 * Key guards:
 * - Only fires if Commerce module is installed.
 * - Only fires for commerce_order entities transitioning to 'completed'.
 * - Only fires once per tenant (checks existing completed orders count).
 *
 * F2 ‚Äî Doc 183 ¬ß4: first_sale trigger (42% expected conversion).
 */
function ecosistema_jaraba_core_entity_update(\Drupal\Core\Entity\EntityInterface $entity) {
  // Guard: Only process commerce_order entities.
  if ($entity->getEntityTypeId() !== 'commerce_order') {
    return;
  }

  // Guard: Commerce module must be installed.
  if (!\Drupal::moduleHandler()->moduleExists('commerce_order')) {
    return;
  }

  // Guard: Order must have just transitioned to 'completed'.
  $newState = NULL;
  if ($entity->hasField('state')) {
    $newState = $entity->get('state')->value ?? NULL;
  }

  if ($newState !== 'completed') {
    return;
  }

  // Check original state to confirm a transition happened.
  if (isset($entity->original) && $entity->original->hasField('state')) {
    $oldState = $entity->original->get('state')->value ?? NULL;
    if ($oldState === 'completed') {
      // Already was completed, not a transition.
      return;
    }
  }

  // Resolve the tenant for this order.
  $tenant = NULL;
  try {
    // Try to get tenant from the order's store owner or tenant field.
    if ($entity->hasField('field_tenant')) {
      $tenantRef = $entity->get('field_tenant')->entity;
      if ($tenantRef) {
        $tenant = $tenantRef;
      }
    }

    // Fallback: resolve tenant from the store's owner via TenantContextService.
    if (!$tenant && \Drupal::hasService('ecosistema_jaraba_core.tenant_context')) {
      $store = $entity->getStore();
      if ($store) {
        $storeOwner = $store->getOwner();
        if ($storeOwner) {
          // @todo CONS-N10: Move to service class for proper DI.
          $tenantContext = \Drupal::service('ecosistema_jaraba_core.tenant_context');
          $tenant = $tenantContext->getTenantForUser($storeOwner);
        }
      }
    }
  }
  catch (\Exception $e) {
    // Non-blocking: if we cannot resolve tenant, skip silently.
    \Drupal::logger('ecosistema_jaraba_core')->warning(
      'F2 first_sale: Could not resolve tenant for order @order: @error',
      [
        '@order' => $entity->id(),
        '@error' => $e->getMessage(),
      ]
    );
    return;
  }

  if (!$tenant) {
    return;
  }

  // Guard: Only fire if this is the FIRST completed order for this tenant.
  try {
    $tenantId = $tenant->id();

    // Check for other completed orders belonging to this tenant.
    $existingCompletedCount = 0;

    // Query completed orders for the same store(s).
    if ($entity->hasField('field_tenant')) {
      $existingCompletedCount = (int) \Drupal::entityTypeManager()
        ->getStorage('commerce_order')
        ->getQuery()
        ->accessCheck(FALSE)
        ->condition('state', 'completed')
        ->condition('field_tenant', $tenantId)
        ->condition('order_id', $entity->id(), '<>')
        ->count()
        ->execute();
    }
    else {
      // Fallback: count by store.
      $store = $entity->getStore();
      if ($store) {
        $existingCompletedCount = (int) \Drupal::entityTypeManager()
          ->getStorage('commerce_order')
          ->getQuery()
          ->accessCheck(FALSE)
          ->condition('state', 'completed')
          ->condition('store_id', $store->id())
          ->condition('order_id', $entity->id(), '<>')
          ->count()
          ->execute();
      }
    }

    if ($existingCompletedCount > 0) {
      // Not the first sale, skip.
      return;
    }

    // Fire the first_sale upgrade trigger.
    if (\Drupal::hasService('ecosistema_jaraba_core.upgrade_trigger')) {
      /** @var \Drupal\ecosistema_jaraba_core\Service\UpgradeTriggerService $upgradeTriggerService */
      $upgradeTriggerService = \Drupal::service('ecosistema_jaraba_core.upgrade_trigger');
      $upgradeTriggerService->fire('first_sale', $tenant, [
        'order_id' => (string) $entity->id(),
        'order_total' => $entity->hasField('total_price') ? ($entity->get('total_price')->number ?? '0') : '0',
      ]);

      \Drupal::logger('ecosistema_jaraba_core')->info(
        'F2 first_sale: Fired upgrade trigger for tenant @tenant (order @order)',
        [
          '@tenant' => $tenantId,
          '@order' => $entity->id(),
        ]
      );
    }
  }
  catch (\Exception $e) {
    // Non-blocking: trigger failure should not break order processing.
    \Drupal::logger('ecosistema_jaraba_core')->warning(
      'F2 first_sale: Error firing trigger for tenant @tenant: @error',
      [
        '@tenant' => $tenant->id(),
        '@error' => $e->getMessage(),
      ]
    );
  }
}

// ===========================================================================
// AUDIT-PERF-001 + AUDIT-CONS-001: ENTITY TYPE ALTER
// ===========================================================================

/**
 * Implements hook_entity_type_alter().
 *
 * Applies two global handlers to ALL content entities in the platform:
 *
 * 1. AUDIT-PERF-001 ‚Äî TenantEntityStorageSchema: Adds DB indexes on
 *    tenant_id + composite indexes (tenant+status, tenant+created,
 *    tenant+user_id) for every entity with a tenant_id base field.
 *
 * 2. AUDIT-CONS-001 ‚Äî TenantAccessControlHandler: Applies a generic
 *    access handler to the 88 entities that don't define one, preventing
 *    unauthorized CRUD operations.
 *
 * Both are applied via hook_entity_type_alter() so zero individual
 * entity annotations need to change. Future entities are automatically
 * covered.
 */
function ecosistema_jaraba_core_entity_type_alter(array &$entity_types): void {
  $storageSchemaClass = 'Drupal\ecosistema_jaraba_core\Storage\TenantEntityStorageSchema';
  $accessHandlerClass = 'Drupal\ecosistema_jaraba_core\Access\DefaultEntityAccessControlHandler';

  // Our custom modules all live under this namespace prefix.
  $customNamespaces = [
    'Drupal\\ecosistema_jaraba_core\\',
    'Drupal\\jaraba_',
  ];

  foreach ($entity_types as $entityTypeId => $entityType) {
    // Only process content entity types from our custom modules.
    if (!$entityType instanceof \Drupal\Core\Entity\ContentEntityTypeInterface) {
      continue;
    }

    $entityClass = $entityType->getClass();
    $isCustomModule = FALSE;
    foreach ($customNamespaces as $ns) {
      if (str_starts_with($entityClass, $ns)) {
        $isCustomModule = TRUE;
        break;
      }
    }

    if (!$isCustomModule) {
      continue;
    }

    // AUDIT-PERF-001: Override storage_schema for entities that use the
    // default SqlContentEntityStorageSchema (don't override custom ones).
    $currentSchema = $entityType->getHandlerClass('storage_schema');
    if (
      !$currentSchema
      || $currentSchema === 'Drupal\Core\Entity\Sql\SqlContentEntityStorageSchema'
    ) {
      $entityType->setHandlerClass('storage_schema', $storageSchemaClass);
    }

    // AUDIT-CONS-001: Add AccessControlHandler for entities that don't have
    // one. Entities with explicit access handlers are left untouched.
    $currentAccess = $entityType->getHandlerClass('access');
    if (!$currentAccess) {
      $entityType->setHandlerClass('access', $accessHandlerClass);
    }
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * Adjunta el Command Palette global (Cmd+K) en todas las rutas admin
 * para usuarios con permiso 'administer site configuration'.
 * F6 ‚Äî Doc 181.
 */
function ecosistema_jaraba_core_preprocess_html(&$variables) {
  $route = \Drupal::routeMatch()->getRouteObject();
  if (!$route) {
    return;
  }

  $isAdmin = \Drupal::service('router.admin_context')->isAdminRoute($route);
  if ($isAdmin && \Drupal::currentUser()->hasPermission('administer site configuration')) {
    $variables['#attached']['library'][] = 'ecosistema_jaraba_core/admin-command-palette';
    $variables['#attached']['drupalSettings']['adminCommandPalette'] = [
      'searchUrl' => \Drupal\Core\Url::fromRoute('ecosistema_jaraba_core.admin.search_api')->toString(),
    ];
  }

  // FASE 11: Add body classes for fiscal dashboard route.
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'ecosistema_jaraba_core.fiscal.dashboard') {
    $variables['attributes']['class'][] = 'page--fiscal-dashboard';
    $variables['attributes']['class'][] = 'page--fiscal';
    $variables['attributes']['class'][] = 'page--clean-layout';
  }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Assigns the zero-region page template to the fiscal dashboard route.
 * FASE 11, entregable F11-3.
 */
function ecosistema_jaraba_core_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'ecosistema_jaraba_core.fiscal.dashboard') {
    $suggestions[] = 'page__fiscal';
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for user_form.
 *
 * Redirige a /empleabilidad despu√©s de que un usuario nuevo establezca
 * su contrase√±a tras hacer clic en el enlace de uso √∫nico.
 */
function ecosistema_jaraba_core_form_user_form_alter(array &$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id): void {
  // Solo actuar si el usuario viene del flujo de reset/one-time login.
  // Drupal almacena 'pass_reset_{uid}' en la sesi√≥n hasta que se guarda el form.
  $account = $form_state->getFormObject()->getEntity();
  $session = \Drupal::request()->getSession();
  if ($session && $account && $session->get('pass_reset_' . $account->id())) {
    $form['actions']['submit']['#submit'][] = '_ecosistema_jaraba_core_password_set_redirect';
  }
}

/**
 * Submit handler: redirige al dashboard tras establecer la contrase√±a.
 */
function _ecosistema_jaraba_core_password_set_redirect(array &$form, \Drupal\Core\Form\FormStateInterface $form_state): void {
  $form_state->setRedirectUrl(\Drupal\Core\Url::fromUserInput('/empleabilidad'));
}

