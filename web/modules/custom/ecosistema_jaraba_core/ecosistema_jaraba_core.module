<?php

/**
 * @file
 * Archivo principal del m칩dulo Ecosistema Jaraba Core.
 *
 * Este archivo contiene los hooks de Drupal necesarios para:
 * - Registrar templates Twig personalizados
 * - Definir configuraciones de email
 * - Implementar los hooks del m칩dulo
 *
 * @see https://www.drupal.org/docs/8/creating-custom-modules
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 *
 * Proporciona informaci칩n de ayuda para el m칩dulo en la p치gina de ayuda
 * de Drupal (/admin/help).
 */
function ecosistema_jaraba_core_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.ecosistema_jaraba_core':
      $output = '<h3>' . t('Acerca de Ecosistema Jaraba Core') . '</h3>';
      $output .= '<p>' . t('Este m칩dulo proporciona las funcionalidades core de la plataforma Ecosistema Jaraba SaaS, incluyendo:') . '</p>';
      $output .= '<ul>';
      $output .= '<li>' . t('Gesti칩n de Verticales de negocio') . '</li>';
      $output .= '<li>' . t('Gesti칩n de Tenants (multi-tenancy)') . '</li>';
      $output .= '<li>' . t('Planes de suscripci칩n SaaS') . '</li>';
      $output .= '<li>' . t('Firma digital de documentos') . '</li>';
      $output .= '<li>' . t('Integraci칩n con Stripe para pagos') . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 *
 * Registra los templates Twig personalizados del m칩dulo.
 * Cada template tiene sus propias variables disponibles documentadas.
 */
function ecosistema_jaraba_core_theme($existing, $type, $theme, $path) {
  return [
    // Template del formulario de registro de nuevos tenants
    // Ruta: /registro/{vertical}
    'ecosistema_jaraba_register_form' => [
      'variables' => [
        'vertical' => NULL,
        'plans' => [],
        'theme_settings' => [],
      ],
      'template' => 'ecosistema-jaraba-register-form',
      'path' => $path . '/templates',
    ],

    // Template de selecci칩n de plan durante onboarding
    // Ruta: /onboarding/seleccionar-plan
    'ecosistema_jaraba_select_plan' => [
      'variables' => [
        'tenant' => NULL,
        'vertical' => NULL,
        'plans' => [],
        'current_plan' => NULL,
      ],
      'template' => 'ecosistema-jaraba-select-plan',
      'path' => $path . '/templates',
    ],

    // Template de configuraci칩n de pago con Stripe
    // Ruta: /onboarding/configurar-pago
    'ecosistema_jaraba_setup_payment' => [
      'variables' => [
        'tenant' => NULL,
        'plan' => NULL,
        'stripe_public_key' => '',
      ],
      'template' => 'ecosistema-jaraba-setup-payment',
      'path' => $path . '/templates',
    ],

    // Template de bienvenida post-onboarding
    // Ruta: /onboarding/bienvenida
    'ecosistema_jaraba_welcome' => [
      'variables' => [
        'tenant' => NULL,
        'vertical' => NULL,
        'plan' => NULL,
        'trial_days_remaining' => NULL,
        'tenant_url' => '',
        'next_steps' => [],
      ],
      'template' => 'ecosistema-jaraba-welcome',
      'path' => $path . '/templates',
    ],

    // Dashboard de administraci칩n para Tenant Admins
    // Ruta: /tenant/dashboard
    // Muestra estado de suscripci칩n, m칠tricas de uso y acciones r치pidas
    'ecosistema_jaraba_tenant_dashboard' => [
      'variables' => [
        'tenant' => NULL,
        'plan' => NULL,
        'group' => NULL,
        'domain' => NULL,
        'vertical' => NULL,
        'metrics' => [],
        'subscription_status' => 'active',
        'subscription_status_label' => '',
        'is_on_trial' => FALSE,
        'trial_days_remaining' => 0,
        'quick_actions' => [],
      ],
      'template' => 'ecosistema-jaraba-tenant-dashboard',
      'path' => $path . '/templates',
    ],

    // P치gina de cambio de plan (upgrade/downgrade)
    // Ruta: /tenant/change-plan
    // Muestra planes disponibles para que el tenant pueda cambiar
    'ecosistema_jaraba_change_plan' => [
      'variables' => [
        'tenant' => NULL,
        'current_plan' => NULL,
        'plans' => [],
        'back_url' => NULL,
      ],
      'template' => 'ecosistema-jaraba-change-plan',
      'path' => $path . '/templates',
    ],
  ];
}

/**
 * Implements hook_mail().
 *
 * Define las plantillas de correo electr칩nico del m칩dulo.
 * Los emails se env칤an en formato HTML con texto plano alternativo.
 */
function ecosistema_jaraba_core_mail($key, &$message, $params) {
  switch ($key) {
    // Email de bienvenida para nuevos tenants
    case 'tenant_welcome':
      $message['subject'] = t('춰Bienvenido a @vertical!', [
        '@vertical' => $params['vertical_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('Tu organizaci칩n <strong>@tenant</strong> ha sido creada exitosamente en la plataforma @vertical.', [
        '@tenant' => $params['tenant_name'],
        '@vertical' => $params['vertical_name'],
      ]);

      $message['body'][] = t('Tu URL de acceso es: @url', [
        '@url' => $params['access_url'],
      ]);

      $message['body'][] = t('Tu periodo de prueba gratuita termina el: @date', [
        '@date' => $params['trial_ends'],
      ]);

      $message['body'][] = t('Para empezar, inicia sesi칩n en tu panel de control y completa la configuraci칩n de tu organizaci칩n.');

      $message['body'][] = '---';
      $message['body'][] = t('El equipo de Ecosistema Jaraba');
      break;

    // Email de recordatorio de fin de trial
    case 'trial_ending_reminder':
      $message['subject'] = t('Tu periodo de prueba en @vertical termina pronto', [
        '@vertical' => $params['vertical_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('Tu periodo de prueba en @tenant termina en @days d칤as.', [
        '@tenant' => $params['tenant_name'],
        '@days' => $params['days_remaining'],
      ]);

      $message['body'][] = t('Para seguir disfrutando de todas las funcionalidades, a침ade un m칠todo de pago antes de que termine el periodo de prueba.');

      $message['body'][] = t('Accede a tu cuenta: @url', [
        '@url' => $params['access_url'],
      ]);
      break;

    // Email de confirmaci칩n de pago
    case 'payment_confirmation':
      $message['subject'] = t('Confirmaci칩n de pago - @tenant', [
        '@tenant' => $params['tenant_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('Hemos recibido tu pago de @amount para el plan @plan.', [
        '@amount' => $params['amount'],
        '@plan' => $params['plan_name'],
      ]);

      $message['body'][] = t('Pr칩xima facturaci칩n: @date', [
        '@date' => $params['next_billing_date'],
      ]);

      $message['body'][] = t('Gracias por confiar en nosotros.');
      break;

    // Email de alerta de pago fallido
    case 'payment_failed':
      $message['subject'] = t('丘멆잺 Problema con tu pago - @tenant', [
        '@tenant' => $params['tenant_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      $message['body'][] = t('No hemos podido procesar tu pago de @amount para el plan @plan.', [
        '@amount' => $params['amount'],
        '@plan' => $params['plan_name'],
      ]);

      $message['body'][] = t('Por favor, verifica tu m칠todo de pago para evitar la suspensi칩n de tu cuenta.');

      $message['body'][] = t('Actualizar m칠todo de pago: @url', [
        '@url' => $params['payment_url'],
      ]);
      break;

    // Email de alerta de l칤mite de uso
    case 'usage_limit_alert':
      $message['subject'] = t('游늵 Alerta de uso (@percent%) - @tenant', [
        '@percent' => $params['percentage'],
        '@tenant' => $params['tenant_name'],
      ]);

      $message['body'][] = t('Hola @name,', [
        '@name' => $params['admin_name'],
      ]);

      if ($params['percentage'] >= 100) {
        $message['body'][] = t('Has alcanzado el 100% del l칤mite de @type en tu plan.', [
          '@type' => $params['limit_type'],
        ]);
        $message['body'][] = t('Uso actual: @current de @max permitidos.', [
          '@current' => $params['current'],
          '@max' => $params['max'],
        ]);
        $message['body'][] = t('Para continuar a침adiendo m치s @type, necesitas actualizar tu plan.', [
          '@type' => $params['limit_type'],
        ]);
      } else {
        $message['body'][] = t('Has alcanzado el @percent% del l칤mite de @type en tu plan.', [
          '@percent' => $params['percentage'],
          '@type' => $params['limit_type'],
        ]);
        $message['body'][] = t('Uso actual: @current de @max permitidos.', [
          '@current' => $params['current'],
          '@max' => $params['max'],
        ]);
        $message['body'][] = t('Te recomendamos revisar tu plan antes de alcanzar el l칤mite.');
      }

      $message['body'][] = t('Actualizar plan: @url', [
        '@url' => $params['upgrade_url'],
      ]);
      break;
  }
}

/**
 * Implements hook_cron().
 *
 * Tareas programadas del m칩dulo que se ejecutan con cada cron.
 */
function ecosistema_jaraba_core_cron() {
  // Verificar tenants con trial pr칩ximo a expirar
  _ecosistema_jaraba_core_check_expiring_trials();

  // Verificar tenants con pagos pendientes
  _ecosistema_jaraba_core_check_past_due_subscriptions();

  // Verificar tenants que se acercan a sus l칤mites de uso
  _ecosistema_jaraba_core_check_usage_limits();
}

/**
 * Verifica y notifica tenants con trial pr칩ximo a expirar.
 *
 * Esta funci칩n busca tenants cuyo periodo de prueba termina en los pr칩ximos
 * 3 d칤as y env칤a recordatorios por email.
 *
 * @internal
 */
function _ecosistema_jaraba_core_check_expiring_trials() {
  $entityTypeManager = \Drupal::entityTypeManager();
  $tenantStorage = $entityTypeManager->getStorage('tenant');

  // Buscar tenants en trial que expiran en 3 d칤as o menos
  $thresholdDate = (new \DateTime())->add(new \DateInterval('P3D'))->format('Y-m-d\TH:i:s');
  $now = (new \DateTime())->format('Y-m-d\TH:i:s');

  $query = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', 'trial')
    ->condition('trial_ends', $now, '>')
    ->condition('trial_ends', $thresholdDate, '<=');

  $tenantIds = $query->execute();

  foreach ($tenantIds as $tenantId) {
    $tenant = $tenantStorage->load($tenantId);
    if ($tenant && !$tenant->get('trial_reminder_sent')->value) {
      // TODO: Enviar email de recordatorio
      \Drupal::logger('ecosistema_jaraba_core')->info(
        '游닎 Recordatorio de trial enviado a tenant @tenant',
        ['@tenant' => $tenant->getName()]
      );

      // Marcar como enviado para no repetir
      $tenant->set('trial_reminder_sent', TRUE);
      $tenant->save();
    }
  }
}

/**
 * Verifica tenants con pagos pendientes para posible suspensi칩n.
 *
 * Los tenants que llevan m치s de 7 d칤as en estado past_due se suspenden.
 *
 * @internal
 */
function _ecosistema_jaraba_core_check_past_due_subscriptions() {
  $entityTypeManager = \Drupal::entityTypeManager();
  $tenantStorage = $entityTypeManager->getStorage('tenant');

  // Buscar tenants en past_due desde hace m치s de 7 d칤as
  $thresholdDate = (new \DateTime())->sub(new \DateInterval('P7D'))->format('Y-m-d\TH:i:s');

  $query = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', 'past_due')
    ->condition('changed', strtotime($thresholdDate), '<');

  $tenantIds = $query->execute();

  $tenantManager = \Drupal::service('ecosistema_jaraba_core.tenant_manager');

  foreach ($tenantIds as $tenantId) {
    $tenant = $tenantStorage->load($tenantId);
    if ($tenant) {
      // Suspender el tenant
      $tenantManager->suspendTenant($tenant, 'payment_overdue');

      \Drupal::logger('ecosistema_jaraba_core')->warning(
        '丘멆잺 Tenant @tenant suspendido por pago pendiente',
        ['@tenant' => $tenant->getName()]
      );
    }
  }
}

/**
 * Verifica tenants que se acercan a sus l칤mites de uso.
 *
 * Env칤a alertas cuando un tenant alcanza el 80% o 100% de sus l칤mites:
 * - N칰mero de productores
 * - Almacenamiento utilizado
 *
 * @internal
 */
function _ecosistema_jaraba_core_check_usage_limits() {
  $entityTypeManager = \Drupal::entityTypeManager();
  $tenantStorage = $entityTypeManager->getStorage('tenant');

  // Solo tenants activos
  $query = $tenantStorage->getQuery()
    ->accessCheck(FALSE)
    ->condition('subscription_status', ['active', 'trial'], 'IN');

  $tenantIds = $query->execute();

  /** @var \Drupal\ecosistema_jaraba_core\Service\TenantContextService $tenantContext */
  $tenantContext = \Drupal::service('ecosistema_jaraba_core.tenant_context');

  $alertThreshold80 = 0.80;
  $alertThreshold100 = 1.00;

  foreach ($tenantIds as $tenantId) {
    $tenant = $tenantStorage->load($tenantId);
    if (!$tenant) {
      continue;
    }

    $plan = $tenant->getSubscriptionPlan();
    if (!$plan) {
      continue;
    }

    $limits = $plan->getLimits();
    $metrics = $tenantContext->getUsageMetrics($tenant);

    // Verificar l칤mite de productores
    $maxProductores = $limits['productores'] ?? 0;
    if ($maxProductores > 0) {
      $currentProductores = $metrics['producers_count'] ?? 0;
      $ratio = $currentProductores / $maxProductores;

      if ($ratio >= $alertThreshold100) {
        _ecosistema_jaraba_core_send_usage_alert($tenant, 'producers', 100, $currentProductores, $maxProductores);
      } elseif ($ratio >= $alertThreshold80) {
        _ecosistema_jaraba_core_send_usage_alert($tenant, 'producers', 80, $currentProductores, $maxProductores);
      }
    }

    // Verificar l칤mite de almacenamiento
    $maxStorageMb = $limits['almacenamiento_mb'] ?? 0;
    if ($maxStorageMb > 0) {
      $currentStorageMb = $metrics['storage_mb'] ?? 0;
      $ratio = $currentStorageMb / $maxStorageMb;

      if ($ratio >= $alertThreshold100) {
        _ecosistema_jaraba_core_send_usage_alert($tenant, 'storage', 100, $currentStorageMb, $maxStorageMb);
      } elseif ($ratio >= $alertThreshold80) {
        _ecosistema_jaraba_core_send_usage_alert($tenant, 'storage', 80, $currentStorageMb, $maxStorageMb);
      }
    }
  }
}

/**
 * Env칤a alerta de uso al administrador del tenant.
 *
 * @param \Drupal\ecosistema_jaraba_core\Entity\TenantInterface $tenant
 *   El tenant que ha alcanzado el l칤mite.
 * @param string $limitType
 *   Tipo de l칤mite: 'producers' o 'storage'.
 * @param int $percentage
 *   Porcentaje alcanzado: 80 o 100.
 * @param int $current
 *   Valor actual.
 * @param int $max
 *   Valor m치ximo permitido.
 */
function _ecosistema_jaraba_core_send_usage_alert($tenant, $limitType, $percentage, $current, $max) {
  $adminUser = $tenant->getAdminUser();
  if (!$adminUser || !$adminUser->getEmail()) {
    return;
  }

  // Crear clave para evitar spam (solo 1 alerta por tipo/nivel/d칤a)
  $alertKey = "usage_alert_{$tenant->id()}_{$limitType}_{$percentage}";
  $state = \Drupal::state();
  $lastAlert = $state->get($alertKey, 0);
  $oneDayAgo = time() - 86400;

  if ($lastAlert > $oneDayAgo) {
    // Ya se envi칩 alerta hoy, no repetir
    return;
  }

  $limitLabels = [
    'producers' => t('productores'),
    'storage' => t('almacenamiento'),
  ];

  $params = [
    'tenant_name' => $tenant->getName(),
    'admin_name' => $adminUser->getDisplayName(),
    'limit_type' => $limitLabels[$limitType] ?? $limitType,
    'percentage' => $percentage,
    'current' => $current,
    'max' => $max,
    'upgrade_url' => \Drupal\Core\Url::fromRoute('ecosistema_jaraba_core.tenant.change_plan', [], ['absolute' => TRUE])->toString(),
  ];

  // Enviar email
  $mailManager = \Drupal::service('plugin.manager.mail');
  $result = $mailManager->mail(
    'ecosistema_jaraba_core',
    'usage_limit_alert',
    $adminUser->getEmail(),
    $adminUser->getPreferredLangcode(),
    $params,
    NULL,
    TRUE
  );

  if ($result['result']) {
    $state->set($alertKey, time());
    \Drupal::logger('ecosistema_jaraba_core')->info(
      '游늵 Alerta de uso (@percent%) enviada a @tenant: @type = @current/@max',
      [
        '@percent' => $percentage,
        '@tenant' => $tenant->getName(),
        '@type' => $limitType,
        '@current' => $current,
        '@max' => $max,
      ]
    );
  }
}
