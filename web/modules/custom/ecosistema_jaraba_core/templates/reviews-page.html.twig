{#
 # Reviews Page — Full page of reviews for a target entity.
 #
 # Variables:
 # - target_entity: EntityInterface
 # - vertical: string (canonical vertical name)
 # - stats: { average, count, distribution }
 # - reviews: array of review entities
 # - current_page: int
 # - per_page: int
 #
 # REV-PHASE5: Pagina publica de resenas.
 #}
<div class="reviews-page" data-reviews-page
     data-review-type="{{ review_entity_type|default('') }}"
     data-target-id="{{ target_entity.id }}"
     data-vertical="{{ vertical|default('') }}">
  <header class="reviews-page__header">
    <h1 class="reviews-page__title">
      {{ 'Resenas de @name'|t({'@name': target_entity.label}) }}
    </h1>
  </header>

  {# Rating summary widget #}
  {% include '@ecosistema_jaraba_theme/partials/_review-widget.html.twig' with {
    rating_stats: stats,
    recent_reviews: [],
    ai_summary: null,
    reviews_url: null,
    can_submit: false,
    submit_url: null,
  } only %}

  {# Filter bar — B-02 #}
  <div class="review-filters" aria-label="{{ 'Filtros de resenas'|t }}">
    <div class="review-filters__group" data-filter-group="stars">
      <button type="button" class="review-filters__chip review-filters__chip--active" data-filter-type="stars" data-filter-value="">{{ 'Todas'|t }}</button>
      {% for star in 5..1 %}
        <button type="button" class="review-filters__chip" data-filter-type="stars" data-filter-value="{{ star }}">{{ star }} ★ {% if stats.distribution[star] is defined %}({{ stats.distribution[star] }}){% endif %}</button>
      {% endfor %}
    </div>
    <div class="review-filters__group" data-filter-group="extras">
      <button type="button" class="review-filters__chip" data-filter-type="verified" data-filter-value="1">{{ 'Compra verificada'|t }}</button>
      <button type="button" class="review-filters__chip" data-filter-type="has_photos" data-filter-value="1">{{ 'Con fotos'|t }}</button>
    </div>
    <div class="review-filters__sort">
      <select aria-label="{{ 'Ordenar resenas'|t }}">
        <option value="newest">{{ 'Mas recientes'|t }}</option>
        <option value="helpful">{{ 'Mas utiles'|t }}</option>
        <option value="highest">{{ 'Mejor valoradas'|t }}</option>
        <option value="lowest">{{ 'Peor valoradas'|t }}</option>
        <option value="oldest">{{ 'Mas antiguas'|t }}</option>
      </select>
    </div>
  </div>

  {# Reviews list #}
  {% if reviews is not empty %}
    <div class="reviews-page__list" role="list" aria-label="{{ 'Lista de resenas'|t }}">
      {% for review_entity in reviews %}
        {% set review_data = {
          id: review_entity.id,
          author_name: review_entity.getOwner ? review_entity.getOwner.getDisplayName : ('Anonimo'|t),
          author_avatar_url: null,
          rating: review_entity.get('rating').value|default(review_entity.get('overall_rating').value|default(0)),
          title: review_entity.get('title').value|default(null),
          body: review_entity.get('comment').value|default(review_entity.get('review_text').value|default(review_entity.get('body').value|default(''))),
          created: review_entity.get('created').value|date('c'),
          verified_purchase: review_entity.hasField('verified_purchase') ? review_entity.get('verified_purchase').value : false,
          helpful_count: review_entity.hasField('helpful_count') ? review_entity.get('helpful_count').value|default(0) : 0,
          photos: [],
          response: null,
        } %}
        <div role="listitem">
          {% include '@ecosistema_jaraba_theme/partials/_review-card.html.twig' with {
            review: review_data
          } only %}
        </div>
      {% endfor %}
    </div>

    {# Pagination #}
    {% set total_pages = (stats.count / per_page)|round(0, 'ceil') %}
    {% if total_pages > 1 %}
      <nav class="reviews-page__pagination pager" aria-label="{{ 'Paginacion de resenas'|t }}">
        <ul class="pager__items">
          {% if current_page > 0 %}
            <li class="pager__item pager__item--previous">
              <a href="?page={{ current_page - 1 }}">← {{ 'Anterior'|t }}</a>
            </li>
          {% endif %}
          {% for p in 0..(total_pages - 1) %}
            <li class="pager__item{{ p == current_page ? ' pager__item--active is-active' : '' }}">
              {% if p == current_page %}
                <span aria-current="page">{{ p + 1 }}</span>
              {% else %}
                <a href="?page={{ p }}">{{ p + 1 }}</a>
              {% endif %}
            </li>
          {% endfor %}
          {% if current_page < (total_pages - 1) %}
            <li class="pager__item pager__item--next">
              <a href="?page={{ current_page + 1 }}">{{ 'Siguiente'|t }} →</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  {% else %}
    <div class="reviews-page__empty">
      <p>{{ 'Aun no hay resenas para este recurso.'|t }}</p>
    </div>
  {% endif %}
</div>
