{#
/**
 * @file
 * Template para la vista de dashboard de demo con sesión activa.
 *
 * Variables:
 * - session: Array completo de datos de sesión (session_id, profile, tenant_name,
 *   metrics, products, sales_history, magic_moment_actions, etc.).
 *
 * S2-04: Template dedicado — antes usaba el mismo template que demo_dashboard
 * pero con variables incompatibles, resultando en una página vacía.
 *
 * Reutiliza la misma estructura visual que demo-dashboard.html.twig
 * pero extrae las variables del array session.
 */
#}

{# Extraer variables del array session para reutilizar la misma estructura #}
{% set session_id = session.session_id|default('') %}
{% set profile = session.profile|default({}) %}
{% set tenant_name = session.tenant_name|default('') %}
{% set metrics = session.metrics|default({}) %}
{% set products = session.products|default([]) %}
{% set magic_actions = session.magic_moment_actions|default([]) %}
{% set unlocked = disclosure.unlocked|default(['dashboard', 'metrics']) %}
{% set disclosure_level = disclosure.level|default(1) %}
{% set next_actions = disclosure.next_actions_needed|default(1) %}

<div class="demo-dashboard" data-session-id="{{ session_id }}" data-demo-dashboard>
  {# Banner de Demo #}
  <div class="demo-banner">
    <div class="demo-banner__content">
      <span class="demo-banner__badge">
        {{ jaraba_icon('navigation', 'play', { size: '14px', color: 'blanco' }) }}
        {{ 'MODO DEMO'|t }}
      </span>
      <span class="demo-banner__tenant-name">{{ tenant_name }}</span>
      {% if profile.icon_category is defined and profile.icon_name is defined %}
        <span>
          {{ jaraba_icon(profile.icon_category, profile.icon_name, { size: '18px', color: 'blanco' }) }}
          {{ profile.name|default('') }}
        </span>
      {% endif %}
    </div>
    <div class="demo-banner__actions">
      {# S7-06: Countdown timer — actualizado via JS. #}
      <span class="demo-countdown" data-demo-countdown aria-live="polite" aria-label="{{ 'Tiempo restante de sesión'|t }}">
        {{ jaraba_icon('dashboard', 'clock', { size: '14px', color: 'blanco' }) }}
        <span data-countdown-display>--:--</span>
      </span>
      <button class="demo-start-btn" data-demo-convert-open type="button">
        {{ jaraba_icon('ai', 'sparkles', { size: '16px', color: 'azul-corporativo' }) }}
        {{ 'Convertir en Cuenta Real'|t }}
      </button>
    </div>
  </div>

  {# Magic Moment Actions #}
  {% if magic_actions %}
    <section class="demo-magic-moment" data-tour-step="demo-magic-moment">
      <h2 class="demo-section-title">
        {{ jaraba_icon('business', 'target', { color: 'naranja-impulso', size: '24px' }) }}
        {{ 'Tu Primer Paso'|t }}
      </h2>
      <div class="demo-magic-actions-grid">
        {% for action in magic_actions %}
          {% set action_url = action.url %}
          {% if action.url == '__storytelling__' %}
            {% set action_url = path('ecosistema_jaraba_core.demo_storytelling', { sessionId: session_id }) %}
          {% endif %}
          <a href="{{ action_url }}"
             class="demo-magic-action-card {{ action.highlight ? 'demo-magic-action-card--highlighted' : '' }}"
             data-action="{{ action.id }}">
            <div class="demo-magic-action-card__icon">
              {{ jaraba_icon(action.icon_category|default('navigation'), action.icon_name|default('arrow'), { size: '24px', variant: 'duotone' }) }}
            </div>
            <h3 class="demo-magic-action-card__title">{{ action.label }}</h3>
            <p class="demo-magic-action-card__description">{{ action.description }}</p>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  {# S6-05: Métricas via partial compartido. #}
  {% include '@ecosistema_jaraba_core/partials/_demo-metrics.html.twig' with { metrics: metrics } only %}

  {# S6-05: Gráfico via partial compartido. #}
  {% include '@ecosistema_jaraba_core/partials/_demo-chart.html.twig' only %}

  {# S7-07: Secciones bloqueadas con glass overlay si no desbloqueadas. #}
  {% if 'ai_playground' not in unlocked %}
    <section class="demo-locked-section" aria-label="{{ 'Sección bloqueada'|t }}">
      <div class="demo-locked-section__overlay">
        {{ jaraba_icon('navigation', 'lock', { size: '32px', color: 'azul-corporativo' }) }}
        <p class="demo-locked-section__message">
          {{ 'Realiza @count acciones más para desbloquear el AI Playground'|t({'@count': next_actions}) }}
        </p>
      </div>
    </section>
  {% endif %}

  {# S6-05: CTA via partial compartido (solo nivel 4). #}
  {% if 'conversion_prompt' in unlocked %}
    {% include '@ecosistema_jaraba_core/partials/_demo-cta.html.twig' with { vertical: profile.vertical|default('agroconecta') } only %}
  {% endif %}
</div>
