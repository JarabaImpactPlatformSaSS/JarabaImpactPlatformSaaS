{#
/**
 * @file
 * Template for FinOps (Cost Optimization) Dashboard.
 *
 * Variables:
 * - tenants: Array of tenant cost data
 * - totals: Aggregate cost totals
 * - projections: Monthly cost projections
 * - alerts: Cost alerts
 * - recommendations: Optimization recommendations
 * - help_info: Help information with metric sources
 * - data_sources: Info about what data is real vs estimated
 * - last_updated: Timestamp of last update
 */
#}
<div class="finops-dashboard">
  {# Header Section #}
  <div class="finops-header">
    <div class="finops-header__content">
      <h1 class="finops-header__title">
        <span class="finops-header__icon">ğŸ’°</span>
        {% trans %}FinOps Dashboard{% endtrans %}
      </h1>
      <p class="finops-header__subtitle">{% trans %}Cost optimization and resource usage{% endtrans %}</p>
    </div>
    <div class="finops-header__actions">
      <button class="btn btn-primary" id="refresh-finops" title="{% trans %}Refresh data{% endtrans %}">
        <span class="btn__icon">ğŸ”„</span> {% trans %}Refresh{% endtrans %}
      </button>
      <a href="/admin/config/finops" class="finops-header__settings use-ajax" data-dialog-type="modal" data-dialog-options='{"width":700,"title":"FinOps Settings"}' title="{% trans %}Configure pricing{% endtrans %}">
        âš™ï¸
      </a>
      <span class="finops-header__updated">
        {% trans %}Last updated{% endtrans %}: <strong id="last-updated">{{ last_updated }}</strong>
      </span>
    </div>
  </div>

  {# Alerts Section #}
  {% if alerts is not empty %}
  <div class="finops-alerts">
    {% for alert in alerts %}
    <div class="alert-card alert-card--{{ alert.type }}">
      <span class="alert-card__icon">
        {% if alert.type == 'critical' %}ğŸš¨{% elseif alert.type == 'warning' %}âš ï¸{% else %}â„¹ï¸{% endif %}
      </span>
      <div class="alert-card__content">
        <strong>{{ alert.title }}</strong>
        <p>{{ alert.message }}</p>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {# Cost Overview Cards #}
  <div class="finops-metrics">
    <div class="metric-card metric-card--cost">
      <div class="metric-card__icon">ğŸ’µ</div>
      <div class="metric-card__content">
        <span class="metric-card__value">â‚¬{{ totals.cost_total }}</span>
        <span class="metric-card__label">{% trans %}Current Month{% endtrans %}</span>
      </div>
      <div class="metric-card__indicator metric-card__indicator--{{ projections.trend }}"></div>
    </div>

    <div class="metric-card metric-card--projection">
      <div class="metric-card__icon">ğŸ“Š</div>
      <div class="metric-card__content">
        <span class="metric-card__value">â‚¬{{ projections.monthly_projected }}</span>
        <span class="metric-card__label">{% trans %}Projected Monthly{% endtrans %}</span>
      </div>
      <div class="metric-card__trend metric-card__trend--{{ projections.trend }}">
        {% if projections.trend == 'up' %}ğŸ“ˆ{% elseif projections.trend == 'down' %}ğŸ“‰{% else %}â¡ï¸{% endif %}
      </div>
    </div>

    <div class="metric-card metric-card--budget">
      <div class="metric-card__icon">ğŸ¯</div>
      <div class="metric-card__content">
        <span class="metric-card__value">{{ projections.budget_usage_percent }}%</span>
        <span class="metric-card__label">{% trans %}Budget Usage{% endtrans %}</span>
      </div>
      <div class="metric-card__progress">
        <div class="progress-bar" style="width: {{ projections.budget_usage_percent|default(0) }}%"></div>
      </div>
    </div>

    <div class="metric-card metric-card--tenants">
      <div class="metric-card__icon">ğŸ¢</div>
      <div class="metric-card__content">
        <span class="metric-card__value">{{ totals.tenant_count }}</span>
        <span class="metric-card__label">{% trans %}Active Tenants{% endtrans %}</span>
      </div>
    </div>
  </div>

  {# Resource Usage Summary #}
  <div class="finops-section">
    <h2 class="finops-section__title">
      <span class="finops-section__icon">ğŸ“ˆ</span>
      {% trans %}Resource Usage{% endtrans %}
    </h2>
    <div class="resource-cards">
      <div class="resource-card">
        <div class="resource-card__header">
          <span class="resource-card__icon">ğŸ’¾</span>
          <span class="resource-card__title">{% trans %}Storage{% endtrans %}</span>
        </div>
        <div class="resource-card__value">{{ totals.storage_mb }} MB</div>
        <div class="resource-card__cost">â‚¬{{ totals.cost_storage }}</div>
      </div>

      <div class="resource-card">
        <div class="resource-card__header">
          <span class="resource-card__icon">ğŸ”Œ</span>
          <span class="resource-card__title">{% trans %}API Requests{% endtrans %}</span>
        </div>
        <div class="resource-card__value">{{ totals.api_requests|number_format }}</div>
        <div class="resource-card__cost">â‚¬{{ totals.cost_api }}</div>
      </div>

      <div class="resource-card">
        <div class="resource-card__header">
          <span class="resource-card__icon">âš¡</span>
          <span class="resource-card__title">{% trans %}CPU Hours{% endtrans %}</span>
        </div>
        <div class="resource-card__value">{{ totals.cpu_hours }} h</div>
        <div class="resource-card__cost">â‚¬{{ totals.cost_cpu }}</div>
    </div>
  </div>

  {# Tenant Costs Table - Desglose por inquilino #}
  <div class="finops-section">
    <h2 class="finops-section__title">
      <span class="finops-section__icon">ğŸ¢</span>
      {% trans %}Cost by Tenant{% endtrans %}
    </h2>
    <div class="tenant-table">
      {% if tenants is not empty %}
      <table class="table table--modern">
        <thead>
          <tr>
            <th>{% trans %}Tenant{% endtrans %}</th>
            <th>{% trans %}Tier{% endtrans %}</th>
            <th>{% trans %}Storage{% endtrans %}</th>
            <th>{% trans %}API Requests{% endtrans %}</th>
            <th>{% trans %}CPU{% endtrans %}</th>
            <th>{% trans %}Total Cost{% endtrans %}</th>
            <th>{% trans %}Status{% endtrans %}</th>
          </tr>
        </thead>
        <tbody id="tenant-costs">
          {% for tenant in tenants %}
          <tr class="tenant-row tenant-row--{{ tenant.status }}">
            <td class="tenant-row__name">
              <strong>{{ tenant.name }}</strong>
              <span class="tenant-row__id">{{ tenant.id }}</span>
            </td>
            <td class="tenant-row__tier">
              <span class="tier-badge tier-badge--{{ tenant.tier }}">{{ tenant.tier|capitalize }}</span>
            </td>
            <td class="tenant-row__storage">{{ tenant.storage_mb }} MB</td>
            <td class="tenant-row__api">{{ tenant.api_requests|number_format }}</td>
            <td class="tenant-row__cpu">{{ tenant.cpu_hours }} h</td>
            <td class="tenant-row__cost">
              <strong>â‚¬{{ tenant.costs.total }}</strong>
            </td>
            <td class="tenant-row__status">
              <span class="status-badge status-badge--{{ tenant.status }}">
                {% if tenant.status == 'normal' %}âœ…{% elseif tenant.status == 'warning' %}âš ï¸{% else %}ğŸš¨{% endif %}
                {{ tenant.status|upper }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <div class="finops-empty-state" style="text-align: center; padding: 2rem; color: var(--finops-text-muted, #94a3b8);">
        <span style="font-size: 2rem;">ğŸ“­</span>
        <p>{% trans %}No tenants found. Create tenants to see cost breakdown.{% endtrans %}</p>
      </div>
      {% endif %}
    </div>
  </div>

  {# Revenue Section (MRR/ARR) #}
  {% if revenue %}
  <div class="finops-section finops-section--revenue">
    <h2 class="finops-section__title">
      <span class="finops-section__icon">ğŸ’µ</span>
      {% trans %}Revenue{% endtrans %}
    </h2>
    <div class="finops-metrics">
      <div class="metric-card metric-card--revenue">
        <span class="metric-card__icon">ğŸ“Š</span>
        <span class="metric-card__value">â‚¬{{ revenue.mrr }}</span>
        <span class="metric-card__label">{% trans %}MRR (Monthly Recurring){% endtrans %}</span>
      </div>
      <div class="metric-card metric-card--revenue">
        <span class="metric-card__icon">ğŸ“ˆ</span>
        <span class="metric-card__value">â‚¬{{ revenue.arr }}</span>
        <span class="metric-card__label">{% trans %}ARR (Annual Recurring){% endtrans %}</span>
      </div>
      <div class="metric-card metric-card--tenants">
        <span class="metric-card__icon">ğŸ¢</span>
        <span class="metric-card__value">{{ revenue.active_subscriptions }}</span>
        <span class="metric-card__label">{% trans %}Active Subscriptions{% endtrans %}</span>
      </div>
      <div class="metric-card metric-card--projection">
        <span class="metric-card__icon">ğŸ¯</span>
        <span class="metric-card__value">â‚¬{{ revenue.monthly_projected }}</span>
        <span class="metric-card__label">{% trans %}Projected This Month{% endtrans %}</span>
      </div>
    </div>
    
    {# Revenue by Tier #}
    {% if revenue.by_tier %}
    <div class="resource-cards" style="margin-top: 1rem;">
      {% for tier, data in revenue.by_tier %}
      <div class="resource-card">
        <div class="resource-card__header">
          <span class="tier-badge tier-badge--{{ tier }}">{{ tier|capitalize }}</span>
        </div>
        <div class="resource-card__value">{{ data.count }} {% trans %}tenants{% endtrans %}</div>
        <div class="resource-card__cost">â‚¬{{ data.monthly }}/{% trans %}month{% endtrans %}</div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% endif %}

  {# Net Results (P&L) Section #}
  {% if net_results %}
  <div class="finops-section finops-section--netresults">
    <h2 class="finops-section__title">
      <span class="finops-section__icon">ğŸ“‰</span>
      {% trans %}Net Results (P&L){% endtrans %}
    </h2>
    <div class="finops-metrics">
      <div class="metric-card metric-card--revenue">
        <span class="metric-card__icon">ğŸ’°</span>
        <span class="metric-card__value">â‚¬{{ net_results.revenue_current }}</span>
        <span class="metric-card__label">{% trans %}Revenue (Current){% endtrans %}</span>
      </div>
      <div class="metric-card metric-card--cost">
        <span class="metric-card__icon">ğŸ’¸</span>
        <span class="metric-card__value">â‚¬{{ net_results.costs_current }}</span>
        <span class="metric-card__label">{% trans %}Costs (Current){% endtrans %}</span>
      </div>
      <div class="metric-card metric-card--{% if net_results.status == 'profitable' %}budget{% else %}cost{% endif %}">
        <span class="metric-card__icon">{% if net_results.status == 'profitable' %}âœ…{% else %}âš ï¸{% endif %}</span>
        <span class="metric-card__value" style="color: {% if net_results.net_current >= 0 %}var(--ej-color-success, #10b981){% else %}var(--ej-color-error, #ef4444){% endif %}">
          â‚¬{{ net_results.net_current }}
        </span>
        <span class="metric-card__label">{% trans %}Net Result{% endtrans %}</span>
      </div>
      <div class="metric-card">
        <span class="metric-card__icon">ğŸ“Š</span>
        <span class="metric-card__value" style="color: {% if net_results.margin_current >= 0 %}var(--ej-color-success, #10b981){% else %}var(--ej-color-error, #ef4444){% endif %}">
          {{ net_results.margin_current }}%
        </span>
        <span class="metric-card__label">{% trans %}Profit Margin{% endtrans %}</span>
      </div>
    </div>
    
    {# Projected Results #}
    <div class="finops-help__sources" style="margin-top: 1rem;">
      <h3 style="font-size: 1rem; margin-bottom: 0.5rem; color: var(--finops-text-muted, #94a3b8);">{% trans %}Monthly Projection{% endtrans %}</h3>
      <table class="table table--modern">
        <thead>
          <tr>
            <th>{% trans %}Metric{% endtrans %}</th>
            <th>{% trans %}Current{% endtrans %}</th>
            <th>{% trans %}Projected{% endtrans %}</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{% trans %}Revenue{% endtrans %}</td>
            <td>â‚¬{{ net_results.revenue_current }}</td>
            <td>â‚¬{{ net_results.revenue_projected }}</td>
          </tr>
          <tr>
            <td>{% trans %}Costs{% endtrans %}</td>
            <td>â‚¬{{ net_results.costs_current }}</td>
            <td>â‚¬{{ net_results.costs_projected }}</td>
          </tr>
          <tr style="font-weight: bold;">
            <td>{% trans %}Net Result{% endtrans %}</td>
            <td style="color: {% if net_results.net_current >= 0 %}var(--ej-color-success, #10b981){% else %}var(--ej-color-error, #ef4444){% endif %}">â‚¬{{ net_results.net_current }}</td>
            <td style="color: {% if net_results.net_projected >= 0 %}var(--ej-color-success, #10b981){% else %}var(--ej-color-error, #ef4444){% endif %}">â‚¬{{ net_results.net_projected }}</td>
          </tr>
          <tr>
            <td>{% trans %}Margin{% endtrans %}</td>
            <td>{{ net_results.margin_current }}%</td>
            <td>{{ net_results.margin_projected }}%</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {# Recommendations Section #}
  {% if recommendations is not empty %}
  <div class="finops-section">
    <h2 class="finops-section__title">
      <span class="finops-section__icon">ğŸ’¡</span>
      {% trans %}Optimization Recommendations{% endtrans %}
    </h2>
    <div class="recommendations-grid">
      {% for rec in recommendations %}
      <div class="recommendation-card recommendation-card--{{ rec.type }}">
        <div class="recommendation-card__header">
          {% if rec.type == 'summary' %}
            <span class="recommendation-card__icon">ğŸ“Š</span>
          {% elseif rec.type == 'storage' %}
            <span class="recommendation-card__icon">ğŸ’¾</span>
          {% elseif rec.type == 'api' %}
            <span class="recommendation-card__icon">ğŸ”Œ</span>
          {% else %}
            <span class="recommendation-card__icon">ğŸ’¡</span>
          {% endif %}
          <strong>{{ rec.title }}</strong>
        </div>
        <p class="recommendation-card__message">{{ rec.message }}</p>
        {% if rec.potential_savings %}
        <div class="recommendation-card__savings">
          {% trans %}Potential Savings{% endtrans %}: <strong>â‚¬{{ rec.potential_savings }}</strong>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {# Quick Actions #}
  <div class="finops-section">
    <h2 class="finops-section__title">
      <span class="finops-section__icon">âš¡</span>
      {% trans %}Quick Actions{% endtrans %}
    </h2>
    <div class="quick-actions">
      <a href="/admin/structure/tenants" class="action-btn action-btn--primary">
        <span class="action-btn__icon">ğŸ¢</span>
        {% trans %}Manage Tenants{% endtrans %}
      </a>
      <a href="/admin/structure/saas-plans" class="action-btn action-btn--secondary">
        <span class="action-btn__icon">ğŸ“‹</span>
        {% trans %}Manage Plans{% endtrans %}
      </a>
      <a href="/admin/health" class="action-btn action-btn--secondary">
        <span class="action-btn__icon">ğŸ¥</span>
        {% trans %}Health Dashboard{% endtrans %}
      </a>
      <a href="/admin/reports" class="action-btn action-btn--external">
        <span class="action-btn__icon">ğŸ“Š</span>
        {% trans %}Full Reports{% endtrans %}
      </a>
    </div>
  </div>

  {# Help & Data Sources Section #}
  {% if help_info or data_sources %}
  <div class="finops-section finops-help">
    <h2 class="finops-section__title">
      <span class="finops-section__icon">â„¹ï¸</span>
      {% trans %}About this Dashboard{% endtrans %}
    </h2>
    
    {# Setup Required Alert #}
    {% if data_sources.setup_required %}
    <div class="alert-card alert-card--warning" style="margin-bottom: 1rem;">
      <span class="alert-card__icon">âš ï¸</span>
      <div class="alert-card__content">
        <strong>{% trans %}Setup Required{% endtrans %}</strong>
        <p>{% trans %}Run the following command to enable real-time tracking:{% endtrans %}</p>
        <code style="display: block; margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 4px;">
          {{ data_sources.setup_command }}
        </code>
      </div>
    </div>
    {% endif %}
    
    {# Data Sources Table #}
    {% if data_sources.sources %}
    <div class="finops-help__sources">
      <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">{% trans %}Data Sources{% endtrans %}</h3>
      {# Diccionario de traducciones para keys de mÃ©trica #}
      {% set metric_labels = {
        'storage': 'Storage'|trans,
        'api_requests': 'API Requests'|trans,
        'cpu_hours': 'CPU Hours'|trans,
        'costs': 'Costs'|trans
      } %}
      <table class="table table--modern" style="margin-bottom: 1rem;">
        <thead>
          <tr>
            <th>{% trans %}Metric{% endtrans %}</th>
            <th>{% trans %}Type{% endtrans %}</th>
            <th>{% trans %}Description{% endtrans %}</th>
          </tr>
        </thead>
        <tbody>
          {% for key, source in data_sources.sources %}
          <tr>
            <td><strong>{{ metric_labels[key]|default(key|replace({'_': ' '})|capitalize) }}</strong></td>
            <td>
              <span class="tier-badge tier-badge--{% if source.type|render == 'Real' %}professional{% else %}basic{% endif %}">
                {{ source.type }}
              </span>
            </td>
            <td>{{ source.description }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}
    
    {# Pricing Info #}
    {% if help_info.pricing %}
    <div class="finops-help__pricing">
      <h3 style="font-size: 1rem; margin-bottom: 0.5rem;">{% trans %}Unit Pricing{% endtrans %}</h3>
      <div class="resource-cards" style="margin-bottom: 1rem;">
        <div class="resource-card">
          <div class="resource-card__header">
            <span class="resource-card__icon">ğŸ’¾</span>
            <span class="resource-card__title">{% trans %}Storage{% endtrans %}</span>
          </div>
          <div class="resource-card__value">{{ help_info.pricing.storage }}</div>
        </div>
        <div class="resource-card">
          <div class="resource-card__header">
            <span class="resource-card__icon">ğŸ”Œ</span>
            <span class="resource-card__title">{% trans %}API{% endtrans %}</span>
          </div>
          <div class="resource-card__value">{{ help_info.pricing.api }}</div>
        </div>
        <div class="resource-card">
          <div class="resource-card__header">
            <span class="resource-card__icon">âš¡</span>
            <span class="resource-card__title">{% trans %}CPU{% endtrans %}</span>
          </div>
          <div class="resource-card__value">{{ help_info.pricing.cpu }}</div>
        </div>
      </div>
    </div>
    {% endif %}
    
    {# Note #}
    {% if help_info.note %}
    <p class="finops-help__note" style="font-size: 0.875rem; color: var(--finops-text-muted, #94a3b8); margin: 0;">
      <span style="margin-right: 0.5rem;">ğŸ’¡</span>{{ help_info.note }}
    </p>
    {% endif %}
    
    {# Link to Settings #}
    {% if help_info.settings_url %}
    <div style="margin-top: 1rem;">
      <a href="{{ help_info.settings_url }}" class="action-btn action-btn--primary use-ajax" data-dialog-type="modal" data-dialog-options='{"width":700,"title":"FinOps Settings"}'>
        <span class="action-btn__icon">âš™ï¸</span>
        {% trans %}Configure Pricing{% endtrans %}
      </a>
    </div>
    {% endif %}
  </div>
  {% endif %}

</div>

