services:
  # BE-14: Este módulo registra 44+ servicios. Cada uno tiene responsabilidad
  # única (SRP) y están agrupados por dominio. La consolidación recomendada
  # es extraer a sub-módulos por dominio en Q2/Q3 2026:
  #   - ecosistema_jaraba_ai: AITelemetry, AIGuardrails, AICost, AIUsageLimit, AIAB, AIOps, AIValue
  #   - ecosistema_jaraba_finops: FinOpsTracking, TenantMetering, ExpansionRevenue
  #   - ecosistema_jaraba_onboarding: UserIntent, TTFV, GuidedTours, InAppMessaging, DemoInteractive
  #   - ecosistema_jaraba_marketplace: MarketplaceRecommendations, TenantCollaboration
  # Los servicios de tenant core (Manager, Context, Subscription, Domain, Theme)
  # permanecen aquí como infraestructura base.

  # ===========================================
  # THEME NEGOTIATOR - FORZAR TEMA FRONTEND EN USER PAGES
  # ===========================================

  # Negociador de tema para páginas de usuario
  # Fuerza el uso del tema frontend en lugar del admin theme
  ecosistema_jaraba_core.user_page_theme_negotiator:
    class: Drupal\ecosistema_jaraba_core\Theme\UserPageThemeNegotiator
    tags:
      - { name: theme_negotiator, priority: 1000 }

  # ===========================================
  # TWIG EXTENSION - HELPERS DE PLANTILLA
  # ===========================================

  # Extension de Twig con funciones personalizadas
  # Provee: jaraba_icon(category, name, options), jaraba_icon_path()
  ecosistema_jaraba_core.twig_extension:
    class: Drupal\ecosistema_jaraba_core\Twig\JarabaTwigExtension
    tags:
      - { name: twig.extension }

  # ===========================================
  # SERVICIOS CORE - GESTIÓN DE TENANTS
  # ===========================================

  # ===========================================
  # ALIASES → jaraba_billing (TD-003 God Object extraction)
  # Los servicios billing ahora viven en jaraba_billing module.
  # Aliases registrados condicionalmente en EcosistemaJarabaCoreServiceProvider
  # para evitar errores cuando jaraba_billing no está instalado.
  # ===========================================

  ecosistema_jaraba_core.tenant_domain:
    class: Drupal\ecosistema_jaraba_core\Service\TenantDomainService
    arguments:
      - '@entity_type.manager'

  ecosistema_jaraba_core.tenant_theme:
    class: Drupal\ecosistema_jaraba_core\Service\TenantThemeService
    arguments:
      - '@ecosistema_jaraba_core.tenant_manager'
      - '@ecosistema_jaraba_core.style_preset'

  # Servicio de resolución de Design Tokens con cascada 4 niveles
  # Platform → Vertical → Plan → Tenant. Genera CSS --ej-* custom properties.
  ecosistema_jaraba_core.style_preset:
    class: Drupal\ecosistema_jaraba_core\Service\StylePresetService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Servicio de aplicación de Style Presets a tenants (f-101/f-102)
  # Crea DesignTokenConfig scope=tenant a partir del preset seleccionado.
  ecosistema_jaraba_core.preset_applicator:
    class: Drupal\ecosistema_jaraba_core\Service\PresetApplicatorService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Gestor de Tenants (fachada que delega a servicios especializados)
  # plan_validator y tenant_subscription se inyectan condicionalmente
  # desde EcosistemaJarabaCoreServiceProvider cuando jaraba_billing está instalado.
  ecosistema_jaraba_core.tenant_manager:
    class: Drupal\ecosistema_jaraba_core\Service\TenantManager
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - ~
      - '@logger.channel.ecosistema_jaraba_core'
      - ~
      - '@ecosistema_jaraba_core.tenant_domain'

  # Servicio de Onboarding de Tenants
  # Gestiona el flujo de registro y activación de nuevos tenants
  ecosistema_jaraba_core.tenant_onboarding:
    class: Drupal\ecosistema_jaraba_core\Service\TenantOnboardingService
    arguments:
      - '@entity_type.manager'
      - '@ecosistema_jaraba_core.tenant_manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@plugin.manager.mail'

  # Servicio de Contexto de Tenant
  # Resuelve el tenant actual basado en el usuario logueado
  # Usado por el dashboard y otras páginas específicas del tenant
  ecosistema_jaraba_core.tenant_context:
    class: Drupal\ecosistema_jaraba_core\Service\TenantContextService
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'

  # TENANT-BRIDGE-001: Bridge entre Tenant entities (billing) y Group entities
  # (content isolation). Todo servicio que necesite resolver entre ambos DEBE
  # usar este servicio. NUNCA cargar getStorage('group') con IDs de Tenant.
  ecosistema_jaraba_core.tenant_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\TenantBridgeService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'


  # ===========================================
  # SERVICIOS DE TRAZABILIDAD Y FIRMA DIGITAL
  # ===========================================

  # Servicio de generación de certificados PDF
  ecosistema_jaraba_core.certificado_pdf:
    class: Drupal\ecosistema_jaraba_core\Service\CertificadoPdfService
    arguments:
      - '@file_system'
      - '@entity_type.manager'

  # Servicio de PDFs con marca del tenant (G117-3)
  # Genera facturas, certificados e informes aplicando identidad visual
  # del tenant (colores, logo, tipografías) desde TenantThemeConfig.
  ecosistema_jaraba_core.branded_pdf:
    class: Drupal\ecosistema_jaraba_core\Service\BrandedPdfService
    arguments:
      - '@file_system'
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Servicio de firma digital
  ecosistema_jaraba_core.firma_digital:
    class: Drupal\ecosistema_jaraba_core\Service\FirmaDigitalService
    arguments:
      - '@config.factory'
      - '@logger.factory'
      - '@file_system'

  # ===========================================
  # SERVICIOS DE PAGOS Y STRIPE CONNECT
  # ===========================================
  # Stripe Connect se gestiona en jaraba_foc.stripe_connect.
  # JarabaStripeConnect fue eliminado en v12.5.0 (TD-001).

  # ===========================================
  # LOGGING
  # ===========================================

  # Canal de logging para el módulo
  logger.channel.ecosistema_jaraba_core:
    parent: logger.channel_base
    arguments: ['ecosistema_jaraba_core']

  # ===========================================
  # IMPERSONATION SERVICE
  # ===========================================

  # Servicio de impersonación para "Login as" tenant
  ecosistema_jaraba_core.impersonation:
    class: Drupal\ecosistema_jaraba_core\Service\ImpersonationService
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - '@session_manager'
      - '@tempstore.private'
      - '@request_stack'
      - '@logger.channel.ecosistema_jaraba_core'


  # ===========================================
  # FINOPS - TRACKING DE USO POR TENANT
  # ===========================================

  # Servicio de tracking de métricas FinOps
  # Registra API requests, storage y CPU por tenant
  ecosistema_jaraba_core.finops_tracking:
    class: Drupal\ecosistema_jaraba_core\Service\FinOpsTrackingService
    arguments:
      - '@database'
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'

  # Event subscriber para tracking automático de requests
  # Se ejecuta en TERMINATE para no impactar performance
  ecosistema_jaraba_core.request_tracking_subscriber:
    class: Drupal\ecosistema_jaraba_core\EventSubscriber\RequestTrackingSubscriber
    arguments:
      - '@ecosistema_jaraba_core.finops_tracking'
      - '@ecosistema_jaraba_core.tenant_context'
    tags:
      - { name: event_subscriber }

  # SEC-08: Event subscriber para headers de seguridad (CORS, CSP, HSTS)
  # Configurable desde /admin/config/system/security-headers
  ecosistema_jaraba_core.security_headers_subscriber:
    class: Drupal\ecosistema_jaraba_core\EventSubscriber\SecurityHeadersSubscriber
    arguments:
      - '@config.factory'
    tags:
      - { name: event_subscriber }

  # ===========================================
  # AI TELEMETRY - MONITOREO DE AGENTES IA
  # ===========================================

  # Servicio de telemetría para agentes de IA
  # Registra latencia, tokens utilizados y costos por invocación
  ecosistema_jaraba_core.ai_telemetry:
    class: Drupal\ecosistema_jaraba_core\Service\AITelemetryService
    arguments:
      - '@database'
      - '@logger.factory'

  # ===========================================
  # TENANT ANALYTICS - GRÁFICOS DE TENDENCIAS
  # ===========================================

  # Servicio de analytics para el dashboard del tenant
  ecosistema_jaraba_core.tenant_analytics:
    class: Drupal\ecosistema_jaraba_core\Service\TenantAnalyticsService
    arguments:
      - '@database'
      - '@date.formatter'

  # ===========================================
  # ALERTING - SLACK/TEAMS WEBHOOKS
  # ===========================================

  # Servicio de alertas para Slack y Microsoft Teams
  ecosistema_jaraba_core.alerting:
    class: Drupal\ecosistema_jaraba_core\Service\AlertingService
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.factory'

  # ===========================================
  # PHASE 13: MARKETPLACE & NETWORK EFFECTS
  # ===========================================

  # Servicio de recomendaciones cross-tenant
  ecosistema_jaraba_core.marketplace_recommendations:
    class: Drupal\ecosistema_jaraba_core\Service\MarketplaceRecommendationService
    arguments:
      - '@database'
      - '@entity_type.manager'
      - '@current_user'

  # Servicio de colaboración tenant-to-tenant
  ecosistema_jaraba_core.tenant_collaboration:
    class: Drupal\ecosistema_jaraba_core\Service\TenantCollaborationService
    arguments:
      - '@database'
      - '@entity_type.manager'

  # ===========================================
  # Q2 2026: PREDICTIVE ONBOARDING (SPRINT 5-6)
  # ===========================================

  # Clasificador de intención de usuario con IA
  ecosistema_jaraba_core.user_intent_classifier:
    class: Drupal\ecosistema_jaraba_core\Service\UserIntentClassifierService
    arguments:
      - '@database'
      - '@current_user'

  # Métricas de Time-to-First-Value
  ecosistema_jaraba_core.ttfv:
    class: Drupal\ecosistema_jaraba_core\Service\TimeToFirstValueService
    arguments:
      - '@database'
      - '@current_user'

  # Tours guiados contextuales
  ecosistema_jaraba_core.guided_tours:
    class: Drupal\ecosistema_jaraba_core\Service\GuidedTourService
    arguments:
      - '@database'
      - '@current_user'

  # Mensajería in-app adaptativa
  ecosistema_jaraba_core.in_app_messaging:
    class: Drupal\ecosistema_jaraba_core\Service\InAppMessagingService
    arguments:
      - '@database'
      - '@current_user'

  # ===========================================
  # Q2 2026: EXPANSION LOOPS (SPRINT 7-8)
  # ===========================================

  # Monitoreo de límites de uso
  # Integra con UpgradeTriggerService (F2) para resolver limites por
  # FreemiumVerticalLimit ConfigEntity y disparar triggers de upgrade.
  ecosistema_jaraba_core.usage_limits:
    class: Drupal\ecosistema_jaraba_core\Service\UsageLimitsService
    arguments:
      - '@database'
      - '@entity_type.manager'
      - '@ecosistema_jaraba_core.upgrade_trigger'
      - '@logger.channel.ecosistema_jaraba_core'

  # Programa de referidos
  ecosistema_jaraba_core.referral_program:
    class: Drupal\ecosistema_jaraba_core\Service\ReferralProgramService
    arguments:
      - '@database'

  # Recomendaciones de pricing
  ecosistema_jaraba_core.pricing_recommendations:
    class: Drupal\ecosistema_jaraba_core\Service\PricingRecommendationService
    arguments:
      - '@database'

  # ===========================================
  # Q3 2026: AI OPERATIONS & RELIABILITY
  # ===========================================

  # Sprint 9-10: AI Monitoring Stack

  # Guardrails para validación de prompts IA (input + intermediate + output)
  # GAP-03: sanitizeRagContent() y sanitizeToolOutput() para prompt injection indirecto
  ecosistema_jaraba_core.ai_guardrails:
    class: Drupal\ecosistema_jaraba_core\Service\AIGuardrailsService
    arguments:
      - '@database'
      - '@config.factory'
      - '@logger.channel.ecosistema_jaraba_core'

  # A/B Testing de prompts
  ecosistema_jaraba_core.ai_ab_testing:
    class: Drupal\ecosistema_jaraba_core\Service\AIPromptABTestingService
    arguments:
      - '@database'

  # Sprint 11-12: Self-Healing & Game Day

  # Self-healing con runbooks automatizados
  ecosistema_jaraba_core.self_healing:
    class: Drupal\ecosistema_jaraba_core\Service\SelfHealingService
    arguments:
      - '@database'
      - '@logger.factory'

  # ===========================================
  # Q4 2026: MARKET EXPANSION & LEVEL 5.0
  # ===========================================

  # Sprint 13-14: Outcome-Based Pricing

  # Aliases → jaraba_billing (registrados en ServiceProvider)

  # Dashboard de valor generado por IA
  ecosistema_jaraba_core.ai_value_dashboard:
    class: Drupal\ecosistema_jaraba_core\Service\AIValueDashboardService
    arguments:
      - '@database'
      - '@cache.default'

  # Sprint 15-16: Level 5.0 Certification

  # AIOps con predicción de incidentes
  ecosistema_jaraba_core.aiops:
    class: Drupal\ecosistema_jaraba_core\Service\AIOpsService
    arguments:
      - '@database'
      - '@logger.factory'

  # ===========================================
  # Q1 2027: INSTANT VALUE (GAP P0)
  # ===========================================

  # Demo interactiva para Time-to-Value < 60s
  ecosistema_jaraba_core.demo_interactive:
    class: Drupal\ecosistema_jaraba_core\Service\DemoInteractiveService
    arguments:
      - '@entity_type.manager'
      - '@logger.factory'
      - '@state'

  # ===========================================
  # Q1 2027: REVERSE TRIAL MODEL (GAP P1)
  # ===========================================

  # Alias → jaraba_billing (registrado en ServiceProvider)

  # ===========================================
  # Q1 2027: AI AGENT AUTONOMY LEVELS (GAP P1)
  # ===========================================

  # Servicio de gestión de autonomía de agentes IA
  ecosistema_jaraba_core.agent_autonomy:
    class: Drupal\ecosistema_jaraba_core\Service\AgentAutonomyService
    arguments:
      - '@entity_type.manager'
      - '@logger.factory'
      - '@state'

  # ===========================================
  # Q1 2027: CONTEXTUAL AI COPILOT (GAP P2)
  # ===========================================

  # ===========================================
  # AVATAR DETECTION & NAVIGATION (Spec 20260120a Fase 3)
  # ===========================================

  # Servicio de deteccion unificada de avatar con cascada de 4 niveles:
  # Domain -> Path/UTM -> Group -> Rol. Resuelve avatar, vertical y confianza.
  ecosistema_jaraba_core.avatar_detection:
    class: Drupal\ecosistema_jaraba_core\Service\AvatarDetectionService
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - '@current_route_match'
      - '@request_stack'
      - '@logger.channel.ecosistema_jaraba_core'

  # Servicio de navegacion contextual por avatar.
  # Genera items de navegacion segun avatar detectado. Generaliza
  # EmployabilityMenuService para cubrir los 10 avatares del ecosistema.
  ecosistema_jaraba_core.avatar_navigation:
    class: Drupal\ecosistema_jaraba_core\Service\AvatarNavigationService
    arguments:
      - '@ecosistema_jaraba_core.avatar_detection'
      - '@current_route_match'
      - '@current_user'

  # Servicio de resolución de contexto para copilotos
  # Detecta dinámicamente avatar, vertical, plan y tenant del usuario
  ecosistema_jaraba_core.copilot_context:
    class: Drupal\ecosistema_jaraba_core\Service\CopilotContextService
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - '@current_route_match'
      - '@logger.channel.ecosistema_jaraba_core'

  # Servicio de copilot contextual embebido
  ecosistema_jaraba_core.contextual_copilot:
    class: Drupal\ecosistema_jaraba_core\Service\ContextualCopilotService
    arguments:
      - '@entity_type.manager'
      - '@current_route_match'
      - '@current_user'

  # ===========================================
  # Q1 2027: MICRO-AUTOMATIONS (INVISIBLE AI)
  # ===========================================

  # Servicio de automatizaciones invisibles
  ecosistema_jaraba_core.micro_automation:
    class: Drupal\ecosistema_jaraba_core\Service\MicroAutomationService
    arguments:
      - '@entity_type.manager'
      - '@logger.factory'
      - '@state'

  # Alias para autowiring de MicroAutomationService en Hook classes (D11 #[Hook])
  Drupal\ecosistema_jaraba_core\Service\MicroAutomationService:
    alias: ecosistema_jaraba_core.micro_automation

  # BE-09: Hook class registrada como servicio con inyección explícita.
  # Drupal 11 #[Hook] requiere que la clase sea un servicio para resolver DI.
  Drupal\ecosistema_jaraba_core\Hook\NodePresaveHooks:
    arguments:
      - '@ecosistema_jaraba_core.micro_automation'
      - '@logger.channel.ecosistema_jaraba_core'

  # BE-09: Hook class para page_attachments_alter con DI explícita.
  # Inyecta Design Tokens CSS + PWA meta tags + premium admin styles.
  Drupal\ecosistema_jaraba_core\Hook\PageAttachmentsHooks:
    arguments:
      - '@path.current'
      - '@ecosistema_jaraba_core.style_preset'
      - '@ecosistema_jaraba_core.tenant_context'

  # ===========================================
  # Q1 2027: AI COST OPTIMIZATION (FinOps for AI)
  # ===========================================

  # Servicio de optimización de costos de IA
  ecosistema_jaraba_core.ai_cost_optimization:
    class: Drupal\ecosistema_jaraba_core\Service\AICostOptimizationService
    arguments:
      - '@state'
      - '@logger.factory'

  # ===========================================
  # Q1 2027: EXPANSION REVENUE TRACKING
  # ===========================================

  # Alias → jaraba_billing (registrado en ServiceProvider)

  # ===========================================
  # Q1 2027: VIDEO CONTENT GEO
  # ===========================================

  # Servicio de Video GEO (Schema.org, YouTube, Transcripciones)
  ecosistema_jaraba_core.video_geo:
    class: Drupal\ecosistema_jaraba_core\Service\VideoGeoService

  # ===========================================
  # Q1 2027: MULTILINGUAL GEO
  # ===========================================

  # Servicio de GEO multilingüe (hreflang, Answer Capsules)
  ecosistema_jaraba_core.multilingual_geo:
    class: Drupal\ecosistema_jaraba_core\Service\MultilingualGeoService

  # ===========================================
  # Q1 2027: TIME-TO-VALUE - SANDBOX TEMPORAL
  # ===========================================

  # Servicio de sandbox temporal para demo sin registro
  ecosistema_jaraba_core.sandbox_tenant:
    class: Drupal\ecosistema_jaraba_core\Service\SandboxTenantService
    arguments:
      - '@entity_type.manager'
      - '@state'
      - '@logger.factory'

  # ===========================================
  # Q1 2027: RATE LIMITING (Best Practices Gap)
  # ===========================================

  # Servicio de rate limiting para protección de APIs críticas
  ecosistema_jaraba_core.rate_limiter:
    class: Drupal\ecosistema_jaraba_core\Service\RateLimiterService
    arguments:
      - '@cache.default'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@config.factory'

  # ===========================================
  # Q1 2027: CRÉDITOS DE IMPACTO (ECA Flows)
  # ===========================================

  # Alias → jaraba_billing (registrado en ServiceProvider)

  # ===========================================
  # Q1 2027: AI USAGE LIMITS (Per Tenant/Plan)
  # ===========================================

  # Servicio de verificación de límites de uso de IA por tenant/plan
  # Implementa warning (80%) y bloqueo (100%) con mensaje de upgrade
  ecosistema_jaraba_core.ai_usage_limit:
    class: Drupal\ecosistema_jaraba_core\Service\AIUsageLimitService
    arguments:
      - '@config.factory'
      - '@state'

  # ===========================================
  # Q1 2027: UNIFIED PROMPT BUILDER (AI Trilogy)
  # ===========================================

  # ===========================================
  # AUDIT LOG & COMPLIANCE (G115-1, G115-2)
  # ===========================================

  # Servicio centralizado de audit logging
  ecosistema_jaraba_core.audit_log:
    class: Drupal\ecosistema_jaraba_core\Service\AuditLogService
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - '@request_stack'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # USAGE ANOMALY DETECTION (G111-3)
  # ===========================================

  # Detector de anomalías de uso con media móvil y desviación estándar
  ecosistema_jaraba_core.usage_anomaly_detector:
    class: Drupal\ecosistema_jaraba_core\Service\UsageAnomalyDetectorService
    arguments:
      - '@database'
      - '@config.factory'
      - '@ecosistema_jaraba_core.alerting'
      - '@ecosistema_jaraba_core.audit_log'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@entity_type.manager'

  # ===========================================
  # RESELLER COMMISSION SERVICE (G117-4)
  # ===========================================

  # Servicio de calculo de comisiones para resellers/partners
  ecosistema_jaraba_core.reseller_commission:
    class: Drupal\ecosistema_jaraba_core\Service\ResellerCommissionService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # PUSH NOTIFICATIONS (G109-3)
  # ===========================================

  # Servicio de notificaciones push Web Push (RFC 8030)
  ecosistema_jaraba_core.platform_push:
    class: Drupal\ecosistema_jaraba_core\Service\PlatformPushService
    arguments:
      - '@entity_type.manager'
      - '@http_client'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@config.factory'

  # Constructor de prompts unificados para agentes IA.
  # Registrado condicionalmente via EcosistemaJarabaCoreServiceProvider
  # solo cuando jaraba_skills y jaraba_tenant_knowledge están instalados.

  # ===========================================
  # BADGE AWARD SERVICE (G110-3)
  # ===========================================

  # Servicio de otorgamiento de insignias (gamificación)
  # Gestiona asignación, revocación y evaluación automática de badges
  ecosistema_jaraba_core.badge_award:
    class: Drupal\ecosistema_jaraba_core\Service\BadgeAwardService
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # UPGRADE TRIGGER SERVICE (F2 - Doc 183)
  # ===========================================

  # Servicio central de triggers de upgrade para el modelo freemium.
  # Evalua limites por vertical, dispara triggers contextuales y
  # registra eventos para analytics de conversion PLG.
  ecosistema_jaraba_core.upgrade_trigger:
    class: Drupal\ecosistema_jaraba_core\Service\UpgradeTriggerService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # EMPLOYABILITY FEATURE GATE (Plan Elevación Empleabilidad v1 — Fase 4)
  # ===========================================

  # Feature gating por plan para el vertical Empleabilidad.
  # Verifica limites de uso diario (cv_builder, job_applications_per_day,
  # copilot_messages_per_day, job_alerts, offers_visible_per_day, diagnostics)
  # consultando FreemiumVerticalLimit y tabla empleabilidad_feature_usage.
  ecosistema_jaraba_core.employability_feature_gate:
    class: Drupal\ecosistema_jaraba_core\Service\EmployabilityFeatureGateService
    arguments:
      - '@ecosistema_jaraba_core.upgrade_trigger'
      - '@database'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.tenant_context'

  # ===========================================
  # EMPRENDIMIENTO FEATURE GATE (Plan Elevación Emprendimiento v1 — Fase 4)
  # ===========================================

  # Feature gating por plan para el vertical Emprendimiento.
  # Verifica limites de uso diario (hypotheses_active, experiments_monthly,
  # copilot_sessions_daily, mentoring_sessions_monthly, bmc_drafts, calculadora_uses)
  # consultando FreemiumVerticalLimit y tabla emprendimiento_feature_usage.
  ecosistema_jaraba_core.emprendimiento_feature_gate:
    class: Drupal\ecosistema_jaraba_core\Service\EmprendimientoFeatureGateService
    arguments:
      - '@ecosistema_jaraba_core.upgrade_trigger'
      - '@database'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.tenant_context'

  # ===========================================
  # ANDALUCÍA +EI FEATURE GATE (Plan Elevación Andalucía +ei v1 — Fase 4)
  # ===========================================

  # Feature gating por plan para el vertical Andalucía +ei.
  # Verifica limites de uso diario (copilot_sessions_daily, mentoring_hours_monthly,
  # sto_exports, training_modules, diagnostic_access, report_downloads)
  # consultando FreemiumVerticalLimit y tabla andalucia_ei_feature_usage.
  ecosistema_jaraba_core.andalucia_ei_feature_gate:
    class: Drupal\ecosistema_jaraba_core\Service\AndaluciaEiFeatureGateService
    arguments:
      - '@ecosistema_jaraba_core.upgrade_trigger'
      - '@database'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.tenant_context'

  # ===========================================
  # JARABALEX FEATURE GATE (Plan Elevación JarabaLex v1 — Fase 4)
  # ===========================================

  # Feature gating por plan para el vertical JarabaLex.
  # Verifica limites de uso diario (searches_per_month, max_alerts,
  # max_bookmarks, citation_insert, digest_access, api_access)
  # consultando FreemiumVerticalLimit y tabla jarabalex_feature_usage.
  ecosistema_jaraba_core.jarabalex_feature_gate:
    class: Drupal\ecosistema_jaraba_core\Service\JarabaLexFeatureGateService
    arguments:
      - '@ecosistema_jaraba_core.upgrade_trigger'
      - '@database'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.tenant_context'

  # Plan Elevación JarabaLex v1 — Fase 6: Email Sequences.
  ecosistema_jaraba_core.jarabalex_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\JarabaLexEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevación JarabaLex v1 — Fase 10: Health Scores.
  ecosistema_jaraba_core.jarabalex_health_score:
    class: Drupal\ecosistema_jaraba_core\Service\JarabaLexHealthScoreService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevación JarabaLex v1 — Fase 9: Journey Progression.
  ecosistema_jaraba_core.jarabalex_journey_progression:
    class: Drupal\ecosistema_jaraba_core\Service\JarabaLexJourneyProgressionService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@datetime.time'
      - '@state'
      - '@?ecosistema_jaraba_core.jarabalex_feature_gate'

  # Plan Elevación JarabaLex v1 — Fase 8: Cross-Vertical Bridges.
  ecosistema_jaraba_core.jarabalex_cross_vertical_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\JarabaLexCrossVerticalBridgeService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # EMPRENDIMIENTO EXPERIMENT SERVICE (Plan Elevación Emprendimiento v1 — Fase 4)
  # ===========================================

  # Servicio de experimentacion A/B para el vertical Emprendimiento.
  # Integra con jaraba_ab_testing para gestionar experimentos especificos
  # del vertical (onboarding, conversion, engagement).
  ecosistema_jaraba_core.emprendimiento_experiment:
    class: Drupal\ecosistema_jaraba_core\Service\EmprendimientoExperimentService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # EMPLOYABILITY EMAIL SEQUENCES (Plan Elevación Empleabilidad v1 — Fase 6)
  # ===========================================

  # Servicio de email sequences automatizadas para el vertical Empleabilidad.
  # Gestiona 5 secuencias del ciclo de vida del candidato:
  # SEQ_EMP_001 (Onboarding), SEQ_EMP_002 (Re-engagement),
  # SEQ_EMP_003 (Upsell Free→Starter), SEQ_EMP_004 (Post-Entrevista),
  # SEQ_EMP_005 (Retention Post-Empleo).
  # Resuelve jaraba_email.sequence_manager en runtime (sin hard dependency).
  ecosistema_jaraba_core.employability_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\EmployabilityEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # EMPLOYABILITY JOURNEY PROGRESSION (Plan Elevación Empleabilidad v1 — Fase 9)
  # ===========================================

  # Servicio de progresión proactiva del journey de Empleabilidad.
  # Evalúa 7 triggers proactivos basados en estado del journey, actividad
  # y perfil del candidato. Dispara acciones en FAB, email y push.
  # Reglas: inactivity_discovery, incomplete_profile, ready_but_inactive,
  # application_frustration, interview_prep, offer_negotiation, post_employment.
  ecosistema_jaraba_core.employability_journey_progression:
    class: Drupal\ecosistema_jaraba_core\Service\EmployabilityJourneyProgressionService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@datetime.time'
      - '@state'
      - '@module_handler'
      - '@?jaraba_candidate.profile_completion'

  # ===========================================
  # EMPLOYABILITY HEALTH SCORE (Plan Elevación Empleabilidad v1 — Fase 10)
  # ===========================================

  # Servicio de health score específico del vertical Empleabilidad.
  # 5 dimensiones: profile_completeness (25%), application_activity (30%),
  # copilot_engagement (15%), training_progress (15%), credential_advancement (15%).
  # 8 KPIs verticales: insertion_rate, time_to_employment, activation_rate,
  # engagement_rate, nps, arpu, conversion_free_paid, churn_rate.
  ecosistema_jaraba_core.employability_health_score:
    class: Drupal\ecosistema_jaraba_core\Service\EmployabilityHealthScoreService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # EMPLOYABILITY CROSS-VERTICAL BRIDGES (Plan Elevación Empleabilidad v1 — Fase 8)
  # ===========================================

  # Servicio de bridges de valor cross-vertical para Empleabilidad.
  # Evalúa y presenta bridges hacia Emprendimiento, Servicios, Formación
  # y Comercio basados en el estado del journey del candidato.
  # Condiciones: time_in_state_90_days, has_freelance_skills,
  # recently_hired, verified_employer.
  ecosistema_jaraba_core.employability_cross_vertical_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\EmployabilityCrossVerticalBridgeService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # LEAD MAGNET EMAIL SERVICE (F3 Doc 178)
  # ===========================================

  # Servicio de envio de emails para lead magnets publicos.
  # Genera cuerpo HTML personalizado por tipo de lead magnet y envia via MailManager.
  ecosistema_jaraba_core.lead_magnet_email:
    class: Drupal\ecosistema_jaraba_core\Service\LeadMagnetEmailService
    arguments:
      - '@plugin.manager.mail'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@config.factory'

  # ===========================================
  # LEAD MAGNET PDF SERVICE (F3 Doc 178)
  # ===========================================

  # Servicio de generacion de HTML print-ready para descarga como PDF.
  # Genera documentos profesionales para Guia AgroConecta y Template
  # Propuesta ServiciosConecta con CSS @media print optimizado.
  ecosistema_jaraba_core.lead_magnet_pdf:
    class: Drupal\ecosistema_jaraba_core\Service\LeadMagnetPdfService
    arguments:
      - '@renderer'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # SEO AUDIT SERVICE (F3 Doc 178 - ComercioConecta)
  # ===========================================

  # Servicio de auditoria SEO basica para el lead magnet de ComercioConecta.
  # Analiza URLs publicas evaluando titulo, meta description, H1, imagenes,
  # HTTPS, viewport, Open Graph, canonical y Schema.org. Score 0-100.
  ecosistema_jaraba_core.seo_audit:
    class: Drupal\ecosistema_jaraba_core\Service\SeoAuditService
    arguments:
      - '@http_client'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # GDPR DRUSH COMMANDS
  # ===========================================

  # Comandos Drush para cumplimiento RGPD/GDPR
  # gdpr:export (Art. 15), gdpr:anonymize (Art. 17), gdpr:report
  ecosistema_jaraba_core.gdpr_commands:
    class: Drupal\ecosistema_jaraba_core\Commands\GdprCommands
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.audit_log'
    tags:
      - { name: drush.command }

  # ===========================================
  # ADMIN CENTER AGGREGATOR (F6 Doc 181 / Spec f104)
  # ===========================================

  # Servicio centralizador de KPIs para el Admin Center Premium.
  # Agrega metricas de FOC (MRR, ARR), Customer Success (Health Scores),
  # tenants, MAU y alertas. Los servicios de modulos opcionales
  # (jaraba_foc, jaraba_customer_success) se inyectan condicionalmente
  # via EcosistemaJarabaCoreServiceProvider.
  ecosistema_jaraba_core.admin_center_aggregator:
    class: Drupal\ecosistema_jaraba_core\Service\AdminCenterAggregatorService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'
      - ~
      - ~
      - '@ecosistema_jaraba_core.fiscal_compliance'

  # ===========================================
  # ADMIN CENTER FINANCE (F6 Doc 181 / Spec f104 §FASE 4)
  # ===========================================

  # Agregador financiero para el Centro Financiero del Admin Center.
  # Envuelve jaraba_foc.saas_metrics y jaraba_foc.metrics_calculator.
  ecosistema_jaraba_core.admin_center_finance:
    class: Drupal\ecosistema_jaraba_core\Service\AdminCenterFinanceService
    arguments:
      - '@logger.channel.ecosistema_jaraba_core'
      - ~
      - ~

  # ===========================================
  # ADMIN CENTER ANALYTICS (F6 Doc 181 / Spec f104 §FASE 6)
  # ===========================================

  # Agregador de analytics y logs para el Admin Center.
  # Envuelve TenantAnalyticsService, AITelemetryService, AuditLog y watchdog.
  ecosistema_jaraba_core.admin_center_analytics:
    class: Drupal\ecosistema_jaraba_core\Service\AdminCenterAnalyticsService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'
      - ~

  # ===========================================
  # ADMIN CENTER ALERTS (F6 Doc 181 / Spec f104 §FASE 5)
  # ===========================================

  # Agregador de alertas y playbooks para el Admin Center.
  # Envuelve jaraba_foc.alerts y jaraba_customer_success.playbook_executor.
  ecosistema_jaraba_core.admin_center_alerts:
    class: Drupal\ecosistema_jaraba_core\Service\AdminCenterAlertService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - ~
      - ~

  # ===========================================
  # ADMIN CENTER SETTINGS (F6 Doc 181 / Spec f104 §FASE 7)
  # ===========================================

  # Configuración global de la plataforma: General, Planes, Integraciones, API Keys.
  ecosistema_jaraba_core.admin_center_settings:
    class: Drupal\ecosistema_jaraba_core\Service\AdminCenterSettingsService
    arguments:
      - '@config.factory'
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # ADMIN STRUCTURE UX OVERRIDE
  # ===========================================

  # RouteSubscriber que reemplaza la página /admin/structure plana
  # del core por una versión categorizada con búsqueda y filtros.
  ecosistema_jaraba_core.admin_structure_route_subscriber:
    class: Drupal\ecosistema_jaraba_core\Routing\AdminStructureRouteSubscriber
    tags:
      - { name: event_subscriber }

  # ===========================================
  # EMPRENDIMIENTO HEALTH SCORE (Plan Elevación Emprendimiento v2 — Fase 1 G1)
  # ===========================================

  # Servicio de health score específico del vertical Emprendimiento.
  # 5 dimensiones: canvas_completeness (25%), hypothesis_validation (30%),
  # experiment_velocity (15%), copilot_engagement (15%), funding_readiness (15%).
  # 8 KPIs verticales: startup_survival_rate, time_to_mvp, hypothesis_validation_rate,
  # activation_rate, mentor_engagement, nps, arpu, conversion_free_paid.
  ecosistema_jaraba_core.emprendimiento_health_score:
    class: Drupal\ecosistema_jaraba_core\Service\EmprendimientoHealthScoreService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # EMPRENDIMIENTO JOURNEY PROGRESSION (Plan Elevación Emprendimiento v2 — Fase 2 G2)
  # ===========================================

  # Servicio de progresión proactiva del journey de Emprendimiento.
  # Evalúa 7 triggers proactivos basados en estado del journey, actividad
  # y perfil del emprendedor. Dispara acciones en FAB, email y push.
  # Reglas: inactivity_discovery, canvas_incomplete, hypothesis_stalled,
  # all_killed_no_pivot, mvp_validated_no_mentor, funding_eligible,
  # post_scaling_expansion.
  ecosistema_jaraba_core.emprendimiento_journey_progression:
    class: Drupal\ecosistema_jaraba_core\Service\EmprendimientoJourneyProgressionService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@datetime.time'
      - '@state'
      - '@module_handler'
      - '@?jaraba_copilot_v2.bmc_validation'
      - '@?jaraba_funding.matching_engine'

  # ===========================================
  # EMPRENDIMIENTO EMAIL SEQUENCES (Plan Elevación Emprendimiento v2 — Fase 3 G3)
  # ===========================================

  # Servicio de email sequences automatizadas para el vertical Emprendimiento.
  # Gestiona 5 secuencias del ciclo de vida del emprendedor:
  # SEQ_ENT_001 (Onboarding Fundador), SEQ_ENT_002 (Canvas Abandonment),
  # SEQ_ENT_003 (Upsell Free→Starter), SEQ_ENT_004 (MVP Celebration),
  # SEQ_ENT_005 (Retention Post-Funding).
  ecosistema_jaraba_core.emprendimiento_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\EmprendimientoEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # ANDALUCÍA +EI EMAIL SEQUENCES (Plan Elevación Andalucía +ei v1 — Fase 5)
  # ===========================================

  # Servicio de email sequences automatizadas para el vertical Andalucía +ei.
  # Gestiona 6 secuencias del ciclo de vida del participante:
  # SEQ_AEI_001 (Welcome Participant), SEQ_AEI_002 (Phase Transition),
  # SEQ_AEI_003 (Hours Milestone), SEQ_AEI_004 (Training Completion),
  # SEQ_AEI_005 (Inactivity Reengagement), SEQ_AEI_006 (Upsell Free→Starter).
  ecosistema_jaraba_core.andalucia_ei_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\AndaluciaEiEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # EMPRENDIMIENTO CROSS-VERTICAL BRIDGES (Plan Elevación Emprendimiento v2 — Fase 5 G5)
  # ===========================================

  # Servicio de bridges de valor cross-vertical para Emprendimiento.
  # Evalúa y presenta bridges hacia Formación, Servicios y Comercio
  # basados en el estado del journey del emprendedor.
  # Condiciones: scaling_needs_team_skills, needs_outsource_mvp,
  # has_product_post_mvp.
  ecosistema_jaraba_core.emprendimiento_cross_vertical_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\EmprendimientoCrossVerticalBridgeService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # ANDALUCÍA +EI EXPERIMENT SERVICE (Plan Elevación Andalucía +ei v1 — Fase 11)
  # ===========================================

  # Servicio de experimentacion A/B para el vertical Andalucía +ei.
  # Integra con jaraba_ab_testing para gestionar experimentos especificos
  # del vertical (onboarding, copilot engagement, transition funnel, upgrade).
  # 8 eventos de conversion: participant_enrolled, first_ia_session,
  # diagnostic_completed, training_10h, training_50h, orientation_10h,
  # phase_insertion, plan_upgraded.
  ecosistema_jaraba_core.andalucia_ei_experiment:
    class: Drupal\ecosistema_jaraba_core\Service\AndaluciaEiExperimentService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # ANDALUCÍA +EI CROSS-VERTICAL BRIDGES (Plan Elevación Andalucía +ei v1 — Fase 6)
  # ===========================================

  # Servicio de bridges de valor cross-vertical para Andalucía +ei.
  # Evalúa y presenta bridges hacia Emprendimiento, Empleabilidad, Servicios y Formación
  # basados en el estado del participante EI.
  # Condiciones: insertion_plus_entrepreneur_interest, no_insertion_90_days,
  # digital_skills_track, recently_inserted.
  ecosistema_jaraba_core.andalucia_ei_cross_vertical_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\AndaluciaEiCrossVerticalBridgeService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # ANDALUCÍA +EI JOURNEY PROGRESSION (Plan Elevación Andalucía +ei v1 — Fase 7)
  # ===========================================

  # Servicio de progresión proactiva del journey para Andalucía +ei.
  # Evalúa 8 reglas proactivas del copilot FAB basadas en la fase y
  # estado del participante: inactividad IA, horas formación bajas,
  # hitos de orientación/formación, preparación inserción, etc.
  ecosistema_jaraba_core.andalucia_ei_journey_progression:
    class: Drupal\ecosistema_jaraba_core\Service\AndaluciaEiJourneyProgressionService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@datetime.time'
      - '@state'
      - '@?jaraba_andalucia_ei.fase_transition_manager'

  # ===========================================
  # COMPLIANCE AGGREGATOR — STACK COMPLIANCE LEGAL N1 (FASE 12)
  # ===========================================

  # Servicio agregador de KPIs de compliance cross-modulo.
  # Agrega metricas de jaraba_privacy, jaraba_legal y jaraba_dr.
  # Los 9 servicios satelite se inyectan condicionalmente (~NULL)
  # via EcosistemaJarabaCoreServiceProvider cuando los modulos
  # no estan instalados.
  ecosistema_jaraba_core.compliance_aggregator:
    class: Drupal\ecosistema_jaraba_core\Service\ComplianceAggregatorService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - ~
      - ~
      - ~
      - ~
      - ~
      - ~
      - ~
      - ~
      - ~

  # ===========================================
  # FISCAL COMPLIANCE SERVICE — STACK FISCAL (FASE 11)
  # ===========================================

  # Servicio de compliance score fiscal unificado (0-100) por tenant.
  # Calcula score basado en 5 subfactores: cadena VeriFactu intacta,
  # remisiones AEAT al dia, certificados vigentes, FACe sin rechazos,
  # morosidad B2B controlada. Servicios opcionales de modulos fiscales
  # se inyectan condicionalmente via EcosistemaJarabaCoreServiceProvider.
  ecosistema_jaraba_core.fiscal_compliance:
    class: Drupal\ecosistema_jaraba_core\Service\FiscalComplianceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - ~
      - ~
      - ~
      - ~
      - ~

  # ===========================================
  # CERTIFICATE MANAGER — STACK FISCAL (FASE 0)
  # ===========================================

  # Servicio centralizado de gestion de certificados digitales PKCS#12.
  # Compartido por jaraba_verifactu, jaraba_facturae y jaraba_einvoice_b2b.
  # Almacena en private://certificates/{tenant_id}/ con lock para concurrencia.
  ecosistema_jaraba_core.certificate_manager:
    class: Drupal\ecosistema_jaraba_core\Service\CertificateManagerService
    arguments:
      - '@file_system'
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@lock'

  # ===========================================
  # ANDALUCÍA +EI HEALTH SCORES & KPIS (Plan Elevación Andalucía +ei v1 — Fase 8)
  # ===========================================

  # Servicio de puntuación de salud y KPIs verticales para Andalucía +ei.
  # Calcula health score por usuario (5 dimensiones ponderadas) y
  # 8 KPIs agregados del vertical (insertion_rate, time_to_insertion,
  # training_completion_rate, ia_engagement_rate, sto_sync_success_rate,
  # participant_nps, conversion_free_paid, churn_rate).
  ecosistema_jaraba_core.andalucia_ei_health_score:
    class: Drupal\ecosistema_jaraba_core\Service\AndaluciaEiHealthScoreService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # AGROCONECTA FEATURE GATE (Plan Elevación AgroConecta Clase Mundial v1 — Fase 0)
  # ===========================================

  # Feature gating por plan para el vertical AgroConecta.
  # Verifica limites de uso (products, orders_per_month,
  # copilot_uses_per_month, photos_per_product, commission_pct,
  # traceability_qr, partner_hub, analytics_advanced, demand_forecaster)
  # consultando FreemiumVerticalLimit y tabla agroconecta_feature_usage.
  ecosistema_jaraba_core.agroconecta_feature_gate:
    class: Drupal\ecosistema_jaraba_core\Service\AgroConectaFeatureGateService
    arguments:
      - '@ecosistema_jaraba_core.upgrade_trigger'
      - '@database'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.tenant_context'

  # Plan Elevacion AgroConecta Clase Mundial v1 — Fase 7: Email Sequences.
  ecosistema_jaraba_core.agroconecta_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\AgroConectaEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion AgroConecta Clase Mundial v1 — Fase 8: CrossVerticalBridge.
  ecosistema_jaraba_core.agroconecta_cross_vertical_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\AgroConectaCrossVerticalBridgeService
    arguments:
      - '@entity_type.manager'
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion AgroConecta Clase Mundial v1 — Fase 9: Journey Progression.
  ecosistema_jaraba_core.agroconecta_journey_progression:
    class: Drupal\ecosistema_jaraba_core\Service\AgroConectaJourneyProgressionService
    arguments:
      - '@entity_type.manager'
      - '@state'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion AgroConecta Clase Mundial v1 — Fase 10: Health Score.
  ecosistema_jaraba_core.agroconecta_health_score:
    class: Drupal\ecosistema_jaraba_core\Service\AgroConectaHealthScoreService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@datetime.time'
      - '@state'
      - '@?ecosistema_jaraba_core.agroconecta_feature_gate'
      - '@?jaraba_customer_success.nps_survey'

  # Plan Elevacion AgroConecta Clase Mundial v1 — Fase 11: Experiment Service.
  ecosistema_jaraba_core.agroconecta_experiment:
    class: Drupal\ecosistema_jaraba_core\Service\AgroConectaExperimentService
    arguments:
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # COMERCIOCONECTA FEATURE GATE (Plan Elevacion ComercioConecta Clase Mundial v1 — Fase 1)
  # ===========================================

  # Feature gating por plan para el vertical ComercioConecta.
  # Verifica limites de uso (products, flash_offers_active,
  # copilot_uses_per_month, qr_codes, seo_local_audit,
  # analytics_advanced, pos_integration)
  # consultando FreemiumVerticalLimit y tabla comercioconecta_feature_usage.
  ecosistema_jaraba_core.comercioconecta_feature_gate:
    class: Drupal\ecosistema_jaraba_core\Service\ComercioConectaFeatureGateService
    arguments:
      - '@ecosistema_jaraba_core.upgrade_trigger'
      - '@database'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.tenant_context'

  # Plan Elevacion ComercioConecta Clase Mundial v1 — Fase 14: Email Sequences.
  ecosistema_jaraba_core.comercioconecta_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\ComercioConectaEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # COMERCIOCONECTA CROSS-VERTICAL BRIDGE (Plan Elevacion ComercioConecta Clase Mundial v1 — Fase 15)
  # ===========================================

  # Bridges contextuales hacia emprendimiento, fiscal, formacion,
  # empleabilidad y agroconecta.
  ecosistema_jaraba_core.comercioconecta_cross_vertical_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\ComercioConectaCrossVerticalBridgeService
    arguments:
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # COMERCIOCONECTA JOURNEY PROGRESSION (Plan Elevacion ComercioConecta Clase Mundial v1 — Fase 16)
  # ===========================================

  # Reglas proactivas de progresion para comerciantes y compradores.
  ecosistema_jaraba_core.comercioconecta_journey_progression:
    class: Drupal\ecosistema_jaraba_core\Service\ComercioConectaJourneyProgressionService
    arguments:
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@datetime.time'
      - '@entity_type.manager'
      - '@?ecosistema_jaraba_core.comercioconecta_feature_gate'

  # ===========================================
  # COMERCIOCONECTA HEALTH SCORE (Plan Elevacion ComercioConecta Clase Mundial v1 — Fase 16)
  # ===========================================

  # Calcula salud del comerciante (5 dimensiones, 8 KPIs).
  ecosistema_jaraba_core.comercioconecta_health_score:
    class: Drupal\ecosistema_jaraba_core\Service\ComercioConectaHealthScoreService
    arguments:
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # COMERCIOCONECTA EXPERIMENT SERVICE (Plan Elevacion ComercioConecta Clase Mundial v1 — Fase 17)
  # ===========================================

  # A/B testing para checkout CTA, product cards, pricing, hero copy, flash offers.
  ecosistema_jaraba_core.comercioconecta_experiment:
    class: Drupal\ecosistema_jaraba_core\Service\ComercioConectaExperimentService
    arguments:
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # SERVICIOSCONECTA FEATURE GATE (Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 0)
  # ===========================================

  # Feature gating por plan para el vertical ServiciosConecta.
  # Verifica limites de uso (services, bookings_per_month,
  # calendar_sync, buzon_confianza, firma_digital, ai_triage,
  # video_conferencing, analytics_dashboard)
  # consultando FreemiumVerticalLimit y tabla serviciosconecta_feature_usage.
  ecosistema_jaraba_core.serviciosconecta_feature_gate:
    class: Drupal\ecosistema_jaraba_core\Service\ServiciosConectaFeatureGateService
    arguments:
      - '@ecosistema_jaraba_core.upgrade_trigger'
      - '@database'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.tenant_context'

  # ===========================================
  # SERVICIOSCONECTA COPILOT BRIDGE (Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 2)
  # ===========================================

  # Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 2: CopilotBridge.
  ecosistema_jaraba_core.serviciosconecta_copilot_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\ServiciosConectaCopilotBridgeService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 7: Email Sequences.
  ecosistema_jaraba_core.serviciosconecta_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\ServiciosConectaEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 8: CrossVerticalBridge.
  ecosistema_jaraba_core.serviciosconecta_cross_vertical_bridge:
    class: Drupal\ecosistema_jaraba_core\Service\ServiciosConectaCrossVerticalBridgeService
    arguments:
      - '@entity_type.manager'
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 9: Journey Progression.
  ecosistema_jaraba_core.serviciosconecta_journey_progression:
    class: Drupal\ecosistema_jaraba_core\Service\ServiciosConectaJourneyProgressionService
    arguments:
      - '@entity_type.manager'
      - '@state'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 10: Health Score.
  ecosistema_jaraba_core.serviciosconecta_health_score:
    class: Drupal\ecosistema_jaraba_core\Service\ServiciosConectaHealthScoreService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 11: Copilot Agent.
  ecosistema_jaraba_core.serviciosconecta_copilot_agent:
    class: Drupal\ecosistema_jaraba_core\Service\ServiciosConectaCopilotAgent
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Plan Elevacion ServiciosConecta Clase Mundial v1 — Fase 12: Experiment Service.
  ecosistema_jaraba_core.serviciosconecta_experiment:
    class: Drupal\ecosistema_jaraba_core\Service\ServiciosConectaExperimentService
    arguments:
      - '@state'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # PLAN RESOLVER SERVICE (Precios Configurables v2.1)
  # ===========================================
  # Central broker for plan tier resolution, features and limits.
  # Reads from SaasPlanTier and SaasPlanFeatures ConfigEntities.
  # Cascade: specific vertical+tier → _default tier → NULL.
  ecosistema_jaraba_core.plan_resolver:
    class: Drupal\ecosistema_jaraba_core\Service\PlanResolverService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # META-SITE PRICING SERVICE (178_MetaSite_Remediation)
  # ===========================================

  # Servicio de datos de pricing para el meta-sitio público.
  # Lee de SaasPlanTier y SaasPlanFeatures vía PlanResolverService cascade
  # para generar datos listos para presentación en landing pages y /planes.
  # Incluye fallbacks hardcoded para entornos sin ConfigEntities.
  ecosistema_jaraba_core.metasite_pricing:
    class: Drupal\ecosistema_jaraba_core\Service\MetaSitePricingService
    arguments:
      - '@entity_type.manager'
      - '@ecosistema_jaraba_core.plan_resolver'

  # Drush command: jaraba:validate-plans
  ecosistema_jaraba_core.plan_validation_commands:
    class: Drupal\ecosistema_jaraba_core\Commands\PlanValidationCommands
    arguments:
      - '@entity_type.manager'
    tags:
      - { name: drush.command }

  # ===========================================
  # METASITE EMAIL SEQUENCES (Sprint 5 Remediation)
  # ===========================================

  # Servicio de email sequences automatizadas para el meta-sitio público.
  # Gestiona 5 secuencias del funnel de nurturing post-suscripción:
  # SEQ_META_001 (Bienvenida + Kit Impulso), SEQ_META_002 (Caso Éxito),
  # SEQ_META_003 (Guía Verticales / Cross-Pollination),
  # SEQ_META_004 (Demo + Pricing), SEQ_META_005 (Re-engagement 15d).
  # Resuelve jaraba_email.sequence_manager en runtime (sin hard dependency).
  ecosistema_jaraba_core.metasite_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\MetaSiteEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # ===========================================
  # GAP-AUD-008: COMMAND BAR (Cmd+K)
  # ===========================================

  # Central registry — service collector for command providers
  ecosistema_jaraba_core.command_registry:
    class: Drupal\ecosistema_jaraba_core\Service\CommandRegistryService
    tags:
      - { name: service_collector, tag: jaraba.command_provider, call: addProvider }

  # Navigation command provider — site routes
  ecosistema_jaraba_core.command_provider.navigation:
    class: Drupal\ecosistema_jaraba_core\CommandBar\NavigationCommandProvider
    tags:
      - { name: jaraba.command_provider }

  # Entity search command provider — content articles
  ecosistema_jaraba_core.command_provider.entity_search:
    class: Drupal\ecosistema_jaraba_core\CommandBar\EntitySearchCommandProvider
    arguments:
      - '@entity_type.manager'
    tags:
      - { name: jaraba.command_provider }

  # Action command provider — quick actions
  ecosistema_jaraba_core.command_provider.actions:
    class: Drupal\ecosistema_jaraba_core\CommandBar\ActionCommandProvider
    tags:
      - { name: jaraba.command_provider }

  # ===========================================
  # INSTITUTIONAL EMAIL SEQUENCES (Sprint 8)
  # ===========================================

  # Servicio de email sequences B2B para meta-sitios institucionales
  # (plataformadeecosistemas.es y jarabaimpact.com).
  # 5 secuencias del funnel B2B:
  # SEQ_INST_001 (Bienvenida + Dossier), SEQ_INST_002 (Caso Éxito),
  # SEQ_INST_003 (Demo + Plataforma), SEQ_INST_004 (Propuesta + Pricing),
  # SEQ_INST_005 (Follow-up 30d).
  ecosistema_jaraba_core.institutional_email_sequence:
    class: Drupal\ecosistema_jaraba_core\Service\InstitutionalEmailSequenceService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.ecosistema_jaraba_core'

  # Onboarding Email Sequence — Sprint 4
  ecosistema_jaraba_core.onboarding_email_subscriber:
    class: Drupal\ecosistema_jaraba_core\EventSubscriber\OnboardingEmailSubscriber
    arguments: ['@plugin.manager.mail', '@config.factory']
    tags:
      - { name: event_subscriber }

  # A/B Test Service — Sprint 5
  ecosistema_jaraba_core.ab_test:
    class: Drupal\ecosistema_jaraba_core\Service\AbTestService
    arguments: ['@config.factory', '@current_user']

  # ──────────────────────────────────────────────────────────────
  # Reviews & Comments — Servicios Transversales (REV-PHASE3)
  # ──────────────────────────────────────────────────────────────

  ecosistema_jaraba_core.review_aggregation:
    class: Drupal\ecosistema_jaraba_core\Service\ReviewAggregationService
    arguments:
      - '@entity_type.manager'
      - '@database'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@cache.default'

  ecosistema_jaraba_core.review_moderation:
    class: Drupal\ecosistema_jaraba_core\Service\ReviewModerationService
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@ecosistema_jaraba_core.review_aggregation'

  ecosistema_jaraba_core.review_schema_org:
    class: Drupal\ecosistema_jaraba_core\Service\ReviewSchemaOrgService
    arguments:
      - '@ecosistema_jaraba_core.review_aggregation'
      - '@entity_type.manager'
      - '@request_stack'

  ecosistema_jaraba_core.review_invitation:
    class: Drupal\ecosistema_jaraba_core\Service\ReviewInvitationService
    arguments:
      - '@entity_type.manager'
      - '@queue'
      - '@logger.channel.ecosistema_jaraba_core'
      - '@plugin.manager.mail'
