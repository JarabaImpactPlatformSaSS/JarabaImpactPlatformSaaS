<?php

declare(strict_types=1);

/**
 * @file
 * Install, update, and uninstall functions for jaraba_ai_agents.
 */

/**
 * Instala campos de tracing distribuido en AIUsageLog (GAP-02).
 *
 * Estructura: Anade 4 nuevos campos base a ai_usage_log:
 *   - trace_id (string, 36): UUID del trace que agrupa operaciones.
 *   - span_id (string, 36): UUID de la operacion individual.
 *   - parent_span_id (string, 36): UUID del span padre (nullable).
 *   - operation_name (string, 128): Nombre legible de la operacion.
 *
 * Logica: Patron DRUPAL-ENTUP-001 — Usa installFieldStorageDefinition()
 *         para registrar las definiciones ya declaradas en
 *         AIUsageLog::baseFieldDefinitions().
 *
 * Los registros existentes tendran estos campos en NULL — las queries
 * de tracing filtran por IS NOT NULL para dashboards.
 */
function jaraba_ai_agents_update_10001(&$sandbox): string {
  $entity_type_id = 'ai_usage_log';
  $fields_to_install = ['trace_id', 'span_id', 'parent_span_id', 'operation_name'];

  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();
  $entity_field_manager = \Drupal::service('entity_field.manager');

  // Obtener definiciones de campos desde la clase de entidad.
  $field_definitions = $entity_field_manager->getFieldStorageDefinitions($entity_type_id);

  $installed = [];
  foreach ($fields_to_install as $field_name) {
    if (isset($field_definitions[$field_name])) {
      try {
        $entity_definition_update_manager->installFieldStorageDefinition(
          $field_name,
          $entity_type_id,
          'jaraba_ai_agents',
          $field_definitions[$field_name]
        );
        $installed[] = $field_name;
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_ai_agents')->error(
          'Error instalando campo @field para @entity: @message',
          [
            '@field' => $field_name,
            '@entity' => $entity_type_id,
            '@message' => $e->getMessage(),
          ]
        );
      }
    }
    else {
      \Drupal::logger('jaraba_ai_agents')->warning(
        'Campo @field no encontrado en definiciones de @entity.',
        ['@field' => $field_name, '@entity' => $entity_type_id]
      );
    }
  }

  if (!empty($installed)) {
    return (string) t('GAP-02: Campos de tracing instalados en AIUsageLog: @fields', [
      '@fields' => implode(', ', $installed),
    ]);
  }

  return (string) t('GAP-02: Ningun campo de tracing necesitaba instalacion en AIUsageLog.');
}

/**
 * GAP-AUD-010: Install ProactiveInsight entity schema.
 *
 * Creates the proactive_insight table with all base fields.
 */
function jaraba_ai_agents_update_10002(&$sandbox): string {
  $entity_type_manager = \Drupal::entityTypeManager();
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  try {
    $entity_type = $entity_type_manager->getDefinition('proactive_insight');
    $entity_definition_update_manager->installEntityType($entity_type);
    return (string) t('GAP-AUD-010: ProactiveInsight entity schema installed.');
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_ai_agents')->error(
      'Error installing ProactiveInsight entity: @message',
      ['@message' => $e->getMessage()]
    );
    return (string) t('GAP-AUD-010: ProactiveInsight install encountered an error: @msg', [
      '@msg' => $e->getMessage(),
    ]);
  }
}

/**
 * GAP-AUD-012: Install A2ATask entity schema.
 *
 * Creates the a2a_task table with all base fields for A2A protocol.
 */
function jaraba_ai_agents_update_10003(&$sandbox): string {
  $entity_type_manager = \Drupal::entityTypeManager();
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  try {
    $entity_type = $entity_type_manager->getDefinition('a2a_task');
    $entity_definition_update_manager->installEntityType($entity_type);
    return (string) t('GAP-AUD-012: A2ATask entity schema installed.');
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_ai_agents')->error(
      'Error installing A2ATask entity: @message',
      ['@message' => $e->getMessage()]
    );
    return (string) t('GAP-AUD-012: A2ATask install encountered an error: @msg', [
      '@msg' => $e->getMessage(),
    ]);
  }
}

/**
 * GAP-L5-A/B: Install VerificationResult and PromptImprovement entity schemas.
 *
 * Estructura: Crea 2 tablas nuevas:
 *   - verification_result: Resultados de verificacion pre-entrega (append-only).
 *   - prompt_improvement: Propuestas de mejora de prompts con audit trail.
 *
 * Logica: Patron DRUPAL-ENTUP-001 — Usa installEntityType() para cada entidad.
 *         Las entidades estan declaradas en Entity/VerificationResult.php y
 *         Entity/PromptImprovement.php con sus respectivas baseFieldDefinitions().
 */
function jaraba_ai_agents_update_10004(&$sandbox): string {
  $entity_type_manager = \Drupal::entityTypeManager();
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  $entities_to_install = [
    'verification_result' => 'VerificationResult',
    'prompt_improvement' => 'PromptImprovement',
  ];

  $installed = [];
  $errors = [];

  foreach ($entities_to_install as $entity_type_id => $label) {
    try {
      $entity_type = $entity_type_manager->getDefinition($entity_type_id);
      $entity_definition_update_manager->installEntityType($entity_type);
      $installed[] = $label;
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_ai_agents')->error(
        'Error installing @entity entity: @message',
        ['@entity' => $label, '@message' => $e->getMessage()]
      );
      $errors[] = $label . ': ' . $e->getMessage();
    }
  }

  $messages = [];
  if (!empty($installed)) {
    $messages[] = 'Installed: ' . implode(', ', $installed);
  }
  if (!empty($errors)) {
    $messages[] = 'Errors: ' . implode('; ', $errors);
  }

  return (string) t('GAP-L5-A/B: @result', [
    '@result' => implode('. ', $messages) ?: 'No entities needed installation.',
  ]);
}

/**
 * GAP-L5-C: Install AiAuditEntry entity schema.
 *
 * Creates the ai_audit_entry table for regulatory-grade append-only audit trail.
 * EU AI Act Art. 12 (Record-keeping) — minimum 5-year retention.
 */
function jaraba_ai_agents_update_10005(&$sandbox): string {
  $entity_type_manager = \Drupal::entityTypeManager();
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  try {
    $entity_type = $entity_type_manager->getDefinition('ai_audit_entry');
    $entity_definition_update_manager->installEntityType($entity_type);
    return (string) t('GAP-L5-C: AiAuditEntry entity schema installed.');
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_ai_agents')->error(
      'Error installing AiAuditEntry entity: @message',
      ['@message' => $e->getMessage()]
    );
    return (string) t('GAP-L5-C: AiAuditEntry install error: @msg', [
      '@msg' => $e->getMessage(),
    ]);
  }
}

/**
 * GAP-L5-E: Install BrowserTask entity schema.
 *
 * Creates the browser_task table for headless browser automation audit trail.
 */
function jaraba_ai_agents_update_10006(&$sandbox): string {
  $entity_type_manager = \Drupal::entityTypeManager();
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  try {
    $entity_type = $entity_type_manager->getDefinition('browser_task');
    $entity_definition_update_manager->installEntityType($entity_type);
    return (string) t('GAP-L5-E: BrowserTask entity schema installed.');
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_ai_agents')->error(
      'Error installing BrowserTask entity: @message',
      ['@message' => $e->getMessage()]
    );
    return (string) t('GAP-L5-E: BrowserTask install error: @msg', [
      '@msg' => $e->getMessage(),
    ]);
  }
}

/**
 * GAP-L5-F/G: Install AutonomousSession and RemediationLog entity schemas.
 *
 * Estructura: Crea 2 tablas nuevas:
 *   - autonomous_session: Sesiones de agentes autonomos con heartbeat.
 *   - remediation_log: Registro append-only de auto-remediaciones.
 *
 * Logica: Patron DRUPAL-ENTUP-001 — Usa installEntityType() para cada entidad.
 */
function jaraba_ai_agents_update_10007(&$sandbox): string {
  $entity_type_manager = \Drupal::entityTypeManager();
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  $entities_to_install = [
    'autonomous_session' => 'AutonomousSession',
    'remediation_log' => 'RemediationLog',
  ];

  $installed = [];
  $errors = [];

  foreach ($entities_to_install as $entity_type_id => $label) {
    try {
      $entity_type = $entity_type_manager->getDefinition($entity_type_id);
      $entity_definition_update_manager->installEntityType($entity_type);
      $installed[] = $label;
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_ai_agents')->error(
        'Error installing @entity entity: @message',
        ['@entity' => $label, '@message' => $e->getMessage()]
      );
      $errors[] = $label . ': ' . $e->getMessage();
    }
  }

  $messages = [];
  if (!empty($installed)) {
    $messages[] = 'Installed: ' . implode(', ', $installed);
  }
  if (!empty($errors)) {
    $messages[] = 'Errors: ' . implode('; ', $errors);
  }

  return (string) t('GAP-L5-F/G: @result', [
    '@result' => implode('. ', $messages) ?: 'No entities needed installation.',
  ]);
}

/**
 * GAP-L5-H/I: Install AggregatedInsight and CausalAnalysis entity schemas.
 *
 * Estructura: Crea 2 tablas nuevas:
 *   - aggregated_insight: Insights federados cross-tenant con k-anonimidad.
 *   - causal_analysis: Analisis causal via LLM premium tier.
 *
 * Logica: Patron DRUPAL-ENTUP-001 — Usa installEntityType() para cada entidad.
 */
function jaraba_ai_agents_update_10008(&$sandbox): string {
  $entity_type_manager = \Drupal::entityTypeManager();
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  $entities_to_install = [
    'aggregated_insight' => 'AggregatedInsight',
    'causal_analysis' => 'CausalAnalysis',
  ];

  $installed = [];
  $errors = [];

  foreach ($entities_to_install as $entity_type_id => $label) {
    try {
      $entity_type = $entity_type_manager->getDefinition($entity_type_id);
      $entity_definition_update_manager->installEntityType($entity_type);
      $installed[] = $label;
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_ai_agents')->error(
        'Error installing @entity entity: @message',
        ['@entity' => $label, '@message' => $e->getMessage()]
      );
      $errors[] = $label . ': ' . $e->getMessage();
    }
  }

  $messages = [];
  if (!empty($installed)) {
    $messages[] = 'Installed: ' . implode(', ', $installed);
  }
  if (!empty($errors)) {
    $messages[] = 'Errors: ' . implode('; ', $errors);
  }

  return (string) t('GAP-L5-H/I: @result', [
    '@result' => implode('. ', $messages) ?: 'No entities needed installation.',
  ]);
}
