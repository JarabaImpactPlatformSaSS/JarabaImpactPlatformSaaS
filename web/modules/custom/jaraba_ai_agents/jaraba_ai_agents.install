<?php

declare(strict_types=1);

/**
 * @file
 * Install, update, and uninstall functions for jaraba_ai_agents.
 */

/**
 * Instala campos de tracing distribuido en AIUsageLog (GAP-02).
 *
 * Estructura: Anade 4 nuevos campos base a ai_usage_log:
 *   - trace_id (string, 36): UUID del trace que agrupa operaciones.
 *   - span_id (string, 36): UUID de la operacion individual.
 *   - parent_span_id (string, 36): UUID del span padre (nullable).
 *   - operation_name (string, 128): Nombre legible de la operacion.
 *
 * Logica: Patron DRUPAL-ENTUP-001 â€” Usa installFieldStorageDefinition()
 *         para registrar las definiciones ya declaradas en
 *         AIUsageLog::baseFieldDefinitions().
 *
 * Los registros existentes tendran estos campos en NULL â€” las queries
 * de tracing filtran por IS NOT NULL para dashboards.
 */
function jaraba_ai_agents_update_10001(&$sandbox): string {
  $entity_type_id = 'ai_usage_log';
  $fields_to_install = ['trace_id', 'span_id', 'parent_span_id', 'operation_name'];

  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();
  $entity_field_manager = \Drupal::service('entity_field.manager');

  // Obtener definiciones de campos desde la clase de entidad.
  $field_definitions = $entity_field_manager->getFieldStorageDefinitions($entity_type_id);

  $installed = [];
  foreach ($fields_to_install as $field_name) {
    if (isset($field_definitions[$field_name])) {
      try {
        $entity_definition_update_manager->installFieldStorageDefinition(
          $field_name,
          $entity_type_id,
          'jaraba_ai_agents',
          $field_definitions[$field_name]
        );
        $installed[] = $field_name;
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_ai_agents')->error(
          'Error instalando campo @field para @entity: @message',
          [
            '@field' => $field_name,
            '@entity' => $entity_type_id,
            '@message' => $e->getMessage(),
          ]
        );
      }
    }
    else {
      \Drupal::logger('jaraba_ai_agents')->warning(
        'Campo @field no encontrado en definiciones de @entity.',
        ['@field' => $field_name, '@entity' => $entity_type_id]
      );
    }
  }

  if (!empty($installed)) {
    return (string) t('GAP-02: Campos de tracing instalados en AIUsageLog: @fields', [
      '@fields' => implode(', ', $installed),
    ]);
  }

  return (string) t('GAP-02: Ningun campo de tracing necesitaba instalacion en AIUsageLog.');
}

/**
 * GAP-AUD-010: Install ProactiveInsight entity schema.
 *
 * Creates the proactive_insight table with all base fields.
 */
function jaraba_ai_agents_update_10002(&$sandbox): string {
  // Entity type install is handled automatically by Drupal when the module
  // defines the entity and entity_type.manager detects it on cache rebuild.
  // We just need to trigger the entity type definition update.
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  try {
    // Apply any pending entity type updates.
    $entity_definition_update_manager->applyUpdates();
    return (string) t('GAP-AUD-010: ProactiveInsight entity schema installed.');
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_ai_agents')->error(
      'Error installing ProactiveInsight entity: @message',
      ['@message' => $e->getMessage()]
    );
    return (string) t('GAP-AUD-010: ProactiveInsight install encountered an error: @msg', [
      '@msg' => $e->getMessage(),
    ]);
  }
}

/**
 * GAP-AUD-012: Install A2ATask entity schema.
 *
 * Creates the a2a_task table with all base fields for A2A protocol.
 */
function jaraba_ai_agents_update_10003(&$sandbox): string {
  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();

  try {
    $entity_definition_update_manager->applyUpdates();
    return (string) t('GAP-AUD-012: A2ATask entity schema installed.');
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_ai_agents')->error(
      'Error installing A2ATask entity: @message',
      ['@message' => $e->getMessage()]
    );
    return (string) t('GAP-AUD-012: A2ATask install encountered an error: @msg', [
      '@msg' => $e->getMessage(),
    ]);
  }
}
