services:

  # Logger channel
  logger.channel.jaraba_ai_agents:
    parent: logger.channel_base
    arguments: ['jaraba_ai_agents']

  # Servicio de Brand Voice por tenant
  jaraba_ai_agents.tenant_brand_voice:
    class: Drupal\jaraba_ai_agents\Service\TenantBrandVoiceService
    arguments:
      - '@config.factory'
      - '@group.membership_loader'
      - '@current_user'

  # Model Router - Routing inteligente por complejidad
  jaraba_ai_agents.model_router:
    class: Drupal\jaraba_ai_agents\Service\ModelRouterService
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'

  # GAP-02: Trace Context — Propagacion de trace_id/span_id (request-scoped)
  jaraba_ai_agents.trace_context:
    class: Drupal\jaraba_ai_agents\Service\TraceContextService
    arguments:
      - '@uuid'
      - '@logger.channel.jaraba_ai_agents'

  # AI Observability - Tracking y métricas (GAP-02: trace context, GAP-AUD-002: metering bridge)
  jaraba_ai_agents.observability:
    class: Drupal\jaraba_ai_agents\Service\AIObservabilityService
    arguments:
      - '@entity_type.manager'
      - '@current_user'
      - '@logger.channel.jaraba_ai_agents'
      - '@?jaraba_ai_agents.trace_context'
      - '@?jaraba_billing.tenant_metering'

  # Workflow Executor - Ejecución de flujos
  jaraba_ai_agents.workflow_executor:
    class: Drupal\jaraba_ai_agents\Service\WorkflowExecutorService
    arguments:
      - '@entity_type.manager'
      - '@jaraba_ai_agents.orchestrator'
      - '@jaraba_ai_agents.observability'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tool_registry'
      - '@jaraba_ai_agents.pending_approval'

  # Quality Evaluator - LLM-as-Judge (GAP-06: entity_type.manager para stats reales)
  jaraba_ai_agents.quality_evaluator:
    class: Drupal\jaraba_ai_agents\Service\QualityEvaluatorService
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@jaraba_ai_agents.observability'
      - '@logger.channel.jaraba_ai_agents'
      - '@entity_type.manager'

  # Orquestador de agentes
  jaraba_ai_agents.orchestrator:
    class: Drupal\jaraba_ai_agents\Service\AgentOrchestrator
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@entity_type.manager'

  # Marketing Agent
  jaraba_ai_agents.marketing_agent:
    class: Drupal\jaraba_ai_agents\Agent\MarketingAgent
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'

  # Smart Marketing Agent (Gen 2 con Model Routing + Tools)
  jaraba_ai_agents.smart_marketing_agent:
    class: Drupal\jaraba_ai_agents\Agent\SmartMarketingAgent
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@jaraba_ai_agents.model_router'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'
      - '@?jaraba_ai_agents.tool_registry'
      - '@?jaraba_ai_agents.provider_fallback'
      - '@?jaraba_ai_agents.context_window_manager'

  # Storytelling Agent (FIX-035: migrated Gen 1 -> Gen 2 with Model Routing)
  jaraba_ai_agents.storytelling_agent:
    class: Drupal\jaraba_ai_agents\Agent\StorytellingAgent
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@jaraba_ai_agents.model_router'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'
      - '@?jaraba_ai_agents.tool_registry'
      - '@?jaraba_ai_agents.provider_fallback'
      - '@?jaraba_ai_agents.context_window_manager'

  # Customer Experience Agent (FIX-035: migrated Gen 1 -> Gen 2 with Model Routing)
  jaraba_ai_agents.customer_experience_agent:
    class: Drupal\jaraba_ai_agents\Agent\CustomerExperienceAgent
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@jaraba_ai_agents.model_router'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'
      - '@?jaraba_ai_agents.tool_registry'
      - '@?jaraba_ai_agents.provider_fallback'
      - '@?jaraba_ai_agents.context_window_manager'

  # Support Agent (FIX-035: migrated Gen 1 -> Gen 2 with Model Routing)
  jaraba_ai_agents.support_agent:
    class: Drupal\jaraba_ai_agents\Agent\SupportAgent
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@jaraba_ai_agents.model_router'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'
      - '@?jaraba_ai_agents.tool_registry'
      - '@?jaraba_ai_agents.provider_fallback'
      - '@?jaraba_ai_agents.context_window_manager'

  # Producer Copilot Agent (AgroConecta - Gen 2 + Tools)
  jaraba_ai_agents.producer_copilot_agent:
    class: Drupal\jaraba_ai_agents\Agent\ProducerCopilotAgent
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@jaraba_ai_agents.model_router'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'
      - '@?jaraba_ai_agents.tool_registry'
      - '@?jaraba_ai_agents.provider_fallback'
      - '@?jaraba_ai_agents.context_window_manager'

  # Sales Agent (AgroConecta - Gen 2 + Tools)
  jaraba_ai_agents.sales_agent:
    class: Drupal\jaraba_ai_agents\Agent\SalesAgent
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@jaraba_ai_agents.model_router'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'
      - '@?jaraba_ai_agents.tool_registry'
      - '@?jaraba_ai_agents.provider_fallback'
      - '@?jaraba_ai_agents.context_window_manager'

  # Merchant Copilot Agent (ComercioConecta - Gen 2 + Tools)
  jaraba_ai_agents.merchant_copilot_agent:
    class: Drupal\jaraba_ai_agents\Agent\MerchantCopilotAgent
    arguments:
      - '@ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@jaraba_ai_agents.model_router'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'
      - '@?jaraba_ai_agents.tool_registry'
      - '@?jaraba_ai_agents.provider_fallback'
      - '@?jaraba_ai_agents.context_window_manager'


  # ========================================
  # Tool Registry - Herramientas Agentic
  # ========================================

  # Registro central de herramientas
  # HAL-AI-01: Guardrails mandatory para sanitizar outputs de tools.
  # HAL-AI-18: Approval gating via PendingApprovalService (lazy-loaded).
  jaraba_ai_agents.tool_registry:
    class: Drupal\jaraba_ai_agents\Tool\ToolRegistry
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@ecosistema_jaraba_core.ai_guardrails'

  # SendEmailTool - Envío de emails
  jaraba_ai_agents.tool.send_email:
    class: Drupal\jaraba_ai_agents\Tool\SendEmailTool
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@plugin.manager.mail'
    tags:
      - { name: jaraba_ai_agents.tool }

  # CreateEntityTool - Creación de entidades
  jaraba_ai_agents.tool.create_entity:
    class: Drupal\jaraba_ai_agents\Tool\CreateEntityTool
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@entity_type.manager'
    tags:
      - { name: jaraba_ai_agents.tool }

  # SearchKnowledgeTool - Búsqueda RAG
  jaraba_ai_agents.tool.search_knowledge:
    class: Drupal\jaraba_ai_agents\Tool\SearchKnowledgeTool
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@jaraba_tenant_knowledge.indexer'
    tags:
      - { name: jaraba_ai_agents.tool }

  # FIX-045: QueryDatabaseTool - Read-only SQL queries
  jaraba_ai_agents.tool.query_database:
    class: Drupal\jaraba_ai_agents\Tool\QueryDatabaseTool
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@database'
    tags:
      - { name: jaraba_ai_agents.tool }

  # FIX-045: UpdateEntityTool - Update entity fields (requires approval)
  jaraba_ai_agents.tool.update_entity:
    class: Drupal\jaraba_ai_agents\Tool\UpdateEntityTool
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@entity_type.manager'
    tags:
      - { name: jaraba_ai_agents.tool }

  # FIX-045: SearchContentTool - Full-text content search
  jaraba_ai_agents.tool.search_content:
    class: Drupal\jaraba_ai_agents\Tool\SearchContentTool
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@entity_type.manager'
    tags:
      - { name: jaraba_ai_agents.tool }

  # PendingApprovalService - Cola de aprobaciones
  jaraba_ai_agents.pending_approval:
    class: Drupal\jaraba_ai_agents\Service\PendingApprovalService
    arguments:
      - '@entity_type.manager'
      - '@jaraba_ai_agents.tool_registry'
      - '@current_user'
      - '@logger.channel.jaraba_ai_agents'

  # AgentCollaborationService - Colaboración multi-agente (G108-2)
  jaraba_ai_agents.agent_collaboration:
    class: Drupal\jaraba_ai_agents\Service\AgentCollaborationService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.jaraba_ai_agents'

  # ========================================
  # F11 — Elevación IA Clase Mundial
  # ========================================

  # Brand Voice Trainer — Pipeline Qdrant + feedback loop
  jaraba_ai_agents.brand_voice_trainer:
    class: Drupal\jaraba_ai_agents\Service\BrandVoiceTrainerService
    arguments:
      - '@entity_type.manager'
      - '@ai.provider'
      - '@jaraba_ai_agents.tenant_brand_voice'
      - '@jaraba_ai_agents.observability'
      - '@logger.channel.jaraba_ai_agents'

  # Prompt Experiment — A/B testing de prompts
  jaraba_ai_agents.prompt_experiment:
    class: Drupal\jaraba_ai_agents\Service\PromptExperimentService
    arguments:
      - '@entity_type.manager'
      - '@jaraba_ai_agents.quality_evaluator'
      - '@jaraba_ai_agents.observability'
      - '@logger.channel.jaraba_ai_agents'

  # JarabaLex Copilot Agent — DEPRECATED (FIX-016)
  # El agente canonico es jaraba_legal_intelligence.legal_copilot_agent
  # (8 modos, contexto de expediente, RAG). Este agente duplicado (6 modos,
  # prompts muertos) se elimina. Se crea alias para compatibilidad hacia atras.
  #
  # Definicion original comentada:
  # jaraba_ai_agents.jarabalex_copilot:
  #   class: Drupal\jaraba_ai_agents\Agent\JarabaLexCopilotAgent
  #   arguments:
  #     - '@ai.provider'
  #     - '@config.factory'
  #     - '@logger.channel.jaraba_ai_agents'
  #     - '@jaraba_ai_agents.tenant_brand_voice'
  #     - '@jaraba_ai_agents.observability'
  #     - '@ecosistema_jaraba_core.unified_prompt_builder'
  #
  # Alias: cualquier codigo que pida jaraba_ai_agents.jarabalex_copilot
  # recibira el agente canonico de jaraba_legal_intelligence.
  jaraba_ai_agents.jarabalex_copilot:
    alias: jaraba_legal_intelligence.legal_copilot_agent
    deprecated: 'The "%alias_id%" service is deprecated. Use "jaraba_legal_intelligence.legal_copilot_agent" directly. See FIX-016.'

  # GAP-AUD-011 + GAP-AUD-013: MultiModal Bridge — Voice + Vision AI
  # HAL-AI-17: Guardrails MANDATORY for multimodal processing.
  jaraba_ai_agents.multimodal_bridge:
    class: Drupal\jaraba_ai_agents\Service\MultiModalBridgeService
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@?ai.provider'
      - '@ecosistema_jaraba_core.ai_guardrails'

  # ========================================
  # FIX-029-051 — Elevacion IA Nivel 5/5
  # ========================================

  # FIX-031: Provider Fallback Service (circuit breaker + fallback chains)
  jaraba_ai_agents.provider_fallback:
    class: Drupal\jaraba_ai_agents\Service\ProviderFallbackService
    arguments:
      - '@config.factory'
      - '@logger.channel.jaraba_ai_agents'

  # FIX-033: Context Window Manager
  jaraba_ai_agents.context_window_manager:
    class: Drupal\jaraba_ai_agents\Service\ContextWindowManager
    arguments:
      - '@logger.channel.jaraba_ai_agents'

  # FIX-038: ReAct Loop Service (Plan-Execute-Reflect)
  jaraba_ai_agents.react_loop:
    class: Drupal\jaraba_ai_agents\Service\ReActLoopService
    arguments:
      - '@jaraba_ai_agents.tool_registry'
      - '@jaraba_ai_agents.observability'
      - '@logger.channel.jaraba_ai_agents'

  # GAP-AUD-009: Inline AI Suggestions Service
  jaraba_ai_agents.inline_ai:
    class: Drupal\jaraba_ai_agents\Service\InlineAiService
    arguments:
      - '@logger.channel.jaraba_ai_agents'
      - '@?jaraba_ai_agents.smart_marketing_agent'

  # FIX-040: Handoff Decision Service
  jaraba_ai_agents.handoff_decision:
    class: Drupal\jaraba_ai_agents\Service\HandoffDecisionService
    arguments:
      - '@ai.provider'
      - '@jaraba_ai_agents.model_router'
      - '@?jaraba_agents.handoff_manager'
      - '@?jaraba_ai_agents.agent_collaboration'
      - '@logger.channel.jaraba_ai_agents'

  # Reviews & Comments — AI Summary Service (REV-PHASE3)
  jaraba_ai_agents.review_ai_summary:
    class: Drupal\jaraba_ai_agents\Service\ReviewAiSummaryService
    arguments:
      - '@entity_type.manager'
      - '@jaraba_ai_agents.model_router'
      - '@logger.channel.jaraba_ai_agents'
      - '@?ai.provider'

