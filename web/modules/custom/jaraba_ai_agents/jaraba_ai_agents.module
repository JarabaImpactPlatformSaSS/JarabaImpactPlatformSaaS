<?php

/**
 * @file
 * Primary module hooks for Jaraba AI Agents.
 */

declare(strict_types=1);

/**
 * Implements hook_help().
 */
function jaraba_ai_agents_help(string $route_name): string {
  if ($route_name === 'help.page.jaraba_ai_agents') {
    return '<p>' . t('Sistema de agentes IA orientados a acciones para verticales SaaS multi-tenant.') . '</p>';
  }
  return '';
}

/**
 * Implements hook_cron().
 *
 * S3-03: Delegates proactive insight generation to ProactiveInsightsService.
 * The service handles interval checks, tenant resolution, and enqueueing.
 */
function jaraba_ai_agents_cron(): void {
  if (\Drupal::hasService('jaraba_ai_agents.proactive_insights')) {
    try {
      \Drupal::service('jaraba_ai_agents.proactive_insights')->runCron();
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_ai_agents')->warning(
        'Proactive insight cron failed: @error',
        ['@error' => $e->getMessage()]
      );
    }
  }

  // GAP-L5-F: Enqueue autonomous agent heartbeats.
  if (\Drupal::hasService('jaraba_ai_agents.autonomous_agent')) {
    try {
      \Drupal::service('jaraba_ai_agents.autonomous_agent')->enqueueHeartbeats();
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_ai_agents')->warning(
        'Autonomous agent heartbeat enqueue failed: @error',
        ['@error' => $e->getMessage()]
      );
    }
  }
}

/**
 * Implements hook_theme().
 */
function jaraba_ai_agents_theme(): array {
  return [
    'jaraba_ai_dashboard' => [
      'variables' => [
        'period' => 'month',
        'stats' => [],
        'cost_by_tier' => [],
        'usage_by_agent' => [],
        'savings' => [],
        'quality_stats' => [],
        // GAP-AUD-004: GEO dashboard data.
        'usage_by_region' => [],
        'usage_trend' => [],
      ],
      'template' => 'jaraba-ai-dashboard',
    ],
    // GAP-L5-C: AI Compliance Dashboard.
    'ai_compliance_dashboard' => [
      'variables' => [
        'risk_matrix' => [],
        'risk_assessments' => [],
        'high_risk_actions' => [],
        'limited_risk_actions' => [],
        'eu_ai_act_deadline' => '',
      ],
      'template' => 'ai-compliance-dashboard',
    ],
    // GAP-L5-F/G: Autonomous Agents & Self-Healing Dashboard.
    'autonomous_agents_dashboard' => [
      'variables' => [
        'stats' => [],
        'active_sessions' => [],
        'escalated_sessions' => [],
        'recent_remediations' => [],
        'agent_types' => [],
      ],
      'template' => 'autonomous-agents-dashboard',
    ],
  ];
}
