<?php

/**
 * @file
 * Primary module hooks for Jaraba AI Agents.
 */

declare(strict_types=1);

/**
 * Implements hook_help().
 */
function jaraba_ai_agents_help(string $route_name): string {
  if ($route_name === 'help.page.jaraba_ai_agents') {
    return '<p>' . t('Sistema de agentes IA orientados a acciones para verticales SaaS multi-tenant.') . '</p>';
  }
  return '';
}

/**
 * Implements hook_cron().
 *
 * GAP-AUD-010: Enqueues proactive insight generation for active tenants.
 * Limited to one execution per day via state API.
 */
function jaraba_ai_agents_cron(): void {
  $state = \Drupal::state();
  $lastRun = (int) $state->get('proactive_insight_last_run', 0);
  $today = strtotime('today midnight');

  // Only run once per day.
  if ($lastRun >= $today) {
    return;
  }

  $state->set('proactive_insight_last_run', \Drupal::time()->getRequestTime());

  // Get active admin users to generate insights for.
  try {
    $userStorage = \Drupal::entityTypeManager()->getStorage('user');
    $adminUids = $userStorage->getQuery()
      ->accessCheck(FALSE)
      ->condition('status', 1)
      ->condition('roles', 'administrator')
      ->range(0, 50)
      ->execute();

    if (empty($adminUids)) {
      return;
    }

    /** @var \Drupal\Core\Queue\QueueInterface $queue */
    $queue = \Drupal::queue('proactive_insight_engine');

    foreach ($adminUids as $uid) {
      $tenantId = 0;

      // Resolve tenant for this user if service available.
      try {
        if (\Drupal::hasService('ecosistema_jaraba_core.tenant_context')) {
          // For cron, we can't resolve per-user tenant easily;
          // the worker will handle tenant resolution.
        }
      }
      catch (\Exception $e) {
        // Continue without tenant.
      }

      $queue->createItem([
        'tenant_id' => $tenantId,
        'user_id' => (int) $uid,
      ]);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_ai_agents')->warning(
      'Proactive insight cron failed: @error',
      ['@error' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_theme().
 */
function jaraba_ai_agents_theme(): array {
  return [
    'jaraba_ai_dashboard' => [
      'variables' => [
        'period' => 'month',
        'stats' => [],
        'cost_by_tier' => [],
        'usage_by_agent' => [],
        'savings' => [],
        'quality_stats' => [],
        // GAP-AUD-004: GEO dashboard data.
        'usage_by_region' => [],
        'usage_trend' => [],
      ],
      'template' => 'jaraba-ai-dashboard',
    ],
  ];
}
