services:
  # Canal de log dedicado del Legal Intelligence Hub.
  logger.channel.jaraba_legal_intelligence:
    parent: logger.channel_base
    arguments: ['jaraba_legal_intelligence']

  # === SEARCH: Busqueda semantica en Qdrant con facetas ===
  jaraba_legal_intelligence.search:
    class: Drupal\jaraba_legal_intelligence\Service\LegalSearchService
    arguments:
      - '@ai.provider'
      - '@ecosistema_jaraba_core.tenant_context'
      - '@entity_type.manager'
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@ecosistema_jaraba_core.jarabalex_feature_gate'

  # === INGESTION: Orquestacion de ingesta de resoluciones ===
  jaraba_legal_intelligence.ingestion:
    class: Drupal\jaraba_legal_intelligence\Service\LegalIngestionService
    arguments:
      - '@entity_type.manager'
      - '@queue'
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@service_container'

  # === NLP PIPELINE: Pipeline NLP de 9 etapas ===
  jaraba_legal_intelligence.nlp_pipeline:
    class: Drupal\jaraba_legal_intelligence\Service\LegalNlpPipelineService
    arguments:
      - '@ai.provider'
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@database'
      - '@entity_type.manager'

  # === ALERTS: Gestion de alertas inteligentes ===
  jaraba_legal_intelligence.alerts:
    class: Drupal\jaraba_legal_intelligence\Service\LegalAlertService
    arguments:
      - '@entity_type.manager'
      - '@ecosistema_jaraba_core.tenant_context'
      - '@plugin.manager.mail'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@ecosistema_jaraba_core.jarabalex_feature_gate'

  # === CITATIONS: Generacion e insercion de citas formateadas ===
  jaraba_legal_intelligence.citations:
    class: Drupal\jaraba_legal_intelligence\Service\LegalCitationService
    arguments:
      - '@entity_type.manager'
      - '@ecosistema_jaraba_core.tenant_context'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@ecosistema_jaraba_core.jarabalex_feature_gate'

  # === DIGEST: Digest semanal personalizado ===
  jaraba_legal_intelligence.digest:
    class: Drupal\jaraba_legal_intelligence\Service\LegalDigestService
    arguments:
      - '@entity_type.manager'
      - '@jaraba_legal_intelligence.search'
      - '@plugin.manager.mail'
      - '@ecosistema_jaraba_core.tenant_context'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@ecosistema_jaraba_core.jarabalex_feature_gate'

  # === COPILOT BRIDGE: Puente entre Legal Intelligence Hub y Copilot ===
  jaraba_legal_intelligence.copilot_bridge:
    class: Drupal\jaraba_legal_intelligence\Service\LegalCopilotBridgeService
    arguments:
      - '@jaraba_legal_intelligence.search'
      - '@jaraba_legal_intelligence.citations'
      - '@entity_type.manager'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@ecosistema_jaraba_core.jarabalex_feature_gate'

  # === COPILOT AGENT: Agente dedicado JarabaLex (8 modos) ===
  # Gen 1 — deprecated, kept for backwards compatibility
  jaraba_legal_intelligence.legal_copilot_agent:
    class: Drupal\jaraba_legal_intelligence\Agent\LegalCopilotAgent
    arguments:
      - '@?ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@?jaraba_ai_agents.tenant_brand_voice'
      - '@?jaraba_ai_agents.observability'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'

  # S5-01: Smart Gen 2 agent — model routing, memory, tools, brand voice
  jaraba_legal_intelligence.smart_legal_copilot_agent:
    class: Drupal\jaraba_legal_intelligence\Agent\SmartLegalCopilotAgent
    arguments:
      - '@?ai.provider'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@?jaraba_ai_agents.tenant_brand_voice'
      - '@?jaraba_ai_agents.observability'
      - '@?jaraba_ai_agents.model_router'
      - '@?ecosistema_jaraba_core.unified_prompt_builder'
      - '@?jaraba_ai_agents.tool_registry'
      - '@?jaraba_ai_agents.provider_fallback'
      - '@?jaraba_ai_agents.context_window_manager'
    calls:
      - [setCostAlertService, ['@?ecosistema_jaraba_core.cost_alert']]

  # =====================================================
  # === LEGAL COHERENCE INTELLIGENCE SYSTEM (LCIS) ===
  # =====================================================
  # 9-layer pipeline para coherencia juridica de IA.
  # Capas 1 (KB) y 4 (PromptRule) son clases estaticas, no servicios.

  # CAPA 2: Intent Classifier — gate del pipeline LCIS.
  jaraba_legal_intelligence.legal_intent_classifier:
    class: Drupal\jaraba_legal_intelligence\LegalCoherence\LegalIntentClassifierService
    arguments:
      - '@logger.channel.jaraba_legal_intelligence'

  # CAPA 3: Normative Graph Enricher — Authority-Aware RAG Ranking.
  jaraba_legal_intelligence.normative_graph_enricher:
    class: Drupal\jaraba_legal_intelligence\LegalCoherence\NormativeGraphEnricher
    arguments:
      - '@?entity_type.manager'
      - '@logger.channel.jaraba_legal_intelligence'

  # CAPA 6: Validator — validacion determinista zero-cost.
  jaraba_legal_intelligence.legal_coherence_validator:
    class: Drupal\jaraba_legal_intelligence\LegalCoherence\LegalCoherenceValidatorService
    arguments:
      - '@logger.channel.jaraba_legal_intelligence'

  # CAPA 7: Verifier — verificacion semantica profunda via LLM.
  jaraba_legal_intelligence.legal_coherence_verifier:
    class: Drupal\jaraba_legal_intelligence\LegalCoherence\LegalCoherenceVerifierService
    arguments:
      - '@ai.provider'
      - '@jaraba_ai_agents.model_router'
      - '@logger.channel.jaraba_legal_intelligence'
      - '@?jaraba_ai_agents.observability'

  # CAPA 8: Disclaimer Enforcement — no-eliminable.
  jaraba_legal_intelligence.legal_disclaimer_enforcement:
    class: Drupal\jaraba_legal_intelligence\LegalCoherence\LegalDisclaimerEnforcementService
    arguments:
      - '@?jaraba_legal_knowledge.disclaimer'
      - '@logger.channel.jaraba_legal_intelligence'

  # Feedback Loop — correcciones profesionales.
  jaraba_legal_intelligence.legal_feedback:
    class: Drupal\jaraba_legal_intelligence\LegalCoherence\LegalFeedbackService
    arguments:
      - '@?entity_type.manager'
      - '@logger.channel.jaraba_legal_intelligence'

  # Multi-turn — contexto de conversacion legal.
  jaraba_legal_intelligence.legal_conversation_context:
    class: Drupal\jaraba_legal_intelligence\LegalCoherence\LegalConversationContext
    arguments:
      - '@logger.channel.jaraba_legal_intelligence'

  # === MERGE & RANK: Fusion de resultados nacionales + UE ===
  jaraba_legal_intelligence.merge_rank:
    class: Drupal\jaraba_legal_intelligence\Service\LegalMergeRankService
    arguments:
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'

  # === SPIDERS: Conectores a fuentes de datos juridicos ===
  jaraba_legal_intelligence.spider.cendoj:
    class: Drupal\jaraba_legal_intelligence\Service\Spider\CendojSpider
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'

  jaraba_legal_intelligence.spider.boe:
    class: Drupal\jaraba_legal_intelligence\Service\Spider\BoeSpider
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'

  jaraba_legal_intelligence.spider.dgt:
    class: Drupal\jaraba_legal_intelligence\Service\Spider\DgtSpider
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'

  jaraba_legal_intelligence.spider.teac:
    class: Drupal\jaraba_legal_intelligence\Service\Spider\TeacSpider
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'

  # === SPIDERS UE: Fuentes europeas (Fase 4) ===
  jaraba_legal_intelligence.spider.eurlex:
    class: Drupal\jaraba_legal_intelligence\Service\Spider\EurLexSpider
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'

  jaraba_legal_intelligence.spider.curia:
    class: Drupal\jaraba_legal_intelligence\Service\Spider\CuriaSpider
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'

  jaraba_legal_intelligence.spider.hudoc:
    class: Drupal\jaraba_legal_intelligence\Service\Spider\HudocSpider
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'

  jaraba_legal_intelligence.spider.edpb:
    class: Drupal\jaraba_legal_intelligence\Service\Spider\EdpbSpider
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.channel.jaraba_legal_intelligence'
