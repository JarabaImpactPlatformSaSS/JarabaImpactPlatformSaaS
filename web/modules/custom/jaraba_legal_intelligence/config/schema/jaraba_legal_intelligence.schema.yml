# Schema de configuracion del Legal Intelligence Hub.
# Define la estructura de datos para validacion de YAML config.

jaraba_legal_intelligence.settings:
  type: config_object
  label: 'Legal Intelligence Hub settings'
  mapping:
    qdrant_url:
      type: string
      label: 'Qdrant server URL'
    qdrant_api_key:
      type: string
      label: 'Qdrant API key'
    nlp_service_url:
      type: string
      label: 'NLP FastAPI service URL'
    tika_url:
      type: string
      label: 'Apache Tika URL'
    qdrant_collection_national:
      type: string
      label: 'Qdrant collection for national sources'
    qdrant_collection_eu:
      type: string
      label: 'Qdrant collection for EU sources'
    score_threshold:
      type: float
      label: 'Minimum Qdrant score threshold'
    max_results:
      type: integer
      label: 'Maximum search results'
    limits:
      type: mapping
      label: 'Plan-based limits'
      mapping:
        starter:
          type: mapping
          label: 'Starter plan limits'
          mapping:
            searches_per_month:
              type: integer
              label: 'Searches per month (0 = unlimited)'
            max_alerts:
              type: integer
              label: 'Maximum alerts (0 = unlimited)'
            max_bookmarks:
              type: integer
              label: 'Maximum bookmarks (0 = unlimited)'
        pro:
          type: mapping
          label: 'Pro plan limits'
          mapping:
            searches_per_month:
              type: integer
              label: 'Searches per month (0 = unlimited)'
            max_alerts:
              type: integer
              label: 'Maximum alerts (0 = unlimited)'
            max_bookmarks:
              type: integer
              label: 'Maximum bookmarks (0 = unlimited)'
        enterprise:
          type: mapping
          label: 'Enterprise plan limits'
          mapping:
            searches_per_month:
              type: integer
              label: 'Searches per month (0 = unlimited)'
            max_alerts:
              type: integer
              label: 'Maximum alerts (0 = unlimited)'
            max_bookmarks:
              type: integer
              label: 'Maximum bookmarks (0 = unlimited)'
    eu_primacy_boost:
      type: float
      label: 'Score boost for EU source results (primacy)'
    freshness_boost:
      type: float
      label: 'Score boost for recent resolutions'
    freshness_days:
      type: integer
      label: 'Days to consider a resolution as recent'
    classification_prompt:
      type: text
      label: 'AI classification prompt (national sources)'
    summary_prompt:
      type: text
      label: 'AI summary prompt (national sources)'
    eu_classification_prompt:
      type: text
      label: 'AI classification prompt (EU sources)'
    eu_summary_prompt:
      type: text
      label: 'AI summary prompt (EU sources with impact_spain)'
    nlp_chunk_max_tokens:
      type: integer
      label: 'Max tokens per text chunk for embeddings'
    nlp_chunk_overlap_tokens:
      type: integer
      label: 'Overlap tokens between consecutive chunks'
    nlp_max_text_length:
      type: integer
      label: 'Max text length for NLP processing (chars)'
    nlp_tika_timeout:
      type: integer
      label: 'Apache Tika HTTP timeout (seconds)'
    nlp_python_timeout:
      type: integer
      label: 'Python NLP service HTTP timeout (seconds)'
    nlp_ai_temperature:
      type: float
      label: 'AI model temperature for classification/summary'
    nlp_ai_max_tokens:
      type: integer
      label: 'AI model max output tokens'
    nlp_classification_max_chars:
      type: integer
      label: 'Max chars sent to AI for classification'
    nlp_summary_max_chars:
      type: integer
      label: 'Max chars sent to AI for summarization'
    default_sync_interval_hours:
      type: integer
      label: 'Default sync interval in hours'
    rate_limit_searches_per_hour:
      type: integer
      label: 'Rate limit: searches per hour per user'

jaraba_legal_intelligence.legal_coherence:
  type: config_object
  label: 'Legal Coherence Intelligence System (LCIS) settings'
  mapping:
    enabled:
      type: boolean
      label: 'LCIS pipeline enabled'
    version:
      type: string
      label: 'LCIS configuration version'
    intent_classifier:
      type: mapping
      label: 'Layer 2: Intent Classifier'
      mapping:
        enabled:
          type: boolean
          label: 'Intent classifier enabled'
        threshold_high:
          type: float
          label: 'Threshold for LEGAL_DIRECT (fast resolution)'
        threshold_low:
          type: float
          label: 'Threshold for NON_LEGAL (fast resolution)'
        llm_fallback_enabled:
          type: boolean
          label: 'Enable LLM for gray zone'
        llm_fallback_tier:
          type: string
          label: 'LLM tier for gray zone'
    normative_graph:
      type: mapping
      label: 'Layer 3: Normative Graph Enricher'
      mapping:
        enabled:
          type: boolean
          label: 'Enricher enabled'
        weight_semantic:
          type: float
          label: 'Semantic score weight'
        weight_authority:
          type: float
          label: 'Authority weight'
        weight_recency:
          type: float
          label: 'Recency weight'
        ccaa_exclusive_bonus:
          type: float
          label: 'CCAA exclusive competence bonus'
        filter_derogated:
          type: boolean
          label: 'Filter derogated norms'
    prompt_rule:
      type: mapping
      label: 'Layer 4: Prompt Rule'
      mapping:
        enabled:
          type: boolean
          label: 'Prompt rule enabled'
        short_version_actions:
          type: sequence
          label: 'Actions using short version'
          sequence:
            type: string
            label: 'Action'
    validator:
      type: mapping
      label: 'Layer 6: Validator'
      mapping:
        enabled:
          type: boolean
          label: 'Validator enabled'
        threshold_block:
          type: float
          label: 'Score threshold for block/regenerate'
        threshold_warn:
          type: float
          label: 'Score threshold for warning'
        max_retries:
          type: integer
          label: 'Max regeneration retries'
        sycophancy_check_enabled:
          type: boolean
          label: 'Anti-sycophancy enabled'
        antinomy_check_enabled:
          type: boolean
          label: 'Antinomy detection enabled'
    verifier:
      type: mapping
      label: 'Layer 7: Verifier'
      mapping:
        enabled:
          type: boolean
          label: 'Verifier enabled'
        high_risk_actions:
          type: sequence
          label: 'HIGH_RISK actions'
          sequence:
            type: string
            label: 'Action'
        tier:
          type: string
          label: 'LLM tier'
        temperature:
          type: float
          label: 'LLM temperature'
        pass_threshold:
          type: float
          label: 'Minimum pass score'
        citation_alignment_enabled:
          type: boolean
          label: 'Citation-Claim Alignment (V8b)'
        premise_validation_enabled:
          type: boolean
          label: 'Premise Validation (V8)'
    disclaimer:
      type: mapping
      label: 'Layer 8: Disclaimer Enforcement'
      mapping:
        enabled:
          type: boolean
          label: 'Disclaimer enforcement enabled'
        score_warning_threshold:
          type: integer
          label: 'Score threshold for visible warning'
        custom_text:
          type: string
          label: 'Custom disclaimer text (empty = default)'
    benchmark:
      type: mapping
      label: 'Layer 9: Benchmark Suite'
      mapping:
        core_cases:
          type: integer
          label: 'Number of core test cases'
        pass_threshold:
          type: float
          label: 'Passing threshold'
        cron_monthly_subset:
          type: integer
          label: 'Monthly cron subset size'
        cron_quarterly_full:
          type: boolean
          label: 'Run full quarterly benchmark'
    multi_turn:
      type: mapping
      label: 'Multi-turn coherence'
      mapping:
        enabled:
          type: boolean
          label: 'Multi-turn tracking enabled'
        max_assertions:
          type: integer
          label: 'Max assertions per session'
        max_turns:
          type: integer
          label: 'Max turns per session'
    feedback:
      type: mapping
      label: 'Feedback loop'
      mapping:
        enabled:
          type: boolean
          label: 'Feedback loop enabled'
        require_validation:
          type: boolean
          label: 'Require admin validation'

jaraba_legal_intelligence.sources:
  type: config_object
  label: 'Legal Intelligence Hub sources'
  mapping:
    sources:
      type: sequence
      label: 'Data sources'
      sequence:
        type: mapping
        label: 'Source'
        mapping:
          name:
            type: string
            label: 'Source name'
          description:
            type: string
            label: 'Description'
          base_url:
            type: string
            label: 'Base URL'
          spider_class:
            type: string
            label: 'Spider PHP class'
          frequency:
            type: string
            label: 'Sync frequency (daily/weekly/monthly)'
          is_active:
            type: boolean
            label: 'Active'
          priority:
            type: integer
            label: 'Priority (lower = higher)'
          scope:
            type: string
            label: 'Scope (national/eu)'

jaraba_legal_intelligence.legal_coherence_benchmark:
  type: config_object
  label: 'Legal Coherence Benchmark Suite (JLB)'
  mapping:
    id:
      type: string
      label: 'Benchmark ID'
    label:
      type: label
      label: 'Benchmark label'
    agent_id:
      type: string
      label: 'Agent ID for benchmark execution'
    version:
      type: string
      label: 'Benchmark version'
    threshold:
      type: float
      label: 'Global passing threshold'
    test_cases:
      type: mapping
      label: 'Test cases'
      mapping:
        '*':
          type: mapping
          label: 'Test case'
          mapping:
            input:
              type: string
              label: 'User input / question'
            expected_output_contains:
              type: sequence
              label: 'Expected output keywords'
              sequence:
                type: string
                label: 'Keyword'
            expected_output_not_contains:
              type: sequence
              label: 'Forbidden output keywords'
              sequence:
                type: string
                label: 'Keyword'
            criteria:
              type: string
              label: 'Evaluation criteria'
            category:
              type: string
              label: 'Test category'
            expected_intent:
              type: string
              label: 'Expected intent classification'
    evaluation_criteria:
      type: mapping
      label: 'Evaluation criteria weights'
      mapping:
        '*':
          type: mapping
          label: 'Criterion'
          mapping:
            weight:
              type: float
              label: 'Weight (0.0-1.0)'
            description:
              type: string
              label: 'Criterion description'
