<?php

declare(strict_types=1);

/**
 * @file
 * Modulo jaraba_agents â€” Agentes IA Autonomos.
 *
 * Estructura: Hooks principales del modulo (theme, preprocess, entity).
 * Logica: Zero-region pattern para dashboard, inyeccion de datos via servicios,
 *         registro de eventos en entity insert/update.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_theme().
 *
 * Estructura: Registra plantillas del dashboard y parciales reutilizables.
 * Logica: Variables inyectadas desde hook_preprocess_page() para zero-region.
 */
function jaraba_agents_theme(): array {
  return [
    'page__agents' => [
      'variables' => [
        'agents' => [],
        'executions' => [],
        'approvals' => [],
        'stats' => [],
        'copilot_context' => NULL,
      ],
    ],
    'agent_card' => [
      'template' => 'partials/agent-card',
      'variables' => [
        'agent' => NULL,
      ],
    ],
    'execution_row' => [
      'template' => 'partials/execution-row',
      'variables' => [
        'execution' => NULL,
      ],
    ],
    'approval_card' => [
      'template' => 'partials/approval-card',
      'variables' => [
        'approval' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Estructura: Sugerencia de plantilla page__agents para la ruta del dashboard.
 * Logica: Permite al tema utilizar page--agents.html.twig.
 */
function jaraba_agents_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_match = \Drupal::routeMatch();
  if ($route_match->getRouteName() === 'jaraba_agents.dashboard') {
    $suggestions[] = 'page__agents';
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * Estructura: Clases de body para rutas del modulo.
 * Logica: Agrega 'page-agents' y 'n2-growth-ready' en rutas jaraba_agents.*;
 *         agrega 'full-width-layout' exclusivamente en el dashboard.
 */
function jaraba_agents_preprocess_html(array &$variables): void {
  $route_match = \Drupal::routeMatch();
  $route_name = $route_match->getRouteName();

  if ($route_name && str_starts_with($route_name, 'jaraba_agents.')) {
    $variables['attributes']['class'][] = 'page-agents';
    $variables['attributes']['class'][] = 'n2-growth-ready';

    if ($route_name === 'jaraba_agents.dashboard') {
      $variables['attributes']['class'][] = 'full-width-layout';
    }
  }
}

/**
 * Implements hook_preprocess_page().
 *
 * Estructura: Inyeccion de datos para el dashboard zero-region.
 * Logica: Carga agentes, ejecuciones, aprobaciones y estadisticas via servicios;
 *         adjunta library y drupalSettings para el frontend.
 */
function jaraba_agents_preprocess_page(array &$variables): void {
  $route_match = \Drupal::routeMatch();
  if ($route_match->getRouteName() !== 'jaraba_agents.dashboard') {
    return;
  }

  /** @var \Drupal\Core\Entity\EntityTypeManagerInterface $entity_type_manager */
  $entity_type_manager = \Drupal::entityTypeManager();

  // Estructura: Carga de agentes configurados.
  $agents = [];
  if ($entity_type_manager->hasDefinition('autonomous_agent')) {
    $agents = $entity_type_manager->getStorage('autonomous_agent')->loadMultiple();
  }

  // Estructura: Carga de ejecuciones recientes.
  $executions = [];
  if ($entity_type_manager->hasDefinition('agent_execution')) {
    $execution_storage = $entity_type_manager->getStorage('agent_execution');
    $execution_ids = $execution_storage->getQuery()
      ->accessCheck(TRUE)
      ->sort('created', 'DESC')
      ->range(0, 20)
      ->execute();
    $executions = $execution_storage->loadMultiple($execution_ids);
  }

  // Estructura: Carga de aprobaciones pendientes.
  $approvals = [];
  if ($entity_type_manager->hasDefinition('agent_approval')) {
    $approval_storage = $entity_type_manager->getStorage('agent_approval');
    $approval_ids = $approval_storage->getQuery()
      ->accessCheck(TRUE)
      ->condition('status', 'pending')
      ->sort('created', 'DESC')
      ->execute();
    $approvals = $approval_storage->loadMultiple($approval_ids);
  }

  // Logica: Estadisticas agregadas para el dashboard.
  /** @var \Drupal\jaraba_agents\Service\AgentMetricsCollectorService $metrics_service */
  $metrics_service = \Drupal::service('jaraba_agents.metrics');
  $stats = $metrics_service->collectDashboardStats();

  $variables['agents'] = $agents;
  $variables['executions'] = $executions;
  $variables['approvals'] = $approvals;
  $variables['stats'] = $stats;

  // Logica: Adjuntar library y configuracion JS para el frontend.
  $variables['#attached']['library'][] = 'jaraba_agents/agents.main';
  $variables['#attached']['drupalSettings']['jarabaAgents'] = [
    'apiBase' => '/api/v1/agents',
    'agentCount' => count($agents),
    'pendingApprovals' => count($approvals),
    'stats' => $stats,
  ];
}

/**
 * Implements hook_entity_insert().
 *
 * Estructura: Registro de eventos al crear ejecuciones de agentes.
 * Logica: Log informativo cuando se crea una entidad agent_execution.
 */
function jaraba_agents_entity_insert(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() === 'agent_execution') {
    \Drupal::logger('jaraba_agents')->info(
      'Ejecucion de agente creada: @id para agente @agent.',
      [
        '@id' => $entity->id(),
        '@agent' => $entity->get('agent_id')->target_id ?? 'desconocido',
      ]
    );
  }
}

/**
 * Implements hook_entity_update().
 *
 * Estructura: Registro de cambios de estado en aprobaciones.
 * Logica: Log informativo cuando cambia el status de una entidad agent_approval.
 */
function jaraba_agents_entity_update(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'agent_approval') {
    return;
  }

  /** @var \Drupal\Core\Entity\ContentEntityInterface $entity */
  $original = $entity->original ?? NULL;
  if ($original === NULL) {
    return;
  }

  $new_status = $entity->get('status')->value ?? '';
  $old_status = $original->get('status')->value ?? '';

  if ($new_status !== $old_status) {
    \Drupal::logger('jaraba_agents')->info(
      'Aprobacion @id cambio de estado: @old â†’ @new.',
      [
        '@id' => $entity->id(),
        '@old' => $old_status,
        '@new' => $new_status,
      ]
    );
  }
}
