<?php

declare(strict_types=1);

/**
 * @file
 * Instalacion del modulo jaraba_agents.
 *
 * Estructura: Hook de instalacion para vocabularios taxonomicos y terminos iniciales.
 * Logica: Patron INSTALL-TAXONOMY-001 — Creacion de vocabularios agent_type y
 *         autonomy_level con terminos semilla necesarios para la operacion del modulo.
 */

use Drupal\taxonomy\Entity\Term;
use Drupal\taxonomy\Entity\Vocabulary;

/**
 * Implements hook_install().
 *
 * Estructura: Crea vocabularios taxonomicos y terminos iniciales.
 * Logica: Patron INSTALL-TAXONOMY-001 — Los vocabularios se crean solo si no existen;
 *         los terminos se crean para cada vocabulario con pesos secuenciales.
 */
function jaraba_agents_install(): void {
  // -------------------------------------------------------------------
  // Vocabulario: agent_type — Tipos de agente disponibles.
  // -------------------------------------------------------------------
  if (!Vocabulary::load('agent_type')) {
    Vocabulary::create([
      'vid' => 'agent_type',
      'name' => 'Tipo de agente',
      'description' => 'Clasificacion de agentes autonomos por funcion.',
    ])->save();
  }

  $agent_types = [
    'Enrollment',
    'Planning',
    'Support',
    'Marketing',
    'Analytics',
  ];

  foreach ($agent_types as $weight => $term_name) {
    Term::create([
      'vid' => 'agent_type',
      'name' => $term_name,
      'weight' => $weight,
    ])->save();
  }

  // -------------------------------------------------------------------
  // Vocabulario: autonomy_level — Niveles de autonomia de agentes.
  // -------------------------------------------------------------------
  if (!Vocabulary::load('autonomy_level')) {
    Vocabulary::create([
      'vid' => 'autonomy_level',
      'name' => 'Nivel de autonomia',
      'description' => 'Escala de autonomia para agentes IA (L0 a L4).',
    ])->save();
  }

  $autonomy_levels = [
    'L0 Informativo',
    'L1 Sugerencia',
    'L2 Semi-autonomo',
    'L3 Supervisado',
    'L4 Autonomo completo',
  ];

  foreach ($autonomy_levels as $weight => $term_name) {
    Term::create([
      'vid' => 'autonomy_level',
      'name' => $term_name,
      'weight' => $weight,
    ])->save();
  }

  \Drupal::logger('jaraba_agents')->notice(
    'Modulo jaraba_agents instalado: vocabularios agent_type y autonomy_level creados con terminos iniciales.'
  );
}

/**
 * Instala campos de programacion (schedule) en AutonomousAgent (GAP-05).
 *
 * Estructura: Anade 4 nuevos campos base a autonomous_agent:
 *   - schedule_type (list_string): Tipo de programacion.
 *   - schedule_config (string_long): JSON con parametros de la programacion.
 *   - last_run (timestamp): Ultima ejecucion programada.
 *   - next_run (timestamp): Proxima ejecucion calculada.
 *
 * Logica: Patron DRUPAL-ENTUP-001 — Usa installFieldStorageDefinition()
 *         para registrar las definiciones de campos ya declaradas en
 *         AutonomousAgent::baseFieldDefinitions().
 */
function jaraba_agents_update_10001(&$sandbox): string {
  $entity_type_id = 'autonomous_agent';
  $fields_to_install = ['schedule_type', 'schedule_config', 'last_run', 'next_run'];

  $entity_definition_update_manager = \Drupal::entityDefinitionUpdateManager();
  $entity_field_manager = \Drupal::service('entity_field.manager');

  // Obtener definiciones de campos desde la clase de entidad.
  $field_definitions = $entity_field_manager->getFieldStorageDefinitions($entity_type_id);

  $installed = [];
  foreach ($fields_to_install as $field_name) {
    if (isset($field_definitions[$field_name])) {
      try {
        $entity_definition_update_manager->installFieldStorageDefinition(
          $field_name,
          $entity_type_id,
          'jaraba_agents',
          $field_definitions[$field_name]
        );
        $installed[] = $field_name;
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_agents')->error(
          'Error instalando campo @field para @entity: @message',
          [
            '@field' => $field_name,
            '@entity' => $entity_type_id,
            '@message' => $e->getMessage(),
          ]
        );
      }
    }
    else {
      \Drupal::logger('jaraba_agents')->warning(
        'Campo @field no encontrado en definiciones de @entity.',
        ['@field' => $field_name, '@entity' => $entity_type_id]
      );
    }
  }

  if (!empty($installed)) {
    return (string) t('GAP-05: Campos de programacion instalados en AutonomousAgent: @fields', [
      '@fields' => implode(', ', $installed),
    ]);
  }

  return (string) t('GAP-05: Ningun campo de programacion necesitaba instalacion en AutonomousAgent.');
}
