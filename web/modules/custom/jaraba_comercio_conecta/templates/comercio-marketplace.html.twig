{#
/**
 * @file
 * Template del marketplace público de ComercioConecta.
 *
 * DIRECTRIZ: Template limpia sin page.content. Header/Footer via partials del tema.
 * Body classes inyectadas via hook_preprocess_html(): comercio-page, marketplace-page.
 *
 * Variables:
 *   - products: Array de entidades ProductRetail.
 *   - categories: Array de términos de taxonomía comercio_category.
 *   - brands: Array de términos de taxonomía comercio_brand.
 *   - merchants: Array de entidades MerchantProfile.
 *   - current_filters: Array con los filtros activos.
 *   - total_results: Total de productos encontrados.
 *   - pager: Array con page, per_page, total_pages.
 */
#}

{# === Hero del Marketplace === #}
<section class="comercio-marketplace-hero" role="main" aria-label="{{ 'Marketplace Local'|trans }}">
  <div class="comercio-marketplace-hero__inner container">
    <h1 class="comercio-marketplace-hero__title">{% trans %}Marketplace Local{% endtrans %}</h1>
    <p class="comercio-marketplace-hero__subtitle">
      {% trans %}Descubre los mejores productos de los comercios de tu barrio{% endtrans %}
    </p>
    <p class="comercio-marketplace-hero__stats">
      {{ total_results }} {% trans %}productos disponibles{% endtrans %}
    </p>

    {# Barra de búsqueda #}
    <div class="comercio-marketplace-hero__search" role="search">
      <form class="comercio-search-form" method="get" action="">
        <input type="search"
               name="q"
               class="comercio-search-form__input"
               placeholder="{{ 'Buscar productos, comercios...'|trans }}"
               value="{{ current_filters.q|default('') }}"
               aria-label="{{ 'Buscar productos'|trans }}">
        <button type="submit" class="comercio-search-form__btn" aria-label="{{ 'Buscar'|trans }}">
          {{ jaraba_icon('ui', 'search', { variant: 'outline', size: '20px' }) }}
        </button>
      </form>
    </div>
  </div>
</section>

{# === Contenido principal: Sidebar filtros + Grid productos === #}
<div class="comercio-marketplace-content container">

  {# === Sidebar de filtros === #}
  <aside class="comercio-marketplace-sidebar" role="complementary" aria-label="{{ 'Filtros de productos'|trans }}">

    {# Filtros activos (chips removibles) #}
    {% if current_filters|length > 0 %}
      <div class="comercio-filters-active">
        <h3 class="comercio-filters-active__title">{% trans %}Filtros activos{% endtrans %}</h3>
        <div class="comercio-filters-active__chips">
          {% for key, value in current_filters %}
            <span class="comercio-chip comercio-chip--filter">
              {{ value }}
              <a href="?{{ current_filters|filter((v, k) => k != key)|url_encode }}"
                 class="comercio-chip__remove"
                 aria-label="{{ 'Quitar filtro'|trans }}">×</a>
            </span>
          {% endfor %}
          <a href="?" class="comercio-filters-active__clear">{% trans %}Limpiar todo{% endtrans %}</a>
        </div>
      </div>
    {% endif %}

    {# Filtro: Categorías #}
    {% if categories|length > 0 %}
      <div class="comercio-filter-group">
        <h3 class="comercio-filter-group__title">{% trans %}Categorías{% endtrans %}</h3>
        <ul class="comercio-filter-group__list">
          {% for category in categories %}
            <li class="comercio-filter-group__item">
              <a href="?category={{ category.id() }}"
                 class="comercio-filter-group__link {{ current_filters.category_id == category.id() ? 'comercio-filter-group__link--active' : '' }}">
                {{ category.label() }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {# Filtro: Comercios #}
    {% if merchants|length > 0 %}
      <div class="comercio-filter-group">
        <h3 class="comercio-filter-group__title">{% trans %}Comercios{% endtrans %}</h3>
        <ul class="comercio-filter-group__list">
          {% for merchant in merchants %}
            <li class="comercio-filter-group__item">
              <a href="?merchant={{ merchant.id() }}"
                 class="comercio-filter-group__link {{ current_filters.merchant_id == merchant.id() ? 'comercio-filter-group__link--active' : '' }}">
                {{ merchant.get('business_name').value }}
              </a>
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {# Filtro: Rango de precio #}
    <div class="comercio-filter-group">
      <h3 class="comercio-filter-group__title">{% trans %}Precio{% endtrans %}</h3>
      <form class="comercio-price-filter" method="get">
        <div class="comercio-price-filter__inputs">
          <input type="number" name="price_min" min="0" step="0.01"
                 placeholder="{{ 'Mín'|trans }}"
                 value="{{ current_filters.price_min|default('') }}"
                 class="comercio-price-filter__input"
                 aria-label="{{ 'Precio mínimo'|trans }}">
          <span class="comercio-price-filter__separator">—</span>
          <input type="number" name="price_max" min="0" step="0.01"
                 placeholder="{{ 'Máx'|trans }}"
                 value="{{ current_filters.price_max|default('') }}"
                 class="comercio-price-filter__input"
                 aria-label="{{ 'Precio máximo'|trans }}">
        </div>
        <button type="submit" class="comercio-price-filter__btn">{% trans %}Aplicar{% endtrans %}</button>
      </form>
    </div>

    {# Filtro: Solo en stock #}
    <div class="comercio-filter-group">
      <label class="comercio-filter-checkbox">
        <input type="checkbox"
               name="in_stock"
               value="1"
               {{ current_filters.in_stock_only ? 'checked' : '' }}
               onchange="this.form.submit()">
        <span>{% trans %}Solo productos en stock{% endtrans %}</span>
      </label>
    </div>
  </aside>

  {# === Grid de productos === #}
  <section class="comercio-marketplace-grid" aria-label="{{ 'Listado de productos'|trans }}">

    {# Barra de ordenación #}
    <div class="comercio-sort-bar">
      <span class="comercio-sort-bar__count">
        {{ total_results }} {% trans %}productos{% endtrans %}
      </span>
      <div class="comercio-sort-bar__controls">
        <label for="comercio-sort" class="sr-only">{% trans %}Ordenar por{% endtrans %}</label>
        <select id="comercio-sort" class="comercio-sort-bar__select" data-sort-control>
          <option value="newest" {{ pager.sort|default('newest') == 'newest' ? 'selected' : '' }}>{% trans %}Más recientes{% endtrans %}</option>
          <option value="price_asc" {{ pager.sort == 'price_asc' ? 'selected' : '' }}>{% trans %}Precio: menor a mayor{% endtrans %}</option>
          <option value="price_desc" {{ pager.sort == 'price_desc' ? 'selected' : '' }}>{% trans %}Precio: mayor a menor{% endtrans %}</option>
          <option value="name_asc" {{ pager.sort == 'name_asc' ? 'selected' : '' }}>{% trans %}Nombre: A-Z{% endtrans %}</option>
        </select>
      </div>
    </div>

    {# Grid de productos #}
    {% if products|length > 0 %}
      <div class="comercio-products-grid" role="list">
        {% for product in products %}
          {% include '@jaraba_comercio_conecta/partials/_comercio-product-card.html.twig' with {
            'product': product
          } only %}
        {% endfor %}
      </div>

      {# Paginación #}
      {% if pager and pager.total_pages > 1 %}
        <nav class="comercio-pager" aria-label="{{ 'Paginación de productos'|trans }}">
          <ul class="comercio-pager__list">
            {% if pager.page > 0 %}
              <li class="comercio-pager__item">
                <a href="?page={{ pager.page - 1 }}" class="comercio-pager__link comercio-pager__link--prev" aria-label="{{ 'Página anterior'|trans }}">
                  ← {% trans %}Anterior{% endtrans %}
                </a>
              </li>
            {% endif %}

            {% for i in 0..pager.total_pages - 1 %}
              <li class="comercio-pager__item">
                {% if i == pager.page %}
                  <span class="comercio-pager__link comercio-pager__link--active" aria-current="page">{{ i + 1 }}</span>
                {% else %}
                  <a href="?page={{ i }}" class="comercio-pager__link">{{ i + 1 }}</a>
                {% endif %}
              </li>
            {% endfor %}

            {% if pager.page < pager.total_pages - 1 %}
              <li class="comercio-pager__item">
                <a href="?page={{ pager.page + 1 }}" class="comercio-pager__link comercio-pager__link--next" aria-label="{{ 'Página siguiente'|trans }}">
                  {% trans %}Siguiente{% endtrans %} →
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}

    {% else %}
      {# Estado vacío #}
      <div class="comercio-empty-state">
        <div class="comercio-empty-state__icon">
          {{ jaraba_icon('commerce', 'shopping-bag', { variant: 'duotone', size: '64px' }) }}
        </div>
        <h3 class="comercio-empty-state__title">{% trans %}No se encontraron productos{% endtrans %}</h3>
        <p class="comercio-empty-state__text">
          {% trans %}Prueba a cambiar los filtros o vuelve a buscar más tarde.{% endtrans %}
        </p>
        {% if current_filters|length > 0 %}
          <a href="?" class="comercio-btn comercio-btn--secondary">{% trans %}Limpiar filtros{% endtrans %}</a>
        {% endif %}
      </div>
    {% endif %}
  </section>
</div>
