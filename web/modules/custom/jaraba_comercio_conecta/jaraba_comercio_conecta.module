<?php

/**
 * @file
 * Módulo principal de ComercioConecta.
 *
 * Estructura: Define hooks de tema, preproceso y automatizaciones para
 *   el vertical de comercio de proximidad del Ecosistema Jaraba.
 *
 * Lógica: Los hooks implementan el patrón de automatización por código
 *   (no ECA BPMN) siguiendo la directriz del proyecto. Cada hook
 *   incluye verificación de tipo de entidad para evitar conflictos
 *   con otras entidades del ecosistema.
 *
 * Sintaxis: Todas las funciones siguen el patrón hook_name() de Drupal.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Render\Markup;

/**
 * Implements hook_theme().
 *
 * Estructura: Registra todos los templates Twig del módulo.
 *   Cada template tiene sus variables documentadas con tipo y propósito.
 *
 * Lógica: Los templates se usan desde los controllers via render arrays
 *   con '#theme' => 'nombre_del_template'. Las variables se pasan
 *   como '#variable_name' => $valor en el render array.
 */
function jaraba_comercio_conecta_theme(): array {
  return [
    // Template principal del marketplace con grid de productos y filtros
    'comercio_marketplace' => [
      'variables' => [
        'products' => [],
        'categories' => [],
        'brands' => [],
        'merchants' => [],
        'current_filters' => [],
        'total_results' => 0,
        'pager' => NULL,
      ],
      'template' => 'comercio-marketplace',
    ],
    // Página de detalle de un producto individual
    'comercio_product_detail' => [
      'variables' => [
        'product' => NULL,
        'variations' => [],
        'merchant' => NULL,
        'related_products' => [],
        'reviews' => [],
        'review_summary' => NULL,
        'schema_json_ld' => '',
      ],
      'template' => 'comercio-product-detail',
    ],
    // Dashboard del comerciante con KPIs y acciones rápidas
    'comercio_merchant_dashboard' => [
      'variables' => [
        'merchant' => NULL,
        'kpis' => [],
        'recent_orders' => [],
        'stock_alerts' => [],
        'sales_chart_data' => [],
      ],
      'template' => 'comercio-merchant-dashboard',
    ],
    // Listado de productos del comerciante
    'comercio_merchant_products' => [
      'variables' => [
        'merchant' => NULL,
        'products' => [],
        'total' => 0,
        'current_filters' => [],
      ],
      'template' => 'comercio-merchant-products',
    ],
    // Dashboard de analíticas del comerciante
    'comercio_merchant_analytics' => [
      'variables' => [
        'merchant' => NULL,
        'kpis' => [],
        'charts' => [],
        'top_products' => [],
        'period' => '30d',
      ],
      'template' => 'comercio-merchant-analytics',
    ],
  ];
}

/**
 * Implements hook_entity_insert().
 *
 * Estructura: Hook que se dispara al crear cualquier entidad.
 *   Filtra por tipo de entidad para actuar solo en entidades
 *   de ComercioConecta.
 *
 * Lógica: Al crear un MerchantProfile, se genera automáticamente
 *   el slug URL-friendly a partir del nombre del comercio si no
 *   se proporcionó uno explícito.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   La entidad recién creada.
 */
function jaraba_comercio_conecta_entity_insert(EntityInterface $entity): void {
  // Auto-generar slug para nuevos perfiles de comerciante
  if ($entity->getEntityTypeId() === 'merchant_profile') {
    $slug = $entity->get('slug')->value;
    if (empty($slug)) {
      $business_name = $entity->get('business_name')->value;
      // Genera slug limpio: minúsculas, sin acentos, guiones
      $slug = _jaraba_comercio_conecta_generate_slug($business_name);
      $entity->set('slug', $slug);
      $entity->save();
    }
  }
}

/**
 * Implements hook_entity_update().
 *
 * Estructura: Hook para detectar cambios de estado en entidades.
 *
 * Lógica: Detecta transiciones de estado en productos y comerciantes
 *   para disparar notificaciones o acciones automáticas.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   La entidad actualizada.
 */
function jaraba_comercio_conecta_entity_update(EntityInterface $entity): void {
  // Detectar cambio de estado en MerchantProfile (verificación)
  if ($entity->getEntityTypeId() === 'merchant_profile') {
    $new_status = $entity->get('verification_status')->value;
    $old_status = $entity->original->get('verification_status')->value ?? '';
    if ($new_status !== $old_status && $new_status === 'approved') {
      \Drupal::logger('jaraba_comercio_conecta')->info(
        'Comerciante @name aprobado (ID: @id)',
        ['@name' => $entity->get('business_name')->value, '@id' => $entity->id()]
      );
      // Enviar notificación de aprobación al comerciante.
      try {
        $userId = $entity->get('user_id')->target_id ?? NULL;
        if ($userId) {
          $user = \Drupal::entityTypeManager()->getStorage('user')->load($userId);
          if ($user && $user->getEmail()) {
            \Drupal::service('plugin.manager.mail')->mail(
              'jaraba_comercio_conecta',
              'merchant_approved',
              $user->getEmail(),
              $user->getPreferredLangcode(),
              [
                'merchant_name' => $entity->get('shop_name')->value ?? $user->getDisplayName(),
              ]
            );
          }
        }
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_comercio_conecta')->error('Error enviando notificación de aprobación: @e', ['@e' => $e->getMessage()]);
      }
    }
  }

  // Detectar stock bajo en productos
  if ($entity->getEntityTypeId() === 'product_retail') {
    $stock = (int) $entity->get('stock_quantity')->value;
    $threshold = (int) ($entity->get('low_stock_threshold')->value ?: 5);
    if ($stock > 0 && $stock <= $threshold) {
      \Drupal::logger('jaraba_comercio_conecta')->notice(
        'Stock bajo para producto @title (stock: @stock, umbral: @threshold)',
        [
          '@title' => $entity->get('title')->value,
          '@stock' => $stock,
          '@threshold' => $threshold,
        ]
      );
      // Notificación de stock bajo al comerciante.
      try {
        $shopId = $entity->get('shop_id')->target_id ?? NULL;
        if ($shopId) {
          $shop = \Drupal::entityTypeManager()->getStorage('merchant_shop')->load($shopId);
          $ownerId = $shop ? ($shop->get('user_id')->target_id ?? NULL) : NULL;
          if ($ownerId) {
            $owner = \Drupal::entityTypeManager()->getStorage('user')->load($ownerId);
            if ($owner && $owner->getEmail()) {
              \Drupal::service('plugin.manager.mail')->mail(
                'jaraba_comercio_conecta',
                'low_stock_alert',
                $owner->getEmail(),
                $owner->getPreferredLangcode(),
                [
                  'product_name' => $entity->label(),
                  'current_stock' => $entity->get('stock_quantity')->value ?? 0,
                ]
              );
            }
          }
        }
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_comercio_conecta')->error('Error enviando alerta de stock bajo: @e', ['@e' => $e->getMessage()]);
      }
    }
  }
}

/**
 * Implements hook_cron().
 *
 * Estructura: Tareas programadas del módulo ComercioConecta.
 *
 * Lógica: Ejecuta periódicamente verificaciones de stock,
 *   limpieza de carritos abandonados y sincronización.
 *   Se protege con un flag de estado para evitar ejecuciones
 *   concurrentes.
 */
function jaraba_comercio_conecta_cron(): void {
  $state = \Drupal::state();
  $last_run = $state->get('jaraba_comercio_conecta.cron_last_run', 0);
  $now = \Drupal::time()->getRequestTime();

  // Ejecutar cada 30 minutos como máximo
  if (($now - $last_run) < 1800) {
    return;
  }

  $state->set('jaraba_comercio_conecta.cron_last_run', $now);

  // Detectar carritos abandonados (>1h sin modificar) y enviar recordatorio.
  try {
    $cart_storage = \Drupal::entityTypeManager()->getStorage('comercio_cart');
    $one_hour_ago = $now - 3600;
    $abandoned_ids = $cart_storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('status', 'active')
      ->condition('changed', $one_hour_ago, '<')
      ->execute();

    if (!empty($abandoned_ids)) {
      $carts = $cart_storage->loadMultiple($abandoned_ids);
      foreach ($carts as $cart) {
        try {
          $uid = $cart->get('uid')->target_id ?? NULL;
          if ($uid) {
            $user = \Drupal::entityTypeManager()->getStorage('user')->load($uid);
            if ($user && $user->getEmail()) {
              \Drupal::service('plugin.manager.mail')->mail(
                'jaraba_comercio_conecta',
                'abandoned_cart_reminder',
                $user->getEmail(),
                $user->getPreferredLangcode(),
                [
                  'customer_name' => $user->getDisplayName(),
                  'cart_id' => $cart->id(),
                ]
              );
              // Marcar el carrito como notificado para no enviar duplicados.
              $cart->set('status', 'abandoned_notified');
              $cart->save();
            }
          }
        }
        catch (\Exception $e) {
          \Drupal::logger('jaraba_comercio_conecta')->error('Error procesando carrito abandonado @id: @e', [
            '@id' => $cart->id(),
            '@e' => $e->getMessage(),
          ]);
        }
      }
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_comercio_conecta')->error('Error en cron carritos abandonados: @e', ['@e' => $e->getMessage()]);
  }

  // Verificar flash offers expiradas y desactivarlas.
  try {
    $product_storage = \Drupal::entityTypeManager()->getStorage('product_retail');
    $expired_ids = $product_storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('flash_offer_end', $now, '<')
      ->condition('status', 'active')
      ->condition('flash_offer_end', NULL, 'IS NOT NULL')
      ->execute();

    if (!empty($expired_ids)) {
      $expired_products = $product_storage->loadMultiple($expired_ids);
      foreach ($expired_products as $product) {
        try {
          $product->set('status', 'expired');
          $product->save();
          \Drupal::logger('jaraba_comercio_conecta')->notice('Flash offer expirada para producto @title (ID: @id)', [
            '@title' => $product->label(),
            '@id' => $product->id(),
          ]);
        }
        catch (\Exception $e) {
          \Drupal::logger('jaraba_comercio_conecta')->error('Error expirando flash offer @id: @e', [
            '@id' => $product->id(),
            '@e' => $e->getMessage(),
          ]);
        }
      }
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_comercio_conecta')->error('Error en cron flash offers: @e', ['@e' => $e->getMessage()]);
  }

  // Reconciliación de stock POS: comparar stock registrado vs POS.
  try {
    $product_storage = \Drupal::entityTypeManager()->getStorage('product_retail');
    $pos_ids = $product_storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('pos_sync_enabled', TRUE)
      ->condition('status', ['active', 'paused'], 'IN')
      ->execute();

    if (!empty($pos_ids)) {
      $pos_products = $product_storage->loadMultiple($pos_ids);
      foreach ($pos_products as $product) {
        try {
          $platform_stock = (int) ($product->get('stock_quantity')->value ?? 0);
          $pos_stock = (int) ($product->get('pos_stock_quantity')->value ?? 0);
          if ($platform_stock !== $pos_stock) {
            \Drupal::logger('jaraba_comercio_conecta')->warning(
              'Discrepancia de stock POS para producto @title (ID: @id): plataforma=@platform, POS=@pos',
              [
                '@title' => $product->label(),
                '@id' => $product->id(),
                '@platform' => $platform_stock,
                '@pos' => $pos_stock,
              ]
            );
          }
        }
        catch (\Exception $e) {
          \Drupal::logger('jaraba_comercio_conecta')->error('Error reconciliando stock POS para @id: @e', [
            '@id' => $product->id(),
            '@e' => $e->getMessage(),
          ]);
        }
      }
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_comercio_conecta')->error('Error en cron reconciliación POS: @e', ['@e' => $e->getMessage()]);
  }
}

/**
 * Implements hook_mail().
 *
 * Estructura: Plantillas de email del módulo ComercioConecta.
 *
 * Lógica: Define subject y body para cada tipo de correo transaccional.
 *   Los templates usan variables del array $params inyectado desde
 *   los hooks y servicios que disparan el envío.
 *
 * @param string $key
 *   Identificador de la plantilla de email.
 * @param array $message
 *   Array del mensaje (por referencia) con subject y body.
 * @param array $params
 *   Parámetros contextuales para el template.
 */
function jaraba_comercio_conecta_mail(string $key, array &$message, array $params): void {
  switch ($key) {
    case 'merchant_approved':
      $message['subject'] = t('¡Tu comercio ha sido aprobado en ComercioConecta!');
      $message['body'][] = t('Hola @name,', ['@name' => $params['merchant_name'] ?? 'Comerciante']);
      $message['body'][] = t('Tu perfil de comerciante ha sido verificado y aprobado. Ya puedes publicar productos y recibir pedidos en la plataforma.');
      $message['body'][] = t('Accede a tu panel de comerciante para empezar a vender.');
      break;

    case 'low_stock_alert':
      $message['subject'] = t('Alerta de stock bajo: @product', ['@product' => $params['product_name'] ?? '']);
      $message['body'][] = t('Hola,');
      $message['body'][] = t('El producto "@product" tiene un stock bajo de @stock unidades. Te recomendamos reabastecer para no perder ventas.', [
        '@product' => $params['product_name'] ?? '',
        '@stock' => $params['current_stock'] ?? 0,
      ]);
      break;

    case 'abandoned_cart_reminder':
      $message['subject'] = t('¡No te olvides de tu carrito en ComercioConecta!');
      $message['body'][] = t('Hola @name,', ['@name' => $params['customer_name'] ?? 'Cliente']);
      $message['body'][] = t('Tienes productos esperándote en tu carrito de compra. Completa tu pedido antes de que se agoten.');
      break;
  }

  // Footer común para todos los correos del módulo.
  if (!empty($message['body'])) {
    $message['body'][] = '';
    $message['body'][] = '---';
    $message['body'][] = t('Jaraba Impact Platform - ComercioConecta');
  }
}

/**
 * Genera un slug URL-friendly a partir de un texto.
 *
 * Lógica: Convierte a minúsculas, elimina acentos y caracteres
 *   especiales, reemplaza espacios por guiones, y trunca a 128 chars.
 *   Verifica unicidad dentro del tenant añadiendo un sufijo numérico
 *   si es necesario.
 *
 * @param string $text
 *   Texto fuente para generar el slug.
 *
 * @return string
 *   Slug limpio y único.
 */
function _jaraba_comercio_conecta_generate_slug(string $text): string {
  // Tabla de transliteración para caracteres españoles
  $transliteration = [
    'á' => 'a', 'é' => 'e', 'í' => 'i', 'ó' => 'o', 'ú' => 'u',
    'ñ' => 'n', 'ü' => 'u', 'Á' => 'a', 'É' => 'e', 'Í' => 'i',
    'Ó' => 'o', 'Ú' => 'u', 'Ñ' => 'n', 'Ü' => 'u',
  ];

  $slug = strtr(mb_strtolower($text), $transliteration);
  // Solo caracteres alfanuméricos y guiones
  $slug = preg_replace('/[^a-z0-9\-]/', '-', $slug);
  // Eliminar guiones múltiples
  $slug = preg_replace('/-+/', '-', $slug);
  // Eliminar guiones al inicio y final
  $slug = trim($slug, '-');
  // Truncar a 128 caracteres
  $slug = substr($slug, 0, 128);

  return $slug;
}
