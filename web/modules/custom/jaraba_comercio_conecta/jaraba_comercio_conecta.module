<?php

/**
 * @file
 * Módulo principal de ComercioConecta.
 *
 * Estructura: Define hooks de tema, preproceso y automatizaciones para
 *   el vertical de comercio de proximidad del Ecosistema Jaraba.
 *
 * Lógica: Los hooks implementan el patrón de automatización por código
 *   (no ECA BPMN) siguiendo la directriz del proyecto. Cada hook
 *   incluye verificación de tipo de entidad para evitar conflictos
 *   con otras entidades del ecosistema.
 *
 * Sintaxis: Todas las funciones siguen el patrón hook_name() de Drupal.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Render\Markup;

/**
 * Implements hook_theme().
 *
 * Estructura: Registra todos los templates Twig del módulo.
 *   Cada template tiene sus variables documentadas con tipo y propósito.
 *
 * Lógica: Los templates se usan desde los controllers via render arrays
 *   con '#theme' => 'nombre_del_template'. Las variables se pasan
 *   como '#variable_name' => $valor en el render array.
 */
function jaraba_comercio_conecta_theme(): array {
  return [
    // Template principal del marketplace con grid de productos y filtros
    'comercio_marketplace' => [
      'variables' => [
        'products' => [],
        'categories' => [],
        'brands' => [],
        'merchants' => [],
        'current_filters' => [],
        'total_results' => 0,
        'pager' => NULL,
      ],
      'template' => 'comercio-marketplace',
    ],
    // Página de detalle de un producto individual
    'comercio_product_detail' => [
      'variables' => [
        'product' => NULL,
        'variations' => [],
        'merchant' => NULL,
        'related_products' => [],
        'reviews' => [],
        'review_summary' => NULL,
        'schema_json_ld' => '',
      ],
      'template' => 'comercio-product-detail',
    ],
    // Dashboard del comerciante con KPIs y acciones rápidas
    'comercio_merchant_dashboard' => [
      'variables' => [
        'merchant' => NULL,
        'kpis' => [],
        'recent_orders' => [],
        'stock_alerts' => [],
        'sales_chart_data' => [],
      ],
      'template' => 'comercio-merchant-dashboard',
    ],
    // Listado de productos del comerciante
    'comercio_merchant_products' => [
      'variables' => [
        'merchant' => NULL,
        'products' => [],
        'total' => 0,
        'current_filters' => [],
      ],
      'template' => 'comercio-merchant-products',
    ],
    // Dashboard de analíticas del comerciante
    'comercio_merchant_analytics' => [
      'variables' => [
        'merchant' => NULL,
        'kpis' => [],
        'charts' => [],
        'top_products' => [],
        'period' => '30d',
      ],
      'template' => 'comercio-merchant-analytics',
    ],
  ];
}

/**
 * Implements hook_entity_insert().
 *
 * Estructura: Hook que se dispara al crear cualquier entidad.
 *   Filtra por tipo de entidad para actuar solo en entidades
 *   de ComercioConecta.
 *
 * Lógica: Al crear un MerchantProfile, se genera automáticamente
 *   el slug URL-friendly a partir del nombre del comercio si no
 *   se proporcionó uno explícito.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   La entidad recién creada.
 */
function jaraba_comercio_conecta_entity_insert(EntityInterface $entity): void {
  // Auto-generar slug para nuevos perfiles de comerciante
  if ($entity->getEntityTypeId() === 'merchant_profile') {
    $slug = $entity->get('slug')->value;
    if (empty($slug)) {
      $business_name = $entity->get('business_name')->value;
      // Genera slug limpio: minúsculas, sin acentos, guiones
      $slug = _jaraba_comercio_conecta_generate_slug($business_name);
      $entity->set('slug', $slug);
      $entity->save();
    }
  }
}

/**
 * Implements hook_entity_update().
 *
 * Estructura: Hook para detectar cambios de estado en entidades.
 *
 * Lógica: Detecta transiciones de estado en productos y comerciantes
 *   para disparar notificaciones o acciones automáticas.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   La entidad actualizada.
 */
function jaraba_comercio_conecta_entity_update(EntityInterface $entity): void {
  // Detectar cambio de estado en MerchantProfile (verificación)
  if ($entity->getEntityTypeId() === 'merchant_profile') {
    $new_status = $entity->get('verification_status')->value;
    $old_status = $entity->original->get('verification_status')->value ?? '';
    if ($new_status !== $old_status && $new_status === 'approved') {
      \Drupal::logger('jaraba_comercio_conecta')->info(
        'Comerciante @name aprobado (ID: @id)',
        ['@name' => $entity->get('business_name')->value, '@id' => $entity->id()]
      );
      // TODO Fase 6: Enviar notificación de aprobación al comerciante
    }
  }

  // Detectar stock bajo en productos
  if ($entity->getEntityTypeId() === 'product_retail') {
    $stock = (int) $entity->get('stock_quantity')->value;
    $threshold = (int) ($entity->get('low_stock_threshold')->value ?: 5);
    if ($stock > 0 && $stock <= $threshold) {
      \Drupal::logger('jaraba_comercio_conecta')->notice(
        'Stock bajo para producto @title (stock: @stock, umbral: @threshold)',
        [
          '@title' => $entity->get('title')->value,
          '@stock' => $stock,
          '@threshold' => $threshold,
        ]
      );
      // TODO Fase 6: Notificación de stock bajo al comerciante
    }
  }
}

/**
 * Implements hook_cron().
 *
 * Estructura: Tareas programadas del módulo ComercioConecta.
 *
 * Lógica: Ejecuta periódicamente verificaciones de stock,
 *   limpieza de carritos abandonados y sincronización.
 *   Se protege con un flag de estado para evitar ejecuciones
 *   concurrentes.
 */
function jaraba_comercio_conecta_cron(): void {
  $state = \Drupal::state();
  $last_run = $state->get('jaraba_comercio_conecta.cron_last_run', 0);
  $now = \Drupal::time()->getRequestTime();

  // Ejecutar cada 30 minutos como máximo
  if (($now - $last_run) < 1800) {
    return;
  }

  $state->set('jaraba_comercio_conecta.cron_last_run', $now);

  // TODO Fase 2: Detectar carritos abandonados (>1h sin modificar)
  // TODO Fase 5: Verificar flash offers expiradas
  // TODO Fase 7: Reconciliación de stock POS
}

/**
 * Genera un slug URL-friendly a partir de un texto.
 *
 * Lógica: Convierte a minúsculas, elimina acentos y caracteres
 *   especiales, reemplaza espacios por guiones, y trunca a 128 chars.
 *   Verifica unicidad dentro del tenant añadiendo un sufijo numérico
 *   si es necesario.
 *
 * @param string $text
 *   Texto fuente para generar el slug.
 *
 * @return string
 *   Slug limpio y único.
 */
function _jaraba_comercio_conecta_generate_slug(string $text): string {
  // Tabla de transliteración para caracteres españoles
  $transliteration = [
    'á' => 'a', 'é' => 'e', 'í' => 'i', 'ó' => 'o', 'ú' => 'u',
    'ñ' => 'n', 'ü' => 'u', 'Á' => 'a', 'É' => 'e', 'Í' => 'i',
    'Ó' => 'o', 'Ú' => 'u', 'Ñ' => 'n', 'Ü' => 'u',
  ];

  $slug = strtr(mb_strtolower($text), $transliteration);
  // Solo caracteres alfanuméricos y guiones
  $slug = preg_replace('/[^a-z0-9\-]/', '-', $slug);
  // Eliminar guiones múltiples
  $slug = preg_replace('/-+/', '-', $slug);
  // Eliminar guiones al inicio y final
  $slug = trim($slug, '-');
  // Truncar a 128 caracteres
  $slug = substr($slug, 0, 128);

  return $slug;
}
