<?php

declare(strict_types=1);

/**
 * @file
 * Módulo principal de ComercioConecta.
 *
 * Estructura: Define hooks de tema, preproceso y automatizaciones para
 *   el vertical de comercio de proximidad del Ecosistema Jaraba.
 *
 * Lógica: Los hooks implementan el patrón de automatización por código
 *   (no ECA BPMN) siguiendo la directriz del proyecto. Cada hook
 *   incluye verificación de tipo de entidad para evitar conflictos
 *   con otras entidades del ecosistema.
 *
 * Sintaxis: Todas las funciones siguen el patrón hook_name() de Drupal.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Render\Markup;

/**
 * Implements hook_theme().
 *
 * Estructura: Registra todos los templates Twig del módulo.
 *   Cada template tiene sus variables documentadas con tipo y propósito.
 *
 * Lógica: Los templates se usan desde los controllers via render arrays
 *   con '#theme' => 'nombre_del_template'. Las variables se pasan
 *   como '#variable_name' => $valor en el render array.
 */
function jaraba_comercio_conecta_theme(): array {
  return [
    // Template principal del marketplace con grid de productos y filtros
    'comercio_marketplace' => [
      'variables' => [
        'products' => [],
        'categories' => [],
        'brands' => [],
        'merchants' => [],
        'current_filters' => [],
        'total_results' => 0,
        'pager' => NULL,
      ],
      'template' => 'comercio-marketplace',
    ],
    // Página de detalle de un producto individual
    'comercio_product_detail' => [
      'variables' => [
        'product' => NULL,
        'variations' => [],
        'merchant' => NULL,
        'related_products' => [],
        'reviews' => [],
        'review_summary' => NULL,
        'schema_json_ld' => '',
      ],
      'template' => 'comercio-product-detail',
    ],
    // Dashboard del comerciante con KPIs y acciones rápidas
    'comercio_merchant_dashboard' => [
      'variables' => [
        'merchant' => NULL,
        'kpis' => [],
        'recent_orders' => [],
        'stock_alerts' => [],
        'sales_chart_data' => [],
      ],
      'template' => 'comercio-merchant-dashboard',
    ],
    // Listado de productos del comerciante
    'comercio_merchant_products' => [
      'variables' => [
        'merchant' => NULL,
        'products' => [],
        'total' => 0,
        'current_filters' => [],
      ],
      'template' => 'comercio-merchant-products',
    ],
    // Dashboard de analíticas del comerciante
    'comercio_merchant_analytics' => [
      'variables' => [
        'merchant' => NULL,
        'kpis' => [],
        'charts' => [],
        'top_products' => [],
        'period' => '30d',
      ],
      'template' => 'comercio-merchant-analytics',
    ],
    // F6: Pagina de checkout
    'comercio_checkout' => [
      'variables' => [
        'cart' => NULL,
        'items' => [],
        'empty' => TRUE,
        'subtotal' => 0,
        'discount' => 0,
        'shipping' => 0,
        'total' => 0,
      ],
      'template' => 'comercio-checkout',
    ],
    // F6: Confirmacion de pedido
    'comercio_checkout_confirmation' => [
      'variables' => [
        'order' => NULL,
        'order_number' => '',
        'total' => 0,
        'status' => '',
        'payment_status' => '',
      ],
      'template' => 'comercio-checkout-confirmation',
    ],
    // F6: Mis pedidos (listado cliente)
    'comercio_my_orders' => [
      'variables' => [
        'orders' => [],
        'total' => 0,
        'page' => 0,
        'total_pages' => 0,
      ],
      'template' => 'comercio-my-orders',
    ],
    // F6: Detalle de pedido
    'comercio_order_detail' => [
      'variables' => [
        'order' => NULL,
        'items' => [],
        'order_number' => '',
        'status' => '',
        'payment_status' => '',
        'subtotal' => 0,
        'tax_amount' => 0,
        'shipping_cost' => 0,
        'discount_amount' => 0,
        'total' => 0,
        'tracking_number' => '',
      ],
      'template' => 'comercio-order-detail',
    ],
    // F7: Dashboard del consumidor
    'comercio_customer_dashboard' => [
      'variables' => [
        'profile' => NULL,
        'recent_orders' => [],
        'stats' => [],
        'wishlist_count' => 0,
      ],
      'template' => 'comercio-customer-dashboard',
    ],
    // F7: Wishlist del consumidor
    'comercio_customer_wishlist' => [
      'variables' => [
        'wishlist' => NULL,
        'items' => [],
        'empty' => TRUE,
      ],
      'template' => 'comercio-customer-wishlist',
    ],
    // F7: Pedidos recibidos del comerciante
    'comercio_merchant_orders' => [
      'variables' => [
        'merchant' => NULL,
        'orders' => [],
        'total' => 0,
        'page' => 0,
        'total_pages' => 0,
      ],
      'template' => 'comercio-merchant-orders',
    ],
    // F7: Pagos y comisiones del comerciante
    'comercio_merchant_payments' => [
      'variables' => [
        'merchant' => NULL,
        'summary' => [],
        'recent_payouts' => [],
        'monthly_revenue' => [],
      ],
      'template' => 'comercio-merchant-payments',
    ],
    // F7: Configuracion del comercio
    'comercio_merchant_settings' => [
      'variables' => [
        'merchant' => NULL,
      ],
      'template' => 'comercio-merchant-settings',
    ],
    // F8: Pagina de busqueda
    'comercio_search' => [
      'variables' => [
        'query' => '',
        'results' => [],
        'total' => 0,
        'filters' => [],
      ],
      'template' => 'comercio-search',
    ],
  ];
}

/**
 * Implements hook_entity_insert().
 *
 * Estructura: Hook que se dispara al crear cualquier entidad.
 *   Filtra por tipo de entidad para actuar solo en entidades
 *   de ComercioConecta.
 *
 * Lógica: Al crear un MerchantProfile, se genera automáticamente
 *   el slug URL-friendly a partir del nombre del comercio si no
 *   se proporcionó uno explícito.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   La entidad recién creada.
 */
function jaraba_comercio_conecta_entity_insert(EntityInterface $entity): void {
  // Auto-generar slug para nuevos perfiles de comerciante
  if ($entity->getEntityTypeId() === 'merchant_profile') {
    $slug = $entity->get('slug')->value;
    if (empty($slug)) {
      $business_name = $entity->get('business_name')->value;
      // Genera slug limpio: minúsculas, sin acentos, guiones
      $slug = _jaraba_comercio_conecta_generate_slug($business_name);
      $entity->set('slug', $slug);
      $entity->save();
    }
  }
}

/**
 * Implements hook_entity_update().
 *
 * Estructura: Hook para detectar cambios de estado en entidades.
 *
 * Lógica: Detecta transiciones de estado en productos y comerciantes
 *   para disparar notificaciones o acciones automáticas.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   La entidad actualizada.
 */
function jaraba_comercio_conecta_entity_update(EntityInterface $entity): void {
  // Detectar cambio de estado en MerchantProfile (verificación)
  if ($entity->getEntityTypeId() === 'merchant_profile') {
    $new_status = $entity->get('verification_status')->value;
    $old_status = $entity->original->get('verification_status')->value ?? '';
    if ($new_status !== $old_status && $new_status === 'approved') {
      \Drupal::logger('jaraba_comercio_conecta')->info(
        'Comerciante @name aprobado (ID: @id)',
        ['@name' => $entity->get('business_name')->value, '@id' => $entity->id()]
      );
      // Enviar notificación de aprobación al comerciante.
      try {
        $userId = $entity->get('user_id')->target_id ?? NULL;
        if ($userId) {
          $user = \Drupal::entityTypeManager()->getStorage('user')->load($userId);
          if ($user && $user->getEmail()) {
            \Drupal::service('plugin.manager.mail')->mail(
              'jaraba_comercio_conecta',
              'merchant_approved',
              $user->getEmail(),
              $user->getPreferredLangcode(),
              [
                'merchant_name' => $entity->get('shop_name')->value ?? $user->getDisplayName(),
              ]
            );
          }
        }
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_comercio_conecta')->error('Error enviando notificación de aprobación: @e', ['@e' => $e->getMessage()]);
      }
    }
  }

  // Detectar stock bajo en productos
  if ($entity->getEntityTypeId() === 'product_retail') {
    $stock = (int) $entity->get('stock_quantity')->value;
    $threshold = (int) ($entity->get('low_stock_threshold')->value ?: 5);
    if ($stock > 0 && $stock <= $threshold) {
      \Drupal::logger('jaraba_comercio_conecta')->notice(
        'Stock bajo para producto @title (stock: @stock, umbral: @threshold)',
        [
          '@title' => $entity->get('title')->value,
          '@stock' => $stock,
          '@threshold' => $threshold,
        ]
      );
      // Notificación de stock bajo al comerciante.
      try {
        $shopId = $entity->get('shop_id')->target_id ?? NULL;
        if ($shopId) {
          $shop = \Drupal::entityTypeManager()->getStorage('merchant_profile')->load($shopId);
          $ownerId = $shop ? ($shop->get('user_id')->target_id ?? NULL) : NULL;
          if ($ownerId) {
            $owner = \Drupal::entityTypeManager()->getStorage('user')->load($ownerId);
            if ($owner && $owner->getEmail()) {
              \Drupal::service('plugin.manager.mail')->mail(
                'jaraba_comercio_conecta',
                'low_stock_alert',
                $owner->getEmail(),
                $owner->getPreferredLangcode(),
                [
                  'product_name' => $entity->label(),
                  'current_stock' => $entity->get('stock_quantity')->value ?? 0,
                ]
              );
            }
          }
        }
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_comercio_conecta')->error('Error enviando alerta de stock bajo: @e', ['@e' => $e->getMessage()]);
      }
    }
  }
}

/**
 * Implements hook_cron().
 *
 * Estructura: Tareas programadas del módulo ComercioConecta.
 *
 * Lógica: Ejecuta periódicamente verificaciones de stock,
 *   limpieza de carritos abandonados y sincronización.
 *   Se protege con un flag de estado para evitar ejecuciones
 *   concurrentes.
 */
function jaraba_comercio_conecta_cron(): void {
  $state = \Drupal::state();
  $last_run = $state->get('jaraba_comercio_conecta.cron_last_run', 0);
  $now = \Drupal::time()->getRequestTime();

  // Ejecutar cada 30 minutos como máximo
  if (($now - $last_run) < 1800) {
    return;
  }

  $state->set('jaraba_comercio_conecta.cron_last_run', $now);

  // Detectar carritos abandonados y enviar emails de recuperación via CartRecoveryService.
  if (\Drupal::entityTypeManager()->hasDefinition('comercio_cart')) {
    try {
      $container = \Drupal::getContainer();
      if ($container && $container->has('jaraba_comercio_conecta.cart_recovery')) {
        /** @var \Drupal\jaraba_comercio_conecta\Service\CartRecoveryService $recovery_service */
        $recovery_service = $container->get('jaraba_comercio_conecta.cart_recovery');
        $recovery_service->detectAbandonedCarts();
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_comercio_conecta')->error('Error en cron carritos abandonados: @e', ['@e' => $e->getMessage()]);
    }
  }

  // Activar/expirar ofertas flash via FlashOfferService.
  if (\Drupal::entityTypeManager()->hasDefinition('comercio_flash_offer')) {
    try {
      $container = \Drupal::getContainer();
      if ($container && $container->has('jaraba_comercio_conecta.flash_offer')) {
        /** @var \Drupal\jaraba_comercio_conecta\Service\FlashOfferService $flash_service */
        $flash_service = $container->get('jaraba_comercio_conecta.flash_offer');
        $flash_service->activateScheduledOffers();
        $flash_service->expireEndedOffers();
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_comercio_conecta')->error('Error en cron flash offers: @e', ['@e' => $e->getMessage()]);
    }
  }

  // Reconciliación de stock POS: comparar stock registrado vs POS.
  // Guard: pos_sync_enabled field aún no definido en ProductRetail.
  if (isset($productFieldDefs['pos_sync_enabled'])) {
    try {
      $product_storage = \Drupal::entityTypeManager()->getStorage('product_retail');
      $pos_ids = $product_storage->getQuery()
        ->accessCheck(FALSE)
        ->condition('pos_sync_enabled', TRUE)
        ->condition('status', ['active', 'paused'], 'IN')
        ->execute();

      if (!empty($pos_ids)) {
        $pos_products = $product_storage->loadMultiple($pos_ids);
        foreach ($pos_products as $product) {
          try {
            $platform_stock = (int) ($product->get('stock_quantity')->value ?? 0);
            $pos_stock = (int) ($product->get('pos_stock_quantity')->value ?? 0);
            if ($platform_stock !== $pos_stock) {
              \Drupal::logger('jaraba_comercio_conecta')->warning(
                'Discrepancia de stock POS para producto @title (ID: @id): plataforma=@platform, POS=@pos',
                [
                  '@title' => $product->label(),
                  '@id' => $product->id(),
                  '@platform' => $platform_stock,
                  '@pos' => $pos_stock,
                ]
              );
            }
          }
          catch (\Exception $e) {
            \Drupal::logger('jaraba_comercio_conecta')->error('Error reconciliando stock POS para @id: @e', [
              '@id' => $product->id(),
              '@e' => $e->getMessage(),
            ]);
          }
        }
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_comercio_conecta')->error('Error en cron reconciliación POS: @e', ['@e' => $e->getMessage()]);
    }
  }
}

/**
 * Implements hook_mail().
 *
 * Estructura: Plantillas de email del módulo ComercioConecta.
 *
 * Lógica: Define subject y body para cada tipo de correo transaccional.
 *   Los templates usan variables del array $params inyectado desde
 *   los hooks y servicios que disparan el envío.
 *
 * @param string $key
 *   Identificador de la plantilla de email.
 * @param array $message
 *   Array del mensaje (por referencia) con subject y body.
 * @param array $params
 *   Parámetros contextuales para el template.
 */
function jaraba_comercio_conecta_mail(string $key, array &$message, array $params): void {
  switch ($key) {
    case 'merchant_approved':
      $message['subject'] = t('¡Tu comercio ha sido aprobado en ComercioConecta!');
      $message['body'][] = t('Hola @name,', ['@name' => $params['merchant_name'] ?? 'Comerciante']);
      $message['body'][] = t('Tu perfil de comerciante ha sido verificado y aprobado. Ya puedes publicar productos y recibir pedidos en la plataforma.');
      $message['body'][] = t('Accede a tu panel de comerciante para empezar a vender.');
      break;

    case 'low_stock_alert':
      $message['subject'] = t('Alerta de stock bajo: @product', ['@product' => $params['product_name'] ?? '']);
      $message['body'][] = t('Hola,');
      $message['body'][] = t('El producto "@product" tiene un stock bajo de @stock unidades. Te recomendamos reabastecer para no perder ventas.', [
        '@product' => $params['product_name'] ?? '',
        '@stock' => $params['current_stock'] ?? 0,
      ]);
      break;

    case 'abandoned_cart_reminder':
      $message['subject'] = t('¡No te olvides de tu carrito en ComercioConecta!');
      $message['body'][] = t('Hola @name,', ['@name' => $params['customer_name'] ?? 'Cliente']);
      $message['body'][] = t('Tienes productos esperándote en tu carrito de compra. Completa tu pedido antes de que se agoten.');
      break;

    case 'order_confirmed':
      $message['subject'] = t('Pedido @number confirmado', ['@number' => $params['order_number'] ?? '']);
      $message['body'][] = t('Hola @name,', ['@name' => $params['customer_name'] ?? 'Cliente']);
      $message['body'][] = t('Tu pedido @number ha sido confirmado y esta siendo preparado.', ['@number' => $params['order_number'] ?? '']);
      $message['body'][] = t('Total: @total EUR', ['@total' => $params['total'] ?? '0']);
      break;

    case 'order_shipped':
      $message['subject'] = t('Tu pedido @number ha sido enviado', ['@number' => $params['order_number'] ?? '']);
      $message['body'][] = t('Hola @name,', ['@name' => $params['customer_name'] ?? 'Cliente']);
      $message['body'][] = t('Tu pedido @number esta en camino.', ['@number' => $params['order_number'] ?? '']);
      if (!empty($params['tracking_number'])) {
        $message['body'][] = t('Numero de seguimiento: @tracking', ['@tracking' => $params['tracking_number']]);
      }
      break;

    case 'merchant_new_order':
      $message['subject'] = t('Nuevo pedido recibido: @number', ['@number' => $params['order_number'] ?? '']);
      $message['body'][] = t('Hola @name,', ['@name' => $params['merchant_name'] ?? 'Comerciante']);
      $message['body'][] = t('Has recibido un nuevo pedido @number por @total EUR.', [
        '@number' => $params['order_number'] ?? '',
        '@total' => $params['total'] ?? '0',
      ]);
      $message['body'][] = t('Accede a tu panel de comerciante para gestionar el pedido.');
      break;
  }

  // Footer común para todos los correos del módulo.
  if (!empty($message['body'])) {
    $message['body'][] = '';
    $message['body'][] = '---';
    $message['body'][] = t('Jaraba Impact Platform - ComercioConecta');
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * Estructura: Añade clases CSS al <body> según la ruta activa
 *   del vertical ComercioConecta.
 *
 * Lógica: Mapea cada ruta del módulo a una clase CSS específica
 *   para permitir estilos granulares por página. Además añade
 *   la clase común 'vertical-comercioconecta' que identifica
 *   todas las páginas del vertical.
 */
function jaraba_comercio_conecta_preprocess_html(array &$variables): void {
  $route = \Drupal::routeMatch()->getRouteName();
  if ($route === NULL) {
    return;
  }

  $route_classes = [
    'jaraba_comercio_conecta.marketplace' => 'page-comercio-marketplace',
    'jaraba_comercio_conecta.marketplace.product' => 'page-comercio-product',
    'jaraba_comercio_conecta.marketplace.merchant' => 'page-comercio-merchant',
    'jaraba_comercio_conecta.merchant_portal' => 'page-comercio-merchant',
    'jaraba_comercio_conecta.merchant_portal.products' => 'page-comercio-merchant-products',
    'jaraba_comercio_conecta.merchant_portal.stock' => 'page-comercio-merchant-stock',
    'jaraba_comercio_conecta.merchant_portal.analytics' => 'page-comercio-merchant-analytics',
    'jaraba_comercio_conecta.merchant_portal.profile' => 'page-comercio-merchant-profile',
    'jaraba_comercio_conecta.merchant_portal.product_add' => 'page-comercio-merchant-products',
    // F6: Checkout y pedidos
    'jaraba_comercio_conecta.checkout' => 'page-comercio-checkout',
    'jaraba_comercio_conecta.checkout.confirmation' => 'page-comercio-checkout',
    'jaraba_comercio_conecta.my_orders' => 'page-comercio-my-orders',
    'jaraba_comercio_conecta.my_orders.detail' => 'page-comercio-order-detail',
    // F7: Customer Portal
    'jaraba_comercio_conecta.customer_portal' => 'page-comercio-customer',
    'jaraba_comercio_conecta.customer_portal.wishlist' => 'page-comercio-customer-wishlist',
    'jaraba_comercio_conecta.customer_portal.profile' => 'page-comercio-customer-profile',
    // F7: Merchant Portal (ampliacion)
    'jaraba_comercio_conecta.merchant_portal.orders' => 'page-comercio-merchant-orders',
    'jaraba_comercio_conecta.merchant_portal.payments' => 'page-comercio-merchant-payments',
    'jaraba_comercio_conecta.merchant_portal.settings' => 'page-comercio-merchant-settings',
    // F8: Search
    'jaraba_comercio_conecta.search' => 'page-comercio-search',
  ];

  if (isset($route_classes[$route])) {
    $variables['attributes']['class'][] = $route_classes[$route];
    $variables['attributes']['class'][] = 'vertical-comercioconecta';
  }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Estructura: Redirige todas las rutas frontend de ComercioConecta
 *   al template page--comercio-marketplace.html.twig (zero-region).
 *
 * Lógica: Directriz ZERO-REGION-001. Si la ruta actual pertenece
 *   al módulo, añade la sugerencia 'page__comercio_marketplace'
 *   para que Drupal utilice el template zero-region del vertical.
 */
function jaraba_comercio_conecta_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  if (str_starts_with($route_name, 'jaraba_comercio_conecta.')) {
    $suggestions[] = 'page__comercio_marketplace';
  }
}

/**
 * Implements hook_preprocess_page().
 *
 * Estructura: Inyecta variables en el template zero-region del vertical.
 *
 * Lógica: ZERO-REGION-001 — Variables inyectadas SOLO aquí, NUNCA
 *   desde el controller. Proporciona clean_content, clean_messages,
 *   copilot_context, theme_settings y avatar_nav a los templates
 *   del vertical ComercioConecta.
 */
function jaraba_comercio_conecta_preprocess_page(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  if (!str_starts_with($route_name, 'jaraba_comercio_conecta.')) {
    return;
  }

  // Inyectar clean_content desde el page render array.
  $variables['clean_content'] = $variables['page']['content'] ?? [];

  // Inyectar mensajes del sistema (highlighted region).
  $variables['clean_messages'] = $variables['page']['highlighted'] ?? [];

  // Copilot context: contexto enriquecido para copiloto IA.
  try {
    $container = \Drupal::getContainer();
    if ($container && $container->has('ecosistema_jaraba_core.copilot_context')) {
      /** @var \Drupal\ecosistema_jaraba_core\Service\CopilotContextService $copilot_service */
      $copilot_service = $container->get('ecosistema_jaraba_core.copilot_context');
      $variables['copilot_context'] = $copilot_service->getContext();
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_comercio_conecta')->warning(
      'No se pudo obtener copilot_context: @msg',
      ['@msg' => $e->getMessage()]
    );
  }

  // Theme settings desde la configuración del tema activo.
  try {
    $active_theme = \Drupal::theme()->getActiveTheme()->getName();
    $variables['theme_settings'] = \Drupal::config($active_theme . '.settings')->getRawData() ?? [];
  }
  catch (\Exception $e) {
    $variables['theme_settings'] = [];
  }

  // Avatar navigation: navegación contextual por avatar del ecosistema.
  try {
    $container = \Drupal::getContainer();
    if ($container && $container->has('ecosistema_jaraba_core.avatar_navigation')) {
      /** @var \Drupal\ecosistema_jaraba_core\Service\AvatarNavigationService $avatar_service */
      $avatar_service = $container->get('ecosistema_jaraba_core.avatar_navigation');
      $variables['avatar_nav'] = $avatar_service->getNavigation();
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_comercio_conecta')->warning(
      'No se pudo obtener avatar_nav: @msg',
      ['@msg' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_page_attachments_alter().
 *
 * Adds Open Graph meta tags for ComercioConecta public pages.
 */
function jaraba_comercio_conecta_page_attachments_alter(array &$attachments): void {
  $route = \Drupal::routeMatch()->getRouteName();
  if ($route === NULL) {
    return;
  }

  $ogRoutes = [
    'jaraba_comercio_conecta.marketplace' => [
      'title' => t('Marketplace ComercioConecta — Comercio local de proximidad'),
      'description' => t('Descubre productos de comercios locales de tu barrio. Compra cerca, compra local.'),
      'type' => 'website',
    ],
    'jaraba_comercio_conecta.marketplace.merchant' => [
      'title' => t('Comercio local — ComercioConecta'),
      'description' => t('Productos y ofertas de tu comercio de barrio en ComercioConecta.'),
      'type' => 'profile',
    ],
    'jaraba_comercio_conecta.marketplace.product' => [
      'title' => t('Producto — ComercioConecta'),
      'description' => t('Producto de comercio local verificado en ComercioConecta.'),
      'type' => 'product',
    ],
    'jaraba_comercio_conecta.search' => [
      'title' => t('Buscar productos — ComercioConecta'),
      'description' => t('Busca y descubre productos de comercios locales de tu zona.'),
      'type' => 'website',
    ],
  ];

  if (!isset($ogRoutes[$route])) {
    return;
  }

  $og = $ogRoutes[$route];
  $siteUrl = \Drupal::request()->getSchemeAndHttpHost();

  $meta = [
    ['property' => 'og:title', 'content' => (string) $og['title']],
    ['property' => 'og:description', 'content' => (string) $og['description']],
    ['property' => 'og:type', 'content' => $og['type']],
    ['property' => 'og:url', 'content' => $siteUrl . \Drupal::request()->getRequestUri()],
    ['property' => 'og:site_name', 'content' => \Drupal::config('system.site')->get('name')],
  ];

  foreach ($meta as $tag) {
    $attachments['#attached']['html_head'][] = [
      [
        '#tag' => 'meta',
        '#attributes' => $tag,
      ],
      'og_' . str_replace(':', '_', $tag['property']),
    ];
  }
}

/**
 * Genera un slug URL-friendly a partir de un texto.
 *
 * Lógica: Convierte a minúsculas, elimina acentos y caracteres
 *   especiales, reemplaza espacios por guiones, y trunca a 128 chars.
 *   Verifica unicidad dentro del tenant añadiendo un sufijo numérico
 *   si es necesario.
 *
 * @param string $text
 *   Texto fuente para generar el slug.
 *
 * @return string
 *   Slug limpio y único.
 */
function _jaraba_comercio_conecta_generate_slug(string $text): string {
  // Tabla de transliteración para caracteres españoles
  $transliteration = [
    'á' => 'a', 'é' => 'e', 'í' => 'i', 'ó' => 'o', 'ú' => 'u',
    'ñ' => 'n', 'ü' => 'u', 'Á' => 'a', 'É' => 'e', 'Í' => 'i',
    'Ó' => 'o', 'Ú' => 'u', 'Ñ' => 'n', 'Ü' => 'u',
  ];

  $slug = strtr(mb_strtolower($text), $transliteration);
  // Solo caracteres alfanuméricos y guiones
  $slug = preg_replace('/[^a-z0-9\-]/', '-', $slug);
  // Eliminar guiones múltiples
  $slug = preg_replace('/-+/', '-', $slug);
  // Eliminar guiones al inicio y final
  $slug = trim($slug, '-');
  // Truncar a 128 caracteres
  $slug = substr($slug, 0, 128);

  return $slug;
}
