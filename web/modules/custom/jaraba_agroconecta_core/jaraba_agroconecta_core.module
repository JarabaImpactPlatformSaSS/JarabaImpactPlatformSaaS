<?php

/**
 * @file
 * Módulo AgroConecta Core.
 *
 * Marketplace agroalimentario multi-vendor con Commerce 3.x,
 * multi-tenancy y portales productor/cliente.
 *
 * Comando de compilación SCSS:
 *   cd web/modules/custom/jaraba_agroconecta_core && npm run build
 */

declare(strict_types=1);

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function jaraba_agroconecta_core_help(string $route_name, RouteMatchInterface $route_match): string
{
    if ($route_name === 'help.page.jaraba_agroconecta_core') {
        return '<p>' . t('Módulo AgroConecta: Marketplace agroalimentario multi-vendor con gestión de productos, productores y certificaciones.') . '</p>';
    }
    return '';
}

/**
 * Implements hook_theme().
 *
 * Define los templates Twig del módulo AgroConecta.
 */
function jaraba_agroconecta_core_theme(): array
{
    return [
        'agro_marketplace' => [
            'variables' => [
                'products' => [],
                'marketplace_name' => '',
                'marketplace_description' => '',
                'total_products' => 0,
                'pager' => NULL,
            ],
            'template' => 'agro-marketplace',
        ],
        'agro_product_detail' => [
            'variables' => [
                'product' => NULL,
                'producer' => NULL,
            ],
            'template' => 'agro-product-detail',
        ],
        'agro_checkout' => [
            'variables' => [
                'marketplace_name' => '',
            ],
            'template' => 'agro-checkout',
        ],
        'agro_order_confirmation' => [
            'variables' => [
                'order' => [],
                'order_number' => '',
            ],
            'template' => 'agro-order-confirmation',
        ],
        // ===== Portal del Productor (Fase 3) =====
        'agro_producer_dashboard' => [
            'variables' => [
                'kpis' => [],
                'alerts' => [],
                'pending_orders' => [],
                'top_products' => [],
            ],
            'template' => 'agro-producer-dashboard',
        ],
        'agro_producer_orders' => [
            'variables' => [
                'orders' => [],
                'total' => 0,
            ],
            'template' => 'agro-producer-orders',
        ],
        'agro_producer_order_detail' => [
            'variables' => [
                'suborder' => [],
                'order' => [],
                'items' => [],
            ],
            'template' => 'agro-producer-order-detail',
        ],
        'agro_producer_products' => [
            'variables' => [
                'products' => [],
                'total' => 0,
            ],
            'template' => 'agro-producer-products',
        ],
        'agro_producer_payouts' => [
            'variables' => [
                'total_revenue' => '',
                'total_commissions' => '',
                'total_payouts' => '',
                'payout_history' => [],
            ],
            'template' => 'agro-producer-payouts',
        ],
        'agro_producer_settings' => [
            'variables' => [
                'producer' => [],
            ],
            'template' => 'agro-producer-settings',
        ],
        // ===== Portal del Cliente (Fase 3) =====
        'agro_customer_dashboard' => [
            'variables' => [
                'active_order' => NULL,
                'total_orders' => 0,
                'recent_products' => [],
                'user_name' => '',
            ],
            'template' => 'agro-customer-dashboard',
        ],
        'agro_customer_orders' => [
            'variables' => [
                'orders' => [],
                'total' => 0,
            ],
            'template' => 'agro-customer-orders',
        ],
        'agro_customer_order_detail' => [
            'variables' => [
                'order' => [],
                'items' => [],
                'timeline' => [],
            ],
            'template' => 'agro-customer-order-detail',
        ],
        'agro_customer_addresses' => [
            'variables' => [
                'addresses' => [],
            ],
            'template' => 'agro-customer-addresses',
        ],
        'agro_customer_favorites' => [
            'variables' => [
                'products' => [],
            ],
            'template' => 'agro-customer-favorites',
        ],
        // ===== Search & Discovery (Fase 5) =====
        'agro_search_page' => [
            'variables' => [
                'search_query' => '',
                'sort' => 'relevance',
                'categories' => [],
                'featured_collections' => [],
                'initial_results' => NULL,
            ],
            'template' => 'agro-search-page',
        ],
        'agro_category_page' => [
            'variables' => [
                'category' => [],
                'products' => [],
            ],
            'template' => 'agro-category-page',
        ],
        'agro_collection_page' => [
            'variables' => [
                'collection' => [],
                'products' => [],
                'total' => 0,
            ],
            'template' => 'agro-collection-page',
        ],
    ];
}

/**
 * Implements hook_preprocess_html().
 *
 * CRÍTICO: Añade body classes para las páginas AgroConecta.
 * NUNCA usar attributes.addClass() en templates Twig.
 *
 * Plan Elevación AgroConecta Clase Mundial v1 — Fase 3 (Body Classes Consolidation).
 * Todas las rutas del vertical reciben:
 *   - Su clase específica de ruta.
 *   - 'agro-page' como clase common del vertical.
 *   - 'page--clean-layout' para indicar layout zero-region.
 *
 * @see /frontend-page-pattern workflow
 */
function jaraba_agroconecta_core_preprocess_html(array &$variables): void
{
    $route = \Drupal::routeMatch()->getRouteName();
    if ($route === NULL) {
        return;
    }

    $routeClasses = [
        // Marketplace público
        'jaraba_agroconecta.marketplace' => ['marketplace-page', 'page-marketplace'],
        'jaraba_agroconecta.product_detail' => ['agro-product-page'],
        'jaraba_agroconecta.checkout' => ['checkout-page', 'page-checkout'],
        'jaraba_agroconecta.order_confirmation' => ['order-confirmation-page'],
        // Portal del Productor (Fase 3)
        'jaraba_agroconecta.producer.dashboard' => ['producer-dashboard-page', 'producer-portal-page'],
        'jaraba_agroconecta.producer.orders' => ['producer-orders-page', 'producer-portal-page'],
        'jaraba_agroconecta.producer.order_detail' => ['producer-order-detail-page', 'producer-portal-page'],
        'jaraba_agroconecta.producer.products' => ['producer-products-page', 'producer-portal-page'],
        'jaraba_agroconecta.producer.payouts' => ['producer-payouts-page', 'producer-portal-page'],
        'jaraba_agroconecta.producer.settings' => ['producer-settings-page', 'producer-portal-page'],
        // Portal del Cliente (Fase 3)
        'jaraba_agroconecta.customer.dashboard' => ['customer-dashboard-page', 'customer-portal-page'],
        'jaraba_agroconecta.customer.orders' => ['customer-orders-page', 'customer-portal-page'],
        'jaraba_agroconecta.customer.order_detail' => ['customer-order-detail-page', 'customer-portal-page'],
        'jaraba_agroconecta.customer.addresses' => ['customer-addresses-page', 'customer-portal-page'],
        'jaraba_agroconecta.customer.favorites' => ['customer-favorites-page', 'customer-portal-page'],
        // Search & Discovery (Fase 5)
        'jaraba_agroconecta.search_page' => ['search-page', 'agro-search-page'],
        'jaraba_agroconecta.category_page' => ['category-page', 'agro-category-page'],
        'jaraba_agroconecta.collection_page' => ['collection-page', 'agro-collection-page'],
        // Landing page del vertical
        'ecosistema_jaraba_core.landing.agroconecta' => ['agroconecta-landing-page'],
    ];

    if (isset($routeClasses[$route])) {
        foreach ($routeClasses[$route] as $class) {
            $variables['attributes']['class'][] = $class;
        }
        // Clases comunes del vertical: identificador + layout zero-region.
        $variables['attributes']['class'][] = 'agro-page';
        $variables['attributes']['class'][] = 'page--clean-layout';
    }
}

/**
 * Implements hook_entity_insert().
 *
 * Triggers automáticos del Producer Copilot:
 * - Nuevo producto sin descripción → Encola generación con Copilot.
 * - Nueva reseña recibida → Encola borrador de respuesta.
 */
function jaraba_agroconecta_core_entity_insert(\Drupal\Core\Entity\EntityInterface $entity): void
{
    // Trigger: Producto sin descripción → generar con Copilot.
    if ($entity->getEntityTypeId() === 'product_agro') {
        $description = '';
        try {
            if ($entity->hasField('body')) {
                $description = trim((string) ($entity->get('body')->value ?? ''));
            }
        }
        catch (\Exception $e) {
            // Campo no disponible.
        }

        if (empty($description)) {
            \Drupal::queue('jaraba_agroconecta_copilot_auto')
                ->createItem([
                    'action' => 'generate_description',
                    'product_id' => (int) $entity->id(),
                    'tenant_id' => $entity->hasField('tenant_id') ? ($entity->get('tenant_id')->target_id ?? NULL) : NULL,
                ]);

            \Drupal::logger('jaraba_agroconecta_core')->info(
                'Producto @id creado sin descripción: encolado para generación automática.',
                ['@id' => $entity->id()]
            );
        }
    }

    // Trigger: Nueva reseña → generar borrador de respuesta.
    if ($entity->getEntityTypeId() === 'review_agro') {
        $rating = 3;
        try {
            $rating = (int) ($entity->get('rating')->value ?? 3);
        }
        catch (\Exception $e) {
            // Campo no disponible.
        }

        \Drupal::queue('jaraba_agroconecta_copilot_auto')
            ->createItem([
                'action' => 'respond_review',
                'review_id' => (int) $entity->id(),
                'review_rating' => $rating,
                'tenant_id' => $entity->hasField('tenant_id') ? ($entity->get('tenant_id')->target_id ?? NULL) : NULL,
            ]);

        \Drupal::logger('jaraba_agroconecta_core')->info(
            'Reseña @id creada: encolado borrador de respuesta automática.',
            ['@id' => $entity->id()]
        );
    }
}

/**
 * Implements hook_cron().
 *
 * Tareas periódicas del módulo AgroConecta:
 * - Actualizar forecasts de demanda (cada 24h, 04:00-06:00 UTC).
 * - Detectar precios fuera de rango y generar alertas (cada 12h).
 */
function jaraba_agroconecta_core_cron(): void
{
    $state = \Drupal::state();
    $time = \Drupal::time()->getRequestTime();

    // === Actualización de forecasts de demanda (cada 24h) ===
    $lastForecast = (int) $state->get('jaraba_agroconecta.last_forecast_update', 0);
    $hour = (int) date('G', $time);

    if (($time - $lastForecast) > 86400 && $hour >= 4 && $hour <= 6) {
        $state->set('jaraba_agroconecta.last_forecast_update', $time);

        // AUDIT-PERF-N11: Queue per-producer forecast instead of synchronous loop.
        $storage = \Drupal::entityTypeManager()->getStorage('producer_profile');
        $producerIds = $storage->getQuery()
            ->accessCheck(FALSE)
            ->condition('status', 1)
            ->execute();

        $queue = \Drupal::queue('jaraba_agroconecta_producer_forecast');
        foreach ($producerIds as $producerId) {
            $queue->createItem([
                'producer_id' => (int) $producerId,
                'operation' => 'forecast',
            ]);
        }

        \Drupal::logger('jaraba_agroconecta_core')->info(
            'Cron: @count productores encolados para forecast.',
            ['@count' => count($producerIds)]
        );
    }

    // === Alertas de precios fuera de rango (cada 12h) ===
    $lastPriceCheck = (int) $state->get('jaraba_agroconecta.last_price_check', 0);

    if (($time - $lastPriceCheck) > 43200) {
        $state->set('jaraba_agroconecta.last_price_check', $time);

        // AUDIT-PERF-N11: Queue per-producer price alerts instead of synchronous loop.
        $storage = \Drupal::entityTypeManager()->getStorage('producer_profile');
        $producerIds = $storage->getQuery()
            ->accessCheck(FALSE)
            ->condition('status', 1)
            ->execute();

        $queue = \Drupal::queue('jaraba_agroconecta_producer_forecast');
        foreach ($producerIds as $producerId) {
            $queue->createItem([
                'producer_id' => (int) $producerId,
                'operation' => 'price_alerts',
            ]);
        }

        \Drupal::logger('jaraba_agroconecta_core')->info(
            'Cron: @count productores encolados para alertas de precio.',
            ['@count' => count($producerIds)]
        );
    }

    // === Detección de carritos abandonados (cada 1h) ===
    $lastCartCheck = (int) $state->get('jaraba_agroconecta.last_cart_recovery_check', 0);

    if (($time - $lastCartCheck) > 3600) {
        $state->set('jaraba_agroconecta.last_cart_recovery_check', $time);

        try {
            /** @var \Drupal\jaraba_agroconecta_core\Service\CartRecoveryService $cartRecovery */
            $cartRecovery = \Drupal::service('jaraba_agroconecta_core.cart_recovery');
            $detected = $cartRecovery->detectAbandonedCarts();

            if ($detected > 0) {
                \Drupal::logger('jaraba_agroconecta_core')->info(
                    'Cron: @count carritos abandonados detectados para recuperación.',
                    ['@count' => $detected]
                );
            }
        }
        catch (\Exception $e) {
            \Drupal::logger('jaraba_agroconecta_core')->error(
                'Cron: error en detección de carritos abandonados: @error',
                ['@error' => $e->getMessage()]
            );
        }
    }
}

/**
 * Implements hook_mail().
 *
 * Plantillas de email del módulo AgroConecta.
 */
function jaraba_agroconecta_core_mail(string $key, array &$message, array $params): void
{
    switch ($key) {
        case 'copilot_content_ready':
            $message['subject'] = t('Tu contenido IA está listo para revisión');
            $message['body'][] = t('Hola @name,', ['@name' => $params['producer_name'] ?? 'Productor']);
            $message['body'][] = t('El copiloto ha generado nuevo contenido para tu producto "@product". Revísalo y apruébalo desde tu panel de control.', [
                '@product' => $params['product_name'] ?? '',
            ]);
            break;

        case 'price_alert':
            $message['subject'] = t('Alerta de precio: @product', ['@product' => $params['product_name'] ?? '']);
            $message['body'][] = t('Hola @name,', ['@name' => $params['producer_name'] ?? 'Productor']);
            $message['body'][] = t('Tu producto "@product" tiene un precio @deviation del promedio del mercado (@avg€). @recommendation', [
                '@product' => $params['product_name'] ?? '',
                '@deviation' => $params['deviation'] ?? '',
                '@avg' => $params['market_avg'] ?? '',
                '@recommendation' => $params['recommendation'] ?? '',
            ]);
            break;

        case 'demand_forecast':
            $message['subject'] = t('Previsión de demanda: @product', ['@product' => $params['product_name'] ?? '']);
            $message['body'][] = t('Hola @name,', ['@name' => $params['producer_name'] ?? 'Productor']);
            $message['body'][] = t('Basándonos en las tendencias de ventas, la demanda de "@product" se prevé @trend en los próximos 30 días.', [
                '@product' => $params['product_name'] ?? '',
                '@trend' => $params['trend'] ?? 'estable',
            ]);
            break;

        case 'cart_recovery':
            $message['subject'] = t('¡No te olvides de tu carrito! @incentive', [
                '@incentive' => !empty($params['discount_percent']) ? '— ' . $params['discount_percent'] . '% de descuento' : '',
            ]);
            $message['body'][] = t('Hola @name,', ['@name' => $params['customer_name'] ?? 'Cliente']);
            $message['body'][] = $params['message'] ?? t('Tus productos artesanales favoritos siguen esperándote en tu carrito.');
            if (!empty($params['discount_code'])) {
                $message['body'][] = t('Usa el código @code para obtener tu descuento.', ['@code' => $params['discount_code']]);
            }
            break;
    }
}

/**
 * Implements hook_preprocess_page().
 *
 * Inyecta variables de página para el zero-region pattern.
 * Plan Elevación AgroConecta Clase Mundial v1 — Fase 4
 * Directriz ZERO-REGION-001.
 */
function jaraba_agroconecta_core_preprocess_page(array &$variables): void
{
    $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

    // Solo procesar rutas del vertical AgroConecta.
    if (str_starts_with($route_name, 'jaraba_agroconecta.') ||
        $route_name === 'ecosistema_jaraba_core.landing.agroconecta') {
        // Inyectar clean_content desde el controller render array.
        if (isset($variables['page']['content'])) {
            $variables['clean_content'] = $variables['page']['content'];
        }

        // Contexto del vertical para templates.
        $variables['agroconecta_context'] = [
            'vertical' => 'agroconecta',
            'route' => $route_name,
        ];

        // Copilot FAB habilitado para rutas con usuario autenticado.
        $variables['copilot_enabled'] = \Drupal::currentUser()->isAuthenticated();
    }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Redirige todas las rutas frontend de AgroConecta al template
 * page--agroconecta.html.twig (zero-region).
 * Plan Elevación AgroConecta Clase Mundial v1 — Fase 4
 * Directriz ZERO-REGION-001.
 */
function jaraba_agroconecta_core_theme_suggestions_page_alter(array &$suggestions, array $variables): void
{
    $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

    // Rutas frontend del vertical (excluir rutas API).
    if ((str_starts_with($route_name, 'jaraba_agroconecta.') && !str_contains($route_name, '.api.')) ||
        $route_name === 'ecosistema_jaraba_core.landing.agroconecta') {
        $suggestions[] = 'page__agroconecta';
    }
}
