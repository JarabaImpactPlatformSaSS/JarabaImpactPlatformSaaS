<?php

/**
 * @file
 * Módulo AgroConecta Core.
 *
 * Marketplace agroalimentario multi-vendor con Commerce 3.x,
 * multi-tenancy y portales productor/cliente.
 *
 * Comando de compilación SCSS:
 *   cd web/modules/custom/jaraba_agroconecta_core && npm run build
 */

declare(strict_types=1);

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function jaraba_agroconecta_core_help(string $route_name, RouteMatchInterface $route_match): string
{
    if ($route_name === 'help.page.jaraba_agroconecta_core') {
        return '<p>' . t('Módulo AgroConecta: Marketplace agroalimentario multi-vendor con gestión de productos, productores y certificaciones.') . '</p>';
    }
    return '';
}

/**
 * Implements hook_theme().
 *
 * Define los templates Twig del módulo AgroConecta.
 */
function jaraba_agroconecta_core_theme(): array
{
    return [
        'agro_marketplace' => [
            'variables' => [
                'products' => [],
                'marketplace_name' => '',
                'marketplace_description' => '',
                'total_products' => 0,
                'pager' => NULL,
            ],
            'template' => 'agro-marketplace',
        ],
        'agro_product_detail' => [
            'variables' => [
                'product' => NULL,
                'producer' => NULL,
            ],
            'template' => 'agro-product-detail',
        ],
        'agro_checkout' => [
            'variables' => [
                'marketplace_name' => '',
            ],
            'template' => 'agro-checkout',
        ],
        'agro_order_confirmation' => [
            'variables' => [
                'order' => [],
                'order_number' => '',
            ],
            'template' => 'agro-order-confirmation',
        ],
        // ===== Portal del Productor (Fase 3) =====
        'agro_producer_dashboard' => [
            'variables' => [
                'kpis' => [],
                'alerts' => [],
                'pending_orders' => [],
                'top_products' => [],
            ],
            'template' => 'agro-producer-dashboard',
        ],
        'agro_producer_orders' => [
            'variables' => [
                'orders' => [],
                'total' => 0,
            ],
            'template' => 'agro-producer-orders',
        ],
        'agro_producer_order_detail' => [
            'variables' => [
                'suborder' => [],
                'order' => [],
                'items' => [],
            ],
            'template' => 'agro-producer-order-detail',
        ],
        'agro_producer_products' => [
            'variables' => [
                'products' => [],
                'total' => 0,
            ],
            'template' => 'agro-producer-products',
        ],
        'agro_producer_payouts' => [
            'variables' => [
                'total_revenue' => '',
                'total_commissions' => '',
                'total_payouts' => '',
                'payout_history' => [],
            ],
            'template' => 'agro-producer-payouts',
        ],
        'agro_producer_settings' => [
            'variables' => [
                'producer' => [],
            ],
            'template' => 'agro-producer-settings',
        ],
        // ===== Portal del Cliente (Fase 3) =====
        'agro_customer_dashboard' => [
            'variables' => [
                'active_order' => NULL,
                'total_orders' => 0,
                'recent_products' => [],
                'user_name' => '',
            ],
            'template' => 'agro-customer-dashboard',
        ],
        'agro_customer_orders' => [
            'variables' => [
                'orders' => [],
                'total' => 0,
            ],
            'template' => 'agro-customer-orders',
        ],
        'agro_customer_order_detail' => [
            'variables' => [
                'order' => [],
                'items' => [],
                'timeline' => [],
            ],
            'template' => 'agro-customer-order-detail',
        ],
        'agro_customer_addresses' => [
            'variables' => [
                'addresses' => [],
            ],
            'template' => 'agro-customer-addresses',
        ],
        'agro_customer_favorites' => [
            'variables' => [
                'products' => [],
            ],
            'template' => 'agro-customer-favorites',
        ],
        // ===== Search & Discovery (Fase 5) =====
        'agro_search_page' => [
            'variables' => [
                'search_query' => '',
                'sort' => 'relevance',
                'categories' => [],
                'featured_collections' => [],
                'initial_results' => NULL,
            ],
            'template' => 'agro-search-page',
        ],
        'agro_category_page' => [
            'variables' => [
                'category' => [],
                'products' => [],
            ],
            'template' => 'agro-category-page',
        ],
        'agro_collection_page' => [
            'variables' => [
                'collection' => [],
                'products' => [],
                'total' => 0,
            ],
            'template' => 'agro-collection-page',
        ],
    ];
}

/**
 * Implements hook_preprocess_html().
 *
 * CRÍTICO: Añade body classes para las páginas AgroConecta.
 * NUNCA usar attributes.addClass() en templates Twig.
 *
 * @see /frontend-page-pattern workflow
 */
function jaraba_agroconecta_core_preprocess_html(array &$variables): void
{
    $route = \Drupal::routeMatch()->getRouteName();

    $routeClasses = [
        'jaraba_agroconecta.marketplace' => ['marketplace-page', 'page-marketplace', 'agro-page'],
        'jaraba_agroconecta.product_detail' => ['agro-product-page', 'agro-page'],
        'jaraba_agroconecta.checkout' => ['checkout-page', 'agro-page', 'page-checkout'],
        'jaraba_agroconecta.order_confirmation' => ['order-confirmation-page', 'agro-page'],
        // Portal del Productor (Fase 3)
        'jaraba_agroconecta.producer.dashboard' => ['producer-dashboard-page', 'producer-portal-page', 'agro-page'],
        'jaraba_agroconecta.producer.orders' => ['producer-orders-page', 'producer-portal-page', 'agro-page'],
        'jaraba_agroconecta.producer.order_detail' => ['producer-order-detail-page', 'producer-portal-page', 'agro-page'],
        'jaraba_agroconecta.producer.products' => ['producer-products-page', 'producer-portal-page', 'agro-page'],
        'jaraba_agroconecta.producer.payouts' => ['producer-payouts-page', 'producer-portal-page', 'agro-page'],
        'jaraba_agroconecta.producer.settings' => ['producer-settings-page', 'producer-portal-page', 'agro-page'],
        // Portal del Cliente (Fase 3)
        'jaraba_agroconecta.customer.dashboard' => ['customer-dashboard-page', 'customer-portal-page', 'agro-page'],
        'jaraba_agroconecta.customer.orders' => ['customer-orders-page', 'customer-portal-page', 'agro-page'],
        'jaraba_agroconecta.customer.order_detail' => ['customer-order-detail-page', 'customer-portal-page', 'agro-page'],
        'jaraba_agroconecta.customer.addresses' => ['customer-addresses-page', 'customer-portal-page', 'agro-page'],
        'jaraba_agroconecta.customer.favorites' => ['customer-favorites-page', 'customer-portal-page', 'agro-page'],
        // Search & Discovery (Fase 5)
        'jaraba_agroconecta.search_page' => ['search-page', 'agro-search-page', 'agro-page'],
        'jaraba_agroconecta.category_page' => ['category-page', 'agro-category-page', 'agro-page'],
        'jaraba_agroconecta.collection_page' => ['collection-page', 'agro-collection-page', 'agro-page'],
    ];

    if (isset($routeClasses[$route])) {
        foreach ($routeClasses[$route] as $class) {
            $variables['attributes']['class'][] = $class;
        }
    }
}

/**
 * Implements hook_entity_insert().
 *
 * Triggers automáticos del Producer Copilot:
 * - Nuevo producto sin descripción → Encola generación con Copilot.
 * - Nueva reseña recibida → Encola borrador de respuesta.
 */
function jaraba_agroconecta_core_entity_insert(\Drupal\Core\Entity\EntityInterface $entity): void
{
    // Trigger: Producto sin descripción → generar con Copilot.
    if ($entity->getEntityTypeId() === 'product_agro') {
        $description = '';
        try {
            if ($entity->hasField('body')) {
                $description = trim((string) ($entity->get('body')->value ?? ''));
            }
        }
        catch (\Exception $e) {
            // Campo no disponible.
        }

        if (empty($description)) {
            \Drupal::queue('jaraba_agroconecta_copilot_auto')
                ->createItem([
                    'action' => 'generate_description',
                    'product_id' => (int) $entity->id(),
                    'tenant_id' => $entity->hasField('tenant_id') ? ($entity->get('tenant_id')->target_id ?? NULL) : NULL,
                ]);

            \Drupal::logger('jaraba_agroconecta_core')->info(
                'Producto @id creado sin descripción: encolado para generación automática.',
                ['@id' => $entity->id()]
            );
        }
    }

    // Trigger: Nueva reseña → generar borrador de respuesta.
    if ($entity->getEntityTypeId() === 'review_agro') {
        $rating = 3;
        try {
            $rating = (int) ($entity->get('rating')->value ?? 3);
        }
        catch (\Exception $e) {
            // Campo no disponible.
        }

        \Drupal::queue('jaraba_agroconecta_copilot_auto')
            ->createItem([
                'action' => 'respond_review',
                'review_id' => (int) $entity->id(),
                'review_rating' => $rating,
                'tenant_id' => $entity->hasField('tenant_id') ? ($entity->get('tenant_id')->target_id ?? NULL) : NULL,
            ]);

        \Drupal::logger('jaraba_agroconecta_core')->info(
            'Reseña @id creada: encolado borrador de respuesta automática.',
            ['@id' => $entity->id()]
        );
    }
}

/**
 * Implements hook_cron().
 *
 * Tareas periódicas del módulo AgroConecta:
 * - Actualizar forecasts de demanda (cada 24h, 04:00-06:00 UTC).
 * - Detectar precios fuera de rango y generar alertas (cada 12h).
 */
function jaraba_agroconecta_core_cron(): void
{
    $state = \Drupal::state();
    $time = \Drupal::time()->getRequestTime();

    // === Actualización de forecasts de demanda (cada 24h) ===
    $lastForecast = (int) $state->get('jaraba_agroconecta.last_forecast_update', 0);
    $hour = (int) date('G', $time);

    if (($time - $lastForecast) > 86400 && $hour >= 4 && $hour <= 6) {
        $state->set('jaraba_agroconecta.last_forecast_update', $time);

        try {
            /** @var \Drupal\jaraba_agroconecta_core\Service\DemandForecasterService $forecaster */
            $forecaster = \Drupal::service('jaraba_agroconecta.demand_forecaster');

            // Obtener productores activos.
            $storage = \Drupal::entityTypeManager()->getStorage('producer_profile');
            $producerIds = $storage->getQuery()
                ->accessCheck(FALSE)
                ->condition('status', 1)
                ->range(0, 100)
                ->execute();

            $updated = 0;
            foreach ($producerIds as $producerId) {
                try {
                    $forecaster->getDemandTrends((int) $producerId, 3);
                    $updated++;
                }
                catch (\Exception $e) {
                    // Continuar con siguiente productor.
                }
            }

            \Drupal::logger('jaraba_agroconecta_core')->info(
                'Cron: forecasts de demanda actualizados para @count productores.',
                ['@count' => $updated]
            );
        }
        catch (\Exception $e) {
            \Drupal::logger('jaraba_agroconecta_core')->error(
                'Cron: error actualizando forecasts: @error',
                ['@error' => $e->getMessage()]
            );
        }
    }

    // === Alertas de precios fuera de rango (cada 12h) ===
    $lastPriceCheck = (int) $state->get('jaraba_agroconecta.last_price_check', 0);

    if (($time - $lastPriceCheck) > 43200) {
        $state->set('jaraba_agroconecta.last_price_check', $time);

        try {
            /** @var \Drupal\jaraba_agroconecta_core\Service\MarketSpyService $marketSpy */
            $marketSpy = \Drupal::service('jaraba_agroconecta.market_spy');

            $storage = \Drupal::entityTypeManager()->getStorage('producer_profile');
            $producerIds = $storage->getQuery()
                ->accessCheck(FALSE)
                ->condition('status', 1)
                ->range(0, 100)
                ->execute();

            $alertCount = 0;
            foreach ($producerIds as $producerId) {
                try {
                    $alerts = $marketSpy->getPriceAlerts((int) $producerId);
                    $alertCount += count($alerts);
                }
                catch (\Exception $e) {
                    // Continuar con siguiente productor.
                }
            }

            if ($alertCount > 0) {
                \Drupal::logger('jaraba_agroconecta_core')->info(
                    'Cron: @count alertas de precio detectadas.',
                    ['@count' => $alertCount]
                );
            }
        }
        catch (\Exception $e) {
            \Drupal::logger('jaraba_agroconecta_core')->error(
                'Cron: error en chequeo de precios: @error',
                ['@error' => $e->getMessage()]
            );
        }
    }
}

/**
 * Implements hook_mail().
 *
 * Plantillas de email del módulo AgroConecta.
 */
function jaraba_agroconecta_core_mail(string $key, array &$message, array $params): void
{
    switch ($key) {
        case 'copilot_content_ready':
            $message['subject'] = t('Tu contenido IA está listo para revisión');
            $message['body'][] = t('Hola @name,', ['@name' => $params['producer_name'] ?? 'Productor']);
            $message['body'][] = t('El copiloto ha generado nuevo contenido para tu producto "@product". Revísalo y apruébalo desde tu panel de control.', [
                '@product' => $params['product_name'] ?? '',
            ]);
            break;

        case 'price_alert':
            $message['subject'] = t('Alerta de precio: @product', ['@product' => $params['product_name'] ?? '']);
            $message['body'][] = t('Hola @name,', ['@name' => $params['producer_name'] ?? 'Productor']);
            $message['body'][] = t('Tu producto "@product" tiene un precio @deviation del promedio del mercado (@avg€). @recommendation', [
                '@product' => $params['product_name'] ?? '',
                '@deviation' => $params['deviation'] ?? '',
                '@avg' => $params['market_avg'] ?? '',
                '@recommendation' => $params['recommendation'] ?? '',
            ]);
            break;

        case 'demand_forecast':
            $message['subject'] = t('Previsión de demanda: @product', ['@product' => $params['product_name'] ?? '']);
            $message['body'][] = t('Hola @name,', ['@name' => $params['producer_name'] ?? 'Productor']);
            $message['body'][] = t('Basándonos en las tendencias de ventas, la demanda de "@product" se prevé @trend en los próximos 30 días.', [
                '@product' => $params['product_name'] ?? '',
                '@trend' => $params['trend'] ?? 'estable',
            ]);
            break;
    }
}
