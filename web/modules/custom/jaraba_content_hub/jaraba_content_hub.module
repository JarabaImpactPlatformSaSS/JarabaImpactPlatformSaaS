<?php

/**
 * @file
 * Primary module hooks for Jaraba Content Hub.
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\image\Entity\ImageStyle;

/**
 * Implements hook_form_alter().
 *
 * Oculta las guías de formato de texto y ayuda en los formularios del Content Hub.
 * Esto proporciona una UX más limpia para los editores de contenido del tenant,
 * eliminando elementos técnicos de Drupal que pueden confundir a usuarios no técnicos.
 *
 * Utiliza str_contains() para capturar todas las variantes del formulario
 * (add, edit, AJAX rebuilds) en lugar de comparación exacta de form_id.
 */
function jaraba_content_hub_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  // Detectar formularios del Content Hub usando coincidencia parcial.
  // Esto captura: content_article_add_form, content_article_edit_form, etc.
  $is_content_hub_form = str_contains($form_id, 'content_article') 
    || str_contains($form_id, 'content_category');

  if ($is_content_hub_form) {
    // Ocultar recursivamente las guías de formato de todos los campos de texto.
    _jaraba_content_hub_hide_format_guidelines($form);
  }
}

/**
 * Oculta recursivamente las guías de formato y ayuda de los elementos del formulario.
 *
 * Esta función recorre el árbol del formulario buscando elementos 'format'
 * (selectores de formato de texto, ayuda "HTML Restringido", enlaces "Acerca de formatos").
 * Al establecer #access = FALSE en el elemento padre 'format', ocultamos todo el
 * subárbol sin necesidad de ocultar cada hijo individualmente.
 *
 * @param array $element
 *   El elemento del formulario a procesar.
 *
 * @see _slide-panel.scss para CSS de respaldo adicional.
 */
function _jaraba_content_hub_hide_format_guidelines(array &$element): void {
  // Verificar si este elemento tiene un sub-elemento 'format'.
  if (isset($element['format'])) {
    // Ocultar todo el wrapper de formato (incluye desplegable, guías y enlace de ayuda).
    $element['format']['#access'] = FALSE;
  }

  // Procesar recursivamente los elementos hijos (claves que no empiezan con #).
  foreach (array_keys($element) as $key) {
    if (is_array($element[$key]) && !str_starts_with((string) $key, '#')) {
      _jaraba_content_hub_hide_format_guidelines($element[$key]);
    }
  }
}


/**
 * Implements hook_help().
 */
function jaraba_content_hub_help(string $route_name): string {
  if ($route_name === 'help.page.jaraba_content_hub') {
    return '<p>' . t('AI-powered content hub with blog articles, categories, and newsletter integration.') . '</p>';
  }
  return '';
}

/**
 * Implements hook_theme().
 */
function jaraba_content_hub_theme(): array {
  return [
    'content_article' => [
      'render element' => 'elements',
    ],
    'content_article__full' => [
      'template' => 'content-article--full',
      'base hook' => 'content_article',
    ],
    'content_article__teaser' => [
      'template' => 'content-article--teaser',
      'base hook' => 'content_article',
    ],
    'content_category' => [
      'render element' => 'elements',
    ],
    'content_hub_blog_index' => [
      'template' => 'content-hub-blog-index',
      'variables' => [
        'title' => NULL,
        'articles' => [],
        'categories' => [],
        'trending' => [],
        'show_reading_time' => TRUE,
        'pager' => NULL,
        'stats' => [],
      ],
    ],
    'content_hub_category_page' => [
      'template' => 'content-hub-category-page',
      'variables' => [
        'category' => [],
        'articles' => [],
        'show_reading_time' => TRUE,
      ],
    ],
    'content_hub_dashboard' => [
      'template' => 'content-hub-dashboard',
      'variables' => [
        'stats' => [],
        'recent_articles' => [],
        'top_categories' => [],
        'drafts' => [],
        'quick_actions' => [],
      ],
    ],
    'content_hub_dashboard_frontend' => [
      'template' => 'content-hub-dashboard-frontend',
      'variables' => [
        'stats' => [],
        'recent_articles' => [],
        'top_categories' => [],
        'drafts' => [],
        'quick_actions' => [],
        // Theme variables for partials
        'site_name' => NULL,
        'logo' => NULL,
        'logged_in' => FALSE,
        'theme_settings' => [],
      ],
    ],
    // === Frontend List Templates (Tenant Editors - NO admin theme) ===
    'content_hub_articles_list' => [
      'template' => 'content-hub-articles-list',
      'variables' => [
        'articles' => [],
        'stats' => [],
        'current_filter' => 'all',
        'search_query' => '',
        'pager' => NULL,
        'back_url' => NULL,
        'add_url' => NULL,
      ],
    ],
    'content_hub_categories_list' => [
      'template' => 'content-hub-categories-list',
      'variables' => [
        'categories' => [],
        'total_count' => 0,
        'back_url' => NULL,
        'add_url' => NULL,
      ],
    ],
    'content_hub_ai_logs_list' => [
      'template' => 'content-hub-ai-logs-list',
      'variables' => [
        'logs' => [],
        'total_count' => 0,
        'pager' => NULL,
        'back_url' => NULL,
      ],
    ],
    'content_hub_article_form' => [
      'template' => 'content-hub-article-form',
      'variables' => [
        'form' => NULL,
        'title' => NULL,
        'back_url' => NULL,
      ],
    ],
    'content_hub_category_form' => [
      'template' => 'content-hub-category-form',
      'variables' => [
        'form' => NULL,
        'title' => NULL,
        'back_url' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_ENTITY_TYPE_presave() for content_article.
 */
function jaraba_content_hub_content_article_presave(EntityInterface $entity): void {
  // 1. Cálculo de tiempo de lectura.
  if ($entity->hasField('body') && !$entity->get('body')->isEmpty()) {
    $text = strip_tags($entity->get('body')->value);
    $word_count = str_word_count($text);
    $reading_time = (int) ceil($word_count / 200);
    $entity->set('reading_time', max(1, $reading_time));

    // 2. Análisis de Sentimiento (F194) — servicio opcional.
    try {
      if (\Drupal::hasService('jaraba_content_hub.sentiment_engine')) {
        /** @var \Drupal\jaraba_content_hub\Service\SentimentEngineService $sentimentEngine */
        $sentimentEngine = \Drupal::service('jaraba_content_hub.sentiment_engine');
        $analysis = $sentimentEngine->analyze($text);
        $entity->set('sentiment_score', $analysis['score']);
        $entity->set('sentiment_label', $analysis['label']);
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_content_hub')->warning(
        'Sentiment analysis failed for article @id: @error',
        ['@id' => $entity->id() ?? 'new', '@error' => $e->getMessage()]
      );
    }

    // 3. Monitor de Reputación — servicio opcional.
    try {
      if (\Drupal::hasService('jaraba_content_hub.reputation_monitor')) {
        /** @var \Drupal\jaraba_content_hub\Service\ReputationMonitorService $reputationMonitor */
        $reputationMonitor = \Drupal::service('jaraba_content_hub.reputation_monitor');
        $reputationMonitor->evaluateContentRisk($entity);
      }
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_content_hub')->warning(
        'Reputation monitor failed for article @id: @error',
        ['@id' => $entity->id() ?? 'new', '@error' => $e->getMessage()]
      );
    }
  }

  // 4. Auto-generación de slug.
  if ($entity->hasField('slug') && $entity->get('slug')->isEmpty()) {
    try {
      $title = $entity->label();
      if (\Drupal::hasService('pathauto.alias_cleaner')) {
        $slug = \Drupal::service('pathauto.alias_cleaner')->cleanString($title);
      }
      else {
        // Fallback: slugify básico.
        $slug = preg_replace('/[^a-z0-9]+/', '-', strtolower($title));
        $slug = trim($slug, '-');
      }
      $entity->set('slug', $slug);
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_content_hub')->warning(
        'Slug generation failed for article: @error',
        ['@error' => $e->getMessage()]
      );
    }
  }
}

/**
 * Implements hook_ENTITY_TYPE_insert() for content_article.
 */
function jaraba_content_hub_content_article_insert(EntityInterface $entity): void {
  _jaraba_content_hub_index_article_if_published($entity);
}

/**
 * Implements hook_ENTITY_TYPE_update() for content_article.
 */
function jaraba_content_hub_content_article_update(EntityInterface $entity): void {
  _jaraba_content_hub_index_article_if_published($entity);
  
  // Trigger: Artículo publicado -> crear borrador de newsletter.
  if ($entity->get('status')->value === 'published' && $entity->original->get('status')->value !== 'published') {
    /** @var \Drupal\jaraba_content_hub\Service\NewsletterBridgeService $bridge */
    $bridge = \Drupal::service('jaraba_content_hub.newsletter_bridge');
    $bridge->createArticleNewsletter($entity);
  }
}

/**
 * Implements hook_ENTITY_TYPE_delete() for content_article.
 */
function jaraba_content_hub_content_article_delete(EntityInterface $entity): void {
  // Remove from Qdrant index.
  if (\Drupal::hasService('jaraba_content_hub.recommendation_service')) {
    try {
      $recommendationService = \Drupal::service('jaraba_content_hub.recommendation_service');
      $recommendationService->removeArticle((int) $entity->id());
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_content_hub')->error('Failed to remove article from index: @error', [
        '@error' => $e->getMessage(),
      ]);
    }
  }
}

/**
 * Helper to index article if published.
 */
function _jaraba_content_hub_index_article_if_published(EntityInterface $entity): void {
  // Only index published articles.
  if (!$entity->hasField('status')) {
    return;
  }

  $status = $entity->get('status')->value;
  if ($status !== 'published') {
    return;
  }

  // Index in Qdrant for recommendations.
  if (\Drupal::hasService('jaraba_content_hub.recommendation_service')) {
    try {
      $recommendationService = \Drupal::service('jaraba_content_hub.recommendation_service');
      $recommendationService->indexArticle((int) $entity->id());
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_content_hub')->warning('Failed to index article: @error', [
        '@error' => $e->getMessage(),
      ]);
    }
  }
}

/**
 * Implements template_preprocess_HOOK() for content_article.
 *
 * Prepara la variable 'article' con datos procesados de la entidad
 * ContentArticle para los templates content-article--full y --teaser.
 * Incluye: datos de autor (bio, avatar), imagen responsive con srcset,
 * URL absoluta, y categoría procesada.
 */
function template_preprocess_content_article(array &$variables): void {
  /** @var \Drupal\jaraba_content_hub\Entity\ContentArticle $entity */
  $entity = $variables['elements']['#content_article'] ?? NULL;
  if (!$entity) {
    return;
  }

  $file_url_generator = \Drupal::service('file_url_generator');

  // Datos base del artículo.
  $article = [
    'id' => $entity->id(),
    'title' => $entity->getTitle(),
    'slug' => $entity->getSlug(),
    'excerpt' => $entity->getExcerpt(),
    'body' => $entity->get('body')->value ?? '',
    'reading_time' => $entity->getReadingTime(),
    'publish_date' => $entity->get('publish_date')->value ?? '',
    'answer_capsule' => $entity->getAnswerCapsule(),
    'ai_generated' => $entity->isAiGenerated(),
    'url' => $entity->toUrl()->setAbsolute()->toString(),
  ];

  // Imagen destacada con srcset responsive.
  if ($entity->hasField('featured_image') && !$entity->get('featured_image')->isEmpty()) {
    $file = $entity->get('featured_image')->entity;
    if ($file) {
      $uri = $file->getFileUri();
      $featured_style = ImageStyle::load('article_featured');
      $hero_style = ImageStyle::load('article_hero');

      $featured_url = $featured_style
        ? $featured_style->buildUrl($uri)
        : $file_url_generator->generateAbsoluteString($uri);
      $hero_url = $hero_style
        ? $hero_style->buildUrl($uri)
        : $file_url_generator->generateAbsoluteString($uri);

      $article['featured_image'] = $featured_url;
      $article['featured_image_srcset'] = $featured_url . ' 1200w, ' . $hero_url . ' 1600w';
    }
  }

  // Categoría.
  if ($entity->hasField('category') && !$entity->get('category')->isEmpty()) {
    $category = $entity->get('category')->entity;
    if ($category) {
      $article['category'] = TRUE;
      $article['category_name'] = $category->getName();
      $article['category_color'] = $category->getColor();
      $article['category_url'] = $category->toUrl()->toString();
    }
  }

  // Autor: nombre, bio y avatar desde la entidad User propietaria.
  $owner = $entity->getOwner();
  if ($owner) {
    $article['author_name'] = $owner->getDisplayName();
    $article['author_url'] = $owner->toUrl()->toString();

    // Bio: campo field_bio o field_description si existe.
    $bio = '';
    foreach (['field_bio', 'field_description', 'field_about'] as $bio_field) {
      if ($owner->hasField($bio_field) && !$owner->get($bio_field)->isEmpty()) {
        $bio = $owner->get($bio_field)->value;
        break;
      }
    }
    $article['author_bio'] = $bio;

    // Avatar: campo user_picture o field_avatar.
    $avatar_url = '';
    foreach (['user_picture', 'field_avatar', 'field_photo'] as $avatar_field) {
      if ($owner->hasField($avatar_field) && !$owner->get($avatar_field)->isEmpty()) {
        $avatar_file = $owner->get($avatar_field)->entity;
        if ($avatar_file) {
          $avatar_url = $file_url_generator->generateAbsoluteString($avatar_file->getFileUri());
          break;
        }
      }
    }
    $article['author_avatar'] = $avatar_url;
  }

  $variables['article'] = $article;
  $variables['show_reading_time'] = TRUE;
}

/**
 * Implements hook_preprocess_page().
 *
 * Inyecta variables de página para el zero-region pattern.
 * Plan Elevación Content Hub — Clase Mundial.
 * Directriz ZERO-REGION-001.
 */
function jaraba_content_hub_preprocess_page(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  // Solo procesar rutas del Content Hub frontend.
  if (str_starts_with($route_name, 'jaraba_content_hub.')) {
    // Inyectar clean_content desde el controller render array.
    if (isset($variables['page']['content'])) {
      $variables['clean_content'] = $variables['page']['content'];
    }

    // Contexto del tema para parciales (header/footer).
    $themeHandler = \Drupal::service('theme_handler');
    $activeTheme = $themeHandler->getDefault();
    $themeConfig = \Drupal::config($activeTheme . '.settings');
    
    $variables['theme_settings'] = $themeConfig->get() ?: [];
    $variables['site_name'] = \Drupal::config('system.site')->get('name') ?: 'Jaraba Impact Platform';
    
    $logoSettings = theme_get_setting('logo', $activeTheme);
    $variables['logo'] = '';
    if (!empty($logoSettings['use_default'])) {
      $variables['logo'] = '/' . \Drupal::service('extension.list.theme')->getPath($activeTheme) . '/logo.svg';
    } elseif (!empty($logoSettings['path'])) {
      $variables['logo'] = $logoSettings['path'];
    }
    
    $variables['logged_in'] = \Drupal::currentUser()->isAuthenticated();
  }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Redirige todas las rutas frontend del Content Hub al template zero-region.
 */
function jaraba_content_hub_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  // Rutas frontend del vertical (excluir rutas API y admin puras).
  if (str_starts_with($route_name, 'jaraba_content_hub.') && !str_contains($route_name, '.api.')) {
    $suggestions[] = 'page__content_hub';
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * Añade body classes para las páginas del Content Hub.
 */
function jaraba_content_hub_preprocess_html(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  if (!str_starts_with($route_name, 'jaraba_content_hub.') &&
      $route_name !== 'entity.content_article.canonical' &&
      $route_name !== 'entity.content_category.canonical') {
    return;
  }

  // Body classes genéricas del content hub.
  if (str_starts_with($route_name, 'jaraba_content_hub.') ||
      $route_name === 'entity.content_article.canonical' ||
      $route_name === 'entity.content_category.canonical') {
    $variables['attributes']['class'][] = 'page-content-hub';
    $variables['attributes']['class'][] = 'page--clean-layout';
  }

  // Body class específica para la ruta del blog listing.
  if ($route_name === 'jaraba_content_hub.blog') {
    $variables['attributes']['class'][] = 'page-blog';
  }

  // --- SEO: Canonical, OG, Twitter Card, Schema.org JSON-LD ---
  // Inyecta meta tags específicos que sobrescriben los genéricos del tema
  // (Drupal deduplicados por clave: 'canonical', 'og_title', etc.).
  _jaraba_content_hub_inject_seo_tags($variables, $route_name);
}

/**
 * Inyecta meta tags SEO específicos del Content Hub.
 *
 * Genera canonical URL, Open Graph, Twitter Card y Schema.org JSON-LD
 * correctos para cada tipo de página del blog. Las claves de html_head
 * coinciden con las del tema para sobrescribirlas.
 *
 * @param array &$variables
 *   Variables de preprocess_html.
 * @param string $route_name
 *   Nombre de la ruta actual.
 */
function _jaraba_content_hub_inject_seo_tags(array &$variables, string $route_name): void {
  $request = \Drupal::request();
  $base_url = $request->getSchemeAndHttpHost();
  $site_config = \Drupal::config('system.site');
  $site_name = $site_config->get('name') ?: 'Jaraba Impact Platform';
  $default_image = $base_url . '/' . \Drupal::service('extension.list.theme')
    ->getPath('ecosistema_jaraba_theme') . '/images/og-image.jpg';

  // Obtener logo para Schema.org publisher.
  $logo_url = '';
  $logo_settings = theme_get_setting('logo', 'ecosistema_jaraba_theme');
  if (!empty($logo_settings['path'])) {
    $logo_url = $base_url . '/' . ltrim($logo_settings['path'], '/');
  }

  // Valores por defecto (listing pages).
  $config = \Drupal::config('jaraba_content_hub.settings');
  $meta_title = (string) ($config->get('blog_title') ?? t('Blog')) . ' | ' . $site_name;
  $description = (string) t('Discover insights, tips, and stories from our community.');
  $og_type = 'website';
  $og_url = $base_url . $request->getPathInfo();
  $og_image = $default_image;
  $schema_json = NULL;

  // Artículo individual: datos específicos de la entidad.
  if ($route_name === 'entity.content_article.canonical') {
    $article = \Drupal::routeMatch()->getParameter('content_article');
    if ($article && $article instanceof \Drupal\jaraba_content_hub\Entity\ContentArticle) {
      $seo_title = '';
      if ($article->hasField('seo_title') && !$article->get('seo_title')->isEmpty()) {
        $seo_title = $article->get('seo_title')->value;
      }
      $meta_title = ($seo_title ?: $article->getTitle()) . ' | ' . $site_name;

      $seo_desc = '';
      if ($article->hasField('seo_description') && !$article->get('seo_description')->isEmpty()) {
        $seo_desc = $article->get('seo_description')->value;
      }
      $description = $seo_desc ?: ($article->getExcerpt() ?: $description);

      $og_type = 'article';
      $og_url = $article->toUrl()->setAbsolute()->toString();

      // Imagen destacada.
      try {
        if ($article->hasField('featured_image') && !$article->get('featured_image')->isEmpty()) {
          $file = $article->get('featured_image')->entity;
          if ($file) {
            $og_image = \Drupal::service('file_url_generator')
              ->generateAbsoluteString($file->getFileUri());
          }
        }
      }
      catch (\Exception $e) {
        // Usar imagen por defecto.
      }

      // Meta tags article:* de Open Graph.
      $publish_date = $article->get('publish_date')->value ?? '';
      $changed = $article->getChangedTime();
      $author_name = '';
      $owner = $article->getOwner();
      if ($owner) {
        $author_name = $owner->getDisplayName();
      }

      $variables['#attached']['html_head'][] = [
        ['#tag' => 'meta', '#attributes' => [
          'property' => 'article:published_time',
          'content' => $publish_date,
        ]],
        'article_published_time',
      ];
      $variables['#attached']['html_head'][] = [
        ['#tag' => 'meta', '#attributes' => [
          'property' => 'article:modified_time',
          'content' => date('c', $changed),
        ]],
        'article_modified_time',
      ];
      if ($author_name) {
        $variables['#attached']['html_head'][] = [
          ['#tag' => 'meta', '#attributes' => [
            'property' => 'article:author',
            'content' => $author_name,
          ]],
          'article_author',
        ];
      }

      // Schema.org JSON-LD via SeoService.
      try {
        /** @var \Drupal\jaraba_content_hub\Service\SeoService $seo_service */
        $seo_service = \Drupal::service('jaraba_content_hub.seo_service');
        $schema_json = $seo_service->generateArticleSchema([
          'title' => $article->getTitle(),
          'excerpt' => $description,
          'publish_date' => $publish_date,
          'changed' => date('c', $changed),
          'author_name' => $author_name,
          'publisher_name' => $site_name,
          'publisher_logo' => $logo_url,
          'featured_image' => $og_image,
          'url' => $og_url,
        ]);
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_content_hub')->error(
          'Error generando Schema.org para artículo @id: @error',
          ['@id' => $article->id(), '@error' => $e->getMessage()]
        );
      }
    }
  }

  // Categoría: datos específicos.
  if ($route_name === 'entity.content_category.canonical') {
    $category = \Drupal::routeMatch()->getParameter('content_category');
    if ($category) {
      $meta_title = $category->getName() . ' — ' . (string) ($config->get('blog_title') ?? t('Blog')) . ' | ' . $site_name;
      if (method_exists($category, 'getDescription') && $category->getDescription()) {
        $description = $category->getDescription();
      }
      $og_url = $category->toUrl()->setAbsolute()->toString();
    }
  }

  // Blog listing: canonical correcto, Schema.org Blog.
  if ($route_name === 'jaraba_content_hub.blog') {
    $og_url = \Drupal\Core\Url::fromRoute('jaraba_content_hub.blog')
      ->setAbsolute()
      ->toString();

    $schema_json = [
      '@context' => 'https://schema.org',
      '@type' => 'Blog',
      'name' => (string) ($config->get('blog_title') ?? t('Blog')),
      'description' => $description,
      'url' => $og_url,
      'publisher' => [
        '@type' => 'Organization',
        'name' => $site_name,
        'logo' => [
          '@type' => 'ImageObject',
          'url' => $logo_url,
        ],
      ],
    ];
  }

  // --- Inyectar meta tags con claves que sobrescriben al tema ---
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['name' => 'description', 'content' => $description]],
    'meta_description',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['property' => 'og:type', 'content' => $og_type]],
    'og_type',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['property' => 'og:title', 'content' => $meta_title]],
    'og_title',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['property' => 'og:description', 'content' => $description]],
    'og_description',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['property' => 'og:url', 'content' => $og_url]],
    'og_url',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['property' => 'og:image', 'content' => $og_image]],
    'og_image',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['name' => 'twitter:title', 'content' => $meta_title]],
    'twitter_title',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['name' => 'twitter:description', 'content' => $description]],
    'twitter_description',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'meta', '#attributes' => ['name' => 'twitter:image', 'content' => $og_image]],
    'twitter_image',
  ];
  $variables['#attached']['html_head'][] = [
    ['#tag' => 'link', '#attributes' => ['rel' => 'canonical', 'href' => $og_url]],
    'canonical',
  ];

  // Schema.org JSON-LD.
  if ($schema_json) {
    $variables['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'script',
        '#attributes' => ['type' => 'application/ld+json'],
        '#value' => json_encode($schema_json, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT),
      ],
      'content_hub_schema_json_ld',
    ];
  }
}
