<?php

/**
 * @file
 * Módulo principal del sistema de Heatmaps nativo Jaraba.
 *
 * Proporciona tracking de interacciones de usuario (clics, scroll, movimiento)
 * y visualización mediante Canvas con gradientes de calor.
 *
 * Ref: Doc Técnico #180 - Native Heatmaps System
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_theme().
 */
function jaraba_heatmap_theme(): array {
  return [
    'heatmap_analytics_dashboard' => [
      'variables' => [
        'pages' => [],
        'summary' => [],
        'tenant_id' => 0,
      ],
      'template' => 'heatmap-analytics-dashboard',
    ],
    'heatmap_metric_card' => [
      'variables' => [
        'title' => '',
        'value' => 0,
        'icon' => '',
        'trend' => NULL,
        'trend_direction' => NULL,
      ],
      'template' => 'heatmap-metric-card',
    ],
  ];
}

/**
 * Implements hook_help().
 *
 * Proporciona documentación contextual del módulo en la interfaz de ayuda.
 */
function jaraba_heatmap_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.jaraba_heatmap':
      $output = '<h3>' . t('Acerca de Jaraba Heatmap') . '</h3>';
      $output .= '<p>' . t('Sistema de heatmaps 100% nativo para la plataforma Jaraba. Elimina dependencias de servicios externos (Hotjar, MS Clarity) proporcionando tracking completo de interacciones.') . '</p>';
      $output .= '<h4>' . t('Capacidades') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('Click Heatmaps: Visualización de zonas de mayor interacción') . '</li>';
      $output .= '<li>' . t('Scroll Depth: Análisis de profundidad de scroll') . '</li>';
      $output .= '<li>' . t('Mouse Movement: Tracking de movimiento para atención') . '</li>';
      $output .= '<li>' . t('Canvas Render: Visualización con gradientes de calor') . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_page_attachments().
 *
 * Inyecta el tracker JavaScript en páginas frontend.
 * Respeta el consentimiento GDPR y excluye rutas administrativas.
 */
function jaraba_heatmap_page_attachments(array &$attachments) {
  // No cargar en rutas de administración.
  $admin_context = \Drupal::service('router.admin_context');
  if ($admin_context->isAdminRoute()) {
    return;
  }

  // Respetar cabecera Do Not Track.
  $request = \Drupal::request();
  if ($request->headers->get('DNT') === '1') {
    return;
  }

  // Verificar si el módulo de configuración tiene el tracking habilitado.
  $config = \Drupal::config('jaraba_heatmap.settings');
  if (!$config->get('enabled')) {
    return;
  }

  // Obtener contexto de tenant para multi-tenancy.
  $tenant_id = NULL;
  if (\Drupal::hasService('ecosistema_jaraba_core.tenant_context')) {
    // @todo CONS-N10: Move to service class for proper DI.
    $tenant_context = \Drupal::service('ecosistema_jaraba_core.tenant_context');
    $tenant = $tenant_context->getCurrentTenant();
    if ($tenant) {
      $tenant_id = $tenant->id();
    }
  }

  // Generar o recuperar session ID.
  $session = \Drupal::request()->getSession();
  $session_id = $session->get('jaraba_heatmap_session');
  if (!$session_id) {
    $session_id = 'hm_' . base_convert(time(), 10, 36) . substr(md5(uniqid()), 0, 9);
    $session->set('jaraba_heatmap_session', $session_id);
  }

  // Adjuntar biblioteca y configuración.
  $attachments['#attached']['library'][] = 'jaraba_heatmap/tracker';
  $attachments['#attached']['drupalSettings']['jarabaHeatmap'] = [
    'enabled' => TRUE,
    'tenantId' => $tenant_id,
    'sessionId' => $session_id,
    'endpoint' => '/api/v1/heatmap/collect',
    'bufferSize' => (int) $config->get('buffer_size') ?: 50,
    'flushInterval' => (int) $config->get('flush_interval') ?: 10000,
    'throttleMove' => (int) $config->get('throttle_move') ?: 100,
    'throttleScroll' => (int) $config->get('throttle_scroll') ?: 200,
  ];
}

/**
 * Implements hook_cron().
 *
 * Orquesta 3 flujos independientes con frecuencias distintas:
 * - Agregación diaria (§11.1)
 * - Cleanup semanal (§11.2)
 * - Detección de anomalías diaria (§11.3)
 *
 * Cada flujo tiene su propio state key para control de ejecución independiente.
 * Ref: Spec 20260130a §11
 */
function jaraba_heatmap_cron() {
  $time = \Drupal::time()->getRequestTime();

  _jaraba_heatmap_cron_aggregation($time);
  _jaraba_heatmap_cron_cleanup($time);
  _jaraba_heatmap_cron_anomaly_detection($time);
}

/**
 * Ejecuta la agregación diaria de eventos de heatmap.
 *
 * Procesa eventos del día anterior en buckets para visualización eficiente.
 * Controlado por state 'jaraba_heatmap.last_aggregation'.
 * Ref: Spec 20260130a §11.1
 *
 * @param int $time
 *   Timestamp actual del request.
 */
function _jaraba_heatmap_cron_aggregation(int $time): void {
  $last_run = \Drupal::state()->get('jaraba_heatmap.last_aggregation', 0);
  $today = strtotime('today');

  if ($last_run >= $today) {
    return;
  }

  if (!\Drupal::hasService('jaraba_heatmap.aggregator')) {
    return;
  }

  try {
    /** @var \Drupal\jaraba_heatmap\Service\HeatmapAggregatorService $aggregator */
    $aggregator = \Drupal::service('jaraba_heatmap.aggregator');
    $aggregator->aggregateDaily();
    \Drupal::state()->set('jaraba_heatmap.last_aggregation', $time);
    \Drupal::logger('jaraba_heatmap')->info('Daily aggregation completed.');
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_heatmap')->error('Error in daily aggregation: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Ejecuta la purga semanal de datos antiguos.
 *
 * Purga eventos raw, datos agregados y screenshots expirados.
 * Controlado por state 'jaraba_heatmap.last_cleanup'.
 * Ref: Spec 20260130a §11.2
 *
 * @param int $time
 *   Timestamp actual del request.
 */
function _jaraba_heatmap_cron_cleanup(int $time): void {
  $last_run = \Drupal::state()->get('jaraba_heatmap.last_cleanup', 0);
  $one_week = 604800;

  if (($time - $last_run) <= $one_week) {
    return;
  }

  if (!\Drupal::hasService('jaraba_heatmap.aggregator')) {
    return;
  }

  try {
    $config = \Drupal::config('jaraba_heatmap.settings');
    /** @var \Drupal\jaraba_heatmap\Service\HeatmapAggregatorService $aggregator */
    $aggregator = \Drupal::service('jaraba_heatmap.aggregator');

    $raw_days = (int) ($config->get('retention_raw_days') ?: 7);
    $agg_days = (int) ($config->get('retention_aggregated_days') ?: 90);

    $aggregator->purgeOldEvents($raw_days);
    $aggregator->purgeOldAggregated($agg_days);

    if (\Drupal::hasService('jaraba_heatmap.screenshot')) {
      /** @var \Drupal\jaraba_heatmap\Service\HeatmapScreenshotService $screenshot */
      $screenshot = \Drupal::service('jaraba_heatmap.screenshot');
      $screenshot->cleanupExpiredScreenshots(30);
    }

    \Drupal::state()->set('jaraba_heatmap.last_cleanup', $time);
    \Drupal::logger('jaraba_heatmap')->info('Weekly cleanup completed.');
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_heatmap')->error('Error in weekly cleanup: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Ejecuta la detección diaria de anomalías en métricas de heatmap.
 *
 * Compara métricas del día anterior con la media de 7 días previos.
 * Controlado por state 'jaraba_heatmap.last_anomaly_check'.
 * Ref: Spec 20260130a §11.3
 *
 * @param int $time
 *   Timestamp actual del request.
 */
function _jaraba_heatmap_cron_anomaly_detection(int $time): void {
  $last_run = \Drupal::state()->get('jaraba_heatmap.last_anomaly_check', 0);
  $today = strtotime('today');

  if ($last_run >= $today) {
    return;
  }

  if (!\Drupal::hasService('jaraba_heatmap.aggregator')) {
    return;
  }

  try {
    /** @var \Drupal\jaraba_heatmap\Service\HeatmapAggregatorService $aggregator */
    $aggregator = \Drupal::service('jaraba_heatmap.aggregator');
    $anomalies = $aggregator->detectAnomalies();

    if (!empty($anomalies)) {
      \Drupal::logger('jaraba_heatmap')->warning('Anomalies detected: @count pages with unusual activity.', [
        '@count' => count($anomalies),
      ]);
    }

    \Drupal::state()->set('jaraba_heatmap.last_anomaly_check', $time);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_heatmap')->error('Error in anomaly detection: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}
