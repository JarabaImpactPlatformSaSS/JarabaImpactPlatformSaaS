{#
/**
 * @file
 * Template for job posting detail page.
 *
 * Variables:
 * - job: Array with job data (id, title, description, etc.) from controller.
 * - employer: Array with employer data (or entity).
 * - similar_jobs: Array of similar job postings.
 * - can_apply: Boolean, whether user can apply.
 * - has_applied: Boolean, whether user has already applied.
 * - schema_org_json_ld: Schema.org JSON-LD script tag (auto-generated).
 */
#}

{# Schema.org JSON-LD for Google Job Search #}
{% if schema_org_json_ld %}
  {{ schema_org_json_ld|raw }}
{% endif %}

<article class="job-detail" itemscope itemtype="https://schema.org/JobPosting">
  <header class="job-detail__header">
    {% if employer %}
      <div class="job-detail__employer">
        {% if employer.logo_url %}
          <img class="job-detail__employer-logo"
               src="{{ employer.logo_url }}"
               alt="{{ employer.name }}"
               itemprop="hiringOrganization" itemscope itemtype="https://schema.org/Organization">
        {% endif %}
        <div class="job-detail__employer-info">
          <span class="job-detail__company-name" itemprop="name">
            {{ employer.name }}
          </span>
        </div>
      </div>
    {% endif %}

    <h1 class="job-detail__title" itemprop="title">{{ job.title }}</h1>

    <div class="job-detail__meta">
      {% if job.location %}
        <span class="job-detail__location" itemprop="jobLocation" itemscope itemtype="https://schema.org/Place">
          {{ jaraba_icon('ui', 'location', { size: '16px' }) }}
          <span itemprop="address" itemscope itemtype="https://schema.org/PostalAddress">
            <span itemprop="addressLocality">{{ job.location }}</span>
          </span>
        </span>
      {% endif %}

      {% if job.job_type %}
        <span class="job-detail__type" itemprop="employmentType">
          {{ jaraba_icon('business', 'job', { size: '16px' }) }}
          {{ job.job_type_label ?? job.job_type|capitalize }}
        </span>
      {% endif %}

      {% if job.remote_type %}
        <span class="job-detail__remote">
          {{ jaraba_icon('ui', 'home', { size: '16px' }) }}
          {{ job.remote_type_label ?? job.remote_type }}
        </span>
      {% endif %}

      {% if job.salary and job.salary_visible %}
        {% set salary = job.salary %}
        {% if salary.min and salary.max %}
          <span class="job-detail__salary" itemprop="baseSalary" itemscope itemtype="https://schema.org/MonetaryAmount">
            {{ jaraba_icon('analytics', 'trending-up', { size: '16px' }) }}
            <span itemprop="currency" content="EUR">€</span>
            <span itemprop="value" itemscope itemtype="https://schema.org/QuantitativeValue">
              <span itemprop="minValue">{{ salary.min|number_format(0, ',', '.') }}</span> -
              <span itemprop="maxValue">{{ salary.max|number_format(0, ',', '.') }}</span>
              <meta itemprop="unitText" content="{{ salary.period|upper }}">
            </span>
            /{{ salary.period }}
          </span>
        {% endif %}
      {% endif %}
    </div>

    {% if job.created %}
      <meta itemprop="datePosted" content="{{ job.created|date('Y-m-d') }}">
    {% endif %}
  </header>

  <div class="job-detail__content">
    <section class="job-detail__description">
      <h2>{{ 'Descripción del puesto'|t }}</h2>
      <div itemprop="description">
        {{ job.description|safe_html }}
      </div>
    </section>

    {% if job.requirements %}
      <section class="job-detail__requirements">
        <h2>{{ 'Requisitos'|t }}</h2>
        <div itemprop="qualifications">
          {{ job.requirements|safe_html }}
        </div>
      </section>
    {% endif %}

    {% if job.responsibilities %}
      <section class="job-detail__responsibilities">
        <h2>{{ 'Responsabilidades'|t }}</h2>
        <div itemprop="responsibilities">
          {{ job.responsibilities|safe_html }}
        </div>
      </section>
    {% endif %}

    {% if job.benefits %}
      <section class="job-detail__benefits">
        <h2>{{ 'Beneficios'|t }}</h2>
        <div>
          {{ job.benefits|safe_html }}
        </div>
      </section>
    {% endif %}

    {% if job.skills %}
      <section class="job-detail__skills">
        <h2>{{ 'Habilidades requeridas'|t }}</h2>
        <div class="skill-tags" itemprop="skills">
          {% for skill in job.skills %}
            <span class="skill-tag">{{ skill.name ?? skill }}</span>
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </div>

  <aside class="job-detail__sidebar" role="complementary" aria-label="{{ 'Job actions'|t }}">
    <div class="job-detail__apply-box">
      {% if can_apply and not has_applied %}
        <a href="{{ path('jaraba_job_board.apply', {'job_posting': job.id}) }}"
           class="jaraba-btn jaraba-btn--primary jaraba-btn--block"
           aria-label="{{ 'Apply for: %title'|t({'%title': job.title}) }}">
          {{ jaraba_icon('ui', 'send', { size: '18px' }) }}
          {{ 'Aplicar ahora'|t }}
        </a>
      {% elseif has_applied %}
        <div class="job-detail__applied-badge" role="status">
          {{ jaraba_icon('ui', 'check', { size: '18px' }) }}
          {{ 'Ya has aplicado'|t }}
        </div>
        <a href="{{ path('jaraba_job_board.my_applications') }}" class="jaraba-btn jaraba-btn--ghost jaraba-btn--block">
          {{ 'Ver mi candidatura'|t }}
        </a>
      {% else %}
        <a href="{{ path('user.login') }}" class="jaraba-btn jaraba-btn--primary jaraba-btn--block">
          {{ 'Inicia sesión para aplicar'|t }}
        </a>
      {% endif %}

      <button type="button" class="jaraba-btn jaraba-btn--ghost jaraba-btn--block job-save-btn"
              data-job-id="{{ job.id }}"
              aria-label="{{ 'Save job: %title'|t({'%title': job.title}) }}">
        {{ jaraba_icon('ui', 'bookmark', { size: '18px' }) }}
        {{ 'Guardar oferta'|t }}
      </button>
    </div>

    {% if employer %}
      <div class="job-detail__company-card">
        <h3>{{ 'Sobre la empresa'|t }}</h3>
        {% if employer.description %}
          <p>{{ employer.description|striptags|slice(0, 200) }}...</p>
        {% endif %}
      </div>
    {% endif %}
  </aside>

  {% if similar_jobs %}
    <section class="job-detail__similar" aria-label="{{ 'Similar job offers'|t }}">
      <h2>{{ 'Ofertas similares'|t }}</h2>
      <div class="similar-jobs-grid">
        {% for similar in similar_jobs %}
          <article class="job-card job-card--compact">
            <h3 class="job-card__title">
              <a href="{{ path('jaraba_job_board.job_detail', {'job_posting': similar.id}) }}">
                {{ similar.title }}
              </a>
            </h3>
            {% if similar.location %}
              <p class="job-card__location">{{ similar.location }}</p>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    </section>
  {% endif %}
</article>
