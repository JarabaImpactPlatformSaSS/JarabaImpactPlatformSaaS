services:
  jaraba_billing.wallet:
    class: Drupal\jaraba_billing\Service\WalletService
    arguments:
      - '@database'
      - '@logger.channel.default'

  # ===========================================
  # JARABA BILLING — Servicios de Subscripción y Metering
  # ===========================================
  # Extraídos de ecosistema_jaraba_core (TD-003 God Object)
  # Los service IDs originales en ecosistema_jaraba_core.services.yml
  # son ahora aliases backward-compatible que apuntan aquí.

  # Logger channel para billing
  logger.channel.jaraba_billing:
    parent: logger.channel_base
    arguments: ['jaraba_billing']

  # Validador de límites de planes SaaS.
  # P1-01/P1-02: Extendido con límites de Page Builder y Credentials.
  # F2: Integra con UpgradeTriggerService para consultar FreemiumVerticalLimit.
  # El tercer argumento es nullable (?) para backwards compatibility cuando
  # ecosistema_jaraba_core.upgrade_trigger no esta disponible.
  jaraba_billing.plan_validator:
    class: Drupal\jaraba_billing\Service\PlanValidator
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.jaraba_billing'
      - '@?ecosistema_jaraba_core.upgrade_trigger'
      - '@?ecosistema_jaraba_core.plan_resolver'
    calls:
      - [setStringTranslation, ['@string_translation']]

  # BE-03 + BIZ-002: Gestión del ciclo de vida de subscripciones
  jaraba_billing.tenant_subscription:
    class: Drupal\jaraba_billing\Service\TenantSubscriptionService
    arguments:
      - '@jaraba_billing.plan_validator'
      - '@logger.channel.jaraba_billing'

  # Metering avanzado por tenant (usage-based pricing)
  jaraba_billing.tenant_metering:
    class: Drupal\jaraba_billing\Service\TenantMeteringService
    arguments:
      - '@database'
      - '@cache.default'
      - '@jaraba_billing.wallet'

  # Motor de cálculo de precios basado en PricingRule
  jaraba_billing.pricing_engine:
    class: Drupal\jaraba_billing\Service\PricingRuleEngine
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.jaraba_billing'

  # Reverse Trial con downgrade automático
  jaraba_billing.reverse_trial:
    class: Drupal\jaraba_billing\Service\ReverseTrialService
    arguments:
      - '@entity_type.manager'
      - '@logger.factory'
      - '@plugin.manager.mail'
      - '@state'

  # Tracking de expansion revenue y PQA
  jaraba_billing.expansion_revenue:
    class: Drupal\jaraba_billing\Service\ExpansionRevenueService
    arguments:
      - '@entity_type.manager'
      - '@state'
      - '@logger.factory'

  # Créditos de impacto para gamificación y engagement
  jaraba_billing.impact_credit:
    class: Drupal\jaraba_billing\Service\ImpactCreditService
    arguments:
      - '@database'
      - '@entity_type.manager'
      - '@logger.channel.jaraba_billing'

  # Agente CFO Sintético para Emprendimiento Digital
  jaraba_billing.synthetic_cfo:
    class: Drupal\jaraba_billing\Service\SyntheticCfoService
    arguments:
      - '@http_client'
      - '@config.factory'
      - '@logger.factory'

  # ===========================================
  # STRIPE INTEGRATION — Servicios de integración real
  # ===========================================

  # Gestión de clientes Stripe
  # AUDIT-PERF-002: Inyección de @lock para prevenir race conditions.
  jaraba_billing.stripe_customer:
    class: Drupal\jaraba_billing\Service\StripeCustomerService
    arguments:
      - '@jaraba_foc.stripe_connect'
      - '@entity_type.manager'
      - '@logger.channel.jaraba_billing'
      - '@lock'

  # Gestión de suscripciones Stripe
  # AUDIT-PERF-002: Inyección de @lock para prevenir race conditions.
  jaraba_billing.stripe_subscription:
    class: Drupal\jaraba_billing\Service\StripeSubscriptionService
    arguments:
      - '@jaraba_foc.stripe_connect'
      - '@jaraba_billing.tenant_subscription'
      - '@entity_type.manager'
      - '@logger.channel.jaraba_billing'
      - '@lock'

  # Sincronización de facturas Stripe
  # AUDIT-PERF-002: Inyección de @lock para prevenir race conditions.
  jaraba_billing.stripe_invoice:
    class: Drupal\jaraba_billing\Service\StripeInvoiceService
    arguments:
      - '@jaraba_foc.stripe_connect'
      - '@entity_type.manager'
      - '@logger.channel.jaraba_billing'
      - '@lock'

  # ===========================================
  # DUNNING + FEATURE ACCESS — Servicios de clase mundial
  # ===========================================

  # Gestión del proceso de dunning (cobro) — spec 134 §6
  jaraba_billing.dunning:
    class: Drupal\jaraba_billing\Service\DunningService
    arguments:
      - '@jaraba_billing.tenant_subscription'
      - '@entity_type.manager'
      - '@database'
      - '@plugin.manager.mail'
      - '@logger.channel.jaraba_billing'

  # Verificación de acceso a features por plan + add-ons — spec 158 §6.1
  jaraba_billing.feature_access:
    class: Drupal\jaraba_billing\Service\FeatureAccessService
    arguments:
      - '@jaraba_billing.plan_validator'
      - '@entity_type.manager'
      - '@logger.channel.jaraba_billing'

  # ===========================================
  # FISCAL INVOICE DELEGATION — FASE 11 (F11-5)
  # ===========================================

  # Delegacion de facturas finalizadas al stack fiscal correspondiente.
  # Detecta tipo (B2G/B2B/nacional) y delega a VeriFactu + Facturae/E-Factura.
  # Servicios opcionales de modulos fiscales inyectados condicionalmente
  # via JarabaBillingServiceProvider cuando los modulos estan instalados.
  jaraba_billing.fiscal_delegation:
    class: Drupal\jaraba_billing\Service\FiscalInvoiceDelegationService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.jaraba_billing'
      - ~
      - ~
      - ~
