services:
  # =====================================================================
  # Canal de log dedicado para Jaraba A/B Testing
  # =====================================================================
  logger.channel.jaraba_ab_testing:
    parent: logger.channel_base
    arguments: ['jaraba_ab_testing']

  # =====================================================================
  # StatisticalEngineService: Motor estadístico centralizado
  # Responsabilidad: Z-score, chi-cuadrado, intervalos de confianza,
  #   cálculo de tamaño muestral, detección de ganador, potencia
  # Relaciones: consume ABExperiment, ABVariant
  # =====================================================================
  jaraba_ab_testing.statistical_engine:
    class: Drupal\jaraba_ab_testing\Service\StatisticalEngineService
    arguments:
      - '@logger.channel.jaraba_ab_testing'

  # =====================================================================
  # VariantAssignmentService: Asignación de visitantes a variantes
  # Responsabilidad: asignación ponderada, persistencia cookie/session,
  #   segmentación por audiencia, exclusiones
  # Relaciones: consume ABExperiment, ABVariant, RequestStack
  # =====================================================================
  jaraba_ab_testing.variant_assignment:
    class: Drupal\jaraba_ab_testing\Service\VariantAssignmentService
    arguments:
      - '@entity_type.manager'
      - '@request_stack'
      - '@logger.channel.jaraba_ab_testing'

  # =====================================================================
  # ExperimentAggregatorService: Agregador de datos multi-fuente
  # Responsabilidad: recopilar métricas de las 3 implementaciones
  #   existentes (page_builder, skills, copilot) y los experimentos
  #   nativos. Dashboard unificado.
  # Relaciones: consume ABExperiment, ExperimentService (page_builder),
  #   ABTestingService (skills)
  # =====================================================================
  jaraba_ab_testing.experiment_aggregator:
    class: Drupal\jaraba_ab_testing\Service\ExperimentAggregatorService
    arguments:
      - '@entity_type.manager'
      - '@ecosistema_jaraba_core.tenant_context'
      - '@jaraba_ab_testing.statistical_engine'
      - '@logger.channel.jaraba_ab_testing'

  # =====================================================================
  # OnboardingExperimentService: Experimentación A/B para onboarding
  # Responsabilidad: gestionar experimentos específicos del flujo de
  #   onboarding, asignar variantes a usuarios nuevos, trackear
  #   conversiones de registro/plan/primer login
  # Relaciones: consume ABExperiment, ABVariant, VariantAssignmentService
  # =====================================================================
  jaraba_ab_testing.onboarding_experiment:
    class: Drupal\jaraba_ab_testing\Service\OnboardingExperimentService
    arguments:
      - '@entity_type.manager'
      - '@jaraba_ab_testing.variant_assignment'
      - '@logger.channel.jaraba_ab_testing'

  # =====================================================================
  # ExposureTrackingService: Tracking de exposiciones y conversiones
  # Responsabilidad: registrar exposiciones de visitantes a variantes,
  #   marcar conversiones, obtener exposiciones por experimento
  # Relaciones: consume ExperimentExposure entity
  # =====================================================================
  jaraba_ab_testing.exposure_tracking:
    class: Drupal\jaraba_ab_testing\Service\ExposureTrackingService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.jaraba_ab_testing'

  # =====================================================================
  # ResultCalculationService: Cálculo de resultados estadísticos
  # Responsabilidad: calcular métricas por variante, evaluar
  #   significancia estadística, auto-parada, declarar ganador
  # Relaciones: consume ExperimentExposure, ExperimentResult, ABExperiment
  # =====================================================================
  jaraba_ab_testing.result_calculation:
    class: Drupal\jaraba_ab_testing\Service\ResultCalculationService
    arguments:
      - '@entity_type.manager'
      - '@logger.channel.jaraba_ab_testing'
