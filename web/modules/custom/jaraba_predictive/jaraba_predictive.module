<?php

declare(strict_types=1);

/**
 * @file
 * Modulo jaraba_predictive â€” Modelos Predictivos ML.
 *
 * Estructura: Hooks principales del modulo (theme, preprocess, entity).
 * Logica: Zero-region pattern para dashboard, inyeccion de datos via servicios,
 *         registro de eventos en entity insert/update.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_theme().
 *
 * Estructura: Registra plantillas del dashboard y parciales reutilizables.
 * Logica: Variables inyectadas desde hook_preprocess_page() para zero-region.
 */
function jaraba_predictive_theme(): array {
  return [
    'page__predictions' => [
      'variables' => [
        'churn_predictions' => [],
        'lead_scores' => [],
        'forecasts' => [],
        'stats' => [],
        'copilot_context' => NULL,
      ],
    ],
    'churn_prediction_card' => [
      'template' => 'partials/churn-prediction-card',
      'variables' => [
        'prediction' => NULL,
      ],
    ],
    'lead_score_card' => [
      'template' => 'partials/lead-score-card',
      'variables' => [
        'lead_score' => NULL,
      ],
    ],
    'forecast_card' => [
      'template' => 'partials/forecast-card',
      'variables' => [
        'forecast' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Estructura: Sugerencia de plantilla page__predictions para la ruta del dashboard.
 * Logica: Permite al tema utilizar page--predictions.html.twig.
 */
function jaraba_predictive_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_match = \Drupal::routeMatch();
  if ($route_match->getRouteName() === 'jaraba_predictive.dashboard') {
    $suggestions[] = 'page__predictions';
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * Estructura: Clases de body para rutas del modulo.
 * Logica: Agrega 'page-predictions' y 'n2-growth-ready' en rutas jaraba_predictive.*;
 *         agrega 'full-width-layout' exclusivamente en el dashboard.
 */
function jaraba_predictive_preprocess_html(array &$variables): void {
  $route_match = \Drupal::routeMatch();
  $route_name = $route_match->getRouteName();

  if ($route_name && str_starts_with($route_name, 'jaraba_predictive.')) {
    $variables['attributes']['class'][] = 'page-predictions';
    $variables['attributes']['class'][] = 'n2-growth-ready';

    if ($route_name === 'jaraba_predictive.dashboard') {
      $variables['attributes']['class'][] = 'full-width-layout';
    }
  }
}

/**
 * Implements hook_preprocess_page().
 *
 * Estructura: Inyeccion de datos para el dashboard zero-region.
 * Logica: Carga predicciones de churn, lead scores, forecasts y estadisticas
 *         via servicios; adjunta library y drupalSettings para el frontend.
 */
function jaraba_predictive_preprocess_page(array &$variables): void {
  $route_match = \Drupal::routeMatch();
  if ($route_match->getRouteName() !== 'jaraba_predictive.dashboard') {
    return;
  }

  /** @var \Drupal\jaraba_predictive\Service\ChurnPredictorService $churn_service */
  $churn_service = \Drupal::service('jaraba_predictive.churn_predictor');
  /** @var \Drupal\jaraba_predictive\Service\ForecastEngineService $forecast_service */
  $forecast_service = \Drupal::service('jaraba_predictive.forecast_engine');

  // 1. Obtener predicciones recientes.
  $entity_type_manager = \Drupal::entityTypeManager();
  $churn_storage = $entity_type_manager->getStorage('churn_prediction');
  $churn_ids = $churn_storage->getQuery()
    ->accessCheck(TRUE)
    ->sort('created', 'DESC')
    ->range(0, 10)
    ->execute();
  $churn_predictions = $churn_storage->loadMultiple($churn_ids);

  // 2. Obtener tendencias para grÃ¡ficos (Ãºltimos 6 meses).
  $revenue_forecast = $forecast_service->getForecastHistory('revenue', 6);
  
  // 3. Obtener alertas de fraude recientes (F192).
  // Simulamos carga de alertas para el dashboard.
  $recent_fraud_count = 0; 

  // 4. EstadÃ­sticas de Mando.
  $stats = [
    'high_risk_count' => count($churn_service->getHighRiskTenants(50)),
    'avg_forecast_accuracy' => $forecast_service->compareActualVsPredicted('revenue')['mape'],
    'total_predictions' => count($churn_predictions),
    'active_fraud_alerts' => $recent_fraud_count,
  ];

  $variables['churn_predictions'] = $churn_predictions;
  $variables['forecasts'] = $revenue_forecast;
  $variables['stats'] = $stats;

  // 4. Copilot Context: Datos para que el asistente IA ayude en el dashboard.
  $variables['copilot_context'] = [
    'primary_risk' => count($churn_predictions) > 0 ? reset($churn_predictions)->get('risk_level')->value : 'low',
    'forecast_trend' => 'stable',
  ];

  $variables['#attached']['library'][] = 'jaraba_predictive/predictive-dashboard';
  $variables['#attached']['drupalSettings']['jarabaPredictive'] = [
    'charts' => [
      'revenue_trend' => $revenue_forecast,
    ],
    'stats' => $stats,
  ];
}

/**
 * Implements hook_entity_insert().
 *
 * Estructura: Registro de eventos al crear predicciones y scores.
 * Logica: Log informativo cuando se crea una entidad de prediccion.
 */
function jaraba_predictive_entity_insert(EntityInterface $entity): void {
  $predictive_types = ['churn_prediction', 'lead_score', 'forecast'];

  if (in_array($entity->getEntityTypeId(), $predictive_types, TRUE)) {
    \Drupal::logger('jaraba_predictive')->info(
      'Entidad @type creada: @id.',
      [
        '@type' => $entity->getEntityTypeId(),
        '@id' => $entity->id(),
      ]
    );
  }
}
