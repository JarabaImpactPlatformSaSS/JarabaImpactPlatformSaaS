<?php

/**
 * @file
 * Customer Success Proactivo - Health scores, churn prediction, playbooks.
 *
 * PROPÓSITO:
 * Módulo principal de Customer Success. Implementa hook_cron para
 * cálculo programado de health scores y ejecución de playbooks.
 * Define hook_theme() para templates del dashboard frontend.
 */

declare(strict_types=1);

/**
 * Implements hook_help().
 */
function jaraba_customer_success_help(string $route_name): string {
  if ($route_name === 'help.page.jaraba_customer_success') {
    return '<p>' . t('Customer Success proactivo con health scores 0-100, predicción de churn, playbooks automatizados y señales de expansión. Dashboard del CSM en /customer-success.') . '</p>';
  }
  return '';
}

/**
 * Implements hook_theme().
 */
function jaraba_customer_success_theme(): array {
  return [
    'jaraba_cs_dashboard' => [
      'variables' => [
        'stats' => [],
        'category_counts' => [],
        'recent_health' => [],
        'at_risk_tenants' => [],
        'active_playbooks' => [],
        'expansion_signals' => [],
        'nps_trend' => [],
      ],
      'template' => 'jaraba-cs-dashboard',
    ],
    'jaraba_cs_health_card' => [
      'variables' => [
        'health' => NULL,
        'tenant' => NULL,
      ],
      'template' => 'jaraba-cs-health-card',
    ],
    'jaraba_cs_churn_panel' => [
      'variables' => [
        'predictions' => [],
      ],
      'template' => 'jaraba-cs-churn-panel',
    ],
    'jaraba_cs_playbook_timeline' => [
      'variables' => [
        'executions' => [],
        'playbooks' => [],
      ],
      'template' => 'jaraba-cs-playbook-timeline',
    ],
    'jaraba_cs_empty_state' => [
      'variables' => [
        'title' => '',
        'message' => '',
        'action_url' => '',
        'action_label' => '',
      ],
      'template' => 'jaraba-cs-empty-state',
    ],
    'jaraba_cs_nps_survey' => [
      'variables' => [
        'survey_title' => '',
        'survey_description' => '',
        'submit_url' => '',
      ],
      'template' => 'jaraba-cs-nps-survey',
    ],
    'jaraba_cs_nps_results' => [
      'variables' => [
        'nps_score' => 0,
        'total_responses' => 0,
        'promoters' => 0,
        'passives' => 0,
        'detractors' => 0,
        'trend_data' => [],
        'recent_responses' => [],
      ],
      'template' => 'jaraba-cs-nps-results',
    ],
    'jaraba_cs_health_detail' => [
      'variables' => [
        'tenant_name' => '',
        'tenant_id' => '',
        'health_score' => 0,
        'category' => 'neutral',
        'trend' => 'stable',
        'engagement_metrics' => [],
        'feature_adoption' => [],
        'risk_factors' => [],
        'recommended_actions' => [],
        'score_history' => [],
      ],
      'template' => 'jaraba-cs-health-detail',
    ],
    'jaraba_cs_expansion_pipeline' => [
      'variables' => [
        'pipeline' => [],
        'total_expansion_value' => 0,
        'stage_counts' => [],
      ],
      'template' => 'jaraba-cs-expansion-pipeline',
    ],
    'jaraba_cs_health_timeline' => [
      'variables' => [
        'events' => [],
        'tenant_name' => '',
      ],
      'template' => 'jaraba-cs-health-timeline',
    ],
    'jaraba_cs_retention_dashboard' => [
      'variables' => [
        'stats' => [],
        'heatmap_data' => [],
        'risk_cards' => [],
        'recent_executions' => [],
      ],
      'template' => 'jaraba-cs-retention-dashboard',
    ],
  ];
}

/**
 * Implements hook_cron().
 *
 * LÓGICA:
 * 1. Ejecutar cálculo programado de health scores (según intervalo).
 * 2. Evaluar triggers de playbooks activos.
 * 3. Avanzar ejecuciones de playbooks pendientes.
 */
function jaraba_customer_success_cron(): void {
  // AUDIT-PERF-N11: Queue operations instead of processing synchronously.
  $queue = \Drupal::queue('jaraba_customer_success_cron_worker');

  $queue->createItem(['operation' => 'health_scores']);
  $queue->createItem(['operation' => 'evaluate_triggers']);
  $queue->createItem(['operation' => 'advance_executions']);

  // Vertical retention: daily evaluation.
  $retentionQueue = \Drupal::queue('jaraba_vertical_retention_cron');
  $retentionQueue->createItem(['operation' => 'vertical_evaluation']);

  // Seasonal predictions only on the 1st of each month.
  if ((int) date('j') === 1) {
    $retentionQueue->createItem(['operation' => 'seasonal_predictions']);
  }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 */
function jaraba_customer_success_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route = \Drupal::routeMatch()->getRouteName();
  if ($route === 'jaraba_customer_success.retention_dashboard') {
    $suggestions[] = 'page__customer_success';
  }
}

/**
 * Implements hook_preprocess_html().
 */
function jaraba_customer_success_preprocess_html(array &$variables): void {
  $route = \Drupal::routeMatch()->getRouteName();
  if ($route === 'jaraba_customer_success.retention_dashboard') {
    $variables['attributes']['class'][] = 'page-customer-success';
    $variables['attributes']['class'][] = 'page-retention-dashboard';
  }
}
