<?php

/**
 * @file
 * Módulo Jaraba Addons: Sistema de add-ons de precios multi-tenant.
 *
 * ESTRUCTURA:
 * Implementa hooks de Drupal para: registro de templates (hook_theme),
 * body classes para páginas de add-ons (hook_preprocess_html),
 * y texto de ayuda (hook_help).
 *
 * LÓGICA:
 * - hook_theme: Registra las plantillas Twig del catálogo de add-ons.
 * - hook_preprocess_html: Añade clases CSS al <body> para identificar
 *   páginas de add-ons y permitir estilos específicos desde SCSS.
 *
 * RELACIONES:
 * - jaraba_addons.module -> templates/ (define templates)
 * - jaraba_addons.module -> AddonCatalogController (templates consumidos por)
 * - jaraba_addons.module <- Drupal core (invocado por)
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function jaraba_addons_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.jaraba_addons':
      $output = '<h3>' . t('About Jaraba Addons') . '</h3>';
      $output .= '<p>' . t('Provides a multi-tenant pricing add-ons system with a catalog of purchasable features, storage, API calls, support tiers, and custom add-ons with subscription management.') . '</p>';
      $output .= '<h4>' . t('Features') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('Add-on catalog with multiple types: feature, storage, API calls, support, custom') . '</li>';
      $output .= '<li>' . t('Monthly and yearly billing cycles with pricing') . '</li>';
      $output .= '<li>' . t('Subscription lifecycle: subscribe, cancel, renew') . '</li>';
      $output .= '<li>' . t('Feature gates based on active add-on subscriptions') . '</li>';
      $output .= '<li>' . t('JSON-based features and limits configuration per add-on') . '</li>';
      $output .= '<li>' . t('REST API for programmatic integration') . '</li>';
      $output .= '<li>' . t('Multi-tenant isolation with tenant-scoped subscriptions') . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 *
 * Registra las plantillas Twig del módulo de add-ons.
 * El catálogo muestra los add-ons disponibles para suscripción
 * y el detalle individual con precios y características.
 */
function jaraba_addons_theme($existing, $type, $theme, $path) {
  return [
    // Catálogo de add-ons (/addons)
    'jaraba_addons_catalog' => [
      'variables' => [
        'addons' => [],
        'addon_types' => [],
        'active_type' => NULL,
        'tenant_subscriptions' => [],
      ],
      'template' => 'addons-catalog',
      'path' => $path . '/templates',
    ],

    // Detalle de add-on (/addons/{addon_id})
    'jaraba_addons_detail' => [
      'variables' => [
        'addon' => [],
        'features' => [],
        'limits' => [],
        'price_monthly' => 0,
        'price_yearly' => 0,
        'is_subscribed' => FALSE,
      ],
      'template' => 'addons-detail',
      'path' => $path . '/templates',
    ],
  ];
}

/**
 * Implements hook_preprocess_html().
 *
 * LÓGICA:
 * Añade clases CSS al <body> cuando el usuario navega por páginas de add-ons.
 * Estas clases permiten aplicar estilos específicos desde SCSS sin
 * necesidad de modificar las plantillas del tema. Las clases siguen
 * el patrón page--addons, page--addon-catalogo, page--addon-detalle.
 *
 * Patrón: body classes via hook_preprocess_html() ÚNICAMENTE.
 * NO se usa attributes.addClass() en templates Twig.
 */
function jaraba_addons_preprocess_html(array &$variables): void {
  $route_match = \Drupal::routeMatch();
  $route_name = $route_match->getRouteName();

  if (!$route_name) {
    return;
  }

  // Mapeo de rutas a clases CSS del body.
  $route_classes = [
    'jaraba_addons.catalog' => ['page--addons', 'page--addons-catalogo'],
    'jaraba_addons.catalog.detail' => ['page--addons', 'page--addon-detalle'],
  ];

  if (isset($route_classes[$route_name])) {
    foreach ($route_classes[$route_name] as $class) {
      $variables['attributes']['class'][] = $class;
    }
  }
}
