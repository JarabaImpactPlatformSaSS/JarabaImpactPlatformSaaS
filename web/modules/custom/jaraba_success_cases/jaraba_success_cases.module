<?php

/**
 * @file
 * Module file for jaraba_success_cases.
 *
 * Provides hooks for theme registration, template suggestions,
 * body class injection, and form alterations for the Success Case entity.
 */

declare(strict_types=1);

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_theme().
 *
 * Registers 3 theme hooks for the frontend templates:
 * - success_cases_list: Grid page with filters and pager.
 * - success_case_detail: Individual case detail page.
 * - success_case_card: Reusable card partial.
 */
function jaraba_success_cases_theme(): array {
  return [
    'success_cases_list' => [
      'variables' => [
        'cases' => [],
        'verticals' => [],
        'current_vertical' => NULL,
        'pager' => NULL,
      ],
      'template' => 'success-cases-list',
    ],
    'success_case_detail' => [
      'variables' => [
        'case' => [],
      ],
      'template' => 'success-case-detail',
    ],
    'success_case_card' => [
      'variables' => [
        'case' => [],
      ],
      'template' => 'success-case-card',
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Adds 'page__success_cases' suggestion for all routes in this module,
 * so they use the Zero Region Policy page template.
 */
function jaraba_success_cases_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();

  if ($route_name && str_starts_with($route_name, 'jaraba_success_cases.')) {
    $suggestions[] = 'page__success_cases';
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * Adds body classes for Success Cases frontend pages.
 * CRITICAL: Body classes MUST be added here, NOT in the template
 * via attributes.addClass() â€” that approach does not work for <body>.
 */
function jaraba_success_cases_preprocess_html(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();

  if ($route_name && str_starts_with($route_name, 'jaraba_success_cases.')) {
    $variables['attributes']['class'][] = 'page-success-cases';
    $variables['attributes']['class'][] = 'full-width-layout';
    $variables['attributes']['class'][] = 'page--clean-layout';

    // Specific class for detail page.
    if ($route_name === 'jaraba_success_cases.detail') {
      $variables['attributes']['class'][] = 'page-success-case-detail';
    }
  }
}

/**
 * Implements hook_form_alter().
 *
 * Hides format guidelines in Success Case forms (especially useful
 * when editing inside a slide-panel modal).
 */
function jaraba_success_cases_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  if (str_contains($form_id, 'success_case')) {
    _jaraba_success_cases_hide_format_guidelines($form);
  }
}

/**
 * Recursively hides text format guidelines from form elements.
 *
 * @param array &$element
 *   The form element to process.
 */
function _jaraba_success_cases_hide_format_guidelines(array &$element): void {
  if (isset($element['format'])) {
    $element['format']['#access'] = FALSE;
  }
  foreach (array_keys($element) as $key) {
    if (is_array($element[$key]) && !str_starts_with((string) $key, '#')) {
      _jaraba_success_cases_hide_format_guidelines($element[$key]);
    }
  }
}
