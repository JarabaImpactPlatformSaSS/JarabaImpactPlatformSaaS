<?php

/**
 * @file
 * Module file for jaraba_success_cases.
 *
 * Provides hooks for theme registration, template suggestions,
 * body class injection, and form alterations for the Success Case entity.
 */

declare(strict_types=1);

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_theme().
 *
 * Registers 3 theme hooks for the frontend templates:
 * - success_cases_list: Grid page with filters and pager.
 * - success_case_detail: Individual case detail page.
 * - success_case_card: Reusable card partial.
 */
function jaraba_success_cases_theme(): array {
  return [
    'success_cases_list' => [
      'variables' => [
        'cases' => [],
        'verticals' => [],
        'current_vertical' => NULL,
        'pager' => NULL,
      ],
      'template' => 'success-cases-list',
    ],
    'success_case_detail' => [
      'variables' => [
        'case' => [],
        'related_cases' => [],
      ],
      'template' => 'success-case-detail',
    ],
    'success_case_card' => [
      'variables' => [
        'case' => [],
      ],
      'template' => 'success-case-card',
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Adds 'page__success_cases' suggestion for all routes in this module,
 * so they use the Zero Region Policy page template.
 */
function jaraba_success_cases_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();

  if ($route_name && str_starts_with($route_name, 'jaraba_success_cases.')) {
    $suggestions[] = 'page__success_cases';
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * Adds body classes for Success Cases frontend pages.
 * CRITICAL: Body classes MUST be added here, NOT in the template
 * via attributes.addClass() — that approach does not work for <body>.
 */
function jaraba_success_cases_preprocess_html(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();

  if ($route_name && str_starts_with($route_name, 'jaraba_success_cases.')) {
    $variables['attributes']['class'][] = 'page-success-cases';
    $variables['attributes']['class'][] = 'full-width-layout';
    $variables['attributes']['class'][] = 'page--clean-layout';

    // Specific class for detail page.
    if ($route_name === 'jaraba_success_cases.detail') {
      $variables['attributes']['class'][] = 'page-success-case-detail';
    }
  }
}

/**
 * Implements hook_form_alter().
 *
 * Hides format guidelines in Success Case forms (especially useful
 * when editing inside a slide-panel modal).
 */
function jaraba_success_cases_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  if (str_contains($form_id, 'success_case')) {
    _jaraba_success_cases_hide_format_guidelines($form);
  }
}

/**
 * Recursively hides text format guidelines from form elements.
 *
 * @param array &$element
 *   The form element to process.
 */
function _jaraba_success_cases_hide_format_guidelines(array &$element): void {
  if (isset($element['format'])) {
    $element['format']['#access'] = FALSE;
  }
  foreach (array_keys($element) as $key) {
    if (is_array($element[$key]) && !str_starts_with((string) $key, '#')) {
      _jaraba_success_cases_hide_format_guidelines($element[$key]);
    }
  }
}

/**
 * Implements hook_page_attachments_alter().
 *
 * Injects Open Graph and Twitter Card meta tags for success case detail pages.
 */
function jaraba_success_cases_page_attachments_alter(array &$attachments): void {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name !== 'jaraba_success_cases.detail') {
    return;
  }

  $slug = \Drupal::routeMatch()->getParameter('slug');
  if (!$slug) {
    return;
  }

  try {
    $storage = \Drupal::entityTypeManager()->getStorage('success_case');
    $ids = $storage->getQuery()
      ->accessCheck(TRUE)
      ->condition('slug', $slug)
      ->condition('status', 1)
      ->range(0, 1)
      ->execute();

    if (empty($ids)) {
      return;
    }

    $case = $storage->load(reset($ids));
    if (!$case) {
      return;
    }

    $title = $case->get('name')->value . ' — ' . t('Caso de Éxito');
    $description = $case->get('meta_description')->value
      ?: $case->get('quote_short')->value
      ?: t('Descubre cómo @name transformó su negocio con el ecosistema Jaraba.', ['@name' => $case->get('name')->value]);
    $url = \Drupal::request()->getSchemeAndHttpHost() . '/caso-de-exito/' . $slug;

    // Resolve image URL if available.
    $imageUrl = '';
    if ($case->hasField('hero_image') && !$case->get('hero_image')->isEmpty()) {
      $file = $case->get('hero_image')->entity;
      if ($file) {
        $imageUrl = \Drupal::service('file_url_generator')->generateAbsoluteString($file->getFileUri());
      }
    }

    $meta = [
      ['property' => 'og:type', 'content' => 'article'],
      ['property' => 'og:title', 'content' => $title],
      ['property' => 'og:description', 'content' => $description],
      ['property' => 'og:url', 'content' => $url],
      ['name' => 'twitter:card', 'content' => $imageUrl ? 'summary_large_image' : 'summary'],
      ['name' => 'twitter:title', 'content' => $title],
      ['name' => 'twitter:description', 'content' => $description],
    ];

    if ($imageUrl) {
      $meta[] = ['property' => 'og:image', 'content' => $imageUrl];
      $meta[] = ['name' => 'twitter:image', 'content' => $imageUrl];
    }

    foreach ($meta as $i => $attrs) {
      $tag = [
        '#tag' => 'meta',
        '#attributes' => $attrs,
      ];
      $attachments['#attached']['html_head'][] = [$tag, 'sc_meta_' . $i];
    }
  }
  catch (\Exception) {
    // Never break page rendering for meta tags.
  }
}

/**
 * Implements template_preprocess_success_case().
 *
 * ENTITY-PREPROCESS-001: Preprocess para la entidad SuccessCase cuando se
 * renderiza en modo vista estándar (entity view / Views). Extrae primitivos,
 * decodifica métricas JSON y proporciona URLs de redes sociales.
 *
 * HAL-DEMO-V3-BACK-007: Añadido para cumplir ENTITY-PREPROCESS-001.
 */
function template_preprocess_success_case(array &$variables): void {
  /** @var \Drupal\jaraba_success_cases\Entity\SuccessCase|null $entity */
  $entity = $variables['elements']['#success_case'] ?? NULL;
  if (!$entity) {
    return;
  }

  $variables['success_case'] = $entity;

  // Primitivos directos.
  $variables['name'] = $entity->get('name')->value;
  $variables['slug'] = $entity->get('slug')->value;
  $variables['profession'] = $entity->get('profession')->value;
  $variables['company'] = $entity->get('company')->value;
  $variables['sector'] = $entity->get('sector')->value;
  $variables['location'] = $entity->get('location')->value;
  $variables['website'] = $entity->get('website')->value;
  $variables['linkedin'] = $entity->get('linkedin')->value;
  $variables['vertical'] = $entity->get('vertical')->value;
  $variables['rating'] = (int) $entity->get('rating')->value;
  $variables['featured'] = (bool) $entity->get('featured')->value;
  $variables['quote_short'] = $entity->get('quote_short')->value;
  $variables['quote_long'] = $entity->get('quote_long')->value;
  $variables['program_name'] = $entity->get('program_name')->value;
  $variables['program_funder'] = $entity->get('program_funder')->value;
  $variables['program_year'] = $entity->get('program_year')->value;
  $variables['meta_description'] = $entity->get('meta_description')->value;

  // Narrativa (texto formateado).
  $variables['challenge_before'] = $entity->get('challenge_before')->value;
  $variables['solution_during'] = $entity->get('solution_during')->value;
  $variables['result_after'] = $entity->get('result_after')->value;

  // Métricas JSON decodificadas.
  $metrics_raw = $entity->get('metrics_json')->value;
  $variables['metrics'] = [];
  if ($metrics_raw) {
    $decoded = json_decode($metrics_raw, TRUE);
    if (is_array($decoded)) {
      $variables['metrics'] = $decoded;
    }
  }

  // URL pública del caso.
  $variables['case_url'] = '/caso-de-exito/' . ($variables['slug'] ?? '');

  // Owner (autor).
  $owner = $entity->getOwner();
  if ($owner) {
    $variables['author_name'] = $owner->getDisplayName();
  }
}
