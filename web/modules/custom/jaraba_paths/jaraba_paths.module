<?php

/**
 * @file
 * Hooks for the jaraba_paths module.
 */

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_insert().
 *
 * Auto-enrollment cuando se completa un diagnóstico.
 */
function jaraba_paths_entity_insert(EntityInterface $entity): void {
  // Placeholder para futura implementación
}

/**
 * Implements hook_entity_update().
 */
function jaraba_paths_entity_update(EntityInterface $entity): void {
  // Detectar diagnóstico completado -> auto-enrollment
  if ($entity->getEntityTypeId() === 'business_diagnostic') {
    $original = $entity->original ?? NULL;

    // Si transición a completado
    if ($original &&
        $original->get('status')->value !== 'completed' &&
        $entity->get('status')->value === 'completed') {
      jaraba_paths_on_diagnostic_completed($entity);
    }
  }
}

/**
 * Auto-enrollment post diagnóstico.
 */
function jaraba_paths_on_diagnostic_completed(EntityInterface $diagnostic): void {
  if (!\Drupal::hasService('jaraba_paths.recommendation')) {
    return;
  }

  try {
    /** @var \Drupal\jaraba_paths\Service\PathRecommendationService $recommendationService */
    $recommendationService = \Drupal::service('jaraba_paths.recommendation');
    $bestMatch = $recommendationService->getBestMatch((int) $diagnostic->id());

    if ($bestMatch && isset($bestMatch['path_id'])) {
      // Guardar referencia en el diagnóstico
      $diagnostic->set('recommended_path_id', $bestMatch['path_id']);
      // No guardar aquí para evitar loop, se guarda fuera

      \Drupal::logger('jaraba_paths')->info('Path @path recommended for diagnostic @diagnostic', [
        '@path' => $bestMatch['path_id'],
        '@diagnostic' => $diagnostic->id(),
      ]);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_paths')->error('Path recommendation error: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_theme().
 */
function jaraba_paths_theme(): array {
  return [
    'path_catalog' => [
      'variables' => [
        'paths' => [],
        'featured_paths' => [],
        'sectors' => [],
        'difficulties' => [],
        'total_count' => 0,
      ],
      'template' => 'path-catalog',
    ],
    'path_detail' => [
      'variables' => [
        'path' => NULL,
        'title' => '',
        'description' => '',
        'sector' => '',
        'difficulty' => '',
        'duration_weeks' => 0,
        'phases' => [],
        'phases_count' => 0,
        'outcomes' => [],
        'enrollment' => NULL,
        'is_enrolled' => FALSE,
        'enrollment_progress' => 0,
        'image_url' => NULL,
      ],
      'template' => 'path-detail',
    ],
    'path_progress' => [
      'variables' => [
        'enrollments' => [],
        'active_enrollment' => NULL,
        'stats' => [],
        'requires_login' => FALSE,
      ],
      'template' => 'path-progress',
    ],
  ];
}
