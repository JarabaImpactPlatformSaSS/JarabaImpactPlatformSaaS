<?php

/**
 * @file
 * Jaraba CRM - Sistema de Gestión de Relaciones Comerciales.
 *
 * Este módulo proporciona:
 * - Gestión de Empresas (Company)
 * - Gestión de Contactos con engagement scoring
 * - Pipeline visual de Oportunidades (Kanban)
 * - Registro de Actividades (Timeline)
 * - Integración con jaraba_email y jaraba_pixels
 */

declare(strict_types=1);

// Cargar callbacks de allowed_values (Directriz #20).
require_once __DIR__ . '/jaraba_crm.allowed_values.inc';

/**
 * Implements hook_preprocess_HOOK() for html.html.twig.
 *
 * Agrega clases al body para las páginas frontend del CRM.
 */
function jaraba_crm_preprocess_html(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();

  if (!$route_name) {
    return;
  }

  $route_classes = [
    'jaraba_crm.dashboard' => ['page--crm', 'page--crm-dashboard'],
    'jaraba_crm.pipeline' => ['page--crm', 'page--crm-pipeline'],
    'jaraba_crm.kanban' => ['page--crm', 'page--crm-kanban'],
  ];

  if (isset($route_classes[$route_name])) {
    foreach ($route_classes[$route_name] as $class) {
      $variables['attributes']['class'][] = $class;
    }
  }
}

/**
 * Implements hook_theme().
 */
function jaraba_crm_theme(): array {
  return [
    'crm_dashboard' => [
      'variables' => [
        'companies_count' => 0,
        'contacts_count' => 0,
        'opportunities_count' => 0,
        'pipeline_value' => 0,
        'recent_activities' => [],
      ],
      'template' => 'crm-dashboard',
    ],
    'crm_pipeline' => [
      'variables' => [
        'stages' => [],
        'opportunities' => [],
      ],
      'template' => 'crm-pipeline',
    ],
    'crm_contact_360' => [
      'variables' => [
        'contact' => NULL,
        'company' => NULL,
        'activities' => [],
        'opportunities' => [],
      ],
      'template' => 'crm-contact-360',
    ],
  ];
}
