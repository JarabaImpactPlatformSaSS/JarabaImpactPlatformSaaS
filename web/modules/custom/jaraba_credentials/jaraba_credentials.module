<?php

declare(strict_types=1);

/**
 * @file
 * Módulo Jaraba Credentials.
 *
 * Automatización de emisión de credenciales OB3 firmadas criptográficamente.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\jaraba_lms\Entity\EnrollmentInterface;

/**
 * Implements hook_entity_update().
 *
 * Detecta cuando un alumno completa un curso en el LMS y dispara
 * la emisión automática de la credencial si existe un template asociado.
 *
 * @see docs/tareas/2026-02-05_bloque_e_training_pendientes.md
 */
function jaraba_credentials_entity_update(EntityInterface $entity): void {
  // Solo nos interesan los enrollments del LMS.
  if ($entity->getEntityTypeId() !== 'lms_enrollment') {
    return;
  }

  /** @var \Drupal\jaraba_lms\Entity\EnrollmentInterface $entity */
  $original = $entity->original;

  // Condiciones de disparo:
  // 1. El progreso ha llegado al 100% en esta actualización.
  // 2. O el estado ha cambiado a 'completed'.
  // 3. Y no se ha emitido ya una credencial para este enrollment.
  $is_completed = $entity->getStatus() === 'completed';
  $was_completed = $original && $original->getStatus() === 'completed';
  $progress_reached_100 = $entity->getProgressPercent() >= 100 && (!$original || $original->getProgressPercent() < 100);

  if (($is_completed && !$was_completed) || $progress_reached_100) {
    if (!$entity->isCertificateIssued()) {
      // Intentar emitir credencial automáticamente.
      _jaraba_credentials_trigger_auto_issue($entity);
    }
  }
}

/**
 * Lógica interna para disparar la emisión automática.
 */
function _jaraba_credentials_trigger_auto_issue(EnrollmentInterface $enrollment): void {
  try {
    $course_id = $enrollment->getCourseId();
    $user_id = $enrollment->getUserId();

    /** @var \Drupal\jaraba_credentials\Service\CredentialIssuer $issuer */
    $issuer = \Drupal::service('jaraba_credentials.issuer');

    // 1. Buscar si hay un programa de certificación vinculado a este curso.
    // En jaraba_training, los CertificationProgram tienen una lista de cursos.
    $program_id = _jaraba_credentials_find_program_for_course($course_id);
    if (!$program_id) {
      return;
    }

    // 2. Buscar si hay un template de credencial para este programa.
    $template = $issuer->findTemplateForProgram($program_id);
    if (!$template) {
      \Drupal::logger('jaraba_credentials')->notice(
        'Intento de emisión automática fallido: No se encontró template para el programa @id.',
        ['@id' => $program_id]
      );
      return;
    }

    // 3. Emitir.
    $context = [
      'enrollment_id' => $enrollment->id(),
      'course_id' => $course_id,
      'certification_id' => $program_id,
    ];
    
    $credential = $issuer->issueCredential($template, $user_id, $context);

    // 4. Marcar enrollment como certificado.
    $enrollment->setCertificateIssued(TRUE, (int) $credential->id());
    $enrollment->save();

    \Drupal::logger('jaraba_credentials')->info(
      'Credencial @cid emitida automáticamente para usuario @uid tras completar curso @course.',
      [
        '@cid' => $credential->id(),
        '@uid' => $user_id,
        '@course' => $course_id,
      ]
    );
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials')->error(
      'Error en emisión automática de credencial: @error',
      ['@error' => $e->getMessage()]
    );
  }
}

/**
 * Helper para encontrar el programa de certificación de un curso.
 */
function _jaraba_credentials_find_program_for_course(int $course_id): ?int {
  $storage = \Drupal::entityTypeManager()->getStorage('certification_program');
  $ids = $storage->getQuery()
    ->accessCheck(FALSE)
    ->condition('status', TRUE)
    ->condition('course_ids', $course_id, 'CONTAINS')
    ->range(0, 1)
    ->execute();

  return !empty($ids) ? (int) reset($ids) : NULL;
}
