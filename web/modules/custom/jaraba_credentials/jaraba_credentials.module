<?php

/**
 * @file
 * M√≥dulo principal de Jaraba Credentials.
 *
 * Sistema de credenciales digitales basado en Open Badge 3.0.
 * Implementa verificaci√≥n criptogr√°fica Ed25519 y emisi√≥n autom√°tica.
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function jaraba_credentials_theme(): array {
  return [
    'credential_verify' => [
      'variables' => [
        'credential' => NULL,
        'issuer' => NULL,
        'template' => NULL,
        'is_valid' => FALSE,
        'verification_message' => '',
        'qr_code' => '',
      ],
      'template' => 'credential-verify',
    ],
    'credential_card' => [
      'variables' => [
        'credential' => NULL,
        'template' => NULL,
        'show_actions' => TRUE,
      ],
      'template' => 'credential-card',
    ],
    'credentials_dashboard' => [
      'variables' => [
        'credentials' => [],
        'user' => NULL,
        'total_count' => 0,
      ],
      'template' => 'credentials-dashboard',
    ],
  ];
}

/**
 * Implements hook_entity_insert().
 *
 * ECA-TRAIN-003: Emisi√≥n autom√°tica de badge al crear certificaci√≥n.
 * ECA-CRED-001: Generaci√≥n autom√°tica de PDF al crear credencial.
 * GAP-3: Emisi√≥n autom√°tica al aprobar examen interactivo.
 */
function jaraba_credentials_entity_insert(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() === 'user_certification') {
    _jaraba_credentials_auto_emit_badge($entity);
  }
  
  // Generar PDF autom√°ticamente cuando se crea una credencial.
  if ($entity->getEntityTypeId() === 'issued_credential') {
    _jaraba_credentials_generate_pdf($entity);
  }

  // GAP-3: Emitir credencial al aprobar examen interactivo.
  if ($entity->getEntityTypeId() === 'interactive_result') {
    _jaraba_credentials_process_interactive_result($entity);
  }
}

/**
 * Procesa resultado de contenido interactivo para emisi√≥n de credencial.
 *
 * GAP-3: Cuando un usuario aprueba un examen/quiz vinculado a un
 * CredentialTemplate, se emite autom√°ticamente una IssuedCredential.
 *
 * @param \Drupal\Core\Entity\EntityInterface $result
 *   La entidad InteractiveResult reci√©n creada.
 */
function _jaraba_credentials_process_interactive_result(EntityInterface $result): void {
  // Verificar si el resultado es aprobado.
  $passed = (bool) ($result->get('passed')->value ?? FALSE);
  if (!$passed) {
    return;
  }

  try {
    /** @var \Drupal\jaraba_credentials\Service\LmsCredentialsIntegration $integration */
    $integration = \Drupal::service('jaraba_credentials.lms_integration');
    $credential = $integration->issueForInteractiveResult($result);

    if ($credential) {
      \Drupal::logger('jaraba_credentials')->info(
        'üéì Credential auto-issued from exam: @uuid for user @user',
        [
          '@uuid' => $credential->uuid(),
          '@user' => $result->get('uid')->target_id ?? 'unknown',
        ]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials')->error(
      'üö´ Error in interactive result credential issuance: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

/**
 * Genera PDF para una credencial reci√©n creada.
 *
 * @param \Drupal\Core\Entity\EntityInterface $credential
 *   La entidad IssuedCredential reci√©n creada.
 */
function _jaraba_credentials_generate_pdf(EntityInterface $credential): void {
  // Solo generar si no tiene PDF adjunto.
  if (!$credential->get('pdf_file')->isEmpty()) {
    return;
  }

  try {
    /** @var \Drupal\jaraba_credentials\Service\CredentialPdfService $pdfService */
    $pdfService = \Drupal::service('jaraba_credentials.pdf_generator');
    
    // Generar PDF.
    $pdfUri = $pdfService->generatePdf($credential);
    
    if ($pdfUri) {
      // Crear entidad de archivo para el PDF.
      /** @var \Drupal\file\FileStorageInterface $fileStorage */
      $fileStorage = \Drupal::entityTypeManager()->getStorage('file');
      
      $file = $fileStorage->create([
        'uri' => $pdfUri,
        'uid' => $credential->getOwnerId() ?? 1,
        'status' => 1,
        'filename' => basename($pdfUri),
      ]);
      $file->save();
      
      // Adjuntar el archivo a la credencial.
      $credential->set('pdf_file', $file->id());
      
      // Guardar sin disparar hooks de nuevo (evita recursi√≥n).
      $credential->original = $credential;
      $credential->save();
      
      \Drupal::logger('jaraba_credentials')->info(
        '‚úÖ PDF generado para credencial @uuid',
        ['@uuid' => $credential->uuid()]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials')->error(
      'üö´ Error generando PDF: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

/**
 * Emite autom√°ticamente un badge cuando se crea una certificaci√≥n.
 *
 * @param \Drupal\Core\Entity\EntityInterface $certification
 *   La entidad UserCertification reci√©n creada.
 */
function _jaraba_credentials_auto_emit_badge(EntityInterface $certification): void {
  // Solo emitir si el estado es 'active'
  $status = $certification->get('certification_status')->value ?? '';
  if ($status !== 'active') {
    return;
  }

  try {
    /** @var \Drupal\jaraba_credentials\Service\CredentialIssuer $issuer */
    $issuer = \Drupal::service('jaraba_credentials.issuer');
    
    // Buscar template asociado al programa de certificaci√≥n
    $programId = $certification->get('program_id')->target_id ?? NULL;
    if (!$programId) {
      return;
    }

    $template = $issuer->findTemplateForProgram($programId);
    if (!$template) {
      \Drupal::logger('jaraba_credentials')->warning(
        'No credential template found for program @program',
        ['@program' => $programId]
      );
      return;
    }

    // Emitir credencial
    $userId = $certification->get('user_id')->target_id ?? NULL;
    if ($userId) {
      $issuer->issueCredential($template, $userId, [
        'certification_id' => $certification->id(),
        'exam_score' => $certification->get('exam_score')->value ?? NULL,
      ]);
      
      \Drupal::logger('jaraba_credentials')->info(
        'Auto-emitted badge for user @user from certification @cert',
        ['@user' => $userId, '@cert' => $certification->id()]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials')->error(
      'Failed to auto-emit badge: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_ENTITY_TYPE_update() for lms_enrollment.
 *
 * ECA-TRAIN-003: Emisi√≥n autom√°tica de credencial al completar curso LMS.
 * 
 * Este hook se dispara cuando un enrollment cambia de estado. Si pasa
 * a 'completed', se busca un CredentialTemplate asociado y se emite
 * autom√°ticamente una IssuedCredential firmada Ed25519.
 *
 * @see Drupal\jaraba_credentials\Service\LmsCredentialsIntegration
 */
function jaraba_credentials_lms_enrollment_update(EntityInterface $entity): void {
  // Solo procesar si el m√≥dulo jaraba_lms est√° instalado
  if (!interface_exists('Drupal\jaraba_lms\Entity\EnrollmentInterface')) {
    return;
  }

  // Verificar que es un lms_enrollment
  if ($entity->getEntityTypeId() !== 'lms_enrollment') {
    return;
  }

  // Obtener estado anterior y actual
  /** @var \Drupal\Core\Entity\ContentEntityInterface $original */
  $original = $entity->original ?? NULL;
  $currentStatus = $entity->get('status')->value ?? '';
  $previousStatus = $original ? ($original->get('status')->value ?? '') : '';

  // Solo actuar si acaba de pasar a 'completed'
  if ($currentStatus !== 'completed' || $previousStatus === 'completed') {
    return;
  }

  \Drupal::logger('jaraba_credentials')->info(
    'LMS enrollment @id completed, checking for auto-credential issuance',
    ['@id' => $entity->id()]
  );

  try {
    /** @var \Drupal\jaraba_credentials\Service\LmsCredentialsIntegration $integration */
    $integration = \Drupal::service('jaraba_credentials.lms_integration');
    $integration->issueForCourseCompletion($entity);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials')->error(
      'Error in LMS credential integration: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_cron().
 *
 * ECA-TRAIN-001/002: Tareas programadas de credenciales.
 * - Enviar recordatorios de expiraci√≥n
 * - Procesar cola de notificaciones
 */
function jaraba_credentials_cron(): void {
  _jaraba_credentials_process_expiration_reminders();
  _jaraba_credentials_process_notification_queue();
}

/**
 * Procesa recordatorios de expiraci√≥n de credenciales.
 *
 * Env√≠a notificaciones a usuarios cuyas credenciales expiran en 30 d√≠as.
 */
function _jaraba_credentials_process_expiration_reminders(): void {
  $threshold = strtotime('+30 days');
  $now = \Drupal::time()->getRequestTime();

  $storage = \Drupal::entityTypeManager()->getStorage('issued_credential');
  $query = $storage->getQuery()
    ->accessCheck(FALSE)
    ->condition('status', 'issued')
    ->condition('expires_on', $now, '>')
    ->condition('expires_on', $threshold, '<')
    ->range(0, 50);

  $ids = $query->execute();
  if (empty($ids)) {
    return;
  }

  $queue = \Drupal::queue('jaraba_credentials_notifications');
  foreach ($ids as $id) {
    $credential = $storage->load($id);
    if (!$credential) {
      continue;
    }

    // Verificar que no se ha enviado ya recordatorio
    $metadata = json_decode($credential->get('metadata')->value ?? '{}', TRUE);
    if (!empty($metadata['expiration_reminder_sent'])) {
      continue;
    }

    $queue->createItem([
      'type' => 'expiration_reminder',
      'credential_id' => $id,
      'user_id' => $credential->get('recipient_id')->target_id,
    ]);
  }
}

/**
 * Procesa la cola de notificaciones de credenciales.
 */
function _jaraba_credentials_process_notification_queue(): void {
  $queue = \Drupal::queue('jaraba_credentials_notifications');
  $processed = 0;
  $maxItems = 10;

  while ($processed < $maxItems && ($item = $queue->claimItem())) {
    try {
      $data = $item->data;
      // TODO: Implementar env√≠o de emails cuando jaraba_email est√© disponible
      \Drupal::logger('jaraba_credentials')->debug(
        'Processing notification: @type for user @user',
        ['@type' => $data['type'], '@user' => $data['user_id'] ?? 'unknown']
      );
      $queue->deleteItem($item);
      $processed++;
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_credentials')->error(
        'Failed to process notification: @message',
        ['@message' => $e->getMessage()]
      );
      $queue->releaseItem($item);
    }
  }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * A√±ade template page--verify para la p√°gina p√∫blica de verificaci√≥n.
 * Usa layout premium con part√≠culas animadas y dise√±o full-width.
 *
 * @see page--verify.html.twig
 */
function jaraba_credentials_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_match = \Drupal::routeMatch();
  $route_name = $route_match->getRouteName();

  // P√°gina p√∫blica de verificaci√≥n de credenciales.
  if ($route_name === 'jaraba_credentials.verify') {
    $suggestions[] = 'page__verify';
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * A√±ade clases al body para la p√°gina de verificaci√≥n.
 * NOTA: Las clases al body DEBEN a√±adirse via hook_preprocess_html(),
 * no con attributes.addClass() en templates (problema D11).
 */
function jaraba_credentials_preprocess_html(array &$variables): void {
  $route_match = \Drupal::routeMatch();
  $route_name = $route_match->getRouteName();

  // P√°gina de verificaci√≥n de credenciales.
  if ($route_name === 'jaraba_credentials.verify') {
    $variables['attributes']['class'][] = 'page-verify';
    $variables['attributes']['class'][] = 'credential-verify-page';
  }

  // Dashboard de certificaciones del usuario.
  if ($route_name === 'jaraba_credentials.my_credentials') {
    $variables['attributes']['class'][] = 'certifications-page';
    $variables['attributes']['class'][] = 'page-my-certifications';
  }
}

