<?php

/**
 * @file
 * Módulo de credenciales para la vertical de Emprendimiento Digital.
 *
 * Implementa badges y diplomas para diagnóstico empresarial, madurez digital,
 * Business Canvas, MVP, mentoring y más, integrado con gamificación.
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function jaraba_credentials_emprendimiento_theme(): array {
  return [
    'emprendimiento_journey_map' => [
      'variables' => [
        'phases' => [],
        'user_progress' => [],
        'next_recommended' => NULL,
        'expertise_level' => '',
      ],
      'template' => 'emprendimiento-journey-map',
    ],
  ];
}

/**
 * Implements hook_entity_insert().
 *
 * Hook nativo ECA: Auto-emisión de badges al completar hitos de emprendimiento.
 */
function jaraba_credentials_emprendimiento_entity_insert(EntityInterface $entity): void {
  $entityType = $entity->getEntityTypeId();

  // Badge por diagnóstico empresarial completado.
  if ($entityType === 'business_diagnostic') {
    _jaraba_credentials_emprendimiento_process_diagnostic($entity);
  }

  // Badge por Business Canvas creado/validado.
  if ($entityType === 'business_canvas') {
    _jaraba_credentials_emprendimiento_process_canvas($entity);
  }

  // Badge por primera sesión de mentoría.
  if ($entityType === 'mentoring_session') {
    _jaraba_credentials_emprendimiento_process_mentoring($entity);
  }
}

/**
 * Implements hook_entity_update().
 *
 * Hook nativo ECA: Procesa cambios de estado en entidades de emprendimiento.
 */
function jaraba_credentials_emprendimiento_entity_update(EntityInterface $entity): void {
  $entityType = $entity->getEntityTypeId();

  // Badge por MVP lanzado/validado.
  if ($entityType === 'mvp_tracker') {
    $newStatus = $entity->get('status')->value ?? '';
    $oldStatus = $entity->original->get('status')->value ?? '';
    if ($newStatus !== $oldStatus) {
      _jaraba_credentials_emprendimiento_process_mvp($entity, $oldStatus, $newStatus);
    }
  }

  // Badge por madurez digital mejorada.
  if ($entityType === 'business_diagnostic') {
    _jaraba_credentials_emprendimiento_check_maturity($entity);
  }
}

/**
 * Procesa diagnóstico empresarial para emisión de badge.
 */
function _jaraba_credentials_emprendimiento_process_diagnostic(EntityInterface $diagnostic): void {
  $status = $diagnostic->get('status')->value ?? '';
  if ($status !== 'completed') {
    return;
  }

  try {
    /** @var \Drupal\jaraba_credentials_emprendimiento\Service\EmprendimientoCredentialService $service */
    $service = \Drupal::service('jaraba_credentials_emprendimiento.credential');
    $uid = (int) ($diagnostic->get('uid')->target_id ?? $diagnostic->getOwnerId());
    $service->issueBadgeForDiagnostic($uid, $diagnostic);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials_emprendimiento')->error(
      'Error emitiendo badge por diagnóstico: @msg',
      ['@msg' => $e->getMessage()]
    );
  }
}

/**
 * Procesa Business Canvas para emisión de badge.
 */
function _jaraba_credentials_emprendimiento_process_canvas(EntityInterface $canvas): void {
  try {
    /** @var \Drupal\jaraba_credentials_emprendimiento\Service\EmprendimientoCredentialService $service */
    $service = \Drupal::service('jaraba_credentials_emprendimiento.credential');
    $uid = (int) ($canvas->get('uid')->target_id ?? $canvas->getOwnerId());
    $service->issueBadgeForCanvas($uid, $canvas);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials_emprendimiento')->error(
      'Error emitiendo badge por canvas: @msg',
      ['@msg' => $e->getMessage()]
    );
  }
}

/**
 * Procesa sesión de mentoría para emisión de badge.
 */
function _jaraba_credentials_emprendimiento_process_mentoring(EntityInterface $session): void {
  $status = $session->get('status')->value ?? '';
  if ($status !== 'completed') {
    return;
  }

  try {
    /** @var \Drupal\jaraba_credentials_emprendimiento\Service\EmprendimientoCredentialService $service */
    $service = \Drupal::service('jaraba_credentials_emprendimiento.credential');
    $uid = (int) ($session->get('mentee_id')->target_id ?? 0);
    if ($uid) {
      $service->issueBadgeForMentoring($uid, $session);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials_emprendimiento')->error(
      'Error emitiendo badge por mentoría: @msg',
      ['@msg' => $e->getMessage()]
    );
  }
}

/**
 * Procesa cambios de MVP para emisión de badge.
 */
function _jaraba_credentials_emprendimiento_process_mvp(EntityInterface $mvp, string $oldStatus, string $newStatus): void {
  try {
    /** @var \Drupal\jaraba_credentials_emprendimiento\Service\EmprendimientoCredentialService $service */
    $service = \Drupal::service('jaraba_credentials_emprendimiento.credential');
    $uid = (int) ($mvp->get('uid')->target_id ?? $mvp->getOwnerId());

    if ($newStatus === 'launched') {
      $service->issueBadgeForMvp($uid, $mvp);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials_emprendimiento')->error(
      'Error emitiendo badge por MVP: @msg',
      ['@msg' => $e->getMessage()]
    );
  }
}

/**
 * Verifica madurez digital para emisión de badges de nivel.
 */
function _jaraba_credentials_emprendimiento_check_maturity(EntityInterface $diagnostic): void {
  $score = (int) ($diagnostic->get('maturity_score')->value ?? 0);
  if ($score <= 0) {
    return;
  }

  try {
    /** @var \Drupal\jaraba_credentials_emprendimiento\Service\EmprendimientoCredentialService $service */
    $service = \Drupal::service('jaraba_credentials_emprendimiento.credential');
    $uid = (int) ($diagnostic->get('uid')->target_id ?? $diagnostic->getOwnerId());
    $service->issueMaturityBadges($uid, $score);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials_emprendimiento')->error(
      'Error emitiendo badges de madurez: @msg',
      ['@msg' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_preprocess_html().
 */
function jaraba_credentials_emprendimiento_preprocess_html(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'jaraba_credentials_emprendimiento.journey') {
    $variables['attributes']['class'][] = 'page-emprendimiento-journey';
  }
}
