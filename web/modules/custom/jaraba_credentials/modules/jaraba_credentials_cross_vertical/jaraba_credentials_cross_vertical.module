<?php

/**
 * @file
 * Módulo de credenciales cross-vertical.
 *
 * Reconoce logros que abarcan múltiples verticales de la plataforma
 * (empleabilidad, emprendimiento, formación, etc.).
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function jaraba_credentials_cross_vertical_theme(): array {
  return [
    'cross_vertical_showcase' => [
      'variables' => [
        'rules' => [],
        'user_progress' => [],
        'earned_badges' => [],
      ],
      'template' => 'cross-vertical-showcase',
    ],
  ];
}

/**
 * Implements hook_entity_insert().
 *
 * Hook nativo ECA: Evalúa reglas cross-vertical al emitir credencial.
 */
function jaraba_credentials_cross_vertical_entity_insert(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'issued_credential') {
    return;
  }

  $recipientId = $entity->get('recipient_id')->target_id ?? NULL;
  if (!$recipientId) {
    return;
  }

  // Evitar recursión si esta credencial es cross-vertical.
  $evidence = $entity->get('evidence')->value ?? '';
  if ($evidence && str_contains($evidence, '"cross_vertical_rule_id"')) {
    return;
  }

  try {
    /** @var \Drupal\jaraba_credentials_cross_vertical\Service\CrossVerticalEvaluator $evaluator */
    $evaluator = \Drupal::service('jaraba_credentials_cross_vertical.evaluator');
    $evaluator->evaluateForUser((int) $recipientId);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials_cross_vertical')->error(
      'Error evaluando reglas cross-vertical: @msg',
      ['@msg' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_cron().
 *
 * Hook nativo ECA: Evaluación diaria de reglas cross-vertical basadas en milestones.
 */
function jaraba_credentials_cross_vertical_cron(): void {
  _jaraba_credentials_cross_vertical_daily_eval();
}

/**
 * Evaluación diaria de reglas cross-vertical.
 */
function _jaraba_credentials_cross_vertical_daily_eval(): void {
  $lastRun = \Drupal::state()->get('jaraba_credentials_cross_vertical.last_daily_eval', 0);
  $now = \Drupal::time()->getRequestTime();

  // Solo ejecutar una vez al día.
  if ($now - $lastRun < 86400) {
    return;
  }

  \Drupal::state()->set('jaraba_credentials_cross_vertical.last_daily_eval', $now);

  try {
    /** @var \Drupal\jaraba_credentials_cross_vertical\Service\CrossVerticalEvaluator $evaluator */
    $evaluator = \Drupal::service('jaraba_credentials_cross_vertical.evaluator');

    // Obtener usuarios con progreso activo.
    $progressIds = \Drupal::entityTypeManager()->getStorage('cross_vertical_progress')
      ->getQuery()
      ->accessCheck(FALSE)
      ->condition('status', 'tracking')
      ->range(0, 100)
      ->execute();

    if (empty($progressIds)) {
      return;
    }

    $progressEntities = \Drupal::entityTypeManager()->getStorage('cross_vertical_progress')->loadMultiple($progressIds);
    $processedUsers = [];

    foreach ($progressEntities as $progress) {
      $uid = (int) ($progress->get('user_id')->target_id ?? 0);
      if ($uid && !in_array($uid, $processedUsers, TRUE)) {
        $evaluator->evaluateForUser($uid);
        $processedUsers[] = $uid;
      }
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_credentials_cross_vertical')->error(
      'Error en evaluación diaria cross-vertical: @msg',
      ['@msg' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_preprocess_html().
 */
function jaraba_credentials_cross_vertical_preprocess_html(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'jaraba_credentials_cross_vertical.showcase') {
    $variables['attributes']['class'][] = 'page-cross-vertical-showcase';
  }
}
