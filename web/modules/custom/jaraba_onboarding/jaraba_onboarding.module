<?php

/**
 * @file
 * Modulo Jaraba Onboarding.
 *
 * Sistema de onboarding guiado para usuarios y tenants del
 * Ecosistema Jaraba SaaS. Proporciona templates configurables,
 * checklists, gamificacion y tours contextuales.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function jaraba_onboarding_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.jaraba_onboarding':
      $output = '<h3>' . t('Acerca de') . '</h3>';
      $output .= '<p>' . t('Sistema de onboarding guiado para el Ecosistema Jaraba.') . '</p>';
      $output .= '<h4>' . t('Caracteristicas') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('Templates de onboarding por vertical') . '</li>';
      $output .= '<li>' . t('Checklists interactivos de progreso') . '</li>';
      $output .= '<li>' . t('Gamificacion con logros y recompensas') . '</li>';
      $output .= '<li>' . t('Tours contextuales por ruta') . '</li>';
      $output .= '<li>' . t('Analytics de completacion y drop-off') . '</li>';
      $output .= '</ul>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function jaraba_onboarding_theme() {
  return [
    'jaraba_onboarding_dashboard' => [
      'variables' => [
        'user' => NULL,
        'progress' => NULL,
        'checklist' => [],
        'achievements' => [],
      ],
      'template' => 'jaraba-onboarding-dashboard',
    ],
    'jaraba_onboarding_checklist' => [
      'variables' => [
        'items' => [],
        'progress_percentage' => 0,
        'user_id' => NULL,
      ],
      'template' => 'jaraba-onboarding-checklist',
    ],
    'jaraba_onboarding_step_complete' => [
      'variables' => [
        'step_id' => NULL,
        'step_label' => '',
        'next_step' => NULL,
        'achievements_earned' => [],
      ],
      'template' => 'jaraba-onboarding-step-complete',
    ],
    // F5 â€” Wizard de 7 pasos (Doc 179).
    'onboarding_wizard' => [
      'variables' => [
        'step' => NULL,
        'step_number' => 1,
        'steps_config' => [],
        'progress' => NULL,
        'vertical' => '',
        'step_content' => [],
      ],
      'template' => 'onboarding-wizard',
    ],
    'onboarding_wizard_step_welcome' => [
      'variables' => [
        'vertical' => '',
        'vertical_label' => '',
        'vertical_color' => '',
        'step_data' => [],
      ],
      'template' => 'onboarding-wizard-step-welcome',
    ],
    'onboarding_wizard_step_identity' => [
      'variables' => [
        'vertical' => '',
        'colors' => [],
        'step_data' => [],
      ],
      'template' => 'onboarding-wizard-step-identity',
    ],
    'onboarding_wizard_step_fiscal' => [
      'variables' => [
        'vertical' => '',
        'step_data' => [],
      ],
      'template' => 'onboarding-wizard-step-fiscal',
    ],
    'onboarding_wizard_step_payments' => [
      'variables' => [
        'vertical' => '',
        'stripe_url' => '',
        'step_data' => [],
      ],
      'template' => 'onboarding-wizard-step-payments',
    ],
    'onboarding_wizard_step_team' => [
      'variables' => [
        'vertical' => '',
        'step_data' => [],
      ],
      'template' => 'onboarding-wizard-step-team',
    ],
    'onboarding_wizard_step_content' => [
      'variables' => [
        'vertical' => '',
        'content_type_label' => '',
        'step_data' => [],
      ],
      'template' => 'onboarding-wizard-step-content',
    ],
    'onboarding_wizard_step_launch' => [
      'variables' => [
        'vertical' => '',
        'tenant_name' => '',
        'preview_url' => '',
        'step_data' => [],
      ],
      'template' => 'onboarding-wizard-step-launch',
    ],
  ];
}

/**
 * Implements hook_preprocess_html().
 *
 * Adjunta la libreria de tours en rutas que tienen ayuda contextual.
 */
function jaraba_onboarding_preprocess_html(array &$variables) {
  $route_match = \Drupal::routeMatch();
  $route_name = $route_match->getRouteName();

  if (!$route_name) {
    return;
  }

  // Solo adjuntar en rutas del frontend (no admin).
  $route = $route_match->getRouteObject();
  if ($route && $route->getOption('_admin_route')) {
    return;
  }

  try {
    /** @var \Drupal\jaraba_onboarding\Service\OnboardingContextualHelpService $helpService */
    $helpService = \Drupal::service('jaraba_onboarding.contextual_help');
    $help = $helpService->getHelpForRoute($route_name);

    if (!empty($help)) {
      $variables['#attached']['library'][] = 'jaraba_onboarding/tours';
      $variables['#attached']['drupalSettings']['jarabaOnboarding'] = [
        'contextualHelp' => $help,
        'routeName' => $route_name,
      ];
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_onboarding')->error('Error cargando ayuda contextual para @route: @error', [
      '@route' => $route_name,
      '@error' => $e->getMessage(),
    ]);
  }
}
