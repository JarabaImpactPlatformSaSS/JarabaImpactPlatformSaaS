<?php

/**
 * @file
 * Módulo principal de ServiciosConecta.
 *
 * Estructura: Define hooks de tema, preproceso y automatizaciones para
 *   el vertical de servicios profesionales del Ecosistema Jaraba.
 *
 * Lógica: Los hooks implementan el patrón de automatización por código
 *   (no ECA BPMN) siguiendo la directriz del proyecto. Cada hook
 *   incluye verificación de tipo de entidad para evitar conflictos
 *   con otras entidades del ecosistema.
 *
 * Sintaxis: Todas las funciones siguen el patrón hook_name() de Drupal.
 */

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 *
 * Estructura: Registra todos los templates Twig del módulo.
 *   Cada template tiene sus variables documentadas con tipo y propósito.
 *
 * Lógica: Los templates se usan desde los controllers via render arrays
 *   con '#theme' => 'nombre_del_template'. Las variables se pasan
 *   como '#variable_name' => $valor en el render array.
 */
function jaraba_servicios_conecta_theme(): array {
  return [
    // Marketplace público de profesionales: grid, filtros, mapa
    'servicios_marketplace' => [
      'variables' => [
        'providers' => [],
        'categories' => [],
        'modalities' => [],
        'current_filters' => [],
        'total_results' => 0,
        'pager' => NULL,
      ],
      'template' => 'servicios-marketplace',
    ],
    // Página pública del perfil de un profesional
    'servicios_provider_detail' => [
      'variables' => [
        'provider' => NULL,
        'services' => [],
        'availability' => [],
        'reviews' => [],
        'review_summary' => NULL,
        'schema_json_ld' => '',
      ],
      'template' => 'servicios-provider-detail',
    ],
    // Dashboard del profesional con KPIs y acciones rápidas
    'servicios_provider_dashboard' => [
      'variables' => [
        'provider' => NULL,
        'kpis' => [],
        'upcoming_bookings' => [],
        'pending_bookings' => [],
        'recent_reviews' => [],
      ],
      'template' => 'servicios-provider-dashboard',
    ],
    // Listado de servicios ofertados por el profesional
    'servicios_provider_offerings' => [
      'variables' => [
        'provider' => NULL,
        'offerings' => [],
        'total' => 0,
        'current_filters' => [],
      ],
      'template' => 'servicios-provider-offerings',
    ],
    // Calendario de reservas del profesional
    'servicios_provider_calendar' => [
      'variables' => [
        'provider' => NULL,
        'bookings' => [],
        'availability_slots' => [],
        'current_week' => '',
      ],
      'template' => 'servicios-provider-calendar',
    ],
    // Listado de reservas del profesional
    'servicios_provider_bookings' => [
      'variables' => [
        'provider' => NULL,
        'bookings' => [],
        'pending_count' => 0,
        'confirmed_count' => 0,
        'completed_count' => 0,
        'cancelled_count' => 0,
        'current_tab' => 'all',
      ],
      'template' => 'servicios-provider-bookings',
    ],
    // Formulario de edicion de perfil profesional
    'servicios_provider_profile' => [
      'variables' => [
        'provider' => NULL,
        'form' => NULL,
        'completeness_score' => 0,
      ],
      'template' => 'servicios-provider-profile',
    ],
    // Formulario de reserva publica
    'servicios_booking_form' => [
      'variables' => [
        'offering' => NULL,
        'provider' => NULL,
        'available_dates' => [],
        'available_slots' => [],
        'form' => NULL,
      ],
      'template' => 'servicios-booking-form',
    ],
  ];
}

/**
 * Implements hook_preprocess_html().
 *
 * Estructura: Añade clases CSS al <body> según la ruta activa.
 *
 * Lógica: Detecta rutas de ServiciosConecta para añadir clases
 *   que permiten estilos específicos por página. Usa el patrón
 *   de mapeo ruta→clase. IMPORTANTE: Las clases en <body> SOLO
 *   funcionan desde hook_preprocess_html, NO desde templates.
 */
function jaraba_servicios_conecta_preprocess_html(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  // Mapeo de rutas a clases CSS en el body
  $route_classes = [
    'jaraba_servicios_conecta.marketplace' => 'page--servicios-marketplace',
    'jaraba_servicios_conecta.marketplace.provider' => 'page--servicios-provider-detail',
    'jaraba_servicios_conecta.provider_portal' => 'page--servicios-provider-dashboard',
    'jaraba_servicios_conecta.provider_portal.offerings' => 'page--servicios-provider-offerings',
    'jaraba_servicios_conecta.provider_portal.calendar' => 'page--servicios-provider-calendar',
    'jaraba_servicios_conecta.provider_portal.bookings' => 'page--servicios-provider-bookings',
    'jaraba_servicios_conecta.provider_portal.profile' => 'page--servicios-provider-profile',
  ];

  if (isset($route_classes[$route_name])) {
    $variables['attributes']['class'][] = $route_classes[$route_name];
    $variables['attributes']['class'][] = 'page--servicios';
  }
}

/**
 * Implements hook_preprocess_page().
 *
 * Inyecta variables zero-region para las paginas de ServiciosConecta.
 * Siguiendo el patron de los verticales de clase mundial, todas las
 * variables de contenido se pasan via preprocess, NO via controller.
 */
function jaraba_servicios_conecta_preprocess_page(array &$variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  // Solo actuar en rutas de ServiciosConecta.
  if (!str_starts_with($route_name, 'jaraba_servicios_conecta.')) {
    return;
  }

  // Variables zero-region comunes.
  $variables['vertical_key'] = 'serviciosconecta';
  $variables['site_name'] = \Drupal::config('system.site')->get('name');
  $variables['site_slogan'] = \Drupal::config('system.site')->get('slogan');
  $variables['logged_in'] = \Drupal::currentUser()->isAuthenticated();

  // Theme settings del tema activo.
  $active_theme = \Drupal::theme()->getActiveTheme()->getName();
  $theme_settings = \Drupal::config($active_theme . '.settings')->getRawData();
  $variables['theme_settings'] = $theme_settings;

  // Footer copyright.
  $variables['footer_copyright'] = $theme_settings['footer_copyright'] ?? '© ' . date('Y') . ' Jaraba Impact Platform';

  // Datos del profesional actual si autenticado.
  $variables['current_provider'] = NULL;
  $variables['provider_stats'] = [];

  if (\Drupal::currentUser()->isAuthenticated()) {
    try {
      $providerService = \Drupal::service('jaraba_servicios_conecta.provider');
      $provider = $providerService->getCurrentUserProvider();
      if ($provider) {
        $variables['current_provider'] = $provider;
        $variables['provider_stats'] = [
          'display_name' => $provider->get('display_name')->value ?? '',
          'average_rating' => (float) ($provider->get('average_rating')->value ?? 0),
          'total_reviews' => (int) ($provider->get('total_reviews')->value ?? 0),
          'verification_status' => $provider->get('verification_status')->value ?? 'pending',
        ];
      }
    }
    catch (\Exception $e) {
      // Provider service not available — continue without provider data.
    }
  }

  // Extraer clean_content del render array principal.
  if (isset($variables['page']['content'])) {
    $variables['clean_content'] = $variables['page']['content'];
  }

  // Mensajes del sistema.
  if (isset($variables['page']['highlighted'])) {
    $variables['clean_messages'] = $variables['page']['highlighted'];
  }
}

/**
 * Implements hook_theme_suggestions_page_alter().
 *
 * Sugiere templates de pagina especificos para rutas de ServiciosConecta.
 * Esto permite usar page--servicios-marketplace.html.twig y
 * page--servicios-dashboard.html.twig en el tema.
 */
function jaraba_servicios_conecta_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  // Rutas del marketplace publico → page--servicios-marketplace.
  $marketplace_routes = [
    'jaraba_servicios_conecta.marketplace',
    'jaraba_servicios_conecta.marketplace.provider',
    'jaraba_servicios_conecta.marketplace.booking',
  ];

  if (in_array($route_name, $marketplace_routes, TRUE)) {
    $suggestions[] = 'page__servicios_marketplace';
  }

  // Rutas del portal del profesional → page--servicios-dashboard.
  $dashboard_routes = [
    'jaraba_servicios_conecta.provider_portal',
    'jaraba_servicios_conecta.provider_portal.offerings',
    'jaraba_servicios_conecta.provider_portal.offering_add',
    'jaraba_servicios_conecta.provider_portal.bookings',
    'jaraba_servicios_conecta.provider_portal.calendar',
    'jaraba_servicios_conecta.provider_portal.profile',
  ];

  if (in_array($route_name, $dashboard_routes, TRUE)) {
    $suggestions[] = 'page__servicios_dashboard';
  }
}

/**
 * Implements hook_entity_insert().
 *
 * Estructura: Hook que se dispara al crear cualquier entidad.
 *   Filtra por tipo de entidad para actuar solo en entidades
 *   de ServiciosConecta.
 *
 * Lógica: Al crear un ProviderProfile, se genera automáticamente
 *   el slug URL-friendly a partir del display_name si no
 *   se proporcionó uno explícito.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   La entidad recién creada.
 */
function jaraba_servicios_conecta_entity_insert(EntityInterface $entity): void {
  // Auto-generar slug para nuevos perfiles de profesional
  if ($entity->getEntityTypeId() === 'provider_profile') {
    $slug = $entity->get('slug')->value;
    if (empty($slug)) {
      $display_name = $entity->get('display_name')->value;
      $slug = _jaraba_servicios_conecta_generate_slug($display_name);
      $entity->set('slug', $slug);
      $entity->save();
    }
  }
}

/**
 * Implements hook_entity_update().
 *
 * Estructura: Hook para detectar cambios de estado en entidades.
 *
 * Lógica: Detecta transiciones de estado en profesionales y reservas
 *   para disparar notificaciones o acciones automáticas.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   La entidad actualizada.
 */
function jaraba_servicios_conecta_entity_update(EntityInterface $entity): void {
  // Detectar cambio de estado en ProviderProfile (verificación)
  if ($entity->getEntityTypeId() === 'provider_profile') {
    $new_status = $entity->get('verification_status')->value;
    $old_status = $entity->original->get('verification_status')->value ?? '';
    if ($new_status !== $old_status && $new_status === 'approved') {
      \Drupal::logger('jaraba_servicios_conecta')->info(
        'Profesional @name aprobado (ID: @id)',
        ['@name' => $entity->get('display_name')->value, '@id' => $entity->id()]
      );
      // Enviar notificación de aprobación al profesional.
      try {
        $userId = $entity->getOwnerId();
        if ($userId) {
          $user = \Drupal::entityTypeManager()->getStorage('user')->load($userId);
          if ($user && $user->getEmail()) {
            \Drupal::service('plugin.manager.mail')->mail(
              'jaraba_servicios_conecta',
              'provider_approved',
              $user->getEmail(),
              $user->getPreferredLangcode(),
              [
                'provider_name' => $entity->get('display_name')->value,
              ]
            );
          }
        }
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_servicios_conecta')->error(
          'Failed to send approval notification: @error',
          ['@error' => $e->getMessage()]
        );
      }
    }
  }

  // Detectar cambio de estado en Booking (confirmación, cancelación).
  if ($entity->getEntityTypeId() === 'booking') {
    $new_status = $entity->get('status')->value;
    $old_status = $entity->original->get('status')->value ?? '';
    if ($new_status !== $old_status) {
      \Drupal::logger('jaraba_servicios_conecta')->info(
        'Reserva @id transición: @old → @new',
        [
          '@id' => $entity->id(),
          '@old' => $old_status,
          '@new' => $new_status,
        ]
      );

      // Enviar notificación por estado de reserva.
      try {
        $clientUid = $entity->getOwnerId();
        $providerId = $entity->get('provider_id')->target_id ?? NULL;
        if ($clientUid) {
          $client = \Drupal::entityTypeManager()->getStorage('user')->load($clientUid);
          if ($client && $client->getEmail()) {
            $mailKey = match ($new_status) {
              'confirmed' => 'booking_confirmed',
              'cancelled_client', 'cancelled_provider' => 'booking_cancelled',
              'completed' => 'booking_completed',
              default => NULL,
            };
            if ($mailKey) {
              \Drupal::service('plugin.manager.mail')->mail(
                'jaraba_servicios_conecta',
                $mailKey,
                $client->getEmail(),
                $client->getPreferredLangcode(),
                [
                  'client_name' => $client->getDisplayName(),
                  'booking_id' => $entity->id(),
                  'datetime' => $entity->get('booking_date')->value ?? '',
                ]
              );
            }
          }
        }
      }
      catch (\Exception $e) {
        \Drupal::logger('jaraba_servicios_conecta')->error(
          'Failed to send booking notification: @error',
          ['@error' => $e->getMessage()]
        );
      }

      // Si cancelada, liberar slot de disponibilidad.
      if (str_starts_with($new_status, 'cancelled_')) {
        try {
          $availability = \Drupal::service('jaraba_servicios_conecta.availability');
          $availability->releaseSlot(
            (int) ($entity->get('provider_id')->target_id ?? 0),
            $entity->get('booking_date')->value ?? '',
            (int) ($entity->get('duration_minutes')->value ?? 60)
          );
        }
        catch (\Exception $e) {
          \Drupal::logger('jaraba_servicios_conecta')->error(
            'Failed to release slot for cancelled booking @id: @error',
            ['@id' => $entity->id(), '@error' => $e->getMessage()]
          );
        }
      }
    }
  }
}

/**
 * Implements hook_cron().
 *
 * Estructura: Tareas programadas del módulo ServiciosConecta.
 *
 * Lógica: Ejecuta periódicamente verificaciones de reservas,
 *   recordatorios de citas y limpieza de slots expirados.
 *   Se protege con un flag de estado para evitar ejecuciones
 *   concurrentes.
 */
function jaraba_servicios_conecta_cron(): void {
  $state = \Drupal::state();
  $last_run = $state->get('jaraba_servicios_conecta.cron_last_run', 0);
  $now = \Drupal::time()->getRequestTime();

  // Ejecutar cada 15 minutos como máximo
  if (($now - $last_run) < 900) {
    return;
  }

  $state->set('jaraba_servicios_conecta.cron_last_run', $now);

  // Fase 2: Auto-cancel pending bookings older than 24h.
  _jaraba_servicios_conecta_cancel_stale_bookings($now);

  // Fase 4: Send appointment reminders (24h and 1h before).
  _jaraba_servicios_conecta_send_reminders($now);

  // Fase 5: Detect no-shows (past confirmed booking without check-in).
  _jaraba_servicios_conecta_detect_no_shows($now);

  // Fase 5: Clean up expired availability slots.
  _jaraba_servicios_conecta_cleanup_expired_slots($now);
}

/**
 * Auto-cancels bookings pending confirmation for more than 24h.
 */
function _jaraba_servicios_conecta_cancel_stale_bookings(int $now): void {
  try {
    $storage = \Drupal::entityTypeManager()->getStorage('booking');
    $threshold = date('Y-m-d\TH:i:s', $now - 86400);

    $ids = $storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('status', 'pending_confirmation')
      ->condition('created', $threshold, '<')
      ->range(0, 50)
      ->execute();

    foreach ($storage->loadMultiple($ids) as $booking) {
      $booking->set('status', 'cancelled_client');
      $booking->save();

      // Release the availability slot.
      try {
        \Drupal::service('jaraba_servicios_conecta.availability')->releaseSlot(
          (int) ($booking->get('provider_id')->target_id ?? 0),
          $booking->get('booking_date')->value ?? '',
          (int) ($booking->get('duration_minutes')->value ?? 60)
        );
      }
      catch (\Exception $e) {
        // Slot release is best-effort.
      }

      \Drupal::logger('jaraba_servicios_conecta')->info(
        'Auto-cancelled stale booking @id (pending >24h)', ['@id' => $booking->id()]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_servicios_conecta')->error(
      'Error cancelling stale bookings: @error', ['@error' => $e->getMessage()]
    );
  }
}

/**
 * Sends appointment reminders 24h and 1h before.
 */
function _jaraba_servicios_conecta_send_reminders(int $now): void {
  try {
    $storage = \Drupal::entityTypeManager()->getStorage('booking');
    $mailManager = \Drupal::service('plugin.manager.mail');
    $userStorage = \Drupal::entityTypeManager()->getStorage('user');

    // Each window has: time range, the flag field to check/set.
    $windows = [
      [
        'from' => $now + 82800,
        'to' => $now + 90000,
        'flag' => 'reminder_24h_sent',
      ],
      [
        'from' => $now + 3300,
        'to' => $now + 3900,
        'flag' => 'reminder_1h_sent',
      ],
    ];

    foreach ($windows as $window) {
      $from = date('Y-m-d\TH:i:s', $window['from']);
      $to = date('Y-m-d\TH:i:s', $window['to']);
      $flag = $window['flag'];

      $ids = $storage->getQuery()
        ->accessCheck(FALSE)
        ->condition('status', 'confirmed')
        ->condition('booking_date', $from, '>=')
        ->condition('booking_date', $to, '<=')
        ->condition($flag, 0)
        ->execute();

      foreach ($storage->loadMultiple($ids) as $booking) {
        $clientUid = $booking->getOwnerId();
        $providerId = $booking->get('provider_id')->target_id ?? NULL;

        foreach ([$clientUid, $providerId] as $userId) {
          if ($userId) {
            $user = $userStorage->load($userId);
            if ($user && $user->getEmail()) {
              $mailManager->mail('jaraba_servicios_conecta', 'booking_reminder', $user->getEmail(), $user->getPreferredLangcode(), [
                'user_name' => $user->getDisplayName(),
                'booking_id' => $booking->id(),
                'datetime' => $booking->get('booking_date')->value ?? '',
              ]);
            }
          }
        }

        // Mark reminder as sent to prevent duplicates.
        $booking->set($flag, TRUE);
        $booking->save();
      }
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_servicios_conecta')->error(
      'Error sending reminders: @error', ['@error' => $e->getMessage()]
    );
  }
}

/**
 * Detects no-shows: confirmed bookings in the past without check-in.
 */
function _jaraba_servicios_conecta_detect_no_shows(int $now): void {
  try {
    $storage = \Drupal::entityTypeManager()->getStorage('booking');
    $pastThreshold = date('Y-m-d\TH:i:s', $now - 3600);

    $ids = $storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('status', 'confirmed')
      ->condition('booking_date', $pastThreshold, '<')
      ->range(0, 50)
      ->execute();

    foreach ($storage->loadMultiple($ids) as $booking) {
      $booking->set('status', 'no_show');
      $booking->save();
      \Drupal::logger('jaraba_servicios_conecta')->info(
        'Marked booking @id as no_show', ['@id' => $booking->id()]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_servicios_conecta')->error(
      'Error detecting no-shows: @error', ['@error' => $e->getMessage()]
    );
  }
}

/**
 * Cleans up expired availability slots.
 */
function _jaraba_servicios_conecta_cleanup_expired_slots(int $now): void {
  try {
    $storage = \Drupal::entityTypeManager()->getStorage('availability_slot');
    $pastThreshold = date('Y-m-d', $now);

    $ids = $storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('is_active', TRUE)
      ->condition('valid_until', $pastThreshold, '<')
      ->condition('valid_until', NULL, 'IS NOT NULL')
      ->range(0, 100)
      ->execute();

    foreach ($storage->loadMultiple($ids) as $slot) {
      $slot->set('is_active', FALSE);
      $slot->save();
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_servicios_conecta')->error(
      'Error cleaning expired slots: @error', ['@error' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_mail().
 */
function jaraba_servicios_conecta_mail($key, &$message, $params): void {
  switch ($key) {
    case 'provider_approved':
      $message['subject'] = t('¡Tu perfil profesional ha sido aprobado!');
      $message['body'][] = t('Hola @name,', ['@name' => $params['provider_name']]);
      $message['body'][] = t('Tu perfil profesional ha sido verificado y aprobado. Ya puedes recibir reservas de clientes.');
      break;

    case 'booking_confirmed':
      $message['subject'] = t('Reserva confirmada #@id', ['@id' => $params['booking_id']]);
      $message['body'][] = t('Hola @name,', ['@name' => $params['client_name']]);
      $message['body'][] = t('Tu reserva #@id ha sido confirmada para el @date.', [
        '@id' => $params['booking_id'],
        '@date' => $params['datetime'],
      ]);
      break;

    case 'booking_cancelled':
      $message['subject'] = t('Reserva cancelada #@id', ['@id' => $params['booking_id']]);
      $message['body'][] = t('Hola @name,', ['@name' => $params['client_name']]);
      $message['body'][] = t('Tu reserva #@id ha sido cancelada.', ['@id' => $params['booking_id']]);
      break;

    case 'booking_completed':
      $message['subject'] = t('Cita completada #@id', ['@id' => $params['booking_id']]);
      $message['body'][] = t('Hola @name,', ['@name' => $params['client_name']]);
      $message['body'][] = t('Tu cita #@id se ha completado. ¡Esperamos que haya ido bien!', ['@id' => $params['booking_id']]);
      $message['body'][] = t('¿Te gustaría dejar una valoración? Accede a tu panel para hacerlo.');
      break;

    case 'booking_reminder':
      $message['subject'] = t('Recordatorio: cita próxima #@id', ['@id' => $params['booking_id']]);
      $message['body'][] = t('Hola @name,', ['@name' => $params['user_name']]);
      $message['body'][] = t('Te recordamos que tienes una cita programada para el @date.', [
        '@date' => $params['datetime'],
      ]);
      break;
  }

  // Footer común.
  if (!empty($message['body'])) {
    $message['body'][] = '';
    $message['body'][] = '---';
    $message['body'][] = t('Jaraba Impact Platform - ServiciosConecta');
  }
}

/**
 * Implements hook_page_attachments_alter().
 *
 * Adds Open Graph meta tags for ServiciosConecta public pages.
 */
function jaraba_servicios_conecta_page_attachments_alter(array &$attachments): void {
  $route_name = \Drupal::routeMatch()->getRouteName() ?? '';

  $og_routes = [
    'jaraba_servicios_conecta.marketplace',
    'jaraba_servicios_conecta.marketplace.provider',
    'jaraba_servicios_conecta.marketplace.booking',
  ];

  if (!in_array($route_name, $og_routes, TRUE)) {
    return;
  }

  $site_name = \Drupal::config('system.site')->get('name') ?? 'Jaraba Impact Platform';
  $request = \Drupal::request();
  $current_url = $request->getSchemeAndHttpHost() . $request->getRequestUri();

  $og_defaults = [
    'og:type' => 'website',
    'og:site_name' => $site_name,
    'og:url' => $current_url,
    'og:locale' => 'es_ES',
  ];

  switch ($route_name) {
    case 'jaraba_servicios_conecta.marketplace':
      $og_defaults['og:title'] = t('Servicios Profesionales — @site', ['@site' => $site_name]);
      $og_defaults['og:description'] = t('Encuentra profesionales de confianza cerca de ti. Reserva citas con abogados, médicos, consultores y más.');
      break;

    case 'jaraba_servicios_conecta.marketplace.provider':
      $slug = \Drupal::routeMatch()->getParameter('provider_slug');
      if ($slug) {
        try {
          $provider = \Drupal::service('jaraba_servicios_conecta.provider')->getProviderBySlug($slug);
          if ($provider) {
            $og_defaults['og:title'] = $provider->get('display_name')->value . ' — ' . $site_name;
            $og_defaults['og:description'] = mb_substr(strip_tags($provider->get('description')->value ?? ''), 0, 160);
          }
        }
        catch (\Exception $e) {
          // Provider not found — use defaults.
        }
      }
      if (empty($og_defaults['og:title'])) {
        $og_defaults['og:title'] = t('Profesional — @site', ['@site' => $site_name]);
        $og_defaults['og:description'] = t('Perfil de profesional en ServiciosConecta.');
      }
      break;

    case 'jaraba_servicios_conecta.marketplace.booking':
      $og_defaults['og:title'] = t('Reservar Cita — @site', ['@site' => $site_name]);
      $og_defaults['og:description'] = t('Reserva una cita con un profesional de confianza.');
      break;
  }

  foreach ($og_defaults as $property => $content) {
    $attachments['#attached']['html_head'][] = [
      [
        '#tag' => 'meta',
        '#attributes' => [
          'property' => $property,
          'content' => $content,
        ],
      ],
      'jaraba_servicios_conecta_' . str_replace(':', '_', $property),
    ];
  }
}

/**
 * Genera un slug URL-friendly a partir de un texto.
 *
 * Lógica: Convierte a minúsculas, elimina acentos y caracteres
 *   especiales, reemplaza espacios por guiones, y trunca a 128 chars.
 *
 * @param string $text
 *   Texto fuente para generar el slug.
 *
 * @return string
 *   Slug limpio.
 */
function _jaraba_servicios_conecta_generate_slug(string $text): string {
  $transliteration = [
    'á' => 'a', 'é' => 'e', 'í' => 'i', 'ó' => 'o', 'ú' => 'u',
    'ñ' => 'n', 'ü' => 'u', 'Á' => 'a', 'É' => 'e', 'Í' => 'i',
    'Ó' => 'o', 'Ú' => 'u', 'Ñ' => 'n', 'Ü' => 'u',
  ];

  $slug = strtr(mb_strtolower($text), $transliteration);
  $slug = preg_replace('/[^a-z0-9\-]/', '-', $slug);
  $slug = preg_replace('/-+/', '-', $slug);
  $slug = trim($slug, '-');
  $slug = substr($slug, 0, 128);

  return $slug;
}
