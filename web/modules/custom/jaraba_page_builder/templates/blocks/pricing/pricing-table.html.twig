{#
/**
 * @file
 * Template para el bloque Tabla de Precios.
 *
 * DIRECTRICES:
 * - Usa jaraba_icon(category, name, { variant, size, color }) para iconos
 * - Usa {% trans %} para textos de interfaz
 * - Usa var(--ej-*) vía SCSS _page-builder
 *
 * @ingroup jaraba_page_builder
 */
#}
{% set bg_class = content.background|default('light') %}
{% set style_class = content.style|default('cards') %}
{% set plans = content.plans|default([]) %}

<section class="jaraba-block jaraba-pricing jaraba-pricing--{{ bg_class }} jaraba-pricing--{{ style_class }}"
         data-block-type="pricing_table">
  
  <div class="jaraba-block__container">
    
    {# Encabezado #}
    <header class="jaraba-pricing__header">
      {% if content.title %}
        <h2 class="jaraba-block__title">{{ content.title }}</h2>
      {% endif %}
      
      {% if content.subtitle %}
        <p class="jaraba-block__subtitle">{{ content.subtitle }}</p>
      {% endif %}
      
      {# Toggle Mensual/Anual #}
      {% if content.billing_toggle %}
        <div class="jaraba-pricing__toggle">
          <span class="jaraba-pricing__toggle-label" data-billing="monthly">{% trans %}Mensual{% endtrans %}</span>
          <label class="jaraba-switch">
            <input type="checkbox" 
                   class="jaraba-switch__input" 
                   data-pricing-toggle
                   aria-label="{% trans %}Cambiar entre facturación mensual y anual{% endtrans %}">
            <span class="jaraba-switch__slider"></span>
          </label>
          <span class="jaraba-pricing__toggle-label" data-billing="annual">
            {% trans %}Anual{% endtrans %}
            {% if content.annual_discount %}
              <span class="jaraba-pricing__discount-badge">-{{ content.annual_discount }}%</span>
            {% endif %}
          </span>
        </div>
      {% endif %}
    </header>
    
    {# Grid de planes #}
    {% if plans is not empty %}
      <div class="jaraba-pricing__grid jaraba-pricing__grid--{{ plans|length }}">
        {% for plan in plans %}
          {% set annual_monthly = plan.price_annual ? (plan.price_annual / 12)|round(2) : plan.price_monthly %}
          
          <article class="jaraba-plan-card {{ plan.is_popular ? 'jaraba-plan-card--popular' : '' }}">
            
            {# Badge popular #}
            {% if plan.is_popular %}
              <div class="jaraba-plan-card__popular-badge">
                {{ jaraba_icon('ui', 'star', { variant: 'filled', size: '14px', color: 'warning' }) }}
                <span>{% trans %}Más popular{% endtrans %}</span>
              </div>
            {% endif %}
            
            {# Cabecera del plan #}
            <header class="jaraba-plan-card__header">
              <h3 class="jaraba-plan-card__name">{{ plan.name }}</h3>
              {% if plan.description %}
                <p class="jaraba-plan-card__description">{{ plan.description }}</p>
              {% endif %}
            </header>
            
            {# Precio #}
            <div class="jaraba-plan-card__pricing">
              {# Precio mensual #}
              <div class="jaraba-plan-card__price" data-price-type="monthly">
                <span class="jaraba-plan-card__currency">€</span>
                <span class="jaraba-plan-card__amount">{{ plan.price_monthly }}</span>
                <span class="jaraba-plan-card__period">/{% trans %}mes{% endtrans %}</span>
              </div>
              
              {# Precio anual (oculto por defecto) #}
              {% if plan.price_annual %}
                <div class="jaraba-plan-card__price jaraba-plan-card__price--hidden" data-price-type="annual">
                  <span class="jaraba-plan-card__currency">€</span>
                  <span class="jaraba-plan-card__amount">{{ annual_monthly }}</span>
                  <span class="jaraba-plan-card__period">/{% trans %}mes{% endtrans %}</span>
                  <small class="jaraba-plan-card__billed">{% trans %}Facturado anualmente{% endtrans %}</small>
                </div>
              {% endif %}
            </div>
            
            {# CTA del plan #}
            <a href="{{ plan.cta_url|default('/contact') }}" 
               class="jaraba-btn {{ plan.is_popular ? 'jaraba-btn--primary' : 'jaraba-btn--outline' }} jaraba-btn--block">
              {{ plan.cta_text|default('Empezar'|trans) }}
            </a>
            
            {# Lista de características #}
            {% if plan.features is not empty %}
              <ul class="jaraba-plan-card__features">
                {% for feature in plan.features %}
                  <li class="jaraba-plan-card__feature {{ feature.included ? '' : 'jaraba-plan-card__feature--excluded' }} {{ feature.highlight ? 'jaraba-plan-card__feature--highlight' : '' }}">
                    <span class="jaraba-plan-card__feature-icon">
                      {% if feature.included %}
                        {{ jaraba_icon('ui', 'check', { variant: 'outline', size: '16px', color: 'success' }) }}
                      {% else %}
                        {{ jaraba_icon('ui', 'x', { variant: 'outline', size: '16px', color: 'muted' }) }}
                      {% endif %}
                    </span>
                    <span class="jaraba-plan-card__feature-text">{{ feature.text }}</span>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
            
          </article>
        {% endfor %}
      </div>
    {% endif %}
    
    {# Tabla de comparación (opcional) #}
    {% if content.show_comparison and plans is not empty %}
      <div class="jaraba-pricing__comparison">
        <h3 class="jaraba-pricing__comparison-title">{% trans %}Comparación detallada{% endtrans %}</h3>

        {# Recopilar todas las features únicas de todos los planes #}
        {% set all_features = [] %}
        {% for plan in plans %}
          {% for feature in plan.features|default([]) %}
            {% if feature.text not in all_features %}
              {% set all_features = all_features|merge([feature.text]) %}
            {% endif %}
          {% endfor %}
        {% endfor %}

        {# Tabla responsive: visible en desktop, oculta en mobile #}
        <div class="jaraba-pricing__comparison-table-wrapper">
          <table class="jaraba-pricing__comparison-table" role="grid"
                 aria-label="{% trans %}Comparación de planes{% endtrans %}">
            <thead>
              <tr>
                <th class="jaraba-pricing__comparison-feature-header" scope="col">
                  {% trans %}Característica{% endtrans %}
                </th>
                {% for plan in plans %}
                  <th class="jaraba-pricing__comparison-plan-header {{ plan.is_popular ? 'jaraba-pricing__comparison-plan-header--popular' : '' }}"
                      scope="col">
                    {{ plan.name }}
                  </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for feature_text in all_features %}
                <tr class="jaraba-pricing__comparison-row">
                  <td class="jaraba-pricing__comparison-cell jaraba-pricing__comparison-cell--label">
                    {{ feature_text }}
                  </td>
                  {% for plan in plans %}
                    {% set feature_found = false %}
                    {% set feature_included = false %}
                    {% for feature in plan.features|default([]) %}
                      {% if feature.text == feature_text %}
                        {% set feature_found = true %}
                        {% set feature_included = feature.included %}
                      {% endif %}
                    {% endfor %}
                    <td class="jaraba-pricing__comparison-cell jaraba-pricing__comparison-cell--value {{ plan.is_popular ? 'jaraba-pricing__comparison-cell--popular' : '' }}"
                        aria-label="{{ plan.name }}: {{ feature_text }}">
                      {% if feature_found and feature_included %}
                        <span class="jaraba-pricing__comparison-icon jaraba-pricing__comparison-icon--included">
                          {{ jaraba_icon('ui', 'check', { variant: 'outline', size: '18px', color: 'success' }) }}
                          <span class="visually-hidden">{% trans %}Incluido{% endtrans %}</span>
                        </span>
                      {% else %}
                        <span class="jaraba-pricing__comparison-icon jaraba-pricing__comparison-icon--excluded">
                          {{ jaraba_icon('ui', 'x', { variant: 'outline', size: '18px', color: 'muted' }) }}
                          <span class="visually-hidden">{% trans %}No incluido{% endtrans %}</span>
                        </span>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {# Vista mobile: cada plan como card independiente #}
        <div class="jaraba-pricing__comparison-mobile">
          {% for plan in plans %}
            <details class="jaraba-pricing__comparison-accordion {{ plan.is_popular ? 'jaraba-pricing__comparison-accordion--popular' : '' }}">
              <summary class="jaraba-pricing__comparison-accordion-header">
                {{ plan.name }}
                {% if plan.is_popular %}
                  <span class="jaraba-pricing__comparison-accordion-badge">
                    {% trans %}Popular{% endtrans %}
                  </span>
                {% endif %}
              </summary>
              <ul class="jaraba-pricing__comparison-accordion-list">
                {% for feature in plan.features|default([]) %}
                  <li class="jaraba-pricing__comparison-accordion-item {{ feature.included ? '' : 'jaraba-pricing__comparison-accordion-item--excluded' }}">
                    <span class="jaraba-pricing__comparison-accordion-icon">
                      {% if feature.included %}
                        {{ jaraba_icon('ui', 'check', { variant: 'outline', size: '16px', color: 'success' }) }}
                      {% else %}
                        {{ jaraba_icon('ui', 'x', { variant: 'outline', size: '16px', color: 'muted' }) }}
                      {% endif %}
                    </span>
                    <span>{{ feature.text }}</span>
                  </li>
                {% endfor %}
              </ul>
            </details>
          {% endfor %}
        </div>
      </div>
    {% endif %}
    
  </div>
</section>
