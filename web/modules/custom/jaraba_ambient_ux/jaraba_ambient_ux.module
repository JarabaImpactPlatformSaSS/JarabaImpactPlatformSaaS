<?php

/**
 * @file
 * Módulo de Experiencia de Usuario Ambiental (Liquid UI).
 */

declare(strict_types=1);

/**
 * Implements hook_preprocess_html().
 *
 * Inyecta el modo de interfaz líquido calculado por la IA.
 */
function jaraba_ambient_ux_preprocess_html(array &$variables): void {
  // Solo aplicar en contextos de tenant (no admin global ni anónimo).
  $tenantContext = \Drupal::service('ecosistema_jaraba_core.tenant_context');
  $tenant = $tenantContext->getCurrentTenant();

  if ($tenant) {
    /** @var \Drupal\jaraba_ambient_ux\Service\IntentToLayoutService $intentEngine */
    $intentEngine = \Drupal::service('jaraba_ambient_ux.intent_engine');
    
    // Calcular modo basado en datos predictivos.
    $uiConfig = $intentEngine->determineUiMode((int) $tenant->id());

    // Inyectar clases CSS líquidas.
    $variables['attributes']['class'][] = $uiConfig['css_class'];
    $variables['attributes']['class'][] = 'liquid-ui-active';
    
    // Pasar configuración a drupalSettings para el frontend JS.
    $variables['#attached']['drupalSettings']['jarabaAmbientUx'] = $uiConfig;
  }
}
