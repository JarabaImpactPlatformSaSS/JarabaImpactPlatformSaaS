<?php

/**
 * @file
 * Primary module hooks for Jaraba Integrations.
 *
 * PROPÓSITO:
 * Marketplace de integraciones y conectores OAuth2 para tenants SaaS.
 * Incluye registro de conectores, instalación por tenant, webhooks y health checks.
 *
 * DIRECTRICES:
 * - Hook-first: hooks nativos de Drupal, no ECA.
 * - i18n: todos los textos con t() / {% trans %}.
 * - Aislamiento: tenant_id en cada entidad.
 */

declare(strict_types=1);

/**
 * Implements hook_help().
 */
function jaraba_integrations_help(string $route_name): string {
  if ($route_name === 'help.page.jaraba_integrations') {
    return '<p>' . t('Marketplace de integraciones y conectores para tenants SaaS multi-vertical.') . '</p>';
  }
  return '';
}

/**
 * Implements hook_theme().
 */
function jaraba_integrations_theme(): array {
  return [
    'jaraba_integrations_dashboard' => [
      'variables' => [
        'connectors' => [],
        'installed' => [],
        'categories' => [],
        'stats' => [],
        'tenant_id' => NULL,
      ],
      'template' => 'jaraba-integrations-dashboard',
    ],
    'jaraba_integrations_connector_card' => [
      'variables' => [
        'connector' => NULL,
        'is_installed' => FALSE,
        'installation' => NULL,
      ],
      'template' => 'jaraba-integrations-connector-card',
    ],
    'jaraba_integrations_webhook_log' => [
      'variables' => [
        'subscriptions' => [],
        'recent_deliveries' => [],
      ],
      'template' => 'jaraba-integrations-webhook-log',
    ],
    'jaraba_oauth_authorize' => [
      'variables' => [
        'client_name' => '',
        'scopes' => [],
        'client_id' => '',
        'redirect_uri' => '',
        'scope' => '',
        'state' => '',
      ],
      'template' => 'jaraba-oauth-authorize',
    ],
    'jaraba_integrations_marketplace' => [
      'variables' => [
        'connectors' => [],
        'categories' => [],
        'featured' => [],
        'stats' => [],
      ],
      'template' => 'jaraba-integrations-marketplace',
    ],
    'jaraba_integrations_developer_portal' => [
      'variables' => [
        'connectors' => [],
        'sdk_info' => [],
        'pending_review' => 0,
      ],
      'template' => 'jaraba-integrations-developer-portal',
    ],
    'jaraba_integrations_developer_docs' => [
      'variables' => [
        'sdk_version' => '',
        'api_endpoints' => [],
      ],
      'template' => 'jaraba-integrations-developer-docs',
    ],
  ];
}

/**
 * Implements hook_preprocess_html().
 *
 * Anade body classes para paginas de integraciones.
 */
function jaraba_integrations_preprocess_html(array &$variables): void {
  $route = \Drupal::routeMatch()->getRouteName() ?? '';

  if (str_starts_with($route, 'jaraba_integrations.')) {
    $variables['attributes']['class'][] = 'page--integrations';

    if (str_contains($route, 'marketplace')) {
      $variables['attributes']['class'][] = 'page--integrations-marketplace';
    }
    elseif (str_contains($route, 'developer')) {
      $variables['attributes']['class'][] = 'page--integrations-developer';
    }
  }
}
