<?php

declare(strict_types=1);

/**
 * @file
 * Módulo principal para el Programa Andalucía +ei.
 *
 * Gestiona participantes del programa con tracking de horas de mentoría IA,
 * integración con STO y transiciones de fase PIIL.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function jaraba_andalucia_ei_help(string $route_name, RouteMatchInterface $route_match): string {
  if ($route_name === 'help.page.jaraba_andalucia_ei') {
    return '<p>' . t('Gestión del Programa Andalucía +ei - Emprendimiento Aumentado con IA.') . '</p>';
  }
  return '';
}

/**
 * Implements hook_theme().
 */
function jaraba_andalucia_ei_theme(): array {
  return [
    'andalucia_ei_dashboard' => [
      'variables' => [
        'participante' => NULL,
        'solicitud' => NULL,
        'is_admin' => FALSE,
        'health_score' => NULL,
        'bridges' => [],
        'proactive_action' => NULL,
        'messages' => NULL,
      ],
      'template' => 'andalucia-ei-dashboard',
    ],
    'solicitud_ei_page' => [
      'variables' => [
        'form' => NULL,
        'messages' => NULL,
      ],
      'template' => 'solicitud-ei-page',
    ],
    'andalucia_ei_landing' => [
      'variables' => [
        'solicitar_url' => NULL,
      ],
      'template' => 'andalucia-ei-landing',
    ],
    'participante_expediente' => [
      'variables' => [
        'completitud' => [],
        'documentos_por_categoria' => [],
        'participante_id' => NULL,
      ],
      'template' => 'partials/_participante-expediente',
    ],
    'participante_portal' => [
      'variables' => [
        'participante' => NULL,
        'health_score' => NULL,
        'completitud' => [],
        'documentos_por_categoria' => [],
        'bridges' => [],
        'proactive_action' => NULL,
        'timeline' => [],
        'formacion' => [],
      ],
      'template' => 'participante-portal',
    ],
    'participante_hero' => [
      'variables' => [
        'participante' => NULL,
        'health_score' => NULL,
      ],
      'template' => 'partials/_participante-hero',
    ],
    'participante_timeline' => [
      'variables' => [
        'timeline' => [],
        'fase_actual' => NULL,
      ],
      'template' => 'partials/_participante-timeline',
    ],
    'participante_formacion' => [
      'variables' => [
        'formacion' => [],
        'participante' => NULL,
      ],
      'template' => 'partials/_participante-formacion',
    ],
    'participante_acciones' => [
      'variables' => [
        'participante' => NULL,
      ],
      'template' => 'partials/_participante-acciones',
    ],
    'participante_logros' => [
      'variables' => [
        'participante' => NULL,
        'formacion' => [],
        'timeline' => [],
      ],
      'template' => 'partials/_participante-logros',
    ],
    'participante_mensajeria' => [
      'variables' => [
        'conversaciones' => [],
        'unread_total' => 0,
        'participante_uuid' => NULL,
        'mentor_online' => NULL,
      ],
      'template' => 'partials/_participante-mensajeria',
    ],
    'andalucia_ei_guia_participante' => [
      'variables' => [
        'solicitar_url' => NULL,
      ],
      'template' => 'andalucia-ei-guia-participante',
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK() for solicitud_ei_page.
 *
 * Injects Drupal status messages into the solicitud template so that
 * form validation errors and success messages are visible to the user.
 */
function jaraba_andalucia_ei_preprocess_solicitud_ei_page(array &$variables): void {
  $variables['messages'] = ['#type' => 'status_messages'];
}

/**
 * Implements hook_preprocess_HOOK() for andalucia_ei_dashboard.
 *
 * Injects Drupal status messages into the dashboard template so that
 * success messages (e.g., after solicitud submission) are visible.
 */
function jaraba_andalucia_ei_preprocess_andalucia_ei_dashboard(array &$variables): void {
  $variables['messages'] = ['#type' => 'status_messages'];
}

// =============================================================================
// ECA-EI-001: CONTABILIZAR HORAS IA AL FINALIZAR SESIÓN COPILOT
// Ver: docs/tecnicos/20260203-Plan_Implementacion_Docs_45_46_v1_Claude.md
// =============================================================================

/**
 * Implements hook_ENTITY_TYPE_update() for copilot_session.
 *
 * Contabiliza automáticamente las horas de mentoría IA cuando finaliza
 * una sesión con el Copilot v2.
 */
function jaraba_andalucia_ei_copilot_session_update(\Drupal\Core\Entity\EntityInterface $entity): void {
  // Solo procesar si la sesión pasa a 'completed'.
  if (!$entity->hasField('status')) {
    return;
  }

  $newStatus = $entity->get('status')->value ?? '';
  $oldStatus = $entity->original->get('status')->value ?? '';

  if ($oldStatus !== 'completed' && $newStatus === 'completed') {
    _jaraba_andalucia_ei_track_ia_hours($entity);
  }
}

/**
 * Registra las horas de sesión IA en el participante Andalucía +ei.
 *
 * @param \Drupal\Core\Entity\EntityInterface $session
 *   Sesión de Copilot completada.
 */
function _jaraba_andalucia_ei_track_ia_hours(\Drupal\Core\Entity\EntityInterface $session): void {
  try {
    $userId = $session->getOwnerId();
    if (!$userId) {
      return;
    }

    // Buscar participante vinculado.
    $storage = \Drupal::entityTypeManager()->getStorage('programa_participante_ei');
    $participantes = $storage->loadByProperties(['uid' => $userId]);
    $participante = reset($participantes);

    if (!$participante) {
      return;
    }

    // Calcular duración de sesión (en horas).
    $duracionMinutos = $session->get('duration_minutes')->value ?? 0;
    $duracionHoras = (float) $duracionMinutos / 60;

    // Aplicar límite diario según configuración (default: 2h/día).
    $config = \Drupal::config('jaraba_andalucia_ei.settings');
    $limiteDiario = (float) ($config->get('maximo_horas_ia_dia') ?? 4);

    // Verificar horas ya registradas hoy.
    $tracker = \Drupal::service('jaraba_andalucia_ei.ai_mentorship_tracker');
    $horasHoy = $tracker->getHoursToday($participante);
    $horasRestantes = max(0, $limiteDiario - $horasHoy);
    $horasARegistrar = min($duracionHoras, $horasRestantes);

    if ($horasARegistrar > 0) {
      $horasActuales = (float) ($participante->get('horas_mentoria_ia')->value ?? 0);
      $participante->set('horas_mentoria_ia', $horasActuales + $horasARegistrar);
      $participante->save();

      // Registrar en auditoría.
      $tracker->recordSession($participante, $horasARegistrar, $session->id());

      // Feature Gate: registrar uso diario de copilot.
      // Plan Elevación Andalucía +ei v1 — Fase 10.
      if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_feature_gate')) {
        \Drupal::service('ecosistema_jaraba_core.andalucia_ei_feature_gate')
          ->recordUsage($userId, 'copilot_sessions_daily');
      }

      // Fase 12: Track first_ia_session conversion si es la primera sesión.
      if ($horasActuales <= 0 && \Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_experiment')) {
        try {
          \Drupal::service('ecosistema_jaraba_core.andalucia_ei_experiment')
            ->trackConversion($userId, 'first_ia_session');
        }
        catch (\Exception $e) {
          // Non-critical.
        }
      }

      \Drupal::logger('jaraba_andalucia_ei')->info(
        'Registradas @horas horas IA para participante @dni (sesión @session)',
        [
          '@horas' => number_format($horasARegistrar, 2),
          '@dni' => $participante->label(),
          '@session' => $session->id(),
        ]
      );
    }
    else {
      // Límite diario alcanzado — disparar upgrade trigger.
      // Plan Elevación Andalucía +ei v1 — Fase 10.
      _jaraba_andalucia_ei_fire_upgrade_trigger('limit_reached', $participante, [
        'feature' => 'copilot_sessions_daily',
        'vertical' => 'andalucia_ei',
      ]);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'Error al registrar horas IA: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

// =============================================================================
// FASE 12: EMBUDO PÚBLICO → REGISTRO → VENTAS
// Onboarding enrollment + conversion tracking on participant creation.
// =============================================================================

/**
 * Implements hook_ENTITY_TYPE_insert() for programa_participante_ei.
 *
 * On participant creation:
 * 1. Enrolls in SEQ_AEI_001 (Welcome Participant) email sequence.
 * 2. Tracks 'participant_enrolled' conversion event for A/B testing.
 * 3. Syncs initial CRM lead stage.
 */
function jaraba_andalucia_ei_programa_participante_ei_insert(\Drupal\Core\Entity\EntityInterface $entity): void {
  $userId = (int) ($entity->getOwnerId() ?? 0);
  if (!$userId) {
    return;
  }

  // 1. Welcome email sequence.
  _jaraba_andalucia_ei_enroll_email_sequence($userId, 'SEQ_AEI_001');

  // 2. A/B conversion tracking.
  if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_experiment')) {
    try {
      \Drupal::service('ecosistema_jaraba_core.andalucia_ei_experiment')
        ->trackConversion($userId, 'participant_enrolled');
    }
    catch (\Exception $e) {
      // Non-critical.
    }
  }

  // 3. Initial CRM sync (lead stage).
  _jaraba_andalucia_ei_sync_to_crm($entity, 'atencion');

  \Drupal::logger('jaraba_andalucia_ei')->info(
    'New participant @id enrolled: welcome email + CRM lead created',
    ['@id' => $entity->id()]
  );
}

// =============================================================================
// ECA-EI-002: NOTIFICAR ELEGIBILIDAD PARA FASE INSERCIÓN
// =============================================================================

/**
 * Implements hook_ENTITY_TYPE_update() for programa_participante_ei.
 *
 * Detecta cuando un participante cumple requisitos para avanzar a fase
 * Inserción y notifica al equipo técnico.
 */
function jaraba_andalucia_ei_programa_participante_ei_update(\Drupal\Core\Entity\EntityInterface $entity): void {
  // Solo en fase Atención.
  if ($entity->getFaseActual() !== 'atencion') {
    return;
  }

  // Verificar si ahora cumple requisitos.
  if ($entity->canTransitToInsercion()) {
    // Verificar si antes no los cumplía (para evitar notificaciones duplicadas).
    $original = $entity->original;
    if (!$original || !$original->canTransitToInsercion()) {
      _jaraba_andalucia_ei_notify_eligibility($entity);
    }
  }

  // Plan Elevación Andalucía +ei v1 — Fase 10: Upgrade Triggers en hitos.
  _jaraba_andalucia_ei_check_hour_milestones($entity);

  // Plan Elevación Andalucía +ei v1 — Fase 10: CRM sync en transición de fase.
  $originalFase = $entity->original ? ($entity->original->getFaseActual() ?? 'atencion') : 'atencion';
  $newFase = $entity->getFaseActual() ?? 'atencion';
  if ($originalFase !== $newFase) {
    _jaraba_andalucia_ei_sync_to_crm($entity, $newFase);

    // Disparar email sequence en transición a inserción.
    if ($newFase === 'insercion') {
      $ownerIdForSeq = (int) $entity->getOwnerId();
      _jaraba_andalucia_ei_enroll_email_sequence($ownerIdForSeq, 'SEQ_AEI_002');

      // Fase 12: Track phase_insertion conversion.
      if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_experiment')) {
        try {
          \Drupal::service('ecosistema_jaraba_core.andalucia_ei_experiment')
            ->trackConversion($ownerIdForSeq, 'phase_insertion');
        }
        catch (\Exception $e) {
          // Non-critical.
        }
      }
    }
  }
}

/**
 * Envía notificación de elegibilidad para fase Inserción.
 *
 * @param \Drupal\jaraba_andalucia_ei\Entity\ProgramaParticipanteEiInterface $participante
 *   Participante elegible.
 */
function _jaraba_andalucia_ei_notify_eligibility($participante): void {
  try {
    $mailManager = \Drupal::service('plugin.manager.mail');

    // Obtener email del técnico/orientador.
    $config = \Drupal::config('jaraba_andalucia_ei.settings');
    $emailTecnicos = $config->get('notification_email') ?? 'orientacion@agentejaraba.es';

    $params = [
      'participante_dni' => $participante->getDniNie(),
      'participante_id' => $participante->id(),
      'horas_orientacion' => $participante->getTotalHorasOrientacion(),
      'horas_formacion' => $participante->get('horas_formacion')->value ?? 0,
    ];

    $mailManager->mail(
      'jaraba_andalucia_ei',
      'eligibility_notification',
      $emailTecnicos,
      'es',
      $params,
      NULL,
      TRUE
    );

    \Drupal::logger('jaraba_andalucia_ei')->notice(
      'Notificación de elegibilidad enviada para participante @dni',
      ['@dni' => $participante->getDniNie()]
    );
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'Error al enviar notificación de elegibilidad: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_mail().
 *
 * Premium HTML email bodies — wrapped by email-wrap.html.twig (branded shell).
 * Uses inline CSS + table layout for maximum email client compatibility.
 */
function jaraba_andalucia_ei_mail(string $key, array &$message, array $params): void {
  $esc = fn($v) => htmlspecialchars((string) ($v ?? ''), ENT_QUOTES, 'UTF-8');

  switch ($key) {
    case 'eligibility_notification':
      $dni = $esc($params['participante_dni']);
      $orient = number_format($params['horas_orientacion'] ?? 0, 1);
      $form = number_format($params['horas_formacion'] ?? 0, 1);
      $url = \Drupal\Core\Url::fromRoute(
        'entity.programa_participante_ei.edit_form',
        ['programa_participante_ei' => $params['participante_id'] ?? 0],
        ['absolute' => TRUE]
      )->toString();

      $message['subject'] = t('Participante elegible para Fase Inserción - Andalucía +ei');
      $message['body'][] = \Drupal\Core\Render\Markup::create(
        '<p style="margin:0 0 16px;font-size:16px;line-height:1.5;color:#333;">' .
          t('El participante con DNI <strong>@dni</strong> ha alcanzado los requisitos mínimos para avanzar a la <strong>Fase de Inserción</strong>.', ['@dni' => $dni]) .
        '</p>' .
        '<table width="100%" cellpadding="0" cellspacing="0" border="0" role="presentation" style="margin:0 0 24px;">' .
          '<tr><td style="padding:16px;background-color:#F0FDF4;border-left:4px solid #10B981;border-radius:0 4px 4px 0;">' .
            '<p style="margin:0 0 6px;font-size:13px;font-weight:600;color:#10B981;text-transform:uppercase;letter-spacing:0.5px;">' . t('Progreso acreditado') . '</p>' .
            '<p style="margin:0 0 4px;font-size:14px;color:#333;"><strong>' . t('Orientación') . ':</strong> ' . $orient . 'h <span style="color:#10B981;">(mín. 10h ✓)</span></p>' .
            '<p style="margin:0;font-size:14px;color:#333;"><strong>' . t('Formación') . ':</strong> ' . $form . 'h <span style="color:#10B981;">(mín. 50h ✓)</span></p>' .
          '</td></tr>' .
        '</table>' .
        '<table cellpadding="0" cellspacing="0" border="0" role="presentation" style="margin:0 0 16px;">' .
          '<tr><td style="border-radius:6px;background-color:#233D63;">' .
            '<a href="' . $esc($url) . '" style="display:inline-block;padding:12px 24px;font-size:16px;font-weight:600;color:#ffffff;text-decoration:none;border-radius:6px;">' .
              t('Ver ficha del participante') .
            '</a>' .
          '</td></tr>' .
        '</table>'
      );
      break;

    case 'nueva_solicitud':
      $nombre = $esc($params['nombre']);
      $email = $esc($params['email']);
      $telefono = $esc($params['telefono']);
      $provincia = $esc($params['provincia']);
      $colectivo = $esc($params['colectivo'] ?? 'Sin determinar');
      $solicitud_url = $esc($params['solicitud_url'] ?? '');

      $message['subject'] = t('Nueva solicitud Andalucía +ei: @nombre', ['@nombre' => $params['nombre'] ?? 'Sin nombre']);

      // Datos del solicitante.
      $html = '<p style="margin:0 0 16px;font-size:16px;line-height:1.5;color:#333;">' .
        t('Se ha recibido una nueva solicitud de participación en <strong>Andalucía +ei</strong>:') .
      '</p>' .
      '<table width="100%" cellpadding="0" cellspacing="0" border="0" role="presentation" style="margin:0 0 24px;border:1px solid #E2E8F0;border-radius:8px;overflow:hidden;">' .
        '<tr style="background-color:#F8FAFC;">' .
          '<td style="padding:8px 16px;font-size:13px;font-weight:600;color:#64748B;width:140px;">' . t('Nombre') . '</td>' .
          '<td style="padding:8px 16px;font-size:14px;color:#333;">' . $nombre . '</td>' .
        '</tr>' .
        '<tr>' .
          '<td style="padding:8px 16px;font-size:13px;font-weight:600;color:#64748B;border-top:1px solid #E2E8F0;">' . t('Email') . '</td>' .
          '<td style="padding:8px 16px;font-size:14px;color:#333;border-top:1px solid #E2E8F0;"><a href="mailto:' . $email . '" style="color:#233D63;">' . $email . '</a></td>' .
        '</tr>' .
        '<tr style="background-color:#F8FAFC;">' .
          '<td style="padding:8px 16px;font-size:13px;font-weight:600;color:#64748B;border-top:1px solid #E2E8F0;">' . t('Teléfono') . '</td>' .
          '<td style="padding:8px 16px;font-size:14px;color:#333;border-top:1px solid #E2E8F0;">' . $telefono . '</td>' .
        '</tr>' .
        '<tr>' .
          '<td style="padding:8px 16px;font-size:13px;font-weight:600;color:#64748B;border-top:1px solid #E2E8F0;">' . t('Provincia') . '</td>' .
          '<td style="padding:8px 16px;font-size:14px;color:#333;border-top:1px solid #E2E8F0;">' . $provincia . '</td>' .
        '</tr>' .
        '<tr style="background-color:#F8FAFC;">' .
          '<td style="padding:8px 16px;font-size:13px;font-weight:600;color:#64748B;border-top:1px solid #E2E8F0;">' . t('Colectivo') . '</td>' .
          '<td style="padding:8px 16px;font-size:14px;color:#333;border-top:1px solid #E2E8F0;">' . $colectivo . '</td>' .
        '</tr>' .
      '</table>';

      // Triaje IA (si disponible).
      if (!empty($params['ai_score'])) {
        $score = (int) $params['ai_score'];
        $rec = $esc($params['ai_recomendacion'] ?? 'pendiente');
        $just = $esc($params['ai_justificacion'] ?? 'No disponible');
        $rec_colors = [
          'admitir' => ['bg' => '#F0FDF4', 'border' => '#10B981', 'badge' => '#10B981'],
          'revisar' => ['bg' => '#FFFBEB', 'border' => '#F59E0B', 'badge' => '#F59E0B'],
          'rechazar' => ['bg' => '#FEF2F2', 'border' => '#EF4444', 'badge' => '#EF4444'],
        ];
        $colors = $rec_colors[$params['ai_recomendacion']] ?? $rec_colors['revisar'];

        $html .= '<table width="100%" cellpadding="0" cellspacing="0" border="0" role="presentation" style="margin:0 0 24px;">' .
          '<tr><td style="padding:16px;background-color:' . $colors['bg'] . ';border-left:4px solid ' . $colors['border'] . ';border-radius:0 4px 4px 0;">' .
            '<p style="margin:0 0 8px;font-size:13px;font-weight:600;color:' . $colors['badge'] . ';text-transform:uppercase;letter-spacing:0.5px;">' . t('Triaje IA') . '</p>' .
            '<p style="margin:0 0 4px;font-size:14px;color:#333;"><strong>' . t('Puntuación') . ':</strong> ' . $score . '/100</p>' .
            '<p style="margin:0 0 4px;font-size:14px;color:#333;"><strong>' . t('Recomendación') . ':</strong> <span style="display:inline-block;padding:2px 8px;background-color:' . $colors['badge'] . ';color:#fff;border-radius:4px;font-size:12px;font-weight:600;text-transform:uppercase;">' . $rec . '</span></p>' .
            '<p style="margin:0;font-size:13px;color:#64748B;line-height:1.4;">' . $just . '</p>' .
          '</td></tr>' .
        '</table>';
      }

      // CTA.
      $html .= '<table cellpadding="0" cellspacing="0" border="0" role="presentation" style="margin:0 0 16px;">' .
        '<tr><td style="border-radius:6px;background-color:#233D63;">' .
          '<a href="' . $solicitud_url . '" style="display:inline-block;padding:12px 24px;font-size:16px;font-weight:600;color:#ffffff;text-decoration:none;border-radius:6px;">' .
            t('Revisar solicitud') .
          '</a>' .
        '</td></tr>' .
      '</table>';

      $message['body'][] = \Drupal\Core\Render\Markup::create($html);
      break;

    case 'confirmacion_solicitud':
      $nombre = $esc($params['nombre']);
      $colectivo = $esc($params['colectivo'] ?? 'Por determinar');
      $dashboard_url = $esc($params['dashboard_url'] ?? '');

      $message['subject'] = t('Tu solicitud Andalucía +ei ha sido recibida');

      $step_circle = fn($n) => '<span style="display:inline-block;width:24px;height:24px;background-color:#FF8C42;color:#fff;border-radius:50%;text-align:center;line-height:24px;font-size:12px;font-weight:700;margin-right:10px;vertical-align:middle;">' . $n . '</span>';

      $html = '<p style="margin:0 0 16px;font-size:16px;line-height:1.5;color:#333;">' .
        t('Hola <strong>@nombre</strong>,', ['@nombre' => $nombre]) .
      '</p>' .
      '<p style="margin:0 0 20px;font-size:16px;line-height:1.5;color:#333;">' .
        t('Hemos recibido correctamente tu solicitud de participación en el programa <strong>Andalucía +ei</strong>.') .
      '</p>' .
      // Summary card.
      '<table width="100%" cellpadding="0" cellspacing="0" border="0" role="presentation" style="margin:0 0 24px;">' .
        '<tr><td style="padding:16px;background-color:#F0FDF4;border-left:4px solid #10B981;border-radius:0 4px 4px 0;">' .
          '<p style="margin:0 0 6px;font-size:13px;font-weight:600;color:#10B981;text-transform:uppercase;letter-spacing:0.5px;">' . t('Resumen de tu solicitud') . '</p>' .
          '<p style="margin:0 0 4px;font-size:14px;color:#333;"><strong>' . t('Programa') . ':</strong> Andalucía +ei — ' . t('Emprendimiento Aumentado con IA') . '</p>' .
          '<p style="margin:0;font-size:14px;color:#333;"><strong>' . t('Colectivo') . ':</strong> ' . $colectivo . '</p>' .
        '</td></tr>' .
      '</table>' .
      // Next steps.
      '<p style="margin:0 0 12px;font-size:16px;font-weight:600;color:#233D63;">' . t('Próximos pasos') . '</p>' .
      '<table width="100%" cellpadding="0" cellspacing="0" border="0" role="presentation" style="margin:0 0 24px;">' .
        '<tr><td style="padding:8px 0;font-size:14px;color:#333;line-height:1.5;">' .
          $step_circle(1) . t('Nuestro equipo revisará tu solicitud en los próximos días laborables.') .
        '</td></tr>' .
        '<tr><td style="padding:8px 0;font-size:14px;color:#333;line-height:1.5;">' .
          $step_circle(2) . t('Te contactaremos por teléfono o email para confirmar tu participación.') .
        '</td></tr>' .
        '<tr><td style="padding:8px 0;font-size:14px;color:#333;line-height:1.5;">' .
          $step_circle(3) . t('Mientras tanto, ¡explora la plataforma!') .
        '</td></tr>' .
      '</table>' .
      // CTA.
      '<table cellpadding="0" cellspacing="0" border="0" role="presentation" style="margin:0 0 24px;">' .
        '<tr><td style="border-radius:6px;background-color:#FF8C42;">' .
          '<a href="' . $dashboard_url . '" style="display:inline-block;padding:12px 24px;font-size:16px;font-weight:600;color:#ffffff;text-decoration:none;border-radius:6px;">' .
            t('Explorar la plataforma') .
          '</a>' .
        '</td></tr>' .
      '</table>' .
      // WhatsApp note.
      '<p style="margin:0 0 4px;font-size:14px;line-height:1.5;color:#64748B;">' .
        t('Si tienes cualquier duda, escríbenos por WhatsApp al <strong>+34 623 174 304</strong>.') .
      '</p>' .
      '<p style="margin:16px 0 0;font-size:14px;color:#64748B;">— ' . t('Equipo Andalucía +ei') . '</p>';

      $message['body'][] = \Drupal\Core\Render\Markup::create($html);
      break;
  }
}

// =============================================================================
// ECA-EI-003: SINCRONIZACIÓN PERIÓDICA CON STO (via Cron)
// =============================================================================

/**
 * Implements hook_cron().
 *
 * Sincronización periódica de datos con el Sistema Telemático del STO.
 */
function jaraba_andalucia_ei_cron(): void {
  // Solo ejecutar cada 6 horas.
  $state = \Drupal::state();
  $lastRun = $state->get('jaraba_andalucia_ei.sto_sync_last_run', 0);
  $now = \Drupal::time()->getRequestTime();

  if ($now - $lastRun < 6 * 3600) {
    return;
  }

  $state->set('jaraba_andalucia_ei.sto_sync_last_run', $now);

  \Drupal::logger('jaraba_andalucia_ei')->info('Iniciando sincronización STO...');

  try {
    // Procesar participantes pendientes de sincronización.
    _jaraba_andalucia_ei_process_sto_sync();
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'Error en sincronización STO: @message',
      ['@message' => $e->getMessage()]
    );
  }

  // Plan Elevación Andalucía +ei v1 — Fase 10/12:
  // Proactive AI evaluation + re-engagement (runs on its own 24h timer).
  _jaraba_andalucia_ei_cron_proactive_evaluation();
}

/**
 * Procesa la sincronización pendiente con el STO.
 */
function _jaraba_andalucia_ei_process_sto_sync(): void {
  $storage = \Drupal::entityTypeManager()->getStorage('programa_participante_ei');

  // Buscar participantes con sync pendiente.
  $pendingIds = $storage->getQuery()
    ->accessCheck(FALSE)
    ->condition('sto_sync_status', 'pending')
    ->range(0, 50)
    ->execute();

  if (empty($pendingIds)) {
    return;
  }

  $participantes = $storage->loadMultiple($pendingIds);
  $exporter = \Drupal::service('jaraba_andalucia_ei.sto_export');

  foreach ($participantes as $participante) {
    try {
      $result = $exporter->syncParticipante($participante);
      $participante->set('sto_sync_status', $result ? 'synced' : 'error');
      $participante->save();
    }
    catch (\Exception $e) {
      $participante->set('sto_sync_status', 'error');
      $participante->save();
      \Drupal::logger('jaraba_andalucia_ei')->error(
        'Error sincronizando participante @id: @message',
        ['@id' => $participante->id(), '@message' => $e->getMessage()]
      );
    }
  }

  \Drupal::logger('jaraba_andalucia_ei')->info(
    'Sincronización STO: @count participantes procesados',
    ['@count' => count($participantes)]
  );
}

// =============================================================================
// FASE 10: UPGRADE TRIGGERS + CRM INTEGRATION
// Plan Elevación Andalucía +ei v1
// =============================================================================

/**
 * Dispara un upgrade trigger para el vertical andalucia_ei.
 *
 * Wrapper seguro que verifica la disponibilidad del servicio
 * antes de disparar. Falla silenciosamente si no está disponible.
 *
 * @param string $triggerType
 *   Tipo de trigger (limit_reached, first_milestone, etc.).
 * @param \Drupal\Core\Entity\EntityInterface $participante
 *   Entidad ProgramaParticipanteEi.
 * @param array $context
 *   Datos adicionales del trigger.
 */
function _jaraba_andalucia_ei_fire_upgrade_trigger(string $triggerType, $participante, array $context = []): void {
  if (!\Drupal::hasService('ecosistema_jaraba_core.upgrade_trigger')) {
    return;
  }

  try {
    // @todo CONS-N10: Move to service class for proper DI.
    $tenantContext = \Drupal::service('ecosistema_jaraba_core.tenant_context');
    $tenant = $tenantContext->getCurrentTenant();

    if (!$tenant) {
      return;
    }

    $context['vertical'] = 'andalucia_ei';
    \Drupal::service('ecosistema_jaraba_core.upgrade_trigger')
      ->fire($triggerType, $tenant, $context);

    \Drupal::logger('jaraba_andalucia_ei')->info(
      'Upgrade trigger @type fired for participant @id',
      ['@type' => $triggerType, '@id' => $participante->id()]
    );
  }
  catch (\Exception $e) {
    // Non-critical — silently fail.
  }
}

/**
 * Verifica hitos de horas y dispara upgrade triggers.
 *
 * Compara horas totales antes y después de la actualización.
 * Dispara trigger en hitos: 25h, 50h, 75h, 100h.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   Participante actualizado (con ->original disponible).
 */
function _jaraba_andalucia_ei_check_hour_milestones($entity): void {
  if (!$entity->original) {
    return;
  }

  $totalNow = (float) ($entity->get('horas_mentoria_ia')->value ?? 0)
    + (float) ($entity->get('horas_mentoria_humana')->value ?? 0)
    + (float) ($entity->get('horas_orientacion_ind')->value ?? 0)
    + (float) ($entity->get('horas_orientacion_grup')->value ?? 0)
    + (float) ($entity->get('horas_formacion')->value ?? 0);

  $totalBefore = (float) ($entity->original->get('horas_mentoria_ia')->value ?? 0)
    + (float) ($entity->original->get('horas_mentoria_humana')->value ?? 0)
    + (float) ($entity->original->get('horas_orientacion_ind')->value ?? 0)
    + (float) ($entity->original->get('horas_orientacion_grup')->value ?? 0)
    + (float) ($entity->original->get('horas_formacion')->value ?? 0);

  $milestones = [25, 50, 75, 100];
  foreach ($milestones as $milestone) {
    if ($totalNow >= $milestone && $totalBefore < $milestone) {
      _jaraba_andalucia_ei_fire_upgrade_trigger('first_milestone', $entity, [
        'milestone' => "{$milestone}h",
      ]);

      // Disparar secuencia de email en hito de horas.
      $milestoneOwnerId = (int) $entity->getOwnerId();
      _jaraba_andalucia_ei_enroll_email_sequence($milestoneOwnerId, 'SEQ_AEI_003');

      // Fase 12: Track training milestone conversions.
      if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_experiment')) {
        try {
          $eventMap = [10 => 'orientation_10h', 50 => 'training_50h'];
          $convEvent = $eventMap[$milestone] ?? NULL;
          if ($convEvent) {
            \Drupal::service('ecosistema_jaraba_core.andalucia_ei_experiment')
              ->trackConversion($milestoneOwnerId, $convEvent);
          }
        }
        catch (\Exception $e) {
          // Non-critical.
        }
      }

      \Drupal::logger('jaraba_andalucia_ei')->notice(
        'Hour milestone @milestone reached for participant @id',
        ['@milestone' => "{$milestone}h", '@id' => $entity->id()]
      );
    }
  }
}

/**
 * Sincroniza la transición de fase con el CRM pipeline.
 *
 * Crea una actividad CRM cuando un participante cambia de fase.
 * Mapea fases Andalucía +ei a stages CRM estándar.
 *
 * @param \Drupal\Core\Entity\EntityInterface $participante
 *   Participante con fase actualizada.
 * @param string $newFase
 *   Nueva fase del participante.
 */
function _jaraba_andalucia_ei_sync_to_crm($participante, string $newFase): void {
  if (!\Drupal::hasService('jaraba_crm.activity')) {
    return;
  }

  $crmMapping = [
    'atencion' => 'lead',
    'insercion' => 'sql',
    'baja' => 'closed_lost',
  ];

  try {
    $activity = \Drupal::service('jaraba_crm.activity');
    $stage = $crmMapping[$newFase] ?? 'lead';
    $owner = $participante->getOwner();

    if (!$owner) {
      return;
    }

    $totalHoras = (float) ($participante->get('horas_mentoria_ia')->value ?? 0)
      + (float) ($participante->get('horas_mentoria_humana')->value ?? 0)
      + (float) ($participante->get('horas_orientacion_ind')->value ?? 0)
      + (float) ($participante->get('horas_orientacion_grup')->value ?? 0);

    $activity->logActivity([
      'type' => 'phase_transition',
      'contact_email' => $owner->getEmail(),
      'stage' => $stage,
      'data' => [
        'fase' => $newFase,
        'programa' => 'andalucia_ei',
        'horas_orientacion' => $totalHoras,
        'horas_formacion' => (float) ($participante->get('horas_formacion')->value ?? 0),
      ],
    ]);

    \Drupal::logger('jaraba_andalucia_ei')->info(
      'CRM sync: participant @id transitioned to @fase (stage: @stage)',
      ['@id' => $participante->id(), '@fase' => $newFase, '@stage' => $stage]
    );
  }
  catch (\Throwable $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'CRM sync error for participant @id: @message',
      ['@id' => $participante->id(), '@message' => $e->getMessage()]
    );
  }
}

/**
 * Inscribe un usuario en una secuencia de email Andalucía +ei.
 *
 * Wrapper seguro para AndaluciaEiEmailSequenceService::enroll().
 *
 * @param int $userId
 *   ID del usuario.
 * @param string $sequenceKey
 *   Clave de la secuencia (SEQ_AEI_001..SEQ_AEI_006).
 */
function _jaraba_andalucia_ei_enroll_email_sequence(int $userId, string $sequenceKey): void {
  if (!\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_email_sequence')) {
    return;
  }

  try {
    \Drupal::service('ecosistema_jaraba_core.andalucia_ei_email_sequence')
      ->enroll($userId, $sequenceKey);
  }
  catch (\Exception $e) {
    // Non-critical — silently fail.
  }
}

// =============================================================================
// FASE 12: CRON ENHANCEMENTS — PROACTIVE EVALUATION + REENGAGEMENT
// Plan Elevación Andalucía +ei v1
// =============================================================================

/**
 * Implements hook_cron() — extended for Phase 12.
 *
 * Added to the existing hook_cron via separate execution block.
 * Runs proactive evaluation batch and re-engagement checks every 24h.
 */
function _jaraba_andalucia_ei_cron_proactive_evaluation(): void {
  $state = \Drupal::state();
  $lastRun = $state->get('jaraba_andalucia_ei.proactive_last_run', 0);
  $now = \Drupal::time()->getRequestTime();

  // Run every 24 hours.
  if ($now - $lastRun < 24 * 3600) {
    return;
  }

  $state->set('jaraba_andalucia_ei.proactive_last_run', $now);

  // Batch evaluate proactive journey rules.
  if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_journey_progression')) {
    try {
      $processed = \Drupal::service('ecosistema_jaraba_core.andalucia_ei_journey_progression')
        ->evaluateBatch();
      \Drupal::logger('jaraba_andalucia_ei')->info(
        'Proactive evaluation: @count participants processed',
        ['@count' => $processed]
      );
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_andalucia_ei')->error(
        'Proactive evaluation error: @message',
        ['@message' => $e->getMessage()]
      );
    }
  }

  // Re-engagement: detect inactive participants (14+ days).
  _jaraba_andalucia_ei_check_reengagement();
}

/**
 * Detects inactive participants and enrolls them in reengagement sequence.
 *
 * Checks for participants with no activity in 14+ days and enrolls
 * them in SEQ_AEI_005 (Inactivity Reengagement).
 */
function _jaraba_andalucia_ei_check_reengagement(): void {
  try {
    $storage = \Drupal::entityTypeManager()->getStorage('programa_participante_ei');
    $fourteenDaysAgo = \Drupal::time()->getRequestTime() - (14 * 86400);

    $inactiveIds = $storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('fase_actual', 'baja', '<>')
      ->condition('changed', $fourteenDaysAgo, '<')
      ->range(0, 100)
      ->execute();

    if (empty($inactiveIds)) {
      return;
    }

    $participants = $storage->loadMultiple($inactiveIds);
    $enrolled = 0;

    foreach ($participants as $participant) {
      $userId = (int) ($participant->getOwnerId() ?? 0);
      if ($userId) {
        // Check if already enrolled (avoid duplicates via state).
        $stateKey = "andalucia_ei_reengagement_sent_{$userId}";
        $lastSent = \Drupal::state()->get($stateKey, 0);
        if ($lastSent && (\Drupal::time()->getRequestTime() - $lastSent) < (30 * 86400)) {
          continue;
        }

        _jaraba_andalucia_ei_enroll_email_sequence($userId, 'SEQ_AEI_005');
        \Drupal::state()->set($stateKey, \Drupal::time()->getRequestTime());
        $enrolled++;
      }
    }

    if ($enrolled > 0) {
      \Drupal::logger('jaraba_andalucia_ei')->info(
        'Re-engagement: @count inactive participants enrolled in SEQ_AEI_005',
        ['@count' => $enrolled]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'Re-engagement check error: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

// =============================================================================
// LANDING PAGE: OG TAGS, SCHEMA.ORG, BODY CLASSES
// =============================================================================

/**
 * Implements hook_page_attachments().
 *
 * Adds Open Graph and Schema.org structured data for the landing page.
 */
function jaraba_andalucia_ei_page_attachments(array &$attachments): void {
  $route = \Drupal::routeMatch()->getRouteName();
  if ($route !== 'jaraba_andalucia_ei.landing') {
    return;
  }

  $request = \Drupal::request();
  $currentUrl = $request->getSchemeAndHttpHost() . $request->getRequestUri();

  $title = t('Programa Andalucia +ei — Emprendimiento Aumentado con IA');
  $description = t('Programa gratuito de emprendimiento, formacion certificada y mentoria con inteligencia artificial para personas desempleadas en Andalucia.');

  // Open Graph meta tags.
  $og_tags = [
    'og:title' => (string) $title,
    'og:description' => (string) $description,
    'og:url' => $currentUrl,
    'og:type' => 'website',
    'og:site_name' => 'Jaraba Impact Platform',
    'twitter:card' => 'summary_large_image',
    'twitter:title' => (string) $title,
    'twitter:description' => (string) $description,
  ];

  foreach ($og_tags as $property => $content) {
    $tag_name = str_starts_with($property, 'twitter:') ? 'name' : 'property';
    $attachments['#attached']['html_head'][] = [
      [
        '#tag' => 'meta',
        '#attributes' => [
          $tag_name => $property,
          'content' => $content,
        ],
      ],
      'andalucia_ei_' . str_replace([':', '/'], '_', $property),
    ];
  }

  // Schema.org JSON-LD (Course + EducationalOrganization).
  $schema = [
    '@context' => 'https://schema.org',
    '@type' => 'Course',
    'name' => (string) $title,
    'description' => (string) $description,
    'url' => $currentUrl,
    'provider' => [
      '@type' => 'EducationalOrganization',
      'name' => 'Jaraba Impact Platform',
      'url' => $request->getSchemeAndHttpHost(),
    ],
    'isAccessibleForFree' => TRUE,
    'coursePrerequisites' => (string) t('Residencia en Andalucia y situacion de desempleo'),
    'educationalLevel' => 'beginner',
    'inLanguage' => 'es',
    'offers' => [
      '@type' => 'Offer',
      'price' => '0',
      'priceCurrency' => 'EUR',
      'availability' => 'https://schema.org/LimitedAvailability',
    ],
  ];

  $attachments['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'script',
      '#attributes' => ['type' => 'application/ld+json'],
      '#value' => json_encode($schema, JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE),
    ],
    'andalucia_ei_schema_org',
  ];
}

/**
 * Implements hook_preprocess_html().
 *
 * Adds body classes for Andalucia +ei pages.
 */
function jaraba_andalucia_ei_preprocess_html(array &$variables): void {
  $route = \Drupal::routeMatch()->getRouteName() ?? '';

  if (str_starts_with($route, 'jaraba_andalucia_ei.')) {
    $variables['attributes']['class'][] = 'page-andalucia-ei';

    if ($route === 'jaraba_andalucia_ei.landing') {
      $variables['attributes']['class'][] = 'page-andalucia-ei--landing';
    }
    elseif ($route === 'jaraba_andalucia_ei.solicitar') {
      $variables['attributes']['class'][] = 'page-andalucia-ei--solicitar';
    }
    elseif ($route === 'jaraba_andalucia_ei.dashboard') {
      $variables['attributes']['class'][] = 'page-andalucia-ei--dashboard';
    }
    elseif ($route === 'jaraba_andalucia_ei.participante_portal') {
      $variables['attributes']['class'][] = 'page-andalucia-ei--portal';
    }
  }
}

// =============================================================================
// FASE 8: SEO — SITEMAP ENTRIES
// =============================================================================

/**
 * Implements hook_simple_sitemap_links_alter().
 *
 * Adds Andalucía +ei public pages to the sitemap.
 */
function jaraba_andalucia_ei_simple_sitemap_links_alter(array &$links, $sitemap_variant): void {
  // Landing page — high priority.
  $links[] = [
    'url' => '/andalucia-ei/programa',
    'priority' => 0.9,
    'changefreq' => 'weekly',
    'lastmod' => date('Y-m-d'),
  ];

  // Application form.
  $links[] = [
    'url' => '/andalucia-ei/solicitar',
    'priority' => 0.8,
    'changefreq' => 'monthly',
    'lastmod' => date('Y-m-d'),
  ];

  // Lead magnet / guide.
  $links[] = [
    'url' => '/andalucia-ei/guia-participante',
    'priority' => 0.6,
    'changefreq' => 'monthly',
    'lastmod' => date('Y-m-d'),
  ];
}
