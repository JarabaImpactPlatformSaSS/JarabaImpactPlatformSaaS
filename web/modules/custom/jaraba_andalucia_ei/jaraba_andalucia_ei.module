<?php

declare(strict_types=1);

/**
 * @file
 * M√≥dulo principal para el Programa Andaluc√≠a +ei.
 *
 * Gestiona participantes del programa con tracking de horas de mentor√≠a IA,
 * integraci√≥n con STO y transiciones de fase PIIL.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function jaraba_andalucia_ei_help(string $route_name, RouteMatchInterface $route_match): string {
  if ($route_name === 'help.page.jaraba_andalucia_ei') {
    return '<p>' . t('Gesti√≥n del Programa Andaluc√≠a +ei - Emprendimiento Aumentado con IA.') . '</p>';
  }
  return '';
}

/**
 * Implements hook_theme().
 */
function jaraba_andalucia_ei_theme(): array {
  return [
    'andalucia_ei_dashboard' => [
      'variables' => [
        'participante' => NULL,
        'is_admin' => FALSE,
        'health_score' => NULL,
        'bridges' => [],
        'proactive_action' => NULL,
      ],
      'template' => 'andalucia-ei-dashboard',
    ],
    'solicitud_ei_page' => [
      'variables' => [
        'form' => NULL,
      ],
      'template' => 'solicitud-ei-page',
    ],
  ];
}

// =============================================================================
// ECA-EI-001: CONTABILIZAR HORAS IA AL FINALIZAR SESI√ìN COPILOT
// Ver: docs/tecnicos/20260203-Plan_Implementacion_Docs_45_46_v1_Claude.md
// =============================================================================

/**
 * Implements hook_ENTITY_TYPE_update() for copilot_session.
 *
 * Contabiliza autom√°ticamente las horas de mentor√≠a IA cuando finaliza
 * una sesi√≥n con el Copilot v2.
 */
function jaraba_andalucia_ei_copilot_session_update(\Drupal\Core\Entity\EntityInterface $entity): void {
  // Solo procesar si la sesi√≥n pasa a 'completed'.
  if (!$entity->hasField('status')) {
    return;
  }

  $newStatus = $entity->get('status')->value ?? '';
  $oldStatus = $entity->original->get('status')->value ?? '';

  if ($oldStatus !== 'completed' && $newStatus === 'completed') {
    _jaraba_andalucia_ei_track_ia_hours($entity);
  }
}

/**
 * Registra las horas de sesi√≥n IA en el participante Andaluc√≠a +ei.
 *
 * @param \Drupal\Core\Entity\EntityInterface $session
 *   Sesi√≥n de Copilot completada.
 */
function _jaraba_andalucia_ei_track_ia_hours(\Drupal\Core\Entity\EntityInterface $session): void {
  try {
    $userId = $session->getOwnerId();
    if (!$userId) {
      return;
    }

    // Buscar participante vinculado.
    $storage = \Drupal::entityTypeManager()->getStorage('programa_participante_ei');
    $participantes = $storage->loadByProperties(['user_id' => $userId]);
    $participante = reset($participantes);

    if (!$participante) {
      return;
    }

    // Calcular duraci√≥n de sesi√≥n (en horas).
    $duracionMinutos = $session->get('duration_minutes')->value ?? 0;
    $duracionHoras = (float) $duracionMinutos / 60;

    // Aplicar l√≠mite diario seg√∫n configuraci√≥n (default: 2h/d√≠a).
    $config = \Drupal::config('jaraba_andalucia_ei.settings');
    $limiteDiario = (float) ($config->get('ai_mentorship_daily_limit') ?? 2);

    // Verificar horas ya registradas hoy.
    $tracker = \Drupal::service('jaraba_andalucia_ei.ai_mentorship_tracker');
    $horasHoy = $tracker->getHoursToday($participante);
    $horasRestantes = max(0, $limiteDiario - $horasHoy);
    $horasARegistrar = min($duracionHoras, $horasRestantes);

    if ($horasARegistrar > 0) {
      $horasActuales = (float) ($participante->get('horas_mentoria_ia')->value ?? 0);
      $participante->set('horas_mentoria_ia', $horasActuales + $horasARegistrar);
      $participante->save();

      // Registrar en auditor√≠a.
      $tracker->recordSession($participante, $horasARegistrar, $session->id());

      // Feature Gate: registrar uso diario de copilot.
      // Plan Elevaci√≥n Andaluc√≠a +ei v1 ‚Äî Fase 10.
      if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_feature_gate')) {
        \Drupal::service('ecosistema_jaraba_core.andalucia_ei_feature_gate')
          ->recordUsage($userId, 'copilot_sessions_daily');
      }

      // Fase 12: Track first_ia_session conversion si es la primera sesi√≥n.
      if ($horasActuales <= 0 && \Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_experiment')) {
        try {
          \Drupal::service('ecosistema_jaraba_core.andalucia_ei_experiment')
            ->trackConversion($userId, 'first_ia_session');
        }
        catch (\Exception $e) {
          // Non-critical.
        }
      }

      \Drupal::logger('jaraba_andalucia_ei')->info(
        'Registradas @horas horas IA para participante @dni (sesi√≥n @session)',
        [
          '@horas' => number_format($horasARegistrar, 2),
          '@dni' => $participante->label(),
          '@session' => $session->id(),
        ]
      );
    }
    else {
      // L√≠mite diario alcanzado ‚Äî disparar upgrade trigger.
      // Plan Elevaci√≥n Andaluc√≠a +ei v1 ‚Äî Fase 10.
      _jaraba_andalucia_ei_fire_upgrade_trigger('limit_reached', $participante, [
        'feature' => 'copilot_sessions_daily',
        'vertical' => 'andalucia_ei',
      ]);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'Error al registrar horas IA: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

// =============================================================================
// FASE 12: EMBUDO P√öBLICO ‚Üí REGISTRO ‚Üí VENTAS
// Onboarding enrollment + conversion tracking on participant creation.
// =============================================================================

/**
 * Implements hook_ENTITY_TYPE_insert() for programa_participante_ei.
 *
 * On participant creation:
 * 1. Enrolls in SEQ_AEI_001 (Welcome Participant) email sequence.
 * 2. Tracks 'participant_enrolled' conversion event for A/B testing.
 * 3. Syncs initial CRM lead stage.
 */
function jaraba_andalucia_ei_programa_participante_ei_insert(\Drupal\Core\Entity\EntityInterface $entity): void {
  $userId = (int) ($entity->getOwnerId() ?? 0);
  if (!$userId) {
    return;
  }

  // 1. Welcome email sequence.
  _jaraba_andalucia_ei_enroll_email_sequence($userId, 'SEQ_AEI_001');

  // 2. A/B conversion tracking.
  if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_experiment')) {
    try {
      \Drupal::service('ecosistema_jaraba_core.andalucia_ei_experiment')
        ->trackConversion($userId, 'participant_enrolled');
    }
    catch (\Exception $e) {
      // Non-critical.
    }
  }

  // 3. Initial CRM sync (lead stage).
  _jaraba_andalucia_ei_sync_to_crm($entity, 'atencion');

  \Drupal::logger('jaraba_andalucia_ei')->info(
    'New participant @id enrolled: welcome email + CRM lead created',
    ['@id' => $entity->id()]
  );
}

// =============================================================================
// ECA-EI-002: NOTIFICAR ELEGIBILIDAD PARA FASE INSERCI√ìN
// =============================================================================

/**
 * Implements hook_ENTITY_TYPE_update() for programa_participante_ei.
 *
 * Detecta cuando un participante cumple requisitos para avanzar a fase
 * Inserci√≥n y notifica al equipo t√©cnico.
 */
function jaraba_andalucia_ei_programa_participante_ei_update(\Drupal\Core\Entity\EntityInterface $entity): void {
  // Solo en fase Atenci√≥n.
  if ($entity->getFaseActual() !== 'atencion') {
    return;
  }

  // Verificar si ahora cumple requisitos.
  if ($entity->canTransitToInsercion()) {
    // Verificar si antes no los cumpl√≠a (para evitar notificaciones duplicadas).
    $original = $entity->original;
    if (!$original || !$original->canTransitToInsercion()) {
      _jaraba_andalucia_ei_notify_eligibility($entity);
    }
  }

  // Plan Elevaci√≥n Andaluc√≠a +ei v1 ‚Äî Fase 10: Upgrade Triggers en hitos.
  _jaraba_andalucia_ei_check_hour_milestones($entity);

  // Plan Elevaci√≥n Andaluc√≠a +ei v1 ‚Äî Fase 10: CRM sync en transici√≥n de fase.
  $originalFase = $entity->original ? ($entity->original->getFaseActual() ?? 'atencion') : 'atencion';
  $newFase = $entity->getFaseActual() ?? 'atencion';
  if ($originalFase !== $newFase) {
    _jaraba_andalucia_ei_sync_to_crm($entity, $newFase);

    // Disparar email sequence en transici√≥n a inserci√≥n.
    if ($newFase === 'insercion') {
      $ownerIdForSeq = (int) $entity->getOwnerId();
      _jaraba_andalucia_ei_enroll_email_sequence($ownerIdForSeq, 'SEQ_AEI_002');

      // Fase 12: Track phase_insertion conversion.
      if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_experiment')) {
        try {
          \Drupal::service('ecosistema_jaraba_core.andalucia_ei_experiment')
            ->trackConversion($ownerIdForSeq, 'phase_insertion');
        }
        catch (\Exception $e) {
          // Non-critical.
        }
      }
    }
  }
}

/**
 * Env√≠a notificaci√≥n de elegibilidad para fase Inserci√≥n.
 *
 * @param \Drupal\jaraba_andalucia_ei\Entity\ProgramaParticipanteEiInterface $participante
 *   Participante elegible.
 */
function _jaraba_andalucia_ei_notify_eligibility($participante): void {
  try {
    $mailManager = \Drupal::service('plugin.manager.mail');

    // Obtener email del t√©cnico/orientador.
    $config = \Drupal::config('jaraba_andalucia_ei.settings');
    $emailTecnicos = $config->get('notification_email') ?? 'orientacion@agentejaraba.es';

    $params = [
      'participante_dni' => $participante->getDniNie(),
      'participante_id' => $participante->id(),
      'horas_orientacion' => $participante->getTotalHorasOrientacion(),
      'horas_formacion' => $participante->get('horas_formacion')->value ?? 0,
    ];

    $mailManager->mail(
      'jaraba_andalucia_ei',
      'eligibility_notification',
      $emailTecnicos,
      'es',
      $params,
      NULL,
      TRUE
    );

    \Drupal::logger('jaraba_andalucia_ei')->notice(
      'Notificaci√≥n de elegibilidad enviada para participante @dni',
      ['@dni' => $participante->getDniNie()]
    );
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'Error al enviar notificaci√≥n de elegibilidad: @message',
      ['@message' => $e->getMessage()]
    );
  }
}

/**
 * Implements hook_mail().
 */
function jaraba_andalucia_ei_mail(string $key, array &$message, array $params): void {
  switch ($key) {
    case 'eligibility_notification':
      $message['subject'] = t('Participante elegible para Fase Inserci√≥n - Andaluc√≠a +ei');
      $message['body'][] = t(
        "El participante con DNI @dni ha alcanzado los requisitos m√≠nimos para avanzar a la Fase de Inserci√≥n:\n\n" .
        "- Horas de orientaci√≥n: @orient h (m√≠nimo: 10h)\n" .
        "- Horas de formaci√≥n: @form h (m√≠nimo: 50h)\n\n" .
        "Acceda a la ficha del participante para aprobar la transici√≥n:\n" .
        "@url",
        [
          '@dni' => $params['participante_dni'] ?? '',
          '@orient' => number_format($params['horas_orientacion'] ?? 0, 1),
          '@form' => number_format($params['horas_formacion'] ?? 0, 1),
          '@url' => \Drupal\Core\Url::fromRoute(
            'entity.programa_participante_ei.edit_form',
            ['programa_participante_ei' => $params['participante_id'] ?? 0],
            ['absolute' => TRUE]
          )->toString(),
        ]
      );
      break;

    case 'nueva_solicitud':
      // Preparar info de triaje IA si disponible.
      $ai_info = '';
      if (!empty($params['ai_score'])) {
        $ai_info = "\n\n--- TRIAJE IA ---\n" .
          "Puntuaci√≥n: " . $params['ai_score'] . "/100\n" .
          "Recomendaci√≥n: " . strtoupper($params['ai_recomendacion'] ?? 'pendiente') . "\n" .
          "Justificaci√≥n: " . ($params['ai_justificacion'] ?? 'No disponible');
      }

      $message['subject'] = t('Nueva solicitud Andaluc√≠a +ei: @nombre', [
        '@nombre' => $params['nombre'] ?? 'Sin nombre',
      ]);
      $message['body'][] = t(
        "Se ha recibido una nueva solicitud de participaci√≥n en Andaluc√≠a +ei:\n\n" .
        "Nombre: @nombre\n" .
        "Email: @email\n" .
        "Tel√©fono: @telefono\n" .
        "Provincia: @provincia\n" .
        "Colectivo inferido: @colectivo\n" .
        "@ai_info\n\n" .
        "Revisar solicitud:\n@url",
        [
          '@nombre' => $params['nombre'] ?? '',
          '@email' => $params['email'] ?? '',
          '@telefono' => $params['telefono'] ?? '',
          '@provincia' => $params['provincia'] ?? '',
          '@colectivo' => $params['colectivo'] ?? 'Sin determinar',
          '@ai_info' => $ai_info,
          '@url' => $params['solicitud_url'] ?? '',
        ]
      );
      break;

    case 'confirmacion_solicitud':
      $message['subject'] = t('Tu solicitud Andaluc√≠a +ei ha sido recibida ‚úÖ');
      $message['body'][] = t(
        "Hola @nombre,\n\n" .
        "Hemos recibido correctamente tu solicitud de participaci√≥n en el programa Andaluc√≠a +ei.\n\n" .
        "üìã RESUMEN DE TU SOLICITUD:\n" .
        "- Programa: Andaluc√≠a +ei ‚Äî Emprendimiento Aumentado con IA\n" .
        "- Colectivo asignado: @colectivo\n\n" .
        "üìå PR√ìXIMOS PASOS:\n" .
        "1. Nuestro equipo revisar√° tu solicitud en los pr√≥ximos d√≠as laborables.\n" .
        "2. Te contactaremos por tel√©fono o email para confirmar tu participaci√≥n.\n" .
        "3. Si tienes cualquier duda, escr√≠benos por WhatsApp al +34 623 174 304.\n\n" .
        "¬°Gracias por tu inter√©s en emprender con nosotros!\n\n" .
        "‚Äî Equipo Andaluc√≠a +ei\n" .
        "Jaraba Impact Platform",
        [
          '@nombre' => $params['nombre'] ?? '',
          '@colectivo' => $params['colectivo'] ?? 'Por determinar',
        ]
      );
      break;
  }
}

// =============================================================================
// ECA-EI-003: SINCRONIZACI√ìN PERI√ìDICA CON STO (via Cron)
// =============================================================================

/**
 * Implements hook_cron().
 *
 * Sincronizaci√≥n peri√≥dica de datos con el Sistema Telem√°tico del STO.
 */
function jaraba_andalucia_ei_cron(): void {
  // Solo ejecutar cada 6 horas.
  $state = \Drupal::state();
  $lastRun = $state->get('jaraba_andalucia_ei.sto_sync_last_run', 0);
  $now = \Drupal::time()->getRequestTime();

  if ($now - $lastRun < 6 * 3600) {
    return;
  }

  $state->set('jaraba_andalucia_ei.sto_sync_last_run', $now);

  \Drupal::logger('jaraba_andalucia_ei')->info('Iniciando sincronizaci√≥n STO...');

  try {
    // Procesar participantes pendientes de sincronizaci√≥n.
    _jaraba_andalucia_ei_process_sto_sync();
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'Error en sincronizaci√≥n STO: @message',
      ['@message' => $e->getMessage()]
    );
  }

  // Plan Elevaci√≥n Andaluc√≠a +ei v1 ‚Äî Fase 10/12:
  // Proactive AI evaluation + re-engagement (runs on its own 24h timer).
  _jaraba_andalucia_ei_cron_proactive_evaluation();
}

/**
 * Procesa la sincronizaci√≥n pendiente con el STO.
 */
function _jaraba_andalucia_ei_process_sto_sync(): void {
  $storage = \Drupal::entityTypeManager()->getStorage('programa_participante_ei');

  // Buscar participantes con sync pendiente.
  $pendingIds = $storage->getQuery()
    ->accessCheck(FALSE)
    ->condition('sto_sync_status', 'pending')
    ->range(0, 50)
    ->execute();

  if (empty($pendingIds)) {
    return;
  }

  $participantes = $storage->loadMultiple($pendingIds);
  $exporter = \Drupal::service('jaraba_andalucia_ei.sto_export');

  foreach ($participantes as $participante) {
    try {
      $result = $exporter->syncParticipante($participante);
      $participante->set('sto_sync_status', $result ? 'synced' : 'error');
      $participante->save();
    }
    catch (\Exception $e) {
      $participante->set('sto_sync_status', 'error');
      $participante->save();
      \Drupal::logger('jaraba_andalucia_ei')->error(
        'Error sincronizando participante @id: @message',
        ['@id' => $participante->id(), '@message' => $e->getMessage()]
      );
    }
  }

  \Drupal::logger('jaraba_andalucia_ei')->info(
    'Sincronizaci√≥n STO: @count participantes procesados',
    ['@count' => count($participantes)]
  );
}

// =============================================================================
// FASE 10: UPGRADE TRIGGERS + CRM INTEGRATION
// Plan Elevaci√≥n Andaluc√≠a +ei v1
// =============================================================================

/**
 * Dispara un upgrade trigger para el vertical andalucia_ei.
 *
 * Wrapper seguro que verifica la disponibilidad del servicio
 * antes de disparar. Falla silenciosamente si no est√° disponible.
 *
 * @param string $triggerType
 *   Tipo de trigger (limit_reached, first_milestone, etc.).
 * @param \Drupal\Core\Entity\EntityInterface $participante
 *   Entidad ProgramaParticipanteEi.
 * @param array $context
 *   Datos adicionales del trigger.
 */
function _jaraba_andalucia_ei_fire_upgrade_trigger(string $triggerType, $participante, array $context = []): void {
  if (!\Drupal::hasService('ecosistema_jaraba_core.upgrade_trigger')) {
    return;
  }

  try {
    // @todo CONS-N10: Move to service class for proper DI.
    $tenantContext = \Drupal::service('ecosistema_jaraba_core.tenant_context');
    $tenant = $tenantContext->getCurrentTenant();

    if (!$tenant) {
      return;
    }

    $context['vertical'] = 'andalucia_ei';
    \Drupal::service('ecosistema_jaraba_core.upgrade_trigger')
      ->fire($triggerType, $tenant, $context);

    \Drupal::logger('jaraba_andalucia_ei')->info(
      'Upgrade trigger @type fired for participant @id',
      ['@type' => $triggerType, '@id' => $participante->id()]
    );
  }
  catch (\Exception $e) {
    // Non-critical ‚Äî silently fail.
  }
}

/**
 * Verifica hitos de horas y dispara upgrade triggers.
 *
 * Compara horas totales antes y despu√©s de la actualizaci√≥n.
 * Dispara trigger en hitos: 25h, 50h, 75h, 100h.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   Participante actualizado (con ->original disponible).
 */
function _jaraba_andalucia_ei_check_hour_milestones($entity): void {
  if (!$entity->original) {
    return;
  }

  $totalNow = (float) ($entity->get('horas_mentoria_ia')->value ?? 0)
    + (float) ($entity->get('horas_mentoria_humana')->value ?? 0)
    + (float) ($entity->get('horas_orientacion_ind')->value ?? 0)
    + (float) ($entity->get('horas_orientacion_grup')->value ?? 0)
    + (float) ($entity->get('horas_formacion')->value ?? 0);

  $totalBefore = (float) ($entity->original->get('horas_mentoria_ia')->value ?? 0)
    + (float) ($entity->original->get('horas_mentoria_humana')->value ?? 0)
    + (float) ($entity->original->get('horas_orientacion_ind')->value ?? 0)
    + (float) ($entity->original->get('horas_orientacion_grup')->value ?? 0)
    + (float) ($entity->original->get('horas_formacion')->value ?? 0);

  $milestones = [25, 50, 75, 100];
  foreach ($milestones as $milestone) {
    if ($totalNow >= $milestone && $totalBefore < $milestone) {
      _jaraba_andalucia_ei_fire_upgrade_trigger('first_milestone', $entity, [
        'milestone' => "{$milestone}h",
      ]);

      // Disparar secuencia de email en hito de horas.
      $milestoneOwnerId = (int) $entity->getOwnerId();
      _jaraba_andalucia_ei_enroll_email_sequence($milestoneOwnerId, 'SEQ_AEI_003');

      // Fase 12: Track training milestone conversions.
      if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_experiment')) {
        try {
          $eventMap = [10 => 'orientation_10h', 50 => 'training_50h'];
          $convEvent = $eventMap[$milestone] ?? NULL;
          if ($convEvent) {
            \Drupal::service('ecosistema_jaraba_core.andalucia_ei_experiment')
              ->trackConversion($milestoneOwnerId, $convEvent);
          }
        }
        catch (\Exception $e) {
          // Non-critical.
        }
      }

      \Drupal::logger('jaraba_andalucia_ei')->notice(
        'Hour milestone @milestone reached for participant @id',
        ['@milestone' => "{$milestone}h", '@id' => $entity->id()]
      );
    }
  }
}

/**
 * Sincroniza la transici√≥n de fase con el CRM pipeline.
 *
 * Crea una actividad CRM cuando un participante cambia de fase.
 * Mapea fases Andaluc√≠a +ei a stages CRM est√°ndar.
 *
 * @param \Drupal\Core\Entity\EntityInterface $participante
 *   Participante con fase actualizada.
 * @param string $newFase
 *   Nueva fase del participante.
 */
function _jaraba_andalucia_ei_sync_to_crm($participante, string $newFase): void {
  if (!\Drupal::hasService('jaraba_crm.activity')) {
    return;
  }

  $crmMapping = [
    'atencion' => 'lead',
    'insercion' => 'sql',
    'baja' => 'closed_lost',
  ];

  try {
    $activity = \Drupal::service('jaraba_crm.activity');
    $stage = $crmMapping[$newFase] ?? 'lead';
    $owner = $participante->getOwner();

    if (!$owner) {
      return;
    }

    $totalHoras = (float) ($participante->get('horas_mentoria_ia')->value ?? 0)
      + (float) ($participante->get('horas_mentoria_humana')->value ?? 0)
      + (float) ($participante->get('horas_orientacion_ind')->value ?? 0)
      + (float) ($participante->get('horas_orientacion_grup')->value ?? 0);

    $activity->logActivity([
      'type' => 'phase_transition',
      'contact_email' => $owner->getEmail(),
      'stage' => $stage,
      'data' => [
        'fase' => $newFase,
        'programa' => 'andalucia_ei',
        'horas_orientacion' => $totalHoras,
        'horas_formacion' => (float) ($participante->get('horas_formacion')->value ?? 0),
      ],
    ]);

    \Drupal::logger('jaraba_andalucia_ei')->info(
      'CRM sync: participant @id transitioned to @fase (stage: @stage)',
      ['@id' => $participante->id(), '@fase' => $newFase, '@stage' => $stage]
    );
  }
  catch (\Throwable $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'CRM sync error for participant @id: @message',
      ['@id' => $participante->id(), '@message' => $e->getMessage()]
    );
  }
}

/**
 * Inscribe un usuario en una secuencia de email Andaluc√≠a +ei.
 *
 * Wrapper seguro para AndaluciaEiEmailSequenceService::enroll().
 *
 * @param int $userId
 *   ID del usuario.
 * @param string $sequenceKey
 *   Clave de la secuencia (SEQ_AEI_001..SEQ_AEI_006).
 */
function _jaraba_andalucia_ei_enroll_email_sequence(int $userId, string $sequenceKey): void {
  if (!\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_email_sequence')) {
    return;
  }

  try {
    \Drupal::service('ecosistema_jaraba_core.andalucia_ei_email_sequence')
      ->enroll($userId, $sequenceKey);
  }
  catch (\Exception $e) {
    // Non-critical ‚Äî silently fail.
  }
}

// =============================================================================
// FASE 12: CRON ENHANCEMENTS ‚Äî PROACTIVE EVALUATION + REENGAGEMENT
// Plan Elevaci√≥n Andaluc√≠a +ei v1
// =============================================================================

/**
 * Implements hook_cron() ‚Äî extended for Phase 12.
 *
 * Added to the existing hook_cron via separate execution block.
 * Runs proactive evaluation batch and re-engagement checks every 24h.
 */
function _jaraba_andalucia_ei_cron_proactive_evaluation(): void {
  $state = \Drupal::state();
  $lastRun = $state->get('jaraba_andalucia_ei.proactive_last_run', 0);
  $now = \Drupal::time()->getRequestTime();

  // Run every 24 hours.
  if ($now - $lastRun < 24 * 3600) {
    return;
  }

  $state->set('jaraba_andalucia_ei.proactive_last_run', $now);

  // Batch evaluate proactive journey rules.
  if (\Drupal::hasService('ecosistema_jaraba_core.andalucia_ei_journey_progression')) {
    try {
      $processed = \Drupal::service('ecosistema_jaraba_core.andalucia_ei_journey_progression')
        ->evaluateBatch();
      \Drupal::logger('jaraba_andalucia_ei')->info(
        'Proactive evaluation: @count participants processed',
        ['@count' => $processed]
      );
    }
    catch (\Exception $e) {
      \Drupal::logger('jaraba_andalucia_ei')->error(
        'Proactive evaluation error: @message',
        ['@message' => $e->getMessage()]
      );
    }
  }

  // Re-engagement: detect inactive participants (14+ days).
  _jaraba_andalucia_ei_check_reengagement();
}

/**
 * Detects inactive participants and enrolls them in reengagement sequence.
 *
 * Checks for participants with no activity in 14+ days and enrolls
 * them in SEQ_AEI_005 (Inactivity Reengagement).
 */
function _jaraba_andalucia_ei_check_reengagement(): void {
  try {
    $storage = \Drupal::entityTypeManager()->getStorage('programa_participante_ei');
    $fourteenDaysAgo = \Drupal::time()->getRequestTime() - (14 * 86400);

    $inactiveIds = $storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('fase_actual', 'baja', '<>')
      ->condition('changed', $fourteenDaysAgo, '<')
      ->range(0, 100)
      ->execute();

    if (empty($inactiveIds)) {
      return;
    }

    $participants = $storage->loadMultiple($inactiveIds);
    $enrolled = 0;

    foreach ($participants as $participant) {
      $userId = (int) ($participant->getOwnerId() ?? 0);
      if ($userId) {
        // Check if already enrolled (avoid duplicates via state).
        $stateKey = "andalucia_ei_reengagement_sent_{$userId}";
        $lastSent = \Drupal::state()->get($stateKey, 0);
        if ($lastSent && (\Drupal::time()->getRequestTime() - $lastSent) < (30 * 86400)) {
          continue;
        }

        _jaraba_andalucia_ei_enroll_email_sequence($userId, 'SEQ_AEI_005');
        \Drupal::state()->set($stateKey, \Drupal::time()->getRequestTime());
        $enrolled++;
      }
    }

    if ($enrolled > 0) {
      \Drupal::logger('jaraba_andalucia_ei')->info(
        'Re-engagement: @count inactive participants enrolled in SEQ_AEI_005',
        ['@count' => $enrolled]
      );
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_andalucia_ei')->error(
      'Re-engagement check error: @message',
      ['@message' => $e->getMessage()]
    );
  }
}
