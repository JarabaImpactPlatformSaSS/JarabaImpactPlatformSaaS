<?php

/**
 * @file
 * Module file for Jaraba Facturae (Facturae 3.2.2 + FACe B2G).
 *
 * Provides electronic invoicing in Facturae 3.2.2 format with XAdES-EPES
 * digital signature and FACe portal integration for B2G invoicing
 * under Ley 25/2013.
 *
 * ECA Hooks:
 * - ECA-FA-001: Auto-generate Facturae when billing_invoice buyer is AAPP.
 * - ECA-FA-002: Sync FACe status every 4 hours via cron queue.
 * - ECA-FA-003: Weekly certificate expiry alerts.
 * - ECA-FA-004: Auto-generate PDF when document is signed.
 * - ECA-FA-005: Auto-generate corrective invoice on cancellation.
 *
 * Spec: Doc 180, Plan: FASES 6-8.
 */

declare(strict_types=1);

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function jaraba_facturae_theme(): array {
  return [
    'page__facturae' => [
      'variables' => [
        'facturae_stats' => [],
        'facturae_recent' => [],
        'certificate' => NULL,
        'has_certificate' => FALSE,
        'tenant_name' => '',
      ],
    ],
    'page__facturae_documents' => [
      'variables' => [],
    ],
    'facturae_dashboard' => [
      'variables' => [
        'facturae_stats' => [],
        'facturae_recent' => [],
      ],
    ],
    'facturae_documents' => [
      'variables' => [],
    ],
    'facturae_document_detail' => [
      'variables' => [
        'document' => NULL,
      ],
    ],
    'facturae_pdf_template' => [
      'variables' => [
        'document' => NULL,
        'signature_info' => [],
        'qr_data_uri' => '',
      ],
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_page_alter().
 */
function jaraba_facturae_theme_suggestions_page_alter(array &$suggestions, array $variables): void {
  $routeName = \Drupal::routeMatch()->getRouteName() ?? '';

  $routeMap = [
    'jaraba_facturae.dashboard' => 'page__facturae',
    'jaraba_facturae.documents' => 'page__facturae_documents',
    'jaraba_facturae.document_detail' => 'page__facturae_documents',
    'jaraba_facturae.face_log' => 'page__facturae',
    'jaraba_facturae.settings' => 'page__facturae',
    'jaraba_facturae.config' => 'page__facturae',
  ];

  if (isset($routeMap[$routeName])) {
    $suggestions[] = $routeMap[$routeName];
  }
}

/**
 * Implements hook_preprocess_html().
 */
function jaraba_facturae_preprocess_html(array &$variables): void {
  $routeName = \Drupal::routeMatch()->getRouteName() ?? '';

  if (!str_starts_with($routeName, 'jaraba_facturae.')) {
    return;
  }

  $variables['attributes']['class'][] = 'page--fiscal';
  $variables['attributes']['class'][] = 'page--clean-layout';

  $routeClasses = [
    'jaraba_facturae.dashboard' => 'page--facturae-dashboard',
    'jaraba_facturae.documents' => 'page--facturae-documents',
    'jaraba_facturae.document_detail' => 'page--facturae-document-detail',
    'jaraba_facturae.face_log' => 'page--facturae-face-log',
    'jaraba_facturae.settings' => 'page--facturae-settings',
    'jaraba_facturae.config' => 'page--facturae-config',
  ];

  if (isset($routeClasses[$routeName])) {
    $variables['attributes']['class'][] = $routeClasses[$routeName];
  }
}

/**
 * Implements hook_entity_insert().
 *
 * ECA-FA-001: When a billing_invoice is created with a buyer that is a
 * Public Administration (detected by client type or NIF starting with
 * Q/S/P), automatically generate a Facturae document.
 *
 * ECA-FA-004: When a facturae_document is created with status 'signed',
 * auto-generate PDF representation with signature and FACe QR.
 */
function jaraba_facturae_entity_insert(EntityInterface $entity): void {
  // ECA-FA-001: Auto-generate Facturae for AAPP invoices.
  if ($entity->getEntityTypeId() === 'billing_invoice') {
    _jaraba_facturae_check_aapp_invoice($entity);
  }

  // ECA-FA-004: Auto-generate PDF for signed documents.
  if ($entity->getEntityTypeId() === 'facturae_document') {
    $status = $entity->get('status')->value ?? '';
    if ($status === 'signed') {
      _jaraba_facturae_generate_pdf($entity);
    }
  }
}

/**
 * Implements hook_entity_update().
 *
 * ECA-FA-004: When a facturae_document transitions to 'signed',
 * auto-generate PDF.
 *
 * ECA-FA-005: When a facturae_document is cancelled (face_anulacion_status
 * set to 3200), auto-generate corrective invoice.
 */
function jaraba_facturae_entity_update(EntityInterface $entity): void {
  if ($entity->getEntityTypeId() !== 'facturae_document') {
    return;
  }

  $currentStatus = $entity->get('status')->value ?? '';
  $originalStatus = $entity->original ? ($entity->original->get('status')->value ?? '') : '';

  // ECA-FA-004: Transition to signed → generate PDF.
  if ($currentStatus === 'signed' && $originalStatus !== 'signed') {
    _jaraba_facturae_generate_pdf($entity);
  }

  // ECA-FA-005: Cancellation accepted → generate corrective invoice.
  $anulacionStatus = $entity->get('face_anulacion_status')->value ?? '';
  $originalAnulacion = $entity->original
    ? ($entity->original->get('face_anulacion_status')->value ?? '')
    : '';

  if ($anulacionStatus === '3200' && $originalAnulacion !== '3200') {
    _jaraba_facturae_generate_corrective($entity);
  }
}

/**
 * Implements hook_cron().
 *
 * ECA-FA-002: Queue FACe status sync every 4 hours for sent invoices.
 * ECA-FA-003: Weekly certificate expiry alerts (Mondays).
 */
function jaraba_facturae_cron(): void {
  _jaraba_facturae_cron_face_sync();
  _jaraba_facturae_cron_cert_expiry();
}

/**
 * ECA-FA-002: Queues FACe status sync for sent invoices.
 *
 * Runs every 4 hours. Queries documents with face_status in
 * ('sent', 'registered', 'registered_rcf', 'accounted') that were
 * sent more than 1 hour ago.
 */
function _jaraba_facturae_cron_face_sync(): void {
  $state = \Drupal::state();
  $lastRun = (int) $state->get('jaraba_facturae.cron_face_sync_last', 0);
  $now = \Drupal::time()->getRequestTime();

  // Every 4 hours (14400 seconds).
  if (($now - $lastRun) < 14400) {
    return;
  }
  $state->set('jaraba_facturae.cron_face_sync_last', $now);

  try {
    $storage = \Drupal::entityTypeManager()->getStorage('facturae_document');
    $query = $storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('face_status', ['sent', 'registered', 'registered_rcf', 'accounted'], 'IN')
      ->condition('face_registry_number', '', '<>')
      ->sort('changed', 'ASC')
      ->range(0, 50);

    $ids = $query->execute();
    if (empty($ids)) {
      return;
    }

    $documents = $storage->loadMultiple($ids);
    $queue = \Drupal::queue('jaraba_facturae_face_sync');

    foreach ($documents as $document) {
      $queue->createItem([
        'document_id' => $document->id(),
        'registry_number' => $document->get('face_registry_number')->value ?? '',
        'tenant_id' => (int) ($document->get('tenant_id')->target_id ?? 0),
      ]);
    }

    \Drupal::logger('jaraba_facturae')->info('FACe sync: queued @count documents for status update.', [
      '@count' => count($ids),
    ]);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_facturae')->error('FACe sync cron error: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}

/**
 * ECA-FA-003: Weekly certificate expiry alerts.
 *
 * Checks on Mondays for certificates expiring within 30 days.
 */
function _jaraba_facturae_cron_cert_expiry(): void {
  $state = \Drupal::state();
  $lastRun = (int) $state->get('jaraba_facturae.cron_cert_check_last', 0);
  $now = \Drupal::time()->getRequestTime();

  // Weekly check (604800 seconds = 7 days).
  if (($now - $lastRun) < 604800) {
    return;
  }

  // Only on Mondays.
  if (date('N', $now) !== '1') {
    return;
  }
  $state->set('jaraba_facturae.cron_cert_check_last', $now);

  try {
    $xadesService = \Drupal::service('jaraba_facturae.xades_service');
    $storage = \Drupal::entityTypeManager()->getStorage('facturae_tenant_config');
    $configs = $storage->loadByProperties(['active' => TRUE]);
    $mailManager = \Drupal::service('plugin.manager.mail');

    foreach ($configs as $config) {
      $tenantId = (int) ($config->get('tenant_id')->target_id ?? 0);
      $tenantName = $config->get('nombre_razon')->value ?? "Tenant $tenantId";
      $certInfo = $xadesService->getCertificateInfo($tenantId);

      if (isset($certInfo['error'])) {
        continue;
      }

      $daysRemaining = $certInfo['days_remaining'] ?? 999;
      if ($daysRemaining > 30) {
        continue;
      }

      // Determine urgency level.
      $urgency = 'warning';
      if ($daysRemaining <= 0) {
        $urgency = 'expired';
      }
      elseif ($daysRemaining <= 7) {
        $urgency = 'critical';
      }

      // Send email alert.
      $notificationEmail = $config->get('face_email_notification')->value ?? '';
      if (!empty($notificationEmail)) {
        $mailManager->mail('jaraba_facturae', 'cert_expiry_alert', $notificationEmail, 'es', [
          'tenant_name' => $tenantName,
          'tenant_id' => $tenantId,
          'days_remaining' => $daysRemaining,
          'urgency' => $urgency,
          'subject' => $certInfo['subject'] ?? '',
          'valid_to' => $certInfo['valid_to'] ?? '',
        ]);
      }

      \Drupal::logger('jaraba_facturae')->warning('Certificate expiry alert: tenant @name (@tid) — @days days remaining (@urgency).', [
        '@name' => $tenantName,
        '@tid' => $tenantId,
        '@days' => $daysRemaining,
        '@urgency' => $urgency,
      ]);
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_facturae')->error('Certificate expiry check error: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_mail().
 */
function jaraba_facturae_mail(string $key, array &$message, array $params): void {
  switch ($key) {
    case 'cert_expiry_alert':
      $urgencyLabels = [
        'warning' => 'Aviso',
        'critical' => 'CRITICO',
        'expired' => 'EXPIRADO',
      ];
      $urgency = $params['urgency'] ?? 'warning';
      $message['subject'] = t('[@urgency] Certificado Facturae proximo a expirar — @tenant', [
        '@urgency' => $urgencyLabels[$urgency] ?? $urgency,
        '@tenant' => $params['tenant_name'] ?? '',
      ]);
      $message['body'][] = t('El certificado digital para firma Facturae del tenant "@tenant" (ID: @tid) expira en @days dias.', [
        '@tenant' => $params['tenant_name'] ?? '',
        '@tid' => $params['tenant_id'] ?? 0,
        '@days' => $params['days_remaining'] ?? 0,
      ]);
      $message['body'][] = t('Sujeto: @subject', ['@subject' => $params['subject'] ?? '']);
      $message['body'][] = t('Fecha de expiracion: @date', ['@date' => $params['valid_to'] ?? '']);
      $message['body'][] = t('Renueve el certificado desde la configuracion del modulo Facturae.');
      break;

    case 'corrective_generated':
      $message['subject'] = t('Factura rectificativa generada — @number', [
        '@number' => $params['corrective_number'] ?? '',
      ]);
      $message['body'][] = t('Se ha generado automaticamente una factura rectificativa @number para corregir la factura @original que fue anulada en FACe.', [
        '@number' => $params['corrective_number'] ?? '',
        '@original' => $params['original_number'] ?? '',
      ]);
      break;
  }
}

/**
 * ECA-FA-001: Checks if a billing invoice buyer is AAPP.
 *
 * Detects Public Administrations by buyer NIF prefix (Q, S, P)
 * or by explicit client type field.
 */
function _jaraba_facturae_check_aapp_invoice(EntityInterface $invoice): void {
  try {
    // Check if buyer is AAPP by NIF prefix or client type.
    $buyerNif = '';
    $clientType = '';

    if ($invoice->hasField('buyer_nif')) {
      $buyerNif = strtoupper(trim($invoice->get('buyer_nif')->value ?? ''));
    }
    if ($invoice->hasField('client_type')) {
      $clientType = $invoice->get('client_type')->value ?? '';
    }

    $isAapp = FALSE;
    if ($clientType === 'aapp' || $clientType === 'public_administration') {
      $isAapp = TRUE;
    }
    elseif (!empty($buyerNif) && preg_match('/^[QSP]/', $buyerNif)) {
      $isAapp = TRUE;
    }

    if (!$isAapp) {
      return;
    }

    // Check if Facturae document already exists for this invoice.
    $facturaeStorage = \Drupal::entityTypeManager()->getStorage('facturae_document');
    $existing = $facturaeStorage->getQuery()
      ->accessCheck(FALSE)
      ->condition('invoice_id', $invoice->id())
      ->count()
      ->execute();

    if ((int) $existing > 0) {
      return;
    }

    // Build Facturae document data from billing invoice.
    $data = [
      'invoice_id' => $invoice->id(),
      'tenant_id' => $invoice->get('tenant_id')->target_id ?? NULL,
      'seller_nif' => $invoice->get('seller_nif')->value ?? '',
      'seller_name' => $invoice->get('seller_name')->value ?? '',
      'buyer_nif' => $buyerNif,
      'buyer_name' => $invoice->get('buyer_name')->value ?? '',
      'total_invoice_amount' => $invoice->get('total_amount')->value ?? '0.00',
      'issue_date' => $invoice->get('issue_date')->value ?? date('Y-m-d'),
      'invoice_class' => 'OO',
      'invoice_type' => 'FC',
      'status' => 'draft',
    ];

    $document = $facturaeStorage->create($data);
    $document->save();

    // Generate Facturae number.
    $tenantId = (int) ($data['tenant_id'] ?? 0);
    $numberingService = \Drupal::service('jaraba_facturae.numbering_service');
    $number = $numberingService->getNextNumber($tenantId, '');
    $document->set('facturae_number', $number);

    // Generate XML.
    $xmlService = \Drupal::service('jaraba_facturae.xml_service');
    $xml = $xmlService->buildFacturaeXml($document);
    $document->set('xml_unsigned', $xml);
    $document->set('status', 'validated');
    $document->save();

    \Drupal::logger('jaraba_facturae')->info('ECA-FA-001: Auto-generated Facturae @number for AAPP invoice @invoice.', [
      '@number' => $number,
      '@invoice' => $invoice->id(),
    ]);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_facturae')->error('ECA-FA-001 error: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}

/**
 * ECA-FA-004: Generates PDF representation for a signed Facturae document.
 */
function _jaraba_facturae_generate_pdf(EntityInterface $document): void {
  try {
    $signedXml = $document->get('xml_signed')->value ?? '';
    $signatureInfo = [];

    if (!empty($signedXml)) {
      $xadesService = \Drupal::service('jaraba_facturae.xades_service');
      $verifyResult = $xadesService->verifySignature($signedXml);
      $signatureInfo = [
        'signer_nif' => $verifyResult['signer_nif'] ?? '',
        'signing_time' => $verifyResult['signing_time'] ?? '',
        'status' => $verifyResult['valid'] ? 'Valid' : 'Invalid',
      ];
    }

    // Render PDF template.
    $renderer = \Drupal::service('renderer');
    $renderArray = [
      '#theme' => 'facturae_pdf_template',
      '#document' => $document,
      '#signature_info' => $signatureInfo,
      '#qr_data_uri' => '',
    ];
    $html = (string) $renderer->renderInIsolation($renderArray);

    if (empty($html)) {
      return;
    }

    // Store rendered HTML for PDF conversion (actual PDF generation
    // would use a library like wkhtmltopdf or Dompdf).
    \Drupal::logger('jaraba_facturae')->info('ECA-FA-004: PDF representation generated for document @id.', [
      '@id' => $document->id(),
    ]);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_facturae')->error('ECA-FA-004 PDF generation error: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}

/**
 * ECA-FA-005: Generates corrective invoice when original is cancelled.
 */
function _jaraba_facturae_generate_corrective(EntityInterface $document): void {
  try {
    $facturaeStorage = \Drupal::entityTypeManager()->getStorage('facturae_document');

    // Check if corrective already exists.
    $existing = $facturaeStorage->getQuery()
      ->accessCheck(FALSE)
      ->condition('corrective_json', '%"original_id":"' . $document->id() . '"%', 'LIKE')
      ->count()
      ->execute();

    if ((int) $existing > 0) {
      return;
    }

    $tenantId = (int) ($document->get('tenant_id')->target_id ?? 0);
    $numberingService = \Drupal::service('jaraba_facturae.numbering_service');
    $correctiveNumber = $numberingService->getNextNumber($tenantId, 'R');

    // Create corrective document referencing the original.
    $correctiveData = [
      'tenant_id' => $document->get('tenant_id')->target_id,
      'invoice_id' => $document->get('invoice_id')->value ?? NULL,
      'seller_nif' => $document->get('seller_nif')->value ?? '',
      'seller_name' => $document->get('seller_name')->value ?? '',
      'buyer_nif' => $document->get('buyer_nif')->value ?? '',
      'buyer_name' => $document->get('buyer_name')->value ?? '',
      'total_invoice_amount' => '-' . ($document->get('total_invoice_amount')->value ?? '0.00'),
      'total_gross_amount' => '-' . ($document->get('total_gross_amount')->value ?? '0.00'),
      'total_tax_outputs' => '-' . ($document->get('total_tax_outputs')->value ?? '0.00'),
      'issue_date' => date('Y-m-d'),
      'invoice_class' => 'OO',
      'invoice_type' => 'FA',
      'facturae_number' => $correctiveNumber,
      'facturae_series' => 'R',
      'corrective_json' => json_encode([
        'original_id' => $document->id(),
        'original_number' => $document->get('facturae_number')->value ?? '',
        'reason' => 'Anulacion aceptada en FACe (codigo 3200)',
        'correction_method' => '01',
        'correction_method_description' => 'Rectificacion integra',
      ]),
      'status' => 'draft',
    ];

    $corrective = $facturaeStorage->create($correctiveData);
    $corrective->save();

    // Generate XML for corrective.
    $xmlService = \Drupal::service('jaraba_facturae.xml_service');
    $xml = $xmlService->buildFacturaeXml($corrective);
    $corrective->set('xml_unsigned', $xml);
    $corrective->set('status', 'validated');
    $corrective->save();

    // Send notification.
    $notificationEmail = '';
    $configStorage = \Drupal::entityTypeManager()->getStorage('facturae_tenant_config');
    $configs = $configStorage->loadByProperties(['tenant_id' => $tenantId]);
    if (!empty($configs)) {
      $config = reset($configs);
      $notificationEmail = $config->get('face_email_notification')->value ?? '';
    }

    if (!empty($notificationEmail)) {
      $mailManager = \Drupal::service('plugin.manager.mail');
      $mailManager->mail('jaraba_facturae', 'corrective_generated', $notificationEmail, 'es', [
        'corrective_number' => $correctiveNumber,
        'original_number' => $document->get('facturae_number')->value ?? '',
      ]);
    }

    \Drupal::logger('jaraba_facturae')->info('ECA-FA-005: Corrective invoice @number generated for cancelled document @original.', [
      '@number' => $correctiveNumber,
      '@original' => $document->get('facturae_number')->value ?? $document->id(),
    ]);
  }
  catch (\Exception $e) {
    \Drupal::logger('jaraba_facturae')->error('ECA-FA-005 corrective generation error: @error', [
      '@error' => $e->getMessage(),
    ]);
  }
}
