# Sistema de Feature Flags

**Fecha de creaci√≥n:** 2026-01-09 22:31  
**√öltima actualizaci√≥n:** 2026-01-09 22:31  
**Versi√≥n:** 1.0.0  
**Categor√≠a:** Arquitectura

---

## üìë Tabla de Contenidos (TOC)

1. [Prop√≥sito](#1-prop√≥sito)
2. [Arquitectura del Sistema](#2-arquitectura-del-sistema)
3. [Tipos de Flags](#3-tipos-de-flags)
4. [Implementaci√≥n T√©cnica](#4-implementaci√≥n-t√©cnica)
5. [Configuraci√≥n por Tenant](#5-configuraci√≥n-por-tenant)
6. [Integraci√≥n con ECA](#6-integraci√≥n-con-eca)
7. [Administraci√≥n UI](#7-administraci√≥n-ui)
8. [Best Practices](#8-best-practices)
9. [Registro de Cambios](#9-registro-de-cambios)

---

## 1. Prop√≥sito

El sistema de Feature Flags permite:

- **Rollout gradual** de nuevas funcionalidades
- **A/B testing** de caracter√≠sticas
- **Kill switches** para desactivar funciones problem√°ticas
- **Diferenciaci√≥n por plan** SaaS
- **Personalizaci√≥n por tenant**

---

## 2. Arquitectura del Sistema

### 2.1 Diagrama de Componentes

```mermaid
graph TB
    subgraph "Admin UI"
        UI[Flag Management]
    end
    
    subgraph "Backend"
        SERVICE[FeatureFlagService]
        CACHE[Redis Cache]
        DB[(Config Entity)]
    end
    
    subgraph "Consumers"
        TWIG[Twig Templates]
        PHP[PHP Services]
        JS[JavaScript]
        ECA[ECA Workflows]
    end
    
    UI --> SERVICE
    SERVICE --> CACHE
    SERVICE --> DB
    
    SERVICE --> TWIG
    SERVICE --> PHP
    SERVICE --> JS
    SERVICE --> ECA
```

### 2.2 Flujo de Evaluaci√≥n

```
Request ‚Üí TenantContext ‚Üí FeatureFlagService ‚Üí Cache Hit?
                                                   ‚îÇ
                                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                    ‚îÇ                             ‚îÇ
                                   S√≠                            No
                                    ‚îÇ                             ‚îÇ
                                    ‚ñº                             ‚ñº
                              Return value                Load from DB
                                                               ‚îÇ
                                                               ‚ñº
                                                         Store in Cache
                                                               ‚îÇ
                                                               ‚ñº
                                                         Return value
```

---

## 3. Tipos de Flags

### 3.1 Por Alcance

| Tipo | Descripci√≥n | Ejemplo |
|------|-------------|---------|
| **Global** | Afecta a toda la plataforma | `maintenance_mode` |
| **Por Plan** | Seg√∫n tier del tenant | `ai_agents_enabled` |
| **Por Tenant** | Espec√≠fico de un tenant | `custom_theme_v2` |
| **Por Usuario** | Individual | `beta_tester` |
| **Por Porcentaje** | Rollout gradual | `new_checkout:25%` |

### 3.2 Por Duraci√≥n

| Tipo | Duraci√≥n | Prop√≥sito |
|------|----------|-----------|
| **Release** | Permanente | Nueva funcionalidad |
| **Experiment** | Temporal | A/B testing |
| **Ops** | Variable | Kill switch, maintenance |
| **Permission** | Permanente | Control de acceso |

---

## 4. Implementaci√≥n T√©cnica

### 4.1 Interfaz del Servicio

```php
<?php

namespace Drupal\ecosistema_jaraba_core\Service;

/**
 * Servicio para gesti√≥n de feature flags.
 */
interface FeatureFlagServiceInterface {

  /**
   * Verifica si una feature flag est√° activa.
   *
   * @param string $flag
   *   Nombre de la flag (ej: 'ai_agents', 'new_checkout').
   * @param int|null $tenantId
   *   ID del tenant (usa el actual si es NULL).
   * @param int|null $userId
   *   ID del usuario (usa el actual si es NULL).
   *
   * @return bool
   *   TRUE si la flag est√° activa.
   */
  public function isEnabled(string $flag, ?int $tenantId = NULL, ?int $userId = NULL): bool;

  /**
   * Obtiene todas las flags activas para un tenant.
   *
   * @param int $tenantId
   *   ID del tenant.
   *
   * @return array
   *   Array asociativo de flags y sus valores.
   */
  public function getFlags(int $tenantId): array;

  /**
   * Activa una flag para un tenant.
   *
   * @param string $flag
   *   Nombre de la flag.
   * @param int $tenantId
   *   ID del tenant.
   * @param mixed $value
   *   Valor de la flag (bool, string, array).
   */
  public function enable(string $flag, int $tenantId, $value = TRUE): void;

  /**
   * Desactiva una flag para un tenant.
   *
   * @param string $flag
   *   Nombre de la flag.
   * @param int $tenantId
   *   ID del tenant.
   */
  public function disable(string $flag, int $tenantId): void;

}
```

### 4.2 Configuraci√≥n YAML

```yaml
# config/install/ecosistema_jaraba_core.feature_flags.yml
feature_flags:
  # Flags por defecto seg√∫n plan
  defaults:
    basico:
      max_productores: 10
      ai_agents: false
      custom_domain: false
      api_access: false
      
    profesional:
      max_productores: 50
      ai_agents: true
      custom_domain: true
      api_access: true
      priority_support: false
      
    enterprise:
      max_productores: -1  # Sin l√≠mite
      ai_agents: true
      custom_domain: true
      api_access: true
      priority_support: true
      sla_custom: true

  # Flags globales
  global:
    maintenance_mode: false
    new_checkout_flow: false
    v2_api: false
```

### 4.3 Uso en C√≥digo PHP

```php
// En un controlador o servicio
$featureFlags = \Drupal::service('ecosistema_jaraba_core.feature_flags');

// Verificar flag simple
if ($featureFlags->isEnabled('ai_agents')) {
  // Mostrar panel de agentes IA
}

// Verificar con tenant espec√≠fico
if ($featureFlags->isEnabled('custom_domain', $tenantId)) {
  // Permitir configuraci√≥n de dominio
}

// Obtener valor num√©rico
$maxProductores = $featureFlags->getValue('max_productores') ?? 10;
```

### 4.4 Uso en Twig

```twig
{# En templates #}
{% if feature_flag('ai_agents') %}
  <div class="ai-agents-panel">
    {% include '@ecosistema_jaraba_core/ai-agents.html.twig' %}
  </div>
{% endif %}

{# Con valor #}
{% set max = feature_flag_value('max_productores', 10) %}
<p>Puedes a√±adir hasta {{ max }} productores.</p>
```

### 4.5 Uso en JavaScript

```javascript
// Flags inyectadas en drupalSettings
if (drupalSettings.featureFlags.ai_agents) {
  initAiAgentsPanel();
}

// API para verificar
Drupal.behaviors.featureFlags = {
  attach: function(context, settings) {
    const flags = settings.featureFlags || {};
    
    if (flags.new_checkout_flow) {
      this.initNewCheckout();
    }
  }
};
```

---

## 5. Configuraci√≥n por Tenant

### 5.1 Schema de Datos

```yaml
# Campo en entidad Tenant
feature_flags:
  type: map
  label: 'Feature Flags Override'
  settings:
    # Override de flags por defecto
    ai_agents: true
    custom_branding: true
    experimental_features:
      - new_dashboard
      - beta_reports
```

### 5.2 Jerarqu√≠a de Prioridad

```
1. Override espec√≠fico del Tenant (m√°xima prioridad)
   ‚îÇ
   ‚ñº
2. Configuraci√≥n del Plan SaaS
   ‚îÇ
   ‚ñº
3. Flags globales de plataforma
   ‚îÇ
   ‚ñº
4. Valores por defecto (m√≠nima prioridad)
```

---

## 6. Integraci√≥n con ECA

### 6.1 Condiciones en ECA

```yaml
# Condici√≥n: verificar feature flag
conditions:
  - plugin: feature_flag_enabled
    configuration:
      flag: ai_agents
      tenant: current
```

### 6.2 Acciones en ECA

```yaml
# Acci√≥n: activar flag
actions:
  - plugin: feature_flag_toggle
    configuration:
      flag: premium_trial
      tenant: "[tenant:id]"
      value: true
      expires: "+14 days"
```

### 6.3 Eventos

| Evento | Trigger |
|--------|---------|
| `feature_flag.enabled` | Al activar una flag |
| `feature_flag.disabled` | Al desactivar una flag |
| `feature_flag.expired` | Al expirar flag temporal |

---

## 7. Administraci√≥n UI

### 7.1 Ruta Admin

```
/admin/config/ecosistema/feature-flags
```

### 7.2 Funcionalidades

- **Lista de flags** con estado por tenant
- **Activar/desactivar** con un click
- **Rollout gradual** con slider de porcentaje
- **Historial de cambios** por flag
- **B√∫squeda y filtros** por tipo, estado, tenant

### 7.3 Permisos

| Permiso | Descripci√≥n |
|---------|-------------|
| `administer feature flags` | Gesti√≥n completa |
| `view feature flags` | Solo lectura |
| `toggle tenant flags` | Cambiar flags de su tenant |

---

## 8. Best Practices

### 8.1 Naming Convention

```
{scope}_{feature}_{variant}
```

**Ejemplos:**
- `checkout_new_flow` (feature)
- `experiment_pricing_v2` (A/B test)
- `ops_maintenance_mode` (operacional)
- `plan_ai_agents` (por plan)

### 8.2 Ciclo de Vida

1. **Crear flag** con valor `false` por defecto
2. **Rollout gradual** (10% ‚Üí 25% ‚Üí 50% ‚Üí 100%)
3. **Monitorizar m√©tricas** durante rollout
4. **Hacer permanente** (remover flag del c√≥digo)
5. **Limpiar** flag obsoleta de config

### 8.3 Antipatterns a Evitar

| ‚ùå Evitar | ‚úÖ Preferir |
|-----------|-------------|
| Flags anidadas | Flags planas |
| Flags con l√≥gica compleja | Flags booleanas simples |
| Dejar flags indefinidamente | Limpiar tras 3 meses |
| Flags en hot paths sin cache | Siempre cachear |

---

## 9. Registro de Cambios

| Fecha | Versi√≥n | Autor | Descripci√≥n |
|-------|---------|-------|-------------|
| 2026-01-09 | 1.0.0 | IA Asistente | Creaci√≥n inicial del documento |
