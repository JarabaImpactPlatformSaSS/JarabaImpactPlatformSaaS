# Pol√≠tica GDPR y Protecci√≥n de Datos - JarabaImpactPlatformSaaS

**Fecha de creaci√≥n:** 2026-01-09 20:02  
**√öltima actualizaci√≥n:** 2026-01-09 20:02  
**Autor:** IA Asistente (Arquitecto SaaS Senior)  
**Versi√≥n:** 1.0.0  
**Categor√≠a:** Compliance / Legal

---

## üìë Tabla de Contenidos (TOC)

1. [Visi√≥n General](#1-visi√≥n-general)
2. [Roles y Responsabilidades](#2-roles-y-responsabilidades)
3. [Categor√≠as de Datos](#3-categor√≠as-de-datos)
4. [Bases Legales para el Tratamiento](#4-bases-legales-para-el-tratamiento)
5. [Derechos de los Interesados](#5-derechos-de-los-interesados)
6. [Consentimiento y Preferencias](#6-consentimiento-y-preferencias)
7. [Retenci√≥n y Eliminaci√≥n de Datos](#7-retenci√≥n-y-eliminaci√≥n-de-datos)
8. [Seguridad de Datos](#8-seguridad-de-datos)
9. [Transferencias Internacionales](#9-transferencias-internacionales)
10. [Gesti√≥n de Brechas de Seguridad](#10-gesti√≥n-de-brechas-de-seguridad)
11. [Implementaci√≥n T√©cnica](#11-implementaci√≥n-t√©cnica)
12. [Registro de Cambios](#12-registro-de-cambios)

---

## 1. Visi√≥n General

### 1.1 Objetivo

Este documento define las pol√≠ticas y procedimientos para el cumplimiento del **Reglamento General de Protecci√≥n de Datos (RGPD/GDPR)** en JarabaImpactPlatformSaaS.

### 1.2 √Åmbito de Aplicaci√≥n

| Aspecto | Descripci√≥n |
|---------|-------------|
| **Territorial** | Datos de ciudadanos/residentes de la UE |
| **Material** | Datos personales tratados total o parcialmente por medios automatizados |
| **Responsable** | Jaraba Impact S.L. (plataforma) |
| **Encargados** | Tenants, proveedores externos |

### 1.3 Principios Fundamentales

```mermaid
mindmap
  root((GDPR))
    Licitud
      Base legal
      Transparencia
    Limitaci√≥n
      Finalidad espec√≠fica
      Minimizaci√≥n
    Exactitud
      Datos actualizados
      Rectificaci√≥n
    Conservaci√≥n
      Tiempo limitado
      Eliminaci√≥n
    Seguridad
      Integridad
      Confidencialidad
    Responsabilidad
      Demostrable
      Documentada
```

---

## 2. Roles y Responsabilidades

### 2.1 Matriz RACI

| Rol | Responsable | Accountable | Consultado | Informado |
|-----|-------------|-------------|------------|-----------|
| **Plataforma (Jaraba)** | Responsable del tratamiento | DPO | Legal | Tenants |
| **Tenant** | Encargado del tratamiento | Admin Tenant | Plataforma | Productores |
| **Productor** | Sub-encargado | Tenant | Plataforma | Clientes |
| **Proveedor Externo** | Encargado | Plataforma | Legal | - |

### 2.2 Data Protection Officer (DPO)

```yaml
DPO:
  nombre: "[Nombre del DPO]"
  email: dpo@jaraba.io
  telefono: "+34 XXX XXX XXX"
  funciones:
    - Supervisar cumplimiento GDPR
    - Asesorar sobre evaluaciones de impacto
    - Punto de contacto con AEPD
    - Formaci√≥n del personal
```

### 2.3 Contratos de Encargado del Tratamiento

| Contrato | Partes | Contenido Obligatorio |
|----------|--------|----------------------|
| **DPA Tenant** | Plataforma ‚Üî Tenant | Art. 28 GDPR, subcontrataci√≥n, auditor√≠as |
| **DPA Proveedor** | Plataforma ‚Üî Stripe/AWS | Cl√°usulas contractuales tipo |
| **T√©rminos Productor** | Tenant ‚Üî Productor | Instrucciones de tratamiento |

---

## 3. Categor√≠as de Datos

### 3.1 Inventario de Datos Personales

| Categor√≠a | Datos | Sensible | Retenci√≥n |
|-----------|-------|----------|-----------|
| **Identificaci√≥n** | Nombre, email, tel√©fono | No | Mientras activo + 5 a√±os |
| **Autenticaci√≥n** | Hash de contrase√±a, tokens | No | Mientras activo |
| **Financieros** | √öltimos 4 d√≠gitos tarjeta, facturas | No | 10 a√±os (fiscal) |
| **Ubicaci√≥n** | Direcci√≥n de env√≠o, pa√≠s | No | Mientras activo + 5 a√±os |
| **Comportamiento** | Historial de compras, navegaci√≥n | No | 2 a√±os |
| **Comunicaciones** | Preferencias, historial emails | No | 2 a√±os post-unsubscribe |

### 3.2 Datos por Entidad

```mermaid
erDiagram
    USER ||--o{ CONSENT : otorga
    USER ||--o{ DATA_REQUEST : solicita
    
    TENANT ||--o{ USER : contiene
    
    PRODUCTOR ||--o{ PRODUCTO : vende
    
    CLIENTE ||--o{ PEDIDO : realiza
    CLIENTE ||--o{ CONSENT : otorga
    
    USER {
        string email PII
        string nombre PII
        string telefono PII
        string password_hash
        datetime created
        datetime last_login
    }
    
    CLIENTE {
        string email PII
        string nombre PII
        string direccion PII
        string telefono PII
    }
    
    CONSENT {
        string tipo
        boolean valor
        datetime timestamp
        string ip
    }
```

### 3.3 Datos NO Recopilados

- ‚ùå Datos de salud
- ‚ùå Datos biom√©tricos
- ‚ùå Origen √©tnico
- ‚ùå Opiniones pol√≠ticas
- ‚ùå Creencias religiosas
- ‚ùå Datos de menores (< 16 a√±os)

---

## 4. Bases Legales para el Tratamiento

### 4.1 Matriz de Bases Legales

| Tratamiento | Base Legal | Art√≠culo GDPR |
|-------------|------------|---------------|
| Creaci√≥n de cuenta | Consentimiento | Art. 6.1.a |
| Ejecuci√≥n de pedidos | Contrato | Art. 6.1.b |
| Facturaci√≥n | Obligaci√≥n legal | Art. 6.1.c |
| Marketing directo | Consentimiento | Art. 6.1.a |
| Analytics agregados | Inter√©s leg√≠timo | Art. 6.1.f |
| Prevenci√≥n de fraude | Inter√©s leg√≠timo | Art. 6.1.f |
| Comunicaciones de servicio | Contrato | Art. 6.1.b |

### 4.2 Evaluaci√≥n de Inter√©s Leg√≠timo (LIA)

```yaml
# Para Analytics agregados
Tratamiento: An√°lisis de uso de la plataforma
Inter√©s_leg√≠timo: Mejora del servicio y UX
Necesidad: S√≠, datos imprescindibles para optimizaci√≥n
Equilibrio:
  - Impacto en interesado: Bajo (datos anonimizados)
  - Expectativas razonables: S√≠
  - Salvaguardas: Agregaci√≥n, pseudonimizaci√≥n
Conclusi√≥n: Inter√©s leg√≠timo v√°lido
```

---

## 5. Derechos de los Interesados

### 5.1 Derechos ARCO-POL

| Derecho | Descripci√≥n | Plazo | Canal |
|---------|-------------|-------|-------|
| **Acceso** | Obtener copia de datos | 30 d√≠as | Panel o email |
| **Rectificaci√≥n** | Corregir datos inexactos | 30 d√≠as | Panel o email |
| **Cancelaci√≥n** | Eliminar datos | 30 d√≠as | Email a DPO |
| **Oposici√≥n** | Oponerse a tratamiento | 30 d√≠as | Panel o email |
| **Portabilidad** | Exportar datos en formato est√°ndar | 30 d√≠as | Panel (JSON/CSV) |
| **Limitaci√≥n** | Suspender tratamiento | 30 d√≠as | Email a DPO |

### 5.2 Flujo de Solicitud de Derechos

```mermaid
sequenceDiagram
    participant U as Usuario
    participant P as Plataforma
    participant DPO as DPO
    participant T as Tenant
    
    U->>P: Solicitud (panel/email)
    P->>P: Verificar identidad
    
    alt Identidad verificada
        P->>DPO: Notificar solicitud
        DPO->>T: Notificar si afecta datos Tenant
        P->>P: Procesar solicitud
        P->>U: Respuesta (‚â§30 d√≠as)
    else Identidad no verificada
        P->>U: Solicitar verificaci√≥n adicional
    end
```

### 5.3 Panel de Privacidad del Usuario

```yaml
# Funcionalidades del panel /mi-cuenta/privacidad
Funcionalidades:
  - Ver todos los datos almacenados
  - Descargar datos (JSON/CSV)
  - Modificar preferencias de consentimiento
  - Solicitar eliminaci√≥n de cuenta
  - Ver historial de consentimientos
  - Revocar accesos de terceros
```

---

## 6. Consentimiento y Preferencias

### 6.1 Tipos de Consentimiento

| Consentimiento | Obligatorio | Por defecto | Granular |
|----------------|-------------|-------------|----------|
| **T√©rminos de servicio** | ‚úÖ | - | No |
| **Cookies esenciales** | - | ‚úÖ | No |
| **Cookies anal√≠ticas** | ‚ùå | ‚ùå | S√≠ |
| **Cookies marketing** | ‚ùå | ‚ùå | S√≠ |
| **Email marketing** | ‚ùå | ‚ùå | S√≠ |
| **Compartir con terceros** | ‚ùå | ‚ùå | S√≠ |

### 6.2 Implementaci√≥n de Consent Management

```php
// ConsentService.php
namespace Drupal\ecosistema_jaraba_core\Service;

class ConsentService {
  
  /**
   * Registra un consentimiento del usuario.
   */
  public function recordConsent(
    int $user_id,
    string $consent_type,
    bool $value,
    string $source = 'web'
  ): void {
    $consent = Consent::create([
      'user_id' => $user_id,
      'consent_type' => $consent_type,
      'value' => $value,
      'ip_address' => \Drupal::request()->getClientIp(),
      'user_agent' => \Drupal::request()->headers->get('User-Agent'),
      'source' => $source,
      'timestamp' => time(),
    ]);
    $consent->save();
    
    // Log para auditor√≠a
    $this->logger->info('Consent recorded: @type=@value for user @uid', [
      '@type' => $consent_type,
      '@value' => $value ? 'granted' : 'revoked',
      '@uid' => $user_id,
    ]);
  }
  
  /**
   * Obtiene el estado actual de consentimiento.
   */
  public function getConsentStatus(int $user_id, string $consent_type): ?bool {
    $consent = $this->entityTypeManager
      ->getStorage('consent')
      ->loadByProperties([
        'user_id' => $user_id,
        'consent_type' => $consent_type,
      ]);
    
    if (!$consent) {
      return NULL; // No ha dado consentimiento
    }
    
    // Obtener el m√°s reciente
    usort($consent, fn($a, $b) => $b->get('timestamp')->value - $a->get('timestamp')->value);
    return (bool) reset($consent)->get('value')->value;
  }
  
  /**
   * Exporta historial de consentimientos para ARCO.
   */
  public function exportConsentHistory(int $user_id): array {
    $consents = $this->entityTypeManager
      ->getStorage('consent')
      ->loadByProperties(['user_id' => $user_id]);
    
    return array_map(fn($c) => [
      'type' => $c->get('consent_type')->value,
      'value' => $c->get('value')->value,
      'timestamp' => date('c', $c->get('timestamp')->value),
      'source' => $c->get('source')->value,
    ], $consents);
  }
}
```

### 6.3 Cookie Banner

```javascript
// Cookie consent banner
window.cookieConsent = {
  init() {
    if (!this.hasConsented()) {
      this.showBanner();
    }
  },
  
  showBanner() {
    const banner = document.createElement('div');
    banner.id = 'cookie-consent';
    banner.innerHTML = `
      <div class="cookie-banner">
        <p>Utilizamos cookies para mejorar tu experiencia. 
           <a href="/politica-cookies">M√°s informaci√≥n</a></p>
        <div class="cookie-actions">
          <button onclick="cookieConsent.acceptAll()">Aceptar todas</button>
          <button onclick="cookieConsent.showPreferences()">Configurar</button>
          <button onclick="cookieConsent.rejectNonEssential()">Solo esenciales</button>
        </div>
      </div>
    `;
    document.body.appendChild(banner);
  },
  
  acceptAll() {
    this.setConsent({ analytics: true, marketing: true });
    this.hideBanner();
  },
  
  rejectNonEssential() {
    this.setConsent({ analytics: false, marketing: false });
    this.hideBanner();
  },
  
  setConsent(preferences) {
    localStorage.setItem('cookie_consent', JSON.stringify({
      ...preferences,
      timestamp: Date.now(),
      version: '1.0'
    }));
    
    // Enviar a backend
    fetch('/api/consent', {
      method: 'POST',
      body: JSON.stringify(preferences)
    });
  }
};
```

---

## 7. Retenci√≥n y Eliminaci√≥n de Datos

### 7.1 Pol√≠tica de Retenci√≥n

| Tipo de Dato | Retenci√≥n Activa | Post-Baja | Base Legal |
|--------------|------------------|-----------|------------|
| Datos de cuenta | Mientras activo | 30 d√≠as | Contrato |
| Facturas | 10 a√±os | 10 a√±os | Obligaci√≥n fiscal |
| Logs de acceso | 1 a√±o | 1 a√±o | Seguridad |
| Historial de pedidos | 5 a√±os | 5 a√±os | Garant√≠as |
| Datos de marketing | 2 a√±os inactivo | 0 | Consentimiento |
| Consentimientos | Indefinido | Indefinido | Prueba |
| Backups | 90 d√≠as | 90 d√≠as | Recuperaci√≥n |

### 7.2 Proceso de Eliminaci√≥n

```mermaid
flowchart TB
    A[Solicitud de eliminaci√≥n] --> B{Verificar identidad}
    B -->|OK| C[Marcar para eliminaci√≥n]
    B -->|Fail| Z[Rechazar]
    
    C --> D{Datos en retenci√≥n legal?}
    D -->|S√≠| E[Anonimizar datos no requeridos]
    D -->|No| F[Eliminar todos los datos]
    
    E --> G[Notificar a Tenant]
    F --> G
    
    G --> H[Propagar a subencargados]
    H --> I[Eliminar de backups]
    I --> J[Confirmar al usuario]
    
    J --> K[Log de auditor√≠a]
```

### 7.3 Automatizaci√≥n de Retenci√≥n

```yaml
# ECA Model: data_retention_cleanup
id: data_retention_cleanup
label: "GDPR - Limpieza autom√°tica de datos"
events:
  - plugin: "cron"
    configuration:
      frequency: "daily"
      time: "03:00"
actions:
  # Anonimizar usuarios inactivos > 2 a√±os (marketing)
  - plugin: "action:entity_query_action"
    configuration:
      entity_type: user
      conditions:
        - field: last_login
          operator: "<"
          value: "-2 years"
        - field: status
          value: 1
      action: anonymize_marketing_data
      
  # Eliminar logs > 1 a√±o
  - plugin: "database:delete"
    configuration:
      table: watchdog
      condition: "timestamp < UNIX_TIMESTAMP(DATE_SUB(NOW(), INTERVAL 1 YEAR))"
```

### 7.4 Script de Anonimizaci√≥n

```php
// DataRetentionService::anonymizeUser()
public function anonymizeUser(UserInterface $user): void {
  // Reemplazar datos personales con hash
  $hash = hash('sha256', $user->id() . time());
  
  $user->set('mail', "deleted-{$hash}@anonymized.local");
  $user->set('name', "Usuario Eliminado {$hash}");
  $user->set('field_telefono', NULL);
  $user->set('field_direccion', NULL);
  $user->setPassword(bin2hex(random_bytes(32)));
  $user->block();
  $user->save();
  
  // Mantener registro de pedidos pero anonimizar
  $orders = $this->getOrdersForUser($user);
  foreach ($orders as $order) {
    $order->set('billing_address', $this->anonymizeAddress($order->get('billing_address')));
    $order->save();
  }
  
  // Log
  $this->logger->notice('User @uid anonymized per retention policy', [
    '@uid' => $user->id(),
  ]);
}
```

---

## 8. Seguridad de Datos

### 8.1 Medidas T√©cnicas

| Medida | Implementaci√≥n | Estado |
|--------|----------------|--------|
| **Cifrado en tr√°nsito** | TLS 1.3 obligatorio | ‚úÖ |
| **Cifrado en reposo** | AES-256 para backups | ‚úÖ |
| **Hash de contrase√±as** | bcrypt con cost 12 | ‚úÖ |
| **2FA** | TOTP para admins | ‚úÖ |
| **WAF** | Cloudflare | ‚úÖ |
| **Audit logs** | Inmutables en S3 | ‚úÖ |

### 8.2 Medidas Organizativas

| Medida | Descripci√≥n |
|--------|-------------|
| **Formaci√≥n** | Anual obligatoria en GDPR |
| **Acceso m√≠nimo** | Solo datos necesarios |
| **Revisi√≥n de accesos** | Trimestral |
| **Pol√≠tica de contrase√±as** | Rotaci√≥n 90 d√≠as, complejidad |
| **NDA** | Obligatorio para empleados |

### 8.3 Pseudonimizaci√≥n

```php
// Pseudonimizaci√≥n para analytics
public function pseudonymizeForAnalytics(array $data): array {
  return [
    'user_hash' => hash('sha256', $data['user_id'] . $this->salt),
    'tenant_id' => $data['tenant_id'], // Se mantiene para segmentaci√≥n
    'event' => $data['event'],
    'timestamp' => $data['timestamp'],
    // NO incluir: email, nombre, IP
  ];
}
```

---

## 9. Transferencias Internacionales

### 9.1 Proveedores y Ubicaci√≥n

| Proveedor | Servicio | Pa√≠s | Mecanismo |
|-----------|----------|------|-----------|
| **AWS** | Hosting | Irlanda (EU) | EU Data Act |
| **Stripe** | Pagos | USA | SCCs + DPF |
| **OpenAI** | IA | USA | SCCs + DPF |
| **Cloudflare** | CDN | Global | SCCs |
| **Google Analytics** | Analytics | USA | Consent + SCCs |

### 9.2 Cl√°usulas Contractuales Tipo (SCCs)

Todos los proveedores fuera del EEE tienen firmadas las SCCs de la Comisi√≥n Europea (Decisi√≥n 2021/914).

### 9.3 Data Privacy Framework (DPF)

Proveedores USA certificados en DPF:
- ‚úÖ Stripe
- ‚úÖ OpenAI
- ‚úÖ Cloudflare

---

## 10. Gesti√≥n de Brechas de Seguridad

### 10.1 Procedimiento de Respuesta

```mermaid
flowchart TB
    A[Detectar incidente] --> B[Contener amenaza]
    B --> C[Evaluar alcance]
    C --> D{Afecta datos personales?}
    
    D -->|No| E[Gestionar como incidente IT]
    D -->|S√≠| F{Riesgo para derechos?}
    
    F -->|Alto| G[Notificar AEPD ‚â§72h]
    G --> H[Notificar afectados]
    F -->|Bajo| I[Documentar internamente]
    
    H --> J[Remediar]
    I --> J
    E --> J
    
    J --> K[Post-mortem]
    K --> L[Actualizar medidas]
```

### 10.2 Clasificaci√≥n de Brechas

| Nivel | Descripci√≥n | Acci√≥n | Plazo AEPD |
|-------|-------------|--------|------------|
| **Cr√≠tico** | Datos sensibles expuestos | AEPD + afectados | 72h |
| **Alto** | Datos personales accedidos | AEPD | 72h |
| **Medio** | Intento de acceso, datos cifrados | Documentar | - |
| **Bajo** | Vulnerabilidad detectada, no explotada | Documentar | - |

### 10.3 Plantilla de Notificaci√≥n a AEPD

```yaml
Notificaci√≥n_Brecha:
  responsable: "Jaraba Impact S.L."
  nif: "BXXXXXXXX"
  dpo: "dpo@jaraba.io"
  
  brecha:
    fecha_deteccion: "YYYY-MM-DD HH:MM"
    fecha_ocurrencia: "YYYY-MM-DD HH:MM (estimada)"
    naturaleza: "Acceso no autorizado / P√©rdida / Destrucci√≥n"
    categorias_datos: ["Identificaci√≥n", "Contacto", "Financieros"]
    numero_afectados: "X usuarios"
    
  consecuencias:
    - "Posible usurpaci√≥n de identidad"
    - "Acceso no autorizado a cuentas"
    
  medidas_tomadas:
    - "Bloqueo de accesos comprometidos"
    - "Reset de contrase√±as"
    - "Notificaci√≥n a afectados"
    
  medidas_futuras:
    - "Implementaci√≥n de 2FA obligatorio"
    - "Auditor√≠a de seguridad externa"
```

---

## 11. Implementaci√≥n T√©cnica

### 11.1 M√≥dulos Drupal Requeridos

| M√≥dulo | Prop√≥sito |
|--------|-----------|
| `gdpr` | Framework base GDPR |
| `gdpr_consent` | Gesti√≥n de consentimientos |
| `gdpr_tasks` | Cola de solicitudes ARCO |
| `eu_cookie_compliance` | Banner de cookies |
| `anonymizer` | Anonimizaci√≥n de datos |

### 11.2 Entidad Consent

```php
/**
 * @ContentEntityType(
 *   id = "consent",
 *   label = @Translation("Consentimiento"),
 *   base_table = "consent",
 *   entity_keys = {
 *     "id" = "id",
 *     "uuid" = "uuid",
 *   },
 * )
 */
class Consent extends ContentEntityBase {
  
  public static function baseFieldDefinitions(EntityTypeInterface $entity_type) {
    $fields = parent::baseFieldDefinitions($entity_type);
    
    $fields['user_id'] = BaseFieldDefinition::create('entity_reference')
      ->setLabel(t('Usuario'))
      ->setSetting('target_type', 'user')
      ->setRequired(TRUE);
    
    $fields['consent_type'] = BaseFieldDefinition::create('list_string')
      ->setLabel(t('Tipo de consentimiento'))
      ->setSetting('allowed_values', [
        'terms' => 'T√©rminos de servicio',
        'marketing' => 'Comunicaciones comerciales',
        'analytics' => 'Cookies anal√≠ticas',
        'third_party' => 'Compartir con terceros',
      ])
      ->setRequired(TRUE);
    
    $fields['value'] = BaseFieldDefinition::create('boolean')
      ->setLabel(t('Valor'))
      ->setRequired(TRUE);
    
    $fields['timestamp'] = BaseFieldDefinition::create('timestamp')
      ->setLabel(t('Fecha/hora'))
      ->setRequired(TRUE);
    
    $fields['ip_address'] = BaseFieldDefinition::create('string')
      ->setLabel(t('Direcci√≥n IP'));
    
    $fields['source'] = BaseFieldDefinition::create('string')
      ->setLabel(t('Origen'))
      ->setDefaultValue('web');
    
    return $fields;
  }
}
```

### 11.3 API de Portabilidad

```php
// GdprController::exportUserData()
public function exportUserData(): JsonResponse {
  $user = $this->currentUser();
  
  $data = [
    'meta' => [
      'export_date' => date('c'),
      'format_version' => '1.0',
      'platform' => 'JarabaImpactPlatform',
    ],
    'personal_data' => [
      'email' => $user->getEmail(),
      'name' => $user->getDisplayName(),
      'created' => date('c', $user->getCreatedTime()),
      'last_login' => date('c', $user->getLastLoginTime()),
    ],
    'consents' => $this->consentService->exportConsentHistory($user->id()),
    'orders' => $this->orderService->exportUserOrders($user->id()),
    'content' => $this->contentService->exportUserContent($user->id()),
  ];
  
  return new JsonResponse($data, 200, [
    'Content-Disposition' => 'attachment; filename="mis-datos.json"',
  ]);
}
```

---

## 12. Registro de Cambios

| Fecha | Versi√≥n | Descripci√≥n |
|-------|---------|-------------|
| 2026-01-09 | 1.0.0 | Creaci√≥n inicial del documento |
