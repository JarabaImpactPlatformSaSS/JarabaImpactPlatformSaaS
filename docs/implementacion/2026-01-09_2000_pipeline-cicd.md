# Pipeline CI/CD - JarabaImpactPlatformSaaS

**Fecha de creaci√≥n:** 2026-01-09 20:00  
**√öltima actualizaci√≥n:** 2026-01-09 20:00  
**Autor:** IA Asistente (Arquitecto SaaS Senior)  
**Versi√≥n:** 1.0.0  
**Categor√≠a:** Implementaci√≥n / DevOps

---

## üìë Tabla de Contenidos (TOC)

1. [Visi√≥n General](#1-visi√≥n-general)
2. [Arquitectura del Pipeline](#2-arquitectura-del-pipeline)
3. [Entornos](#3-entornos)
4. [GitHub Actions Workflows](#4-github-actions-workflows)
5. [Quality Gates](#5-quality-gates)
6. [Estrategia de Despliegue](#6-estrategia-de-despliegue)
7. [Rollback y Recovery](#7-rollback-y-recovery)
8. [Secretos y Configuraci√≥n](#8-secretos-y-configuraci√≥n)
9. [Monitorizaci√≥n Post-Deploy](#9-monitorizaci√≥n-post-deploy)
10. [Registro de Cambios](#10-registro-de-cambios)

---

## 1. Visi√≥n General

### 1.1 Objetivos del Pipeline

| Objetivo | Descripci√≥n |
|----------|-------------|
| **Automatizaci√≥n** | Cero intervenci√≥n manual en despliegues |
| **Calidad** | Tests obligatorios antes de producci√≥n |
| **Velocidad** | < 15 min desde commit hasta producci√≥n |
| **Seguridad** | Escaneo de vulnerabilidades integrado |
| **Trazabilidad** | Audit trail completo de cambios |

### 1.2 Flujo General

```mermaid
flowchart LR
    subgraph dev["üë®‚Äçüíª Desarrollo"]
        A[Commit] --> B[Push]
    end
    
    subgraph ci["üîÑ CI"]
        B --> C[Lint]
        C --> D[Unit Tests]
        D --> E[Security Scan]
        E --> F{Quality Gate}
    end
    
    subgraph cd["üöÄ CD"]
        F -->|Pass| G[Build]
        G --> H[Deploy Staging]
        H --> I[Integration Tests]
        I --> J{Aprobaci√≥n}
        J -->|Manual| K[Deploy Production]
    end
    
    F -->|Fail| L[‚ùå Notificaci√≥n]
```

---

## 2. Arquitectura del Pipeline

### 2.1 Branching Strategy

```mermaid
gitGraph
    commit id: "main"
    branch develop
    checkout develop
    commit id: "feature-1"
    branch feature/tenant-onboarding
    checkout feature/tenant-onboarding
    commit id: "implement"
    commit id: "tests"
    checkout develop
    merge feature/tenant-onboarding id: "PR merge"
    checkout main
    merge develop id: "Release v1.2.0" tag: "v1.2.0"
```

### 2.2 Ramas y Prop√≥sito

| Rama | Prop√≥sito | Despliegue Autom√°tico |
|------|-----------|----------------------|
| `main` | Producci√≥n estable | ‚Üí Production |
| `develop` | Integraci√≥n continua | ‚Üí Staging |
| `feature/*` | Nuevas funcionalidades | ‚Üí Preview (opcional) |
| `hotfix/*` | Correcciones urgentes | ‚Üí Staging ‚Üí Production |
| `release/*` | Preparaci√≥n de release | ‚Üí Staging |

### 2.3 Triggers

| Evento | Acci√≥n |
|--------|--------|
| Push a `feature/*` | Lint + Unit Tests |
| PR a `develop` | Full CI + Preview Deploy |
| Merge a `develop` | Deploy a Staging |
| Tag `v*.*.*` | Deploy a Production |
| Push a `hotfix/*` | Fast-track CI/CD |

---

## 3. Entornos

### 3.1 Definici√≥n de Entornos

| Entorno | URL | Prop√≥sito | Datos |
|---------|-----|-----------|-------|
| **Local** | `*.lndo.site` | Desarrollo | Fixtures |
| **Preview** | `pr-{n}.preview.jaraba.io` | Review de PR | Sanitizados |
| **Staging** | `staging.jaraba.io` | Pre-producci√≥n | Copia de prod |
| **Production** | `*.jaraba.io` | Producci√≥n | Reales |

### 3.2 Matriz de Configuraci√≥n

| Variable | Local | Staging | Production |
|----------|-------|---------|------------|
| `DEBUG` | true | true | false |
| `CACHE_ENABLED` | false | true | true |
| `AI_PROVIDER` | mock | openai | openai |
| `STRIPE_MODE` | test | test | live |
| `LOG_LEVEL` | debug | info | warning |

### 3.3 Infraestructura

```yaml
# docker-compose.prod.yml (simplificado)
services:
  web:
    image: jaraba/platform:${TAG}
    replicas: 2
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      
  database:
    image: mariadb:10.11
    volumes:
      - db_data:/var/lib/mysql
      
  redis:
    image: redis:7-alpine
    
  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
```

---

## 4. GitHub Actions Workflows

### 4.1 CI Workflow

```yaml
# .github/workflows/ci.yml
name: CI Pipeline

on:
  push:
    branches: [develop, feature/*, hotfix/*]
  pull_request:
    branches: [develop, main]

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '20'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer, phpcs, phpstan
          
      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          
      - name: Install dependencies
        run: composer install --no-dev --prefer-dist
        
      - name: PHP CodeSniffer
        run: phpcs --standard=Drupal,DrupalPractice web/modules/custom
        
      - name: PHPStan
        run: phpstan analyse web/modules/custom --level=6
        
      - name: ESLint
        run: |
          npm ci
          npm run lint:js

  test:
    runs-on: ubuntu-latest
    needs: lint
    services:
      mysql:
        image: mariadb:10.11
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: drupal_test
        ports:
          - 3306:3306
          
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo_mysql, gd, zip
          
      - name: Install Drupal
        run: |
          composer install
          cp .env.ci .env
          ./vendor/bin/drush site:install minimal -y
          
      - name: Run PHPUnit
        run: |
          ./vendor/bin/phpunit \
            --configuration phpunit.xml \
            --coverage-clover coverage.xml
            
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml

  security:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Composer Audit
        run: composer audit
        
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          security-checks: 'vuln,secret'
          severity: 'HIGH,CRITICAL'
```

### 4.2 CD Workflow - Staging

```yaml
# .github/workflows/deploy-staging.yml
name: Deploy to Staging

on:
  push:
    branches: [develop]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker Image
        run: |
          docker build -t jaraba/platform:staging-${{ github.sha }} .
          
      - name: Push to Registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push jaraba/platform:staging-${{ github.sha }}
          
      - name: Deploy to Staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: deploy
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /var/www/jaraba
            docker compose pull
            docker compose up -d --no-deps web
            docker compose exec web drush cr
            docker compose exec web drush updb -y
            
      - name: Smoke Tests
        run: |
          sleep 30
          curl -f https://staging.jaraba.io/health || exit 1
          
      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "‚úÖ Staging deployed: ${{ github.sha }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

### 4.3 CD Workflow - Production

```yaml
# .github/workflows/deploy-production.yml
name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
      - name: Build Production Image
        run: |
          docker build \
            --build-arg VERSION=${{ steps.version.outputs.VERSION }} \
            -t jaraba/platform:${{ steps.version.outputs.VERSION }} \
            -t jaraba/platform:latest \
            .
            
      - name: Push to Registry
        run: |
          docker push jaraba/platform:${{ steps.version.outputs.VERSION }}
          docker push jaraba/platform:latest
          
      - name: Pre-deploy Backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: deploy
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            /opt/scripts/backup-database.sh production pre-deploy
            
      - name: Blue-Green Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: deploy
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /var/www/jaraba
            export TAG=${{ steps.version.outputs.VERSION }}
            ./scripts/blue-green-deploy.sh
            
      - name: Health Check
        run: |
          for i in {1..10}; do
            curl -f https://jaraba.io/health && exit 0
            sleep 10
          done
          exit 1
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          
      - name: Notify
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "üöÄ Production deployed: ${{ steps.version.outputs.VERSION }}"
            }
```

---

## 5. Quality Gates

### 5.1 Criterios de Aceptaci√≥n

| Gate | Criterio | Umbral |
|------|----------|--------|
| **Code Coverage** | Cobertura de tests | ‚â• 80% |
| **Static Analysis** | Errores PHPStan | 0 |
| **Code Style** | Violaciones PHPCS | 0 |
| **Security** | Vulnerabilidades cr√≠ticas | 0 |
| **Performance** | Lighthouse Score | ‚â• 85 |
| **Accessibility** | WCAG 2.1 AA | Pass |

### 5.2 Branch Protection Rules

```yaml
# Configuraci√≥n de protecci√≥n (repository settings)
main:
  required_reviews: 2
  require_code_owner_review: true
  require_status_checks:
    - lint
    - test
    - security
  require_linear_history: true
  require_signed_commits: true
  
develop:
  required_reviews: 1
  require_status_checks:
    - lint
    - test
```

---

## 6. Estrategia de Despliegue

### 6.1 Blue-Green Deployment

```mermaid
sequenceDiagram
    participant LB as Load Balancer
    participant Blue as Blue (v1.1)
    participant Green as Green (v1.2)
    participant DB as Database
    
    Note over Blue: Activo
    Note over Green: Standby
    
    Green->>DB: drush updb
    Green->>Green: Health check
    
    LB->>Green: Switch traffic
    Note over Green: Activo
    Note over Blue: Standby
    
    alt Problema detectado
        LB->>Blue: Rollback instant√°neo
    else OK
        Blue->>Blue: Cleanup
    end
```

### 6.2 Script de Blue-Green

```bash
#!/bin/bash
# scripts/blue-green-deploy.sh

set -e

CURRENT=$(docker compose ps --format "table {{.Name}}" | grep web | head -1)
if [[ $CURRENT == *"blue"* ]]; then
  DEPLOY_TO="green"
  CURRENT_ENV="blue"
else
  DEPLOY_TO="blue"
  CURRENT_ENV="green"
fi

echo "üîÑ Deploying to $DEPLOY_TO (current: $CURRENT_ENV)"

# Pull new image
docker compose pull web-$DEPLOY_TO

# Start new container
docker compose up -d web-$DEPLOY_TO

# Wait for health
for i in {1..30}; do
  if curl -sf http://localhost:808${DEPLOY_TO: -1}/health; then
    echo "‚úÖ $DEPLOY_TO is healthy"
    break
  fi
  sleep 2
done

# Run database updates
docker compose exec web-$DEPLOY_TO drush updb -y
docker compose exec web-$DEPLOY_TO drush cr

# Switch nginx upstream
sed -i "s/web-$CURRENT_ENV/web-$DEPLOY_TO/g" /etc/nginx/conf.d/upstream.conf
nginx -s reload

echo "üöÄ Traffic switched to $DEPLOY_TO"

# Keep old container for 5 minutes (rollback window)
sleep 300
docker compose stop web-$CURRENT_ENV
```

---

## 7. Rollback y Recovery

### 7.1 Procedimiento de Rollback

| Escenario | Acci√≥n | Tiempo |
|-----------|--------|--------|
| **Post-deploy inmediato** | Switch a contenedor anterior | < 30s |
| **Problema en BD** | Restore desde backup pre-deploy | < 5 min |
| **Problema en c√≥digo** | Deploy de tag anterior | < 10 min |

### 7.2 Comandos de Rollback

```bash
# Rollback inmediato (blue-green)
./scripts/blue-green-rollback.sh

# Rollback a versi√≥n espec√≠fica
./scripts/deploy-version.sh v1.1.5

# Restore de base de datos
./scripts/restore-database.sh production pre-deploy-2026-01-09
```

### 7.3 Automatizaci√≥n de Rollback

```yaml
# ECA o GitHub Action fallback
on_health_check_fail:
  - notify: "üî¥ Health check failed on production"
  - action: rollback_to_previous
  - notify: "üîÑ Rollback initiated automatically"
```

---

## 8. Secretos y Configuraci√≥n

### 8.1 GitHub Secrets

| Secret | Descripci√≥n | Entornos |
|--------|-------------|----------|
| `DOCKER_USERNAME` | Docker Hub user | All |
| `DOCKER_PASSWORD` | Docker Hub token | All |
| `STAGING_SSH_KEY` | SSH key staging | Staging |
| `PROD_SSH_KEY` | SSH key production | Production |
| `SLACK_WEBHOOK` | Notificaciones | All |
| `STRIPE_SECRET_KEY` | API Stripe | Production |
| `DATABASE_URL` | Connection string | Per-environment |

### 8.2 Gesti√≥n de Configuraci√≥n

```bash
# .env.example
DATABASE_URL=mysql://user:pass@localhost/drupal
REDIS_URL=redis://localhost:6379
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
AI_API_KEY=xxx
```

### 8.3 Seguridad de Secretos

- ‚úÖ Secretos en GitHub Secrets (encrypted)
- ‚úÖ Rotaci√≥n trimestral obligatoria
- ‚úÖ Acceso por environment (staging vs production)
- ‚ùå Nunca en c√≥digo fuente
- ‚ùå Nunca en logs

---

## 9. Monitorizaci√≥n Post-Deploy

### 9.1 M√©tricas a Monitorizar

| M√©trica | Herramienta | Umbral Alerta |
|---------|-------------|---------------|
| **Response Time** | New Relic | > 500ms |
| **Error Rate** | Sentry | > 1% |
| **CPU Usage** | Prometheus | > 80% |
| **Memory** | Prometheus | > 85% |
| **DB Connections** | Prometheus | > 90% |
| **Queue Depth** | Redis | > 1000 |

### 9.2 Dashboard Post-Deploy

```yaml
# Grafana dashboard widgets
panels:
  - title: "Requests/sec"
    type: graph
    query: "rate(http_requests_total[5m])"
    
  - title: "Error Rate"
    type: gauge
    query: "rate(http_errors_total[5m]) / rate(http_requests_total[5m])"
    
  - title: "P95 Latency"
    type: stat
    query: "histogram_quantile(0.95, http_request_duration_seconds)"
    
  - title: "Active Tenants"
    type: counter
    query: "count(tenant_active)"
```

### 9.3 Alertas Cr√≠ticas

```yaml
# Alertmanager rules
groups:
  - name: post-deploy
    rules:
      - alert: HighErrorRate
        expr: rate(http_errors_total[5m]) > 0.05
        for: 2m
        annotations:
          summary: "Error rate above 5%"
          
      - alert: SlowResponses
        expr: http_request_duration_seconds_p95 > 1
        for: 5m
        annotations:
          summary: "P95 latency above 1s"
```

---

## 10. Registro de Cambios

| Fecha | Versi√≥n | Descripci√≥n |
|-------|---------|-------------|
| 2026-01-09 | 1.0.0 | Creaci√≥n inicial del documento |
