# Plan de Cierre de Gaps - Especificaciones 20260122-20260125

**Fecha**: 2026-02-12
**Version**: 1.0.0
**Estado**: Implementado
**Autor**: Claude Code (asistido)

---

## Tabla de Contenidos

1. [Contexto y Alcance](#1-contexto-y-alcance)
2. [Hallazgos de Auditoria](#2-hallazgos-de-auditoria)
3. [FASE 1: Infraestructura Lando](#3-fase-1-infraestructura-lando)
4. [FASE 2: Content Entities Self-Discovery](#4-fase-2-content-entities-self-discovery)
5. [FASE 3: Servicios Dedicados](#5-fase-3-servicios-dedicados)
6. [FASE 4: Formularios Phase 2/3](#6-fase-4-formularios-phase-23)
7. [FASE 5: Integracion Copilot v2](#7-fase-5-integracion-copilot-v2)
8. [FASE 6: Tests Unitarios](#8-fase-6-tests-unitarios)
9. [Tabla de Correspondencia con Especificaciones](#9-tabla-de-correspondencia)
10. [Cumplimiento de Directrices](#10-cumplimiento-de-directrices)
11. [Verificacion Post-Implementacion](#11-verificacion)

---

## 1. Contexto y Alcance

La auditoria de los 7 documentos tecnicos (Docs 159-165, fechados 20260122-20260125) revelo gaps de implementacion en 3 areas principales:

- **Infraestructura Lando** (Doc 159): Configuracion Redis, variables de entorno, script de onboarding
- **Modulo Self-Discovery** (Docs 160-161): Content Entities faltantes, servicios dedicados, formularios Phase 2/3
- **Integracion Copilot v2** (Doc 161): Inyeccion automatica de contexto Self-Discovery

**Hallazgo clave**: k6 load testing ya existia en `tests/performance/load_test.js` (270 lineas). La auditoria inicial reporto un falso negativo, coherente con el aprendizaje documentado en `2026-02-09_auditoria_v2_falsos_positivos`.

**Total gaps reales**: 14 items (no 15 como se reporto inicialmente).

---

## 2. Hallazgos de Auditoria

### Estado Pre-Implementacion

| Componente | Estado | Completitud |
|-----------|--------|-------------|
| `.lando/redis.conf` | No existe | 0% |
| `settings.local.php` | Solo Redis basico | 30% |
| `.env.example` | No existe | 0% |
| `scripts/setup-dev.sh` | No existe | 0% |
| InterestProfile entity | Datos en user.data (volatil) | 0% |
| StrengthAssessment entity | Datos en user.data (volatil) | 0% |
| LifeWheelService | No existe | 0% |
| TimelineAnalysisService | No existe | 0% |
| RiasecService | No existe | 0% |
| StrengthAnalysisService | No existe | 0% |
| TimelinePhase2Form | No existe | 0% |
| TimelinePhase3Form | No existe | 0% |
| Copilot context injection | No hay inyeccion automatica | 0% |
| Tests unitarios | Solo 2 archivos existentes | 40% |

### Estado Post-Implementacion

Todos los componentes al 100% de conformidad con especificaciones.

---

## 3. FASE 1: Infraestructura Lando

### 3.1 Redis Configuration (`.lando/redis.conf`)

**Spec**: Doc 159, seccion 7.1.3
**Solucion**: Archivo de configuracion Redis optimizado para desarrollo local con:
- `maxmemory 1gb` para entorno de desarrollo
- Politica `allkeys-lru` para evitar errores OOM
- Persistencia RDB cada 300 segundos si hay 10+ cambios
- Logging a `/var/log/redis/redis.log`

### 3.2 Settings Local (`settings.local.php`)

**Spec**: Doc 159, seccion 6.2
**Estado previo**: Solo configuracion Redis basica (30%)
**Solucion**: Completar con:
- Configuracion Qdrant (host, puerto, API key via `getenv()`)
- Configuracion Tika (host, puerto)
- Credenciales AI (OpenAI, Anthropic) via `getenv()`
- Xdebug settings
- Trusted host patterns para `*.lndo.site`
- Development cache settings (render/page cache NULL)
- CSS/JS aggregation deshabilitada
- Rutas de archivos (public, private, temp)

### 3.3 Environment Template (`.env.example`)

**Spec**: Doc 159, seccion 5.2
**Solucion**: Template con placeholders (NUNCA credenciales reales):
- Variables de base de datos
- Credenciales Redis
- Configuracion Qdrant y Tika
- API keys AI (placeholder)
- Configuracion de entorno (debug, hash salt)

### 3.4 Script de Onboarding (`scripts/setup-dev.sh`)

**Spec**: Doc 159, seccion 7.2
**Solucion**: Script Bash completo con:
- `set -e` para fail-fast
- Verificacion de prerequisitos (Docker, Lando)
- Creacion de directorios necesarios
- Copia de `.env.example` a `.env`
- Arranque de Lando
- Instalacion de dependencias Composer
- Health check de servicios AI
- Resumen de verificacion final

---

## 4. FASE 2: Content Entities Self-Discovery

### Decision Arquitectonica

Las especificaciones Docs 160 y 161 definen InterestProfile y StrengthAssessment como Content Entities. Los datos RIASEC y Fortalezas se guardaban anteriormente en `user.data` (servicio volatil, sin Field UI, sin Views integration). Se crean como Content Entities manteniendo compatibilidad retroactiva con `user.data`.

### 4.1 InterestProfile Entity

**Tabla**: `interest_profile`
**Patron**: Identico a `LifeWheelAssessment.php` (ContentEntityBase + EntityOwnerInterface)
**Campos**:
- `user_id`: entity_reference a User
- `riasec_code`: string (3 caracteres, ej: "RIA")
- `score_realistic` a `score_conventional`: 6 enteros 0-100
- `dominant_types`: string_long (JSON array)
- `answers`: string_long (JSON de respuestas)
- `suggested_careers`: string_long (JSON array)
- `created`, `changed`: timestamps

**Handlers**:
- ListBuilder: `InterestProfileListBuilder`
- Access: `InterestProfileAccessControlHandler`
- Form: Settings form para Field UI base route
- Route Provider: `AdminHtmlRouteProvider`
- Views Data: `EntityViewsData`

### 4.2 StrengthAssessment Entity

**Tabla**: `strength_assessment`
**Campos**:
- `user_id`: entity_reference a User
- `top_strengths`: string_long (JSON array top 5)
- `all_scores`: string_long (JSON con scores de 24 fortalezas)
- `answers`: string_long (JSON de 20 selecciones)
- `created`, `changed`: timestamps

**Handlers**: Misma estructura que InterestProfile.

### 4.3 Actualizacion de Forms Existentes

- `InterestsAssessmentForm::saveResults()`: Ahora crea `InterestProfile` entity ademas de guardar en `user.data` (compatibilidad retroactiva)
- `StrengthsAssessmentForm::saveResults()`: Ahora crea `StrengthAssessment` entity ademas de guardar en `user.data`

### 4.4 Navegacion Administrativa

- Rutas settings para ambas entidades en `/admin/structure/`
- Tabs en `/admin/content` para ambas colecciones
- Menu links en `/admin/structure` para ambas
- Botones "Anadir" en las colecciones

---

## 5. FASE 3: Servicios Dedicados

### 5.1 LifeWheelService

**Responsabilidades**: Encapsula toda la logica de consulta de evaluaciones Rueda de la Vida.
- `getLatestAssessment(uid)`: Ultima evaluacion del usuario
- `getAverageScore(uid)`: Promedio de la ultima evaluacion
- `getLowestAreas(uid, count)`: Areas con puntuacion mas baja
- `getHighestAreas(uid, count)`: Areas con puntuacion mas alta
- `getTrend(uid)`: Compara ultima con penultima evaluacion
- `getHistorical(uid, limit)`: Historial de evaluaciones

### 5.2 TimelineAnalysisService

**Responsabilidades**: Analisis y agregacion de eventos del Timeline.
- `getAllEvents(uid)`: Todos los eventos del usuario
- `getIdentifiedPatterns(uid)`: Factores recurrentes
- `getTopSatisfactionFactors(uid)`: Factores de satisfaccion mas frecuentes
- `getTopSkills(uid)`: Habilidades mas mencionadas
- `getTopValues(uid)`: Valores mas descubiertos
- `getEventsByType(uid, type)`: Filtrar por tipo de evento

### 5.3 RiasecService

**Responsabilidades**: Acceso a datos RIASEC con fallback a user.data.
- `getLatestProfile(uid)`: Ultimo perfil InterestProfile entity
- `getCode(uid)`: Codigo RIASEC de 3 letras
- `getScores(uid)`: Puntuaciones por categoria
- `getDominantTypes(uid)`: Tipos dominantes
- `getSuggestedCareers(uid)`: Carreras sugeridas
- Fallback automatico a `user.data` para retrocompatibilidad

### 5.4 StrengthAnalysisService

**Responsabilidades**: Acceso a datos de Fortalezas con fallback a user.data.
- `getLatestAssessment(uid)`: Ultima evaluacion StrengthAssessment
- `getTop5(uid)`: Top 5 fortalezas
- `getAllScores(uid)`: Todas las puntuaciones
- `getStrengthDescription(strengthKey)`: Descripcion de una fortaleza
- Fallback automatico a `user.data` para retrocompatibilidad

### 5.5 Refactorizacion de SelfDiscoveryContextService

El servicio original accedia directamente a entities y user.data. Se refactoriza para inyectar los 4 servicios nuevos, convirtiendose en un agregador puro que delega a los servicios especializados.

---

## 6. FASE 4: Formularios Phase 2/3

### 6.1 TimelinePhase2Form

**Ruta**: `/my-profile/self-discovery/timeline/{life_timeline}/describe`
**Proposito**: Enriquecer un evento del Timeline con informacion de Phase 2.
**Campos**:
- `event_description`: textarea para describir el evento en detalle
- `satisfaction_factors`: checkboxes (Logro, Reconocimiento, Autonomia, Proposito, Crecimiento)
- `skills_demonstrated`: textfield para habilidades demostradas
- `values_reflected`: textfield para valores reflejados

### 6.2 TimelinePhase3Form

**Ruta**: `/my-profile/self-discovery/timeline/patterns`
**Proposito**: Identificar patrones recurrentes en el Timeline.
**Campos**:
- `patterns_identified`: textarea para patrones identificados
- `recurring_themes`: textfield para temas recurrentes
- `ai_insights`: contenido readonly generado por TimelineAnalysisService

---

## 7. FASE 5: Integracion Copilot v2

### Patron Descubierto

El `CopilotOrchestratorService` ya utiliza inyeccion nullable para `EntrepreneurContextService` (argumento 9 del constructor). Se sigue exactamente el mismo patron.

### Cambios

1. **Constructor**: Anadir `?SelfDiscoveryContextService $selfDiscoveryContext = NULL` como 10mo argumento
2. **services.yml**: Anadir `'@jaraba_self_discovery.context'` como argumento del orchestrator
3. **buildSystemPrompt()**: Si `$this->selfDiscoveryContext` no es null, llamar a `getCopilotContextPrompt()` y anexar al prompt
4. **Sin hook en .module**: La inyeccion via servicio es mas limpia y sigue el patron establecido

---

## 8. FASE 6: Tests Unitarios

### Tests de Entidades
- `InterestProfileTest.php`: Verifica campos base, logica de codigo RIASEC, JSON parsing
- `StrengthAssessmentTest.php`: Verifica campos base, top 5, JSON parsing

### Tests de Servicios
- `LifeWheelServiceTest.php`: Verifica calculo de promedio, areas bajas/altas, tendencia
- `RiasecServiceTest.php`: Verifica obtencion de codigo, scores, fallback
- `StrengthAnalysisServiceTest.php`: Verifica top 5, all scores, fallback

**Patron**: PHPUnit TestCase (no UnitTestCase de Drupal para evitar dependencias), replicando logica interna.

---

## 9. Tabla de Correspondencia

| Spec | Seccion | Area | Gap | Solucion | Fase |
|------|---------|------|-----|----------|------|
| Doc 159 | S7.1.3 | redis.conf | Archivo no existe | Crear `.lando/redis.conf` | 1.1 |
| Doc 159 | S6.2 | settings.local.php | Incompleto (30%) | Completar configuracion | 1.2 |
| Doc 159 | S5.2 | .env.example | No existe en raiz | Crear template | 1.3 |
| Doc 159 | S7.2 | setup-dev.sh | No existe | Crear script onboarding | 1.4 |
| Doc 160 | S3.1 | InterestProfile | No es Content Entity | Crear entity + handlers | 2.1 |
| Doc 160 | S3.1 | StrengthAssessment | No es Content Entity | Crear entity + handlers | 2.2 |
| Doc 160 | S3.2 | LifeWheelService | No existe | Crear servicio | 3.1 |
| Doc 160 | S3.2 | TimelineAnalysisService | No existe | Crear servicio | 3.2 |
| Doc 160 | S3.2 | RiasecService | No existe | Crear servicio | 3.3 |
| Doc 160 | S3.2 | StrengthAnalysisService | No existe | Crear servicio | 3.4 |
| Doc 161 | S3.1 | TimelinePhase2Form | No existe form class | Crear formulario | 4.1 |
| Doc 161 | S3.1 | TimelinePhase3Form | No existe form class | Crear formulario | 4.2 |
| Doc 161 | S2 | Copilot context injection | No hay inyeccion auto | Inyectar via constructor | 5.1 |
| Doc 160 | S6 | Tests unitarios | Incompletos | Crear 5 test files | 6 |

---

## 10. Cumplimiento de Directrices

| Directriz | Implementacion |
|-----------|---------------|
| **i18n** | Todos los textos con `$this->t()` en PHP |
| **Content Entities** | Field UI, Views, AdminHtmlRouteProvider, fieldable=TRUE |
| **Admin navigation** | /admin/content (task links) + /admin/structure (menu links) |
| **Tenant isolation** | Permissions + entity owner access control |
| **@ai.provider** | Copilot usa AI module, no HTTP directo |
| **Variables entorno** | Todas via `getenv()`, nunca hardcoded |
| **Seguridad** | `.env.example` con placeholders, `.env` en `.gitignore` |
| **Scripts** | `set -e`, colores, verificaciones, patron existente |

---

## 11. Verificacion

### Comandos de Verificacion

```bash
# 1. Crear tablas de entidades nuevas
lando drush entity:updates -y

# 2. Limpiar cache
lando drush cr

# 3. Ejecutar tests
lando php vendor/bin/phpunit web/modules/custom/jaraba_self_discovery/tests/

# 4. Verificar navegacion admin
# - /admin/content -> tabs InterestProfile y StrengthAssessment
# - /admin/structure -> enlaces de configuracion
```

### Archivos Creados

Total: 23 archivos nuevos (incluido este documento).

### Archivos Modificados

Total: 11 archivos existentes actualizados.
