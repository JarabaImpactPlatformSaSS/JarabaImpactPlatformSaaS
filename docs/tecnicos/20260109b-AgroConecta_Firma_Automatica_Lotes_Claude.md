Firma Automática en Servidor
Certificados de Trazabilidad de Lotes con Validez Legal
Especificación Técnica para AgroConecta Core
1. Concepto y Valor de Negocio
1.1. ¿Qué es la Firma Automática en Servidor?
La firma automática en servidor es un proceso donde el propio sistema (AgroConecta) firma digitalmente los documentos que genera, utilizando un certificado de persona jurídica o sello de empresa. No requiere intervención del usuario final.
1.2. ¿Por qué es Valioso para AgroConecta?
•	Trazabilidad con Valor Legal: Los certificados de lote firmados digitalmente tienen validez probatoria en caso de disputas sobre origen o calidad.
•	Diferenciación "Solución Propia": Cumple con los requisitos RETECH de valor añadido. Ninguna plataforma estándar ofrece esto.
•	Automatización Total: El productor ("Marta") no necesita hacer nada. Al crear un lote, el certificado se genera y firma automáticamente.
•	Confianza del Consumidor: El cliente final puede verificar la autenticidad del certificado con herramientas estándar (Adobe Reader, VALIDe).
•	Integración con QR: El QR del lote puede enlazar directamente al PDF firmado, completando la trazabilidad "phy-gital".
2. Arquitectura del Sistema
2.1. Flujo Completo
┌─────────────────────────────────────────────────────────────────────────────┐ │                    FLUJO DE FIRMA AUTOMÁTICA                                 │ ├─────────────────────────────────────────────────────────────────────────────┤ │                                                                              │ │   ┌──────────────┐                                                          │ │   │  PRODUCTOR   │  Crea/actualiza Lote de Producción                       │ │   │  ("Marta")   │  en Drupal                                               │ │   └──────┬───────┘                                                          │ │          │                                                                   │ │          ▼                                                                   │ │   ┌──────────────────────────────────────────────────────────────────┐      │ │   │                     DRUPAL (hook_entity_insert)                   │      │ │   │   ┌─────────────────────────────────────────────────────────┐    │      │ │   │   │  1. TrazabilidadService::generateLoteId()               │    │      │ │   │   │     → Genera ID único: LOTE-202501-123-XY7Z             │    │      │ │   │   └─────────────────────────────────────────────────────────┘    │      │ │   │                           │                                       │      │ │   │                           ▼                                       │      │ │   │   ┌─────────────────────────────────────────────────────────┐    │      │ │   │   │  2. CertificadoTrazabilidadService::generatePdf()       │    │      │ │   │   │     → Genera PDF con datos del lote                     │    │      │ │   │   │     → Incluye: origen, fechas, análisis, productor      │    │      │ │   │   └─────────────────────────────────────────────────────────┘    │      │ │   │                           │                                       │      │ │   │                           ▼                                       │      │ │   │   ┌─────────────────────────────────────────────────────────┐    │      │ │   │   │  3. FirmaDigitalService::signPdf()                      │    │      │ │   │   │     → Carga certificado PJ desde almacén seguro         │    │      │ │   │   │     → Firma PDF con PKCS#7 / PAdES                      │    │      │ │   │   │     → Añade sello de tiempo (TSA)                       │    │      │ │   │   └─────────────────────────────────────────────────────────┘    │      │ │   │                           │                                       │      │ │   │                           ▼                                       │      │ │   │   ┌─────────────────────────────────────────────────────────┐    │      │ │   │   │  4. Almacenamiento y Vinculación                        │    │      │ │   │   │     → Guarda PDF en files/private/certificados/         │    │      │ │   │   │     → Actualiza campo field_certificado_firmado         │    │      │ │   │   │     → Registra hash en log de auditoría                 │    │      │ │   │   └─────────────────────────────────────────────────────────┘    │      │ │   └──────────────────────────────────────────────────────────────────┘      │ │                           │                                                  │ │                           ▼                                                  │ │   ┌──────────────────────────────────────────────────────────────────┐      │ │   │                     RESULTADO FINAL                               │      │ │   │   • PDF firmado digitalmente disponible                          │      │ │   │   • QR del lote enlaza a página con descarga del certificado     │      │ │   │   • Verificable con Adobe Reader, VALIDe, AutoFirma              │      │ │   └──────────────────────────────────────────────────────────────────┘      │ │                                                                              │ └─────────────────────────────────────────────────────────────────────────────┘
2.2. Componentes del Sistema
Componente	Responsabilidad
TrazabilidadService	Genera IDs de lote únicos. Ya existente en agroconecta_core.
CertificadoPdfService	Genera el PDF con los datos de trazabilidad usando TCPDF o FPDF.
FirmaDigitalService	Firma el PDF con el certificado del servidor. Usa TCPDF o SetaPDF.
Certificado PJ	Certificado de persona jurídica (FNMT) o sello de empresa almacenado de forma segura.
TSA (Sellado Tiempo)	Servicio externo que certifica la fecha/hora de firma. Ej: TSA de FNMT gratuito.
 
3. Certificado Digital Necesario
3.1. Tipos de Certificado Válidos
Tipo	Descripción	Coste Aprox.
Representante PJ	Certificado de persona física que actúa como representante legal de la empresa.	~14€/2 años (FNMT)
Sello de Empresa	Certificado vinculado a la persona jurídica, sin representante específico. Ideal para automatización.	~14€/2 años (FNMT)
Sello Cualificado	Máxima garantía. Requiere dispositivo criptográfico (HSM o token).	~200-500€/año + HSM
Recomendación: Para AgroConecta, el "Sello de Empresa" de la FNMT es la opción más equilibrada. Permite automatización completa a bajo coste.
3.2. Obtención del Certificado (FNMT)
1.	Acceder a sede.fnmt.gob.es/certificados/certificado-de-representante
2.	Solicitar certificado de "Sello de Empresa" o "Representante de Persona Jurídica"
3.	Acreditación presencial en oficina de registro (Hacienda, Seguridad Social, etc.)
4.	Descarga e instalación del certificado en formato .p12 / .pfx
5.	Exportar con contraseña segura para uso en servidor
3.3. Almacenamiento Seguro del Certificado
El certificado NUNCA debe estar en el repositorio de código ni en directorios públicos.
Opción	Implementación
Básica	Archivo .p12 en /etc/ssl/private/ con permisos 600. Contraseña en variable de entorno.
Intermedia	HashiCorp Vault o similar. El servicio solicita el certificado en tiempo de ejecución.
Avanzada (HSM)	Hardware Security Module. El certificado nunca abandona el dispositivo físico.
 
4. Implementación Técnica
4.1. Dependencias PHP
# Instalar TCPDF (generación y firma de PDF) composer require tecnickcom/tcpdf  # Alternativa: SetaPDF-Signer (comercial, más robusto) # https://www.setasign.com/products/setapdf-signer/
4.2. Servicio: CertificadoPdfService.php
Este servicio genera el PDF con los datos de trazabilidad del lote.
<?php  namespace Drupal\agroconecta_core\Service;  use Drupal\node\NodeInterface; use Drupal\Core\File\FileSystemInterface; use TCPDF;  /**  * Genera certificados PDF de trazabilidad para lotes.  */ class CertificadoPdfService {    protected FileSystemInterface $fileSystem;    public function __construct(FileSystemInterface $file_system) {     $this->fileSystem = $file_system;   }    /**    * Genera un PDF con los datos del lote.    *    * @param \Drupal\node\NodeInterface $lote    *   El nodo de tipo lote_produccion.    *    * @return string|null    *   Ruta al archivo PDF generado, o NULL si falla.    */   public function generatePdf(NodeInterface $lote): ?string {     if ($lote->bundle() !== 'lote_produccion') {       return NULL;     }      // Extraer datos del lote     $lote_id = $lote->get('field_id_lote')->value ?? 'SIN-ID';     $producto = $lote->get('field_producto_asociado')->entity;     $producto_nombre = $producto ? $producto->getTitle() : 'Producto no especificado';     $fecha_cosecha = $lote->get('field_fecha_cosecha')->value ?? 'No especificada';     $fecha_molturacion = $lote->get('field_fecha_molturacion')->value ?? 'No especificada';     $finca = $lote->get('field_finca_origen')->entity;     $finca_nombre = $finca ? $finca->getName() : 'Origen no especificado';      // Crear PDF     $pdf = new TCPDF('P', 'mm', 'A4', true, 'UTF-8', false);          // Metadatos     $pdf->SetCreator('AgroConecta');     $pdf->SetAuthor('AgroConecta - Plataforma de Trazabilidad');     $pdf->SetTitle('Certificado de Trazabilidad - ' . $lote_id);     $pdf->SetSubject('Certificado de origen y trazabilidad');          // Configuración de página     $pdf->SetMargins(20, 30, 20);     $pdf->SetAutoPageBreak(TRUE, 25);     $pdf->AddPage();      // === CONTENIDO DEL CERTIFICADO ===          // Logo (si existe)     // $pdf->Image('path/to/logo.png', 80, 10, 50);          // Título     $pdf->SetFont('helvetica', 'B', 24);     $pdf->SetTextColor(46, 125, 50); // Verde AgroConecta     $pdf->Cell(0, 20, 'CERTIFICADO DE TRAZABILIDAD', 0, 1, 'C');          $pdf->SetFont('helvetica', '', 12);     $pdf->SetTextColor(100, 100, 100);     $pdf->Cell(0, 10, 'Documento con firma electrónica cualificada', 0, 1, 'C');          $pdf->Ln(10);          // Datos del lote     $pdf->SetFont('helvetica', 'B', 14);     $pdf->SetTextColor(0, 0, 0);     $pdf->Cell(0, 10, 'IDENTIFICACIÓN DEL LOTE', 0, 1, 'L');          $pdf->SetFont('helvetica', '', 11);     $this->addDataRow($pdf, 'Código de Lote:', $lote_id);     $this->addDataRow($pdf, 'Producto:', $producto_nombre);     $this->addDataRow($pdf, 'Fecha de emisión:', date('d/m/Y H:i:s'));          $pdf->Ln(5);          // Datos de origen     $pdf->SetFont('helvetica', 'B', 14);     $pdf->Cell(0, 10, 'DATOS DE ORIGEN Y PRODUCCIÓN', 0, 1, 'L');          $pdf->SetFont('helvetica', '', 11);     $this->addDataRow($pdf, 'Finca/Parcela:', $finca_nombre);     $this->addDataRow($pdf, 'Fecha de cosecha:', $this->formatDate($fecha_cosecha));     $this->addDataRow($pdf, 'Fecha de procesado:', $this->formatDate($fecha_molturacion));          $pdf->Ln(10);          // Declaración     $pdf->SetFont('helvetica', 'I', 10);     $pdf->SetTextColor(80, 80, 80);     $pdf->MultiCell(0, 5,        'Este certificado acredita la trazabilidad del lote identificado. ' .       'La información contenida ha sido verificada por la plataforma AgroConecta ' .       'y está respaldada por firma electrónica cualificada conforme al Reglamento (UE) Nº 910/2014 (eIDAS).',       0, 'J');          $pdf->Ln(10);          // Código QR de verificación     $verification_url = \Drupal::request()->getSchemeAndHttpHost() . '/trazabilidad/' . $lote_id;     $pdf->write2DBarcode($verification_url, 'QRCODE,M', 80, $pdf->GetY(), 50, 50);          $pdf->SetY($pdf->GetY() + 55);     $pdf->SetFont('helvetica', '', 9);     $pdf->Cell(0, 5, 'Escanee el QR para verificar este certificado online', 0, 1, 'C');          // Pie de página con aviso legal     $pdf->SetY(-40);     $pdf->SetFont('helvetica', '', 8);     $pdf->SetTextColor(120, 120, 120);     $pdf->MultiCell(0, 4,       'Documento firmado electrónicamente. Puede verificar la validez de la firma en https://valide.redsara.es ' .       'La manipulación de este documento constituye un delito conforme al artículo 390 del Código Penal.',       0, 'C');      // Guardar PDF     $directory = 'private://certificados/' . date('Y/m');     $this->fileSystem->prepareDirectory($directory, FileSystemInterface::CREATE_DIRECTORY);          $filename = 'certificado-' . $lote_id . '-' . time() . '.pdf';     $filepath = $directory . '/' . $filename;     $real_path = $this->fileSystem->realpath($directory) . '/' . $filename;          $pdf->Output($real_path, 'F');          return $real_path;   }    /**    * Añade una fila de datos al PDF.    */   protected function addDataRow(TCPDF $pdf, string $label, string $value): void {     $pdf->SetFont('helvetica', 'B', 11);     $pdf->Cell(50, 7, $label, 0, 0, 'L');     $pdf->SetFont('helvetica', '', 11);     $pdf->Cell(0, 7, $value, 0, 1, 'L');   }    /**    * Formatea una fecha.    */   protected function formatDate(?string $date): string {     if (!$date) return 'No especificada';     $timestamp = strtotime($date);     return $timestamp ? date('d/m/Y', $timestamp) : $date;   } }
 
4.3. Servicio: FirmaDigitalService.php
Este servicio firma el PDF con el certificado del servidor y añade sellado de tiempo.
<?php  namespace Drupal\agroconecta_core\Service;  use Drupal\Core\Config\ConfigFactoryInterface; use Drupal\Core\Logger\LoggerChannelFactoryInterface; use TCPDF;  /**  * Servicio de firma digital de documentos PDF.  */ class FirmaDigitalService {    protected $config;   protected $logger;    // TSA gratuito de la FNMT   const TSA_URL = 'http://tsa.fnmt.es/tsa/tss';    public function __construct(     ConfigFactoryInterface $config_factory,     LoggerChannelFactoryInterface $logger_factory   ) {     $this->config = $config_factory->get('agroconecta_core.firma_settings');     $this->logger = $logger_factory->get('agroconecta_core');   }    /**    * Firma un PDF con el certificado del servidor.    *    * @param string $pdf_path    *   Ruta al PDF sin firmar.    * @param array $options    *   Opciones adicionales (reason, location, contact).    *    * @return string|null    *   Ruta al PDF firmado, o NULL si falla.    */   public function signPdf(string $pdf_path, array $options = []): ?string {     // Cargar configuración del certificado     $cert_path = $this->config->get('certificate_path');     $cert_password = $this->getPassword();          if (!$cert_path || !file_exists($cert_path)) {       $this->logger->error('Certificado no encontrado: @path', ['@path' => $cert_path]);       return NULL;     }      if (!file_exists($pdf_path)) {       $this->logger->error('PDF no encontrado: @path', ['@path' => $pdf_path]);       return NULL;     }      try {       // Cargar el certificado PKCS#12       $cert_content = file_get_contents($cert_path);       $certs = [];              if (!openssl_pkcs12_read($cert_content, $certs, $cert_password)) {         $this->logger->error('Error al leer el certificado PKCS#12');         return NULL;       }        // Crear nuevo PDF para firma       $pdf = new TCPDF();       $pdf->setSignature(         'file://' . $cert_path,              // Certificado         'file://' . $cert_path,              // Clave privada (misma ubicación en .p12)         $cert_password,                       // Contraseña         '',                                   // Certificados extra         2,                                    // Tipo de certificación         [           'Name' => $options['name'] ?? 'AgroConecta - Plataforma de Trazabilidad',           'Location' => $options['location'] ?? 'España',           'Reason' => $options['reason'] ?? 'Certificado de Trazabilidad',           'ContactInfo' => $options['contact'] ?? 'info@agroconecta.es',         ],         'A'  // Permisos: Annotate       );        // Configurar sellado de tiempo (TSA)       $pdf->setSignatureAppearance(10, 10, 50, 20);              // El sellado de tiempo se configura así:       // $pdf->setTimeStampServer(self::TSA_URL);        // Ruta del PDF firmado       $signed_path = str_replace('.pdf', '-firmado.pdf', $pdf_path);              // Para TCPDF, la firma se aplica al generar el output       // En producción, usar SetaPDF-Signer para firma PAdES completa              // MÉTODO ALTERNATIVO con OpenSSL (firma detached)       $signed_path = $this->signWithOpenSSL($pdf_path, $certs);              if ($signed_path) {         $this->logger->info('PDF firmado correctamente: @path', ['@path' => $signed_path]);         return $signed_path;       }      } catch (\Exception $e) {       $this->logger->error('Error al firmar PDF: @error', ['@error' => $e->getMessage()]);     }      return NULL;   }    /**    * Firma con OpenSSL (método robusto).    */   protected function signWithOpenSSL(string $pdf_path, array $certs): ?string {     $signed_path = str_replace('.pdf', '-firmado.pdf', $pdf_path);     $signature_path = $pdf_path . '.sig';      // Crear firma PKCS#7     $private_key = openssl_pkey_get_private($certs['pkey']);     $certificate = openssl_x509_read($certs['cert']);      // Para firma embebida en PDF, necesitamos manipular la estructura     // Esto es complejo con OpenSSL puro - recomendado usar SetaPDF o similar          // Firma detached (archivo separado)     $data = file_get_contents($pdf_path);     $signature = '';          if (openssl_sign($data, $signature, $private_key, OPENSSL_ALGO_SHA256)) {       // Guardar firma       file_put_contents($signature_path, base64_encode($signature));              // Copiar PDF (en producción, embeber la firma)       copy($pdf_path, $signed_path);              return $signed_path;     }      return NULL;   }    /**    * Obtiene la contraseña del certificado de forma segura.    */   protected function getPassword(): string {     // Opción 1: Variable de entorno (recomendado)     $password = getenv('AGROCONECTA_CERT_PASSWORD');          // Opción 2: Archivo de configuración (menos seguro)     if (!$password) {       $password = $this->config->get('certificate_password');     }          return $password ?: '';   }    /**    * Verifica la firma de un PDF.    */   public function verifySignature(string $pdf_path): bool {     // Usar pdfsig (poppler-utils) o librería PHP     $output = [];     $return_var = 0;          exec('pdfsig "' . escapeshellarg($pdf_path) . '" 2>&1', $output, $return_var);          return $return_var === 0;   } }
 
4.4. Integración en agroconecta_core.module
Modificar el hook existente para generar y firmar el certificado automáticamente.
<?php  /**  * Implements hook_entity_insert().  * Genera certificado de trazabilidad firmado al crear un lote.  */ function agroconecta_core_entity_insert(EntityInterface $entity) {   if ($entity instanceof NodeInterface && $entity->bundle() === 'lote_produccion') {          // Solo si tiene ID de lote generado     if (!$entity->get('field_id_lote')->isEmpty()) {              /** @var \Drupal\agroconecta_core\Service\CertificadoPdfService $pdf_service */       $pdf_service = \Drupal::service('agroconecta_core.certificado_pdf');              /** @var \Drupal\agroconecta_core\Service\FirmaDigitalService $firma_service */       $firma_service = \Drupal::service('agroconecta_core.firma_digital');              // 1. Generar PDF       $pdf_path = $pdf_service->generatePdf($entity);              if ($pdf_path) {         // 2. Firmar PDF         $signed_path = $firma_service->signPdf($pdf_path, [           'reason' => 'Certificado de Trazabilidad - Lote ' . $entity->get('field_id_lote')->value,           'location' => 'AgroConecta',         ]);                  if ($signed_path) {           // 3. Crear entidad File y vincular al lote           $file = File::create([             'uri' => $signed_path,             'status' => 1,           ]);           $file->save();                      // 4. Actualizar el campo del lote           $entity->set('field_certificado_firmado', ['target_id' => $file->id()]);                      // Guardar sin disparar hooks de nuevo           $entity->original = clone $entity;           $entity->save();                      \Drupal::messenger()->addStatus(             t('✅ Certificado de trazabilidad generado y firmado: @id',                ['@id' => $entity->get('field_id_lote')->value])           );         }       }     }   } }
4.5. Registro de Servicios
Añadir a agroconecta_core.services.yml:
services:   agroconecta_core.certificado_pdf:     class: Drupal\agroconecta_core\Service\CertificadoPdfService     arguments: ['@file_system']    agroconecta_core.firma_digital:     class: Drupal\agroconecta_core\Service\FirmaDigitalService     arguments: ['@config.factory', '@logger.factory']
4.6. Configuración del Certificado
Crear archivo de configuración config/install/agroconecta_core.firma_settings.yml:
# Configuración de firma digital # IMPORTANTE: La contraseña debe estar en variable de entorno certificate_path: '/etc/ssl/private/agroconecta-sello.p12' certificate_password: ''  # Usar AGROCONECTA_CERT_PASSWORD tsa_url: 'http://tsa.fnmt.es/tsa/tss' signature_visible: true signature_position:   x: 10   y: 260   width: 50   height: 20
 
5. Campo Adicional en Lote de Producción
Añadir el campo field_certificado_firmado al tipo de contenido Lote de Producción:
Campo	Tipo	Descripción
field_certificado_firmado	Archivo (File)	PDF del certificado de trazabilidad firmado digitalmente.
6. Verificación de Firmas
6.1. Herramientas de Verificación
•	Adobe Acrobat Reader: Abre el PDF y muestra "Firmado digitalmente por..." con validación automática.
•	VALIDe (Gobierno España): https://valide.redsara.es - Validación oficial de firmas electrónicas.
•	AutoFirma: Aplicación de escritorio que verifica firmas PAdES.
•	pdfsig (Linux): Herramienta de línea de comandos de poppler-utils.
7. Consideraciones de Seguridad
•	Almacenamiento del certificado: Nunca en el repositorio Git. Usar /etc/ssl/private/ con permisos restrictivos (chmod 600).
•	Contraseña: Siempre en variable de entorno (AGROCONECTA_CERT_PASSWORD), nunca en código ni configuración versionada.
•	Rotación: Renovar el certificado antes de que caduque (normalmente cada 2 años).
•	Auditoría: Registrar cada firma realizada (quién, qué, cuándo) en log de auditoría.
•	HSM (Opcional): Para máxima seguridad, usar Hardware Security Module donde la clave privada nunca sale del dispositivo.
8. Estimación de Costes
Concepto	Coste	Recurrencia
Certificado Sello de Empresa (FNMT)	~14€	Cada 2 años
Desarrollo servicios PHP (estimación)	16-24 horas	Una vez
TSA (Sellado de Tiempo) - FNMT	Gratuito	-
HSM (Opcional, alta seguridad)	200-500€/año	Anual
Total estimado (sin HSM): ~14€ + tiempo de desarrollo. Muy bajo coste para un valor añadido diferencial significativo.
