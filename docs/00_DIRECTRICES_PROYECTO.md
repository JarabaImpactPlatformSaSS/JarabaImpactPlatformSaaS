# ðŸ“‹ DIRECTRICES DEL PROYECTO - JarabaImpactPlatformSaaS

> **âš ï¸ DOCUMENTO MAESTRO**: Este documento debe leerse y memorizarse al inicio de cada conversaciÃ³n o al reanudarla.

**Fecha de creaciÃ³n:** 2026-01-09 15:28  
**Ãšltima actualizaciÃ³n:** 2026-02-26
**VersiÃ³n:** 84.0.0 (Auditoria IA Clase Mundial â€” 25/25 GAPs Implementados en 4 Sprints)

---

## ðŸ“‘ Tabla de Contenidos (TOC)

1. [InformaciÃ³n General del Proyecto](#1-informaciÃ³n-general-del-proyecto)
2. [Stack TecnolÃ³gico](#2-stack-tecnolÃ³gico)
3. [Arquitectura Multi-tenant](#3-arquitectura-multi-tenant)
4. [Seguridad y Permisos](#4-seguridad-y-permisos)
5. [Principios de Desarrollo](#5-principios-de-desarrollo)
6. [Testing y Calidad](#6-testing-y-calidad)
7. [Estructura de DocumentaciÃ³n](#7-estructura-de-documentaciÃ³n)
8. [Convenciones de Nomenclatura](#8-convenciones-de-nomenclatura)
9. [Formato de Documentos](#9-formato-de-documentos)
10. [Flujo de Trabajo de DocumentaciÃ³n](#10-flujo-de-trabajo-de-documentaciÃ³n)
11. [EstÃ¡ndares de CÃ³digo y Comentarios](#11-estÃ¡ndares-de-cÃ³digo-y-comentarios)
12. [Control de Versiones](#12-control-de-versiones)
13. [Procedimientos de ActualizaciÃ³n](#13-procedimientos-de-actualizaciÃ³n)
14. [Glosario de TÃ©rminos](#14-glosario-de-tÃ©rminos)
15. [Registro de Cambios](#15-registro-de-cambios)

---

## 2. Stack TecnolÃ³gico

### 2.1 Backend & Core
- **Lenguaje:** PHP 8.4 (requerido para compatibilidad con Drupal 11).
- **Framework:** Drupal 11.
- **Motor de BD:** MariaDB 10.11+.
- **CachÃ© & Pub/Sub:** Redis 7.4.

---

## 6. Testing y Calidad (Actualizado 2026-02-23)

| Norma | ID | DescripciÃ³n | Prioridad |
|-------|----|-------------|-----------|
| **Mocking de Clases Final** | TEST-MOCK-001 | Las clases `final` (ej. AiProviderPluginManager) NO pueden mockearse directamente. Se DEBE inyectar como `object` en constructores y usar interfaces temporales en los tests. | P0 |
| **Namespaces en Tests** | TEST-NS-001 | Las interfaces de mock temporales DEBEN envolverse en `if (!interface_exists(...))` para evitar colisiones durante la ejecuciÃ³n masiva de suites. | P0 |
| **Metadatos de CachÃ©** | TEST-CACHE-001 | Todo mock de entidad en tests de AccessControl DEBE implementar `getCacheContexts`, `getCacheTags` y `getCacheMaxAge` para evitar fallos de tipo en core. | P1 |
| **Firma Digital XML** | TEST-XML-001 | Las aserciones sobre XML con namespaces DEBEN usar XPath en lugar de comparaciones de cadenas literales para evitar fragilidad por prefijos. | P1 |
| **Trivy Config YAML** | CICD-TRIVY-001 | Las claves `skip-dirs` y `skip-files` en trivy.yaml DEBEN estar anidadas bajo el bloque `scan:`. Claves al nivel raÃ­z o con nombres incorrectos (`exclude-dirs`) son ignoradas silenciosamente. Verificar en logs CI que el conteo de archivos es coherente. | P0 |
| **Deploy Smoke Fallback** | CICD-DEPLOY-001 | Todo smoke test que dependa de un secret de URL DEBE implementar un fallback (SSH/Drush) antes de fallar. Usar `::warning::` cuando el fallback tiene Ã©xito, no `::error::`. | P1 |
| **Preview Image en Templates** | PB-PREVIEW-001 | Todo YAML de PageTemplate DEBE incluir `preview_image` apuntando al PNG correspondiente. ConvenciÃ³n: `id` con guiones â†’ `/modules/custom/jaraba_page_builder/images/previews/{id-con-guiones}.png`. | P0 |
| **Preview Data Rico** | PB-DATA-001 | Los `preview_data` de templates verticales DEBEN incluir arrays con 3+ items representativos del dominio (features, testimonials, faqs, stats, etc.), no solo campos genÃ©ricos. | P1 |
| **CategorÃ­a Default Unificada** | PB-CAT-001 | La categorÃ­a por defecto de PageTemplate DEBE ser `'content'` en las 3 fuentes: `PageTemplate.php`, `CanvasApiController`, `TemplateRegistryService`. | P1 |
| **Drupal 10+ Entity Updates** | DRUPAL-ENTUP-001 | `EntityDefinitionUpdateManager::applyUpdates()` fue eliminado en Drupal 10+. Usar `installFieldStorageDefinition()` / `updateFieldStorageDefinition()` explÃ­citamente en update hooks. | P0 |
| **CSRF en Rutas API** | CSRF-API-001 | Toda ruta API (`/api/v1/*`) consumida via `fetch()` DEBE usar `_csrf_request_header_token: 'TRUE'` (NO `_csrf_token`). El JS DEBE obtener el token de `/session/token` y enviarlo como header `X-CSRF-Token`. | P0 |
| **XSS en Twig** | TWIG-XSS-001 | Campos de contenido de usuario en Twig DEBEN usar `\|safe_html` (NUNCA `\|raw`). Solo se permite `\|raw` para JSON-LD schema auto-generado y HTML generado completamente por backend. | P0 |
| **TranslatableMarkup Cast** | TM-CAST-001 | Los valores de `$this->t()` que se pasan a render arrays o templates Twig DEBEN castearse a `(string)` en el controlador para evitar `InvalidArgumentException` por doble traducciÃ³n. | P1 |
| **PWA Meta Tags Duales** | PWA-META-001 | La funciÃ³n `addPwaMetaTags()` DEBE incluir AMBOS meta tags: `apple-mobile-web-app-capable` (iOS Safari) y `mobile-web-app-capable` (Chrome/Android). Eliminar uno rompe PWA en la otra plataforma. | P1 |
| **Entidades Append-Only** | ENTITY-APPEND-001 | Las entidades de registro inmutable (predicciones, logs, auditorÃ­a) NO DEBEN tener form handlers de ediciÃ³n/eliminaciÃ³n. El AccessControlHandler DEBE denegar `update` y `delete`. Solo se permite `create` y `view`. | P0 |
| **Config Seeding via Update Hook** | CONFIG-SEED-001 | Al crear config entities que requieran datos iniciales, los YAMLs de `config/install/` DEBEN procesarse en un `update_hook` que lea los archivos YAML, codifique campos JSON con `json_encode()`, y cree las entidades via `Entity::create()->save()`. Los YAMLs raw almacenan arrays PHP, no JSON strings. | P1 |
| **Preview Image Todo Vertical** | PB-PREVIEW-002 | Todo vertical que se aÃ±ada al Page Builder DEBE generar sus imÃ¡genes de preview PNG en `images/previews/` ANTES de desplegar a producciÃ³n. ConvenciÃ³n: `{vertical}-{tipo}.png`. Paleta consistente por vertical usando design tokens `--ej-{vertical}-*`. | P0 |
| **No Duplicar Bloques GrapesJS** | PB-DUP-001 | No DEBEN existir bloques con el mismo label en el BlockManager GrapesJS. Verificar `blockManager.get(id)` antes de registrar para evitar duplicados entre bloques estÃ¡ticos y dinÃ¡micos (API Template Registry). | P1 |
| **Field Mapping en APIs** | API-FIELD-001 | Los campos de la entity `create()` DEBEN coincidir exactamente con los definidos en `baseFieldDefinitions()`. Nunca usar nombres de conveniencia del request (ej. `datetime`) como nombres de campos de entidad (ej. `booking_date`). Mapear explÃ­citamente en el controlador. | P0 |
| **State Machine Status Values** | STATE-001 | Los valores de status en controladores, cron y hooks DEBEN coincidir con los `allowed_values` de la entidad. Si la entidad define `cancelled_client`/`cancelled_provider`, nunca usar `cancelled` genÃ©rico internamente. Mapear en el punto de entrada de la API. | P0 |
| **Cron Idempotency Flags** | CRON-FLAG-001 | Toda acciÃ³n de cron que envÃ­e notificaciones DEBE: (1) filtrar por flag `NOT sent` en la query, (2) marcar el flag como `TRUE` tras enviar, (3) guardar la entidad. Esto previene duplicados en ejecuciones concurrentes o reintentos. | P0 |
| **Cifrado Server-Side** | MSG-ENC-001 | Los datos sensibles en tablas custom (mensajes, adjuntos) DEBEN cifrarse con AES-256-GCM via `openssl_encrypt()`/`openssl_decrypt()`. IV de 12 bytes (aleatorio por mensaje), tag de 16 bytes almacenado junto al ciphertext. La clave se deriva con Argon2id (`sodium_crypto_pwhash`) desde una Platform Master Key (env var), NUNCA hardcodeada. Los DTOs readonly encapsulan datos descifrados en memoria. | P0 |
| **WebSocket Auth Middleware** | MSG-WS-001 | Las conexiones WebSocket DEBEN autenticarse en `onOpen()` con JWT o session cookie. El middleware DEBE validar el token, resolver el user_id y tenant_id, y adjuntarlos al objeto Connection ANTES de permitir mensajes. Conexiones sin auth valido se cierran inmediatamente con codigo 4401. | P0 |
| **Rate Limiting en Mensajeria** | MSG-RATE-001 | Los endpoints de envio de mensajes DEBEN implementar rate limiting: (1) por usuario (30 msg/min), (2) por conversacion (100 msg/min). Contadores via COUNT en tabla con ventana temporal. Lanzar `RateLimitException` con los campos `limit`, `windowSeconds` y `scope`. | P1 |
| **ConfigEntity Cascade Resolution** | PLAN-CASCADE-001 | Cuando una ConfigEntity tiene datos por combinacion vertical+tier, la resolucion DEBE seguir cascade: (1) especifico `{vertical}_{tier}`, (2) default `_default_{tier}`, (3) NULL. El servicio broker central (`PlanResolverService`) encapsula esta logica. Los consumidores NUNCA implementan el cascade directamente. | P0 |
| **Plan Name Normalization via Aliases** | PLAN-RESOLVER-001 | Los nombres de plan de cualquier fuente (Stripe, user input, migration) DEBEN normalizarse via `PlanResolverService::normalize()` antes de usarse para consultar features o limites. El `SaasPlanTier` ConfigEntity almacena aliases editables desde UI. Los consumidores NUNCA hardcodean mapeos de nombres de plan. | P0 |
| **Config Schema Dynamic Keys** | CONFIG-SCHEMA-001 | Cuando una ConfigEntity tiene campos `mapping` con keys dinamicos por vertical/contexto (ej. `limits`), el schema DEBE usar `type: sequence` con inner `type: integer/string`, NO `type: mapping` con keys fijos. `mapping` con keys fijos lanza `SchemaIncompleteException` en Kernel tests para cualquier key no declarado. | P0 |
| **Header Sticky por Defecto** | CSS-STICKY-001 | El `.landing-header` DEBE usar `position: sticky` por defecto. Solo las landing pages con hero fullscreen (`body.landing-page`, `body.page-front`) usan `position: fixed`. Las areas de contenido (`main-content`, `user-main`, `error-page`) NO DEBEN tener `padding-top` compensatorio para header fijo â€” solo padding estetico (`1.5rem`). El ajuste de toolbar admin (`top: 39px/79px`) se aplica globalmente en el SCSS del header. | P0 |
| **Identidad IA Inquebrantable** | AI-IDENTITY-001 | Todo prompt de sistema de agente, copiloto o servicio IA que genere texto conversacional DEBE incluir una regla de identidad que prohiba revelar el modelo subyacente (Claude, ChatGPT, GPT, Gemini, Copilot, Llama, Mistral). La identidad DEBE ser siempre "Asistente de Jaraba Impact Platform" o el nombre del vertical correspondiente. En `BaseAgent.buildSystemPrompt()` se inyecta como parte #0 antes del Brand Voice. En servicios standalone, se antepone al system prompt. | P0 |
| **Aislamiento de Competidores en IA** | AI-COMPETITOR-001 | Ningun prompt de IA DEBE mencionar, recomendar ni referenciar plataformas competidoras (LinkedIn, Indeed, InfoJobs, Salesforce, HubSpot, Zoho, Monday, Trello, Slack, Mailchimp, Canva, Gupy) ni modelos de IA (ChatGPT, Claude, Gemini, Perplexity, OpenAI, Google AI). Si el usuario menciona un competidor, la IA DEBE redirigir a las funcionalidades equivalentes de Jaraba. Excepcion: integraciones reales del SaaS (LinkedIn import, LinkedIn Ads, Meta Pixel) donde LinkedIn/Meta son canales de distribucion, no competidores directos. | P0 |
| **Mensajes en Templates de Formulario Custom** | FORM-MSG-001 | Cuando un modulo define un `#theme` custom para renderizar un formulario (patron zero-region), el theme hook DEBE declarar una variable `messages` y el preprocess hook DEBE inyectar `['#type' => 'status_messages']`. El template DEBE renderizar `{{ messages }}` ANTES del `{{ form }}`. Sin esto, los errores de validacion y mensajes de exito se pierden silenciosamente. | P0 |
| **URLs Canonicas de Paginas Legales** | LEGAL-ROUTE-001 | Las paginas legales DEBEN usar URLs en espanol SEO-friendly: `/politica-privacidad`, `/terminos-uso`, `/politica-cookies`. Nunca URLs en ingles (`/privacy`) ni abreviadas (`/privacidad`). Todos los enlaces del formulario, footer y sitemap DEBEN apuntar a la URL canonica. | P1 |
| **Contenido Legal Configurable desde UI** | LEGAL-CONFIG-001 | El contenido de paginas legales e informativas DEBE ser editable desde Theme Settings (Apariencia > Configuracion del tema) sin necesidad de tocar codigo. Los controladores leen de `theme_get_setting()` y los templates muestran un placeholder informativo cuando no hay contenido configurado. | P1 |
| **Coherencia Limites Freemium** | FREEMIUM-TIER-001 | Los limites del tier Starter DEBEN ser estrictamente superiores a los del tier Free para cada metrica. Al crear o modificar `plan_features.{vertical}_{tier}.yml`, verificar que cada limite supere el valor correspondiente en `freemium_vertical_limit.{vertical}_free_{metric}.yml`. Los `upgrade_message` DEBEN reflejar los valores reales del Starter. | P0 |
| **XSS innerHTML en JS** | INNERHTML-XSS-001 | Todo dato recibido de una respuesta API que se inserte en el DOM via `innerHTML` DEBE pasar por `Drupal.checkPlain()` antes de la insercion. Valores numericos DEBEN pasar por `parseInt()`/`parseFloat()`. Solo se permite HTML generado client-side (tags `<strong>`, `<br>`, `<em>`) post-sanitizacion. | P0 |
| **Cache de CSRF Token JS** | CSRF-JS-CACHE-001 | El token CSRF obtenido de `/session/token` DEBE cachearse en una variable de modulo (promise cacheada) para evitar multiples peticiones al servidor. Patron: `var _csrfTokenPromise = null; function getCsrfToken() { if (!_csrfTokenPromise) { _csrfTokenPromise = fetch('/session/token').then(r => r.text()); } return _csrfTokenPromise; }`. | P1 |
| **Whitelist de Campos en APIs** | API-WHITELIST-001 | Todo endpoint que acepte campos dinamicos del request JSON para actualizar una entidad DEBE definir una constante `ALLOWED_FIELDS` y filtrar el input contra ella antes de ejecutar `$entity->set()`. Nunca iterar directamente sobre `$data` del request sin filtrar. | P0 |
| **Convencion jaraba_icon()** | ICON-CONVENTION-001 | La funcion Twig `jaraba_icon()` DEBE invocarse siempre como `jaraba_icon('category', 'name', { variant: 'duotone', color: 'azul-corporativo', size: '24px' })`. NUNCA usar estilo path (`'ui/arrow-left'`), argumentos posicionales (`'download', 'outline', 'white', '20'`), argumentos invertidos (`'name', 'category'`) ni tamaÃ±os sin unidad. Las categorias validas son: `actions`, `fiscal`, `media`, `micro`, `ui`, `users` y las bridge categories (`achievement`, `finance`, `general`, `legal`, `navigation`, `status`, `tools`). | P0 |
| **Duotone-First en Iconos** | ICON-DUOTONE-001 | Todo icono en templates premium DEBE usar `variant: 'duotone'` por defecto. El variante `duotone` aplica `opacity: 0.2` + `fill: currentColor` a capas de fondo, creando profundidad visual coherente con el diseno glassmorphism. Solo usar `outline` para contextos minimalistas (breadcrumbs, inline text). | P1 |
| **Colores Jaraba en Iconos** | ICON-COLOR-001 | Los iconos DEBEN usar colores de la paleta Jaraba: `azul-corporativo` (#233D63), `naranja-impulso` (#FF8C42), `verde-innovacion` (#00A9A5), `white`, `neutral`. NUNCA usar colores genericos (`primary`, `blue`, `red`) ni codigos hex directos en la llamada a `jaraba_icon()`. | P1 |
| **Strict Equality en Access Handlers** | ACCESS-STRICT-001 | Toda comparacion de ownership en access handlers DEBE usar `(int) $entity->getOwnerId() === (int) $account->id()` o `(int) $entity->get('field')->target_id === (int) $account->id()`. NUNCA usar `==` (loose equality) â€” vulnerable a type juggling (`"0" == false`, `null == 0`). El cast `(int)` en ambos lados normaliza string/null a entero y documenta la intencion de comparacion numerica. | P0 |
| **Preheader en Emails MJML** | EMAIL-PREVIEW-001 | Toda plantilla MJML DEBE tener `<mj-preview>` con texto descriptivo unico inmediatamente despues de `<mj-body>`. El preheader es lo que el usuario ve en la bandeja de entrada antes de abrir el email. Usar HTML entities para acentos (`&aacute;`, `&oacute;`, etc.). | P0 |
| **Direccion Postal en Emails** | EMAIL-POSTAL-001 | Toda plantilla MJML DEBE incluir la direccion postal fisica del remitente en el footer: `Pol. Ind. Juncaril, C/ Baza Parcela 124, 18220 Albolote, Granada`. Requerido por CAN-SPAM Act Â§5(a)(1)(C) para todo email comercial. | P0 |
| **Font Outfit en Emails** | BRAND-FONT-001 | El font-family en plantillas MJML DEBE ser `Outfit, Arial, Helvetica, sans-serif`. `Outfit` es la fuente de marca de Jaraba y DEBE ser siempre el primer font declarado. | P1 |
| **Colores Brand en Emails MJML** | BRAND-COLOR-001 | Las plantillas MJML DEBEN usar exclusivamente colores del sistema de tokens de marca. Prohibido usar Tailwind defaults (#374151, #6b7280, #f3f4f6, #e5e7eb, #9ca3af, #111827, #2563eb). Los colores semanticos (error rojo #dc2626, exito verde #16a34a, warning amber #f59e0b) se preservan. El azul primario de marca es #1565C0. | P1 |
| **PathProcessor para path_alias custom** | PATH-ALIAS-PROCESSOR-001 | Cuando una entidad ContentEntity usa un campo `path_alias` propio (no gestionado por el modulo `path_alias` del core), se DEBE implementar un `InboundPathProcessorInterface` registrado como servicio con prioridad superior a 100. El procesador DEBE: (1) excluir prefijos de sistema (`/api/`, `/admin/`, `/user/`) para rendimiento, (2) no filtrar por status â€” delegar en el AccessControlHandler, (3) usar static cache por path, (4) retornar la ruta canonica de la entidad (ej. `/page/{id}`). | P0 |
| **TenantBridgeService Obligatorio** | TENANT-BRIDGE-001 | Todo servicio que necesite resolver entre entidades Tenant y Group DEBE usar `TenantBridgeService` (`ecosistema_jaraba_core.tenant_bridge`). NUNCA cargar `getStorage('group')` con Tenant IDs ni viceversa. Tenant entities son propietarias de billing; Group entities gestionan aislamiento de contenido. Metodos: `getTenantForGroup()`, `getGroupForTenant()`, `getTenantIdForGroup()`, `getGroupIdForTenant()`. Error handling con `\InvalidArgumentException` si la entidad no existe. | P0 |
| **Tenant Isolation en Access Handlers** | TENANT-ISOLATION-ACCESS-001 | Todo `AccessControlHandler` de entidades con campo `tenant_id` DEBE verificar que el tenant de la entidad coincida con el tenant del usuario para operaciones `update`/`delete` usando `isSameTenant()`. Las paginas publicadas (`view`) son publicas. El patron: `(int) $entity->get('tenant_id')->target_id === (int) $this->tenantContext->getCurrentTenantId()`. Aplica a `PageContentAccessControlHandler` y cualquier handler futuro con aislamiento por tenant. | P0 |
| **CI Pipeline con Kernel Tests** | CI-KERNEL-001 | El pipeline de CI DEBE ejecutar tanto Unit tests como Kernel tests. El job `kernel-test` requiere servicio MariaDB (mariadb:10.11) con base de datos `drupal_test`. Los Kernel tests validan integracion con BD real (schemas de entidad, queries, services DI). Todo PR que modifique servicios, entidades o access handlers DEBE pasar ambas suites antes de merge. | P0 |
| **Prohibicion de Emojis en Canvas Data** | ICON-EMOJI-001 | Las paginas de Page Builder NO DEBEN contener emojis Unicode como iconos visuales en `canvas_data`. Los emojis se renderizan de forma inconsistente entre plataformas/navegadores y no siguen la paleta de marca. Toda auditoria de iconos DEBE incluir un scan de `canvas_data` en la BD ademas de los templates Twig. Usar SVGs inline del sistema de iconos con colores hex del brand. | P0 |
| **SVG Inline en Canvas Data con Color Explicito** | ICON-CANVAS-INLINE-001 | Los SVGs insertados inline en `canvas_data` (HTML almacenado en BD, no procesado por Twig) DEBEN usar colores hex explicitos del brand (`#233D63` azul-corporativo, `#FF8C42` naranja-impulso, `#00A9A5` verde-innovacion) en atributos `stroke` y `fill`. NUNCA usar `currentColor` en canvas_data â€” no hereda CSS del tema. Los SVGs DEBEN especificar `width` y `height` explicitos (tipicamente 48px para iconos de tarjeta). | P0 |
| **Premium Entity Forms Obligatorios** | PREMIUM-FORMS-PATTERN-001 | Todo formulario de entidad ContentEntity DEBE extender `PremiumEntityFormBase` (no `ContentEntityForm`). DEBE implementar `getSectionDefinitions()` (array de secciones con label, icon, fields) y `getFormIcon()`. El `save()` DEBE llamar a `parent::save()` y redirigir a la coleccion. Los campos computados o internos DEBEN usar `#disabled = TRUE`. La inyeccion de dependencias DEBE usar el patron `parent::create()`. Los fieldsets y details groups estan PROHIBIDOS (usar secciones en su lugar). Glass-card UI con navigation pills y sticky action bar. SCSS en `_premium-forms.scss`. | P1 |
| **Preprocess Obligatorio para Custom Entities** | ENTITY-PREPROCESS-001 | Toda ContentEntity custom que se renderice en view mode DEBE tener una funcion `template_preprocess_{entity_type}()` en el `.module` que extraiga los datos de la entidad en un array estructurado `$variables['entity_data']` para Twig. La entidad esta en `$variables['elements']['#{entity_type}']`. El preprocess DEBE: (1) extraer valores primitivos (title, body, dates), (2) resolver entidades referenciadas (category, owner/author), (3) generar URLs de imagenes responsive con `ImageStyle::load()->buildUrl()` y srcset. Sin este preprocess, los templates Twig NO pueden acceder a los datos de la entidad. | P1 |
| **Resiliencia en Presave Hooks** | PRESAVE-RESILIENCE-001 | Los hooks `hook_{entity_type}_presave()` que invoquen servicios opcionales (sentiment_engine, reputation_monitor, pathauto) DEBEN: (1) verificar `\Drupal::hasService('service_id')` antes de llamar, (2) envolver la llamada en `try {} catch (\Throwable $e)`, (3) loguear fallos sin abortar el save. Esto garantiza que los saves de entidades NO fallen cuando modulos opcionales no estan instalados o los servicios fallan. | P1 |
| **Guardrails PII Espanol** | AI-GUARDRAILS-PII-001 | El `AIGuardrailsService::checkPII()` DEBE detectar datos personales espanoles ademas de los formatos US. Patrones obligatorios: DNI (`/\b\d{8}[A-Za-z]\b/`), NIE (`/\b[XYZxyz]\d{7}[A-Za-z]\b/`), IBAN ES (`/\bES\d{2}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{2}[\s-]?\d{10}\b/`), NIF/CIF (`/\b[A-HJ-NP-SUVW]\d{7}[A-J0-9]\b/`), telefono espanol (`/\b(?:\+34\|0034)[\s-]?\d{9}\b/`). El IBAN ES DEBE estar tambien en `BLOCKED_PATTERNS`. Todo nuevo mercado geogrÃ¡fico DEBE anadir sus patrones PII al guardrail. | P0 |
| **Observabilidad Conectada en Servicios IA** | AI-OBSERVABILITY-001 | Todo servicio IA que invoque un modelo LLM o genere embeddings DEBE registrar la ejecucion via `$this->observability->log()` con al menos: `agent_id`, `action`, `tier`, `model_id`, `provider_id`, `tenant_id`, `vertical`, `input_tokens`, `output_tokens`, `duration_ms`, `success`. Los tokens se estiman como `ceil(mb_strlen($text) / 4)` cuando el proveedor no devuelve conteo real. Los servicios de workflow DEBEN loguear tanto el path de exito como el de fallo. | P0 |
| **Verticales Canonicos** | VERTICAL-CANONICAL-001 | Los 10 nombres canonicos de vertical son: `empleabilidad`, `emprendimiento`, `comercioconecta`, `agroconecta`, `jarabalex`, `serviciosconecta`, `andalucia_ei`, `jaraba_content_hub`, `formacion`, `demo`. Todo servicio que use nombres de vertical (BaseAgent, JarabaRagService, AiImageSuggestionService, AiFieldGeneratorController) DEBE normalizar aliases legacy (`comercio_conecta`â†’`comercioconecta`, `servicios_conecta`â†’`serviciosconecta`, `content_hub`â†’`jaraba_content_hub`). El default DEBE ser `'general'` (no un vertical especifico). La constante `BaseAgent::VERTICALS` es la fuente de verdad. | P0 |
| **Model Routing en Config YAML** | MODEL-ROUTING-CONFIG-001 | Los modelos IA, pricing y thresholds de complejidad del `ModelRouterService` DEBEN definirse en `jaraba_ai_agents.model_routing.yml` (no hardcodeados). El servicio carga la config en el constructor y hace deep-merge con defaults en codigo. El schema YAML DEBE declararse en `jaraba_ai_agents.schema.yml`. Los 3 tiers (`fast`, `balanced`, `premium`) DEBEN tener: `provider`, `model`, `cost_per_1k_input`, `cost_per_1k_output`, `max_complexity`, `use_cases`. Al cambiar de modelo o proveedor, solo se actualiza el YAML sin code deploy. | P1 |
| **Streaming SSE Semantico** | AI-STREAMING-001 | Los endpoints SSE de copilot DEBEN: (1) usar `Content-Type: text/event-stream` (NUNCA `text/plain`), (2) emitir eventos tipados (`mode`, `thinking`, `chunk`, `done`, `error`), (3) dividir el output por parrafos semanticos (`splitIntoParagraphs()`) en lugar de chunks arbitrarios de N caracteres, (4) NO usar `usleep()` para simular streaming â€” emitir chunks tan pronto como esten disponibles, (5) incluir `streaming_mode: 'buffered'` en el evento `done` si el output no es streaming real del proveedor. | P1 |
| **Meta-Site Nav en Page Template** | META-SITE-NAV-001 | El template `page--page-builder.html.twig` DEBE incluir el partial compartido `_header.html.twig` cuando la variable `meta_site` es truthy. El header inline hardcodeado (clase `landing-header--tenant`) NO renderiza navegacion â€” solo se usa para paginas non-meta-site (dashboard, preview). La cadena de override de navegacion es: `theme_preprocess_page()` â†’ `MetaSiteResolverService::resolveFromPageContent()` â†’ `$variables['theme_settings']['navigation_items']` â†’ `_header.html.twig` parsea y despacha al sub-partial. | P1 |
| **Copilot Sugerencias con URL** | COPILOT-LINK-001 | Las sugerencias del copilot IA DEBEN soportar objetos `{label, url}` ademas de strings planos. Las sugerencias con URL se renderizan como `<a>` con clase `--link` (fondo naranja, font-weight 600, icono flecha SVG). El backend `CopilotOrchestratorService::getContextualActionButtons()` genera CTAs contextuales: anonimo â†’ "Crear cuenta gratis" (`/user/register`), autenticado â†’ acciones por modo (coachâ†’Mi perfil, cfoâ†’Panel financiero). Ambas implementaciones JS (v1 `contextual-copilot.js` y v2 `copilot-chat-widget.js`) DEBEN soportar el formato dual. Links externos llevan `target="_blank"`. | P1 |
| **Header Layout Classic para Nav Visible** | HEADER-LAYOUT-NAV-001 | El campo `header_type` de SiteConfig controla el sub-partial de header: `classic` muestra navegacion horizontal + hamburguesa movil, `minimal` muestra solo logo + hamburguesa (SIN nav horizontal), `transparent` es como classic con fondo transparente. Los meta-sitios que necesiten navegacion visible DEBEN usar `header_type = 'classic'`. Si la navegacion no aparece a pesar de que los datos son correctos, verificar que el header_type no sea `minimal`. | P1 |
| **Constructor SmartBaseAgent Unificado** | SMART-AGENT-DI-001 | Todo agente Gen 2 que extienda `SmartBaseAgent` DEBE aceptar 10 argumentos de constructor: 6 core (aiProvider, configFactory, logger, brandVoice, observability, modelRouter) + 4 opcionales (promptBuilder, toolRegistry, providerFallback, contextWindowManager). Los ultimos 3 se inyectan con `@?` en services.yml. El constructor DEBE llamar a `parent::__construct()` con los 6 core args, luego `setModelRouter()`, y conditional setters para los opcionales: `if ($toolRegistry) { $this->setToolRegistry($toolRegistry); }`. | P0 |
| **Provider Fallback con Circuit Breaker** | PROVIDER-FALLBACK-001 | Toda llamada LLM via `SmartBaseAgent` DEBE usar `ProviderFallbackService` con circuit breaker. Configuracion: 3 fallos en 5 minutos = skip provider, cascada por tier (primary â†’ fallback â†’ emergency). Cadenas definidas en `jaraba_ai_agents.provider_fallback.yml`. El circuit breaker tiene 3 estados: CLOSED (normal), OPEN (skip, cooldown), HALF_OPEN (probar un request). Estado almacenado en Drupal State API. Al cambiar de provider, solo se actualiza el YAML sin code deploy. | P0 |
| **Deteccion de Jailbreak Bilingue** | JAILBREAK-DETECT-001 | `AIGuardrailsService::validate()` DEBE incluir `checkJailbreak()` con patrones de deteccion de prompt injection y role-play attacks. Patrones obligatorios bilingues ES/EN: "ignore previous instructions", "you are now", "DAN mode", "pretend you are", "olvida tus instrucciones", "actua como si fueras", "from now on you are". Accion: BLOCK. Todo nuevo patron de ataque detectado en produccion DEBE anadirse al guardrail. | P0 |
| **Masking PII en Output** | OUTPUT-PII-MASK-001 | `SmartBaseAgent` DEBE llamar a `AIGuardrailsService::maskOutputPII()` sobre el texto de respuesta del LLM ANTES de retornarlo al usuario. El metodo reutiliza los mismos patrones regex de `checkPII()` (DNI, NIE, IBAN ES, NIF/CIF, SSN, etc.) pero reemplaza con `[DATO PROTEGIDO]` en vez de bloquear. Los guardrails de IA DEBEN ser bidireccionales: validar input Y sanitizar output. | P0 |
| **Tool Use Loop en Agentes** | TOOL-USE-AGENT-001 | Los agentes con `ToolRegistry` inyectado DEBEN implementar `callAiApiWithTools()` con loop iterativo: (1) llamar LLM con tool docs en system prompt, (2) parsear `{"tool_call": {"tool_id": "...", "params": {}}}` del response, (3) ejecutar via `ToolRegistry::execute()`, (4) appendear resultado como context, (5) re-llamar LLM. Max 5 iteraciones. Los tools se auto-registran via tag `jaraba_ai_agents.tool` en services.yml. | P1 |
| **Cache Semantica de 2 Capas** | SEMANTIC-CACHE-001 | `CopilotCacheService` DEBE implementar cache de 2 capas: Layer 1 = hash exacto via Drupal Cache API (Redis), Layer 2 = similaridad semantica via `SemanticCacheService` (embedding + Qdrant vectorSearch, threshold 0.92). El `set()` DEBE escribir en ambas capas. El `get()` intenta Layer 1, si MISS intenta Layer 2. `SemanticCacheService` se inyecta opcionalmente (`\Drupal::hasService()` + try-catch). La respuesta incluye `cache_layer: 'exact'\|'semantic'`. | P1 |
| **Razonamiento Multi-Paso ReAct** | REACT-LOOP-001 | Para tareas autonomas multi-paso, usar `ReActLoopService::run(agent, objective, context, maxSteps=10)` con ciclo PLANâ†’EXECUTEâ†’OBSERVEâ†’REFLECTâ†’FINISH. Cada paso se loguea via `AIObservabilityService`. La ejecucion de herramientas usa `ToolRegistry::execute()`. El loop se detiene al recibir FINISH o al alcanzar maxSteps. Requiere FIX-029 (tool use) y FIX-030 (bridge). | P1 |
| **Contrato de Llamada a Servicios** | SERVICE-CALL-CONTRACT-001 | Cuando un servicio se registra en `services.yml` y se consume desde otro servicio, las llamadas DEBEN coincidir exactamente con la firma del metodo: (1) numero de argumentos, (2) orden de argumentos, (3) tipos de argumentos. Tras registrar un servicio nuevo o modificar firmas existentes, verificar TODOS los puntos de llamada con `grep -rn 'serviceName->methodName'`. Un `\Drupal::hasService()` + `try-catch` NO protege contra errores de firma â€” el servicio se resuelve pero explota en runtime con `TypeError`. Caso real: `SemanticCacheService::get(query, mode, ?tenantId)` se llamaba con 2 args (sin `mode`), `set(query, response, mode, ?tenantId, ttl)` se llamaba con args en orden incorrecto. | P0 |
| **Canvas Editor Compartido en Articulos** | CANVAS-ARTICLE-001 | El Canvas Editor GrapesJS del Page Builder se reutiliza en articulos del Content Hub via library dependency (`jaraba_page_builder/grapesjs-canvas`). NUNCA copiar el engine JS ni los plugins â€” la library del Content Hub declara dependencia y un bridge JS (`article-canvas-editor.js`) reconfigura el StorageManager a endpoints propios del Content Hub (`/api/v1/articles/{id}/canvas`). Los articulos usan campo `layout_mode` (legacy/canvas) para bifurcar renderizado: canvas â†’ `rendered_html` con CSS inyectado, legacy â†’ `body` como texto. Los endpoints API propios del Content Hub DEBEN replicar los mismos sanitizers del Page Builder (HTML: remove script/event handlers/javascript:, CSS: remove expression()/import/@moz-binding). El campo `body` permanece required en baseFieldDefinitions pero se hace opcional en el form para canvas mode (placeholder en save). | P1 |
| **Streaming Real via PHP Generator** | STREAMING-REAL-001 | Los endpoints de streaming SSE del copilot DEBEN usar `StreamingOrchestratorService::streamChat()` que retorna un PHP Generator yield-eando eventos tipados (`chunk`, `cached`, `done`, `error`). El servicio usa `ChatInput::setStreamedOutput(TRUE)` para streaming real token-by-token del provider LLM. El controller consume el Generator con `foreach` y emite SSE events. Buffer de 80 chars o sentence boundary para chunks legibles. Fallback automatico: si el servicio no esta disponible, usar `handleBufferedStreaming()` (comportamiento original con chunking artificial). La inyeccion en el controller es via `$container->has()` (no `@?`, que es para services.yml). | P1 |
| **Native Function Calling API-Level** | NATIVE-TOOLS-001 | Los agentes con `ToolRegistry` inyectado DEBEN preferir `callAiApiWithNativeTools()` sobre `callAiApiWithTools()` (text-based). El metodo nativo usa `ChatInput::setChatTools(ToolsInput)` del modulo Drupal AI para pasar tools a nivel de API. Los tool calls se leen via `ChatMessage::getTools()` que retorna `ToolsFunctionOutputInterface[]` con nombre y argumentos parseados nativamente por el provider. `ToolRegistry::generateNativeToolsInput()` convierte las herramientas al formato `ToolsInput > ToolsFunctionInput > ToolsPropertyInput`. El loop iterativo es max 5 como el text-based. Si `callAiApiWithNativeTools()` falla (excepcion), DEBE caer automaticamente a `callAiApiWithTools()` como fallback. Ambos metodos coexisten en SmartBaseAgent. | P1 |
| **MCP Server JSON-RPC 2.0** | MCP-SERVER-001 | El endpoint `POST /api/v1/mcp` expone las herramientas del ToolRegistry a clientes MCP externos (Claude Desktop, VS Code Copilot) via JSON-RPC 2.0 siguiendo la especificacion MCP 2025-11-25. Un solo endpoint con dispatch por metodo (`initialize`, `tools/list`, `tools/call`, `ping`). Requiere permiso `use ai agents` + CSRF token. Los tool outputs se sanitizan via `AIGuardrailsService::maskOutputPII()`. Los error codes siguen el estandar JSON-RPC: -32700 (parse), -32600 (invalid request), -32601 (method not found), -32602 (invalid params), -32603 (internal). `buildInputSchema()` convierte parametros de tools a JSON Schema. | P1 |
| **Distributed Tracing** | TRACE-CONTEXT-001 | Todo request SSE/API del copilot DEBE generar un `trace_id` (UUID) via `TraceContextService` al inicio. El trace_id se propaga a: `AIObservabilityService::log()`, `CopilotCacheService`, `AIGuardrailsService`, `ToolRegistry::execute()`. El SSE `done` event incluye el trace_id para que el frontend pueda correlacionar. Los logs de observabilidad incluyen trace_id + span_id (generado por operacion) para reconstruir el flujo completo de un request. | P1 |
| **Streaming PII Buffer Masking** | STREAMING-PII-001 | Durante streaming real, el PII masking DEBE aplicarse sobre el buffer acumulado completo (no sobre cada chunk individual). Un PII puede estar partido entre 2 chunks consecutivos (ej. "1234" en chunk 1 + "5678A" en chunk 2 = DNI). `maskBufferPII()` acumula el texto, aplica `AIGuardrailsService::maskOutputPII()` sobre el total, y emite solo el delta (texto nuevo post-masking). Esto garantiza deteccion de PIIs que cruzan boundaries de chunks. | P0 |
| **Agent Long-Term Memory** | AGENT-MEMORY-001 | `AgentLongTermMemoryService` backed por Qdrant (semantic recall) + tabla BD (structured facts) permite a los agentes recordar entre conversaciones. Types: `fact`, `preference`, `interaction_summary`, `correction`. El metodo `remember()` se llama despues de cada interaccion exitosa. El metodo `recall()` se integra en `buildSystemPrompt()` como seccion `<agent_memory>`. Los embeddings se generan via `JarabaRagService::generateEmbedding()`. El threshold de similarity es configurable. | P1 |
| **Command Bar Registry Pattern** | COMMAND-BAR-001 | El Command Bar (Cmd+K/Ctrl+K) usa `CommandRegistryService` como service collector con tag `jaraba.command_provider`. Cada provider implementa `CommandProviderInterface` con metodos `search(query, limit)` e `isAccessible(account)`. Providers: Navigation (rutas admin), EntitySearch (entidades por label), Actions (create/clear cache), AiSearch (SmartBaseAgent fast tier como fallback). La busqueda server-side via `GET /api/v1/command-bar/search?q={query}` con CSRF header. JS usa `Drupal.url()` para API calls, `Drupal.checkPlain()` para resultados, navegacion por teclado (arrows + Enter + Esc), debounce 300ms. Toggle desde Theme Settings. Mobile: full-screen overlay sin border-radius. | P1 |
| **Inline AI Form Integration** | INLINE-AI-001 | Los formularios `PremiumEntityFormBase` soportan sugerencias IA inline via metodo `getInlineAiFields()` que retorna array de field names. Para cada campo configurado, JS (`inline-ai-trigger.js`) aÃ±ade boton sparkle (âœ¦) que llama `POST /api/v1/inline-ai/suggest` con CSRF. `InlineAiService` usa `SmartBaseAgent` fast tier (Haiku 4.5) para generar 3 sugerencias. Sugerencias se renderizan como chips clickeables que insertan el valor en el campo. En GrapesJS, plugin `grapesjs-jaraba-ai.js` aÃ±ade boton AI en RichTextEditor toolbar. | P1 |
| **Proactive Insight Entity Pattern** | PROACTIVE-INSIGHT-001 | `ProactiveInsight` es ContentEntity con campos: insight_type (optimization/alert/opportunity), severity (high/medium/low), target_user, tenant_id, action_url, ai_model, ai_confidence, read_status. Generados por `ProactiveInsightEngineWorker` (QueueWorker cron, max 3 insights/user/dia). Form extiende `PremiumEntityFormBase`. Access handler verifica target_user para view y tenant para edit/delete. Notificacion via bell icon en header. | P1 |
| **A2A Protocol Extension** | A2A-PROTOCOL-001 | El protocolo Agent-to-Agent extiende el patron MCP existente con: (1) Agent Card discovery en `GET /.well-known/agent.json` con capabilities, endpoints, supported_actions. (2) Task lifecycle: submittedâ†’workingâ†’completed/failed via `POST /api/v1/a2a/task` y `GET /api/v1/a2a/task/{id}`. (3) Auth: Bearer token + HMAC-SHA256 optional. (4) Rate limit: 100 tasks/hour per agent (Flood). (5) Task results sanitizados via `maskOutputPII()`. | P1 |
| **Prompt Regression Testing** | PROMPT-REGRESSION-001 | Toda clase que genera prompts para LLM DEBE tener un prompt regression test que compare contra golden fixtures. `PromptRegressionTestBase` guarda fixtures en `tests/fixtures/prompts/{name}.txt`. Primera ejecucion crea el fixture, siguientes validan identicidad. Cambios intencionales requieren actualizar el fixture. Suite `PromptRegression` en `phpunit.xml`. Cobertura minima: AIIdentityRule, InlineAi, ProactiveInsight, SkillInference, DemandForecasting, OnboardingAi. | P1 |
| **GTM/GA4 con Consent Mode v2** | GTM-GA4-001 | El snippet de GTM DEBE inyectarse via partial `_gtm-analytics.html.twig` incluido en `html.html.twig` (head para snippet + body para noscript fallback). DEBE implementar Google Consent Mode v2 con defaults conservadores (`ad_storage: 'denied'`, `analytics_storage: 'denied'`, `wait_for_update: 500`) para cumplir GDPR/RGPD. El container ID de GTM viene de `theme_get_setting('gtm_container_id')`. Si no hay GTM, DEBE existir un fallback standalone de GA4 con `theme_get_setting('ga4_measurement_id')`. El dataLayer DEBE recibir un push con contexto del meta-sitio (`meta_site`, `tenant_id`, `tenant_name`, `user_type`, `page_language`). NUNCA hardcodear IDs de GTM/GA4 en cÃ³digo â€” siempre desde theme_settings. | P0 |
| **A/B Testing Frontend con Cookie** | AB-EXPERIMENT-001 | El JS de A/B testing (`metasite-experiments.js`) DEBE usar cookies persistentes (30 dÃ­as) con nombre `jb_exp_{experimentId}` para asignar variantes. La asignaciÃ³n DEBE ser ponderada via `weight` por variante. Las variantes se aplican al DOM via `change.type` (text/html/style/class-add/class-remove/attribute/href). Cada impresiÃ³n se registra via `POST /api/experiments/{id}/impression`. Los eventos `experiment_view` y `experiment_conversion` se empujan al dataLayer con `experiment_id`, `variant_id`, `variant_name`. Las conversiones se detectan via atributo `data-experiment-goal` en elementos CTA. La librerÃ­a depende de `core/drupalSettings` donde el backend inyecta el array `experiments[]` activos. | P1 |
| **Hreflang Tags para SEO Internacional** | HREFLANG-SEO-001 | Toda pÃ¡gina del SaaS DEBE tener tags `<link rel="alternate" hreflang="xx">` para ES y EN, mÃ¡s `hreflang="x-default"` apuntando a ES como idioma principal. Los tags se generan en `_hreflang-meta.html.twig` e incluyen en `html.html.twig` head. Las URLs DEBEN incluir el prefijo de idioma (`/es/`, `/en/`). Se usa `{% include ignore missing %}` para tolerancia a plantilla ausente. Esto permite a Google indexar correctamente las versiones idiomÃ¡ticas y evitar contenido duplicado cross-language. | P1 |
| **Heatmap Tracker en Meta-Sitios** | HEATMAP-TRACKER-001 | El mÃ³dulo `jaraba_heatmap` tiene su propia librerÃ­a `tracker` que registra clicks, scroll y hover. Para activar el tracking en meta-sitios, DEBE attach `jaraba_heatmap/tracker` en `page--page-builder.html.twig` dentro del bloque `{% if meta_site %}`. Los datos se envÃ­an al `HeatmapApiController` backend. El dashboard de analytics estÃ¡ en `/heatmap/analytics`. NUNCA cargar el tracker en pÃ¡ginas de admin (`/admin/*`). | P1 |
| **Stack Analytics Unificado para Meta-Sitios** | METASITE-ANALYTICS-001 | Todo meta-sitio DEBE tener activadas 4 capas de analytics en `page--page-builder.html.twig`: (1) `metasite-tracking` (dataLayer: CTA clicks, form submits, scroll depth, engagement time, section views, cross-pollination), (2) `metasite-experiments` (A/B testing con cookie + drupalSettings), (3) `jaraba_heatmap/tracker` (click/scroll/hover heatmap), (4) GTM/GA4 via `_gtm-analytics.html.twig` en `html.html.twig`. Todas las librerÃ­as se condicionan con `{% if meta_site %}` para no cargar en el dashboard. El dataLayer es el bus de eventos compartido entre todas las capas. | P0 |

---

## 15. Registro de Cambios

| Fecha | VersiÃ³n | DescripciÃ³n |
|-------|---------|-------------|
| 2026-02-26 | **84.0.0** | **Auditoria IA Clase Mundial â€” 25/25 GAPs Implementados:** 6 reglas nuevas: SKILL-INFERENCE-001 (P1, SkillInferenceService parsea LinkedIn/portfolio, genera embeddings Qdrant, top 10 skills con confidence, fallback keyword extraction), DEMAND-FORECASTING-001 (P1, DemandForecastingService con 90 dias historico â†’ balanced tier â†’ JSON forecast, fallback lineal confidence 0.4), DESIGN-SYSTEM-001 (P1, ComponentDocumentationController genera pagina live /admin/design-system con paleta/tipografia/spacing/shadows/breakpoints/iconos/componentes SCSS), COST-ATTRIBUTION-001 (P1, ObservabilityApiController endpoint cost-attribution con CostAlertService 80%/95% + TenantMeteringService), HORIZONTAL-SCALING-001 (P1, ScheduledAgentWorker QueueWorker cron 300s + supervisor-ai-workers.conf 4 programas + settings.ai-queues.php Redis routing), MULTIMODAL-VISION-001 (P1, CopilotStreamController multipart/form-data con MultiModalBridgeService analyzeImage + copilot-chat-widget.js image upload UI). 25 gaps implementados en 4 sprints: S1 P0 Foundations (Command Bar, tests base 266, blog slugs, llms.txt, onboarding AI, pricing metering, demo playground), S2 P1 Core AI UX (Inline AI, Proactive Intelligence, prompt regression, tenant_id, dashboard GEO, Schema.org GEO, dark mode), S3 P2 Advanced (Voice AI, A2A Protocol, Vision/Multimodal, skill inference, adaptive learning, AI writing GrapesJS, service matching GPS), S4 P3 Scale (demand forecasting, design system docs, cost attribution, horizontal scaling). Verificacion: 3.182 tests / 11.553 assertions 0 errores. Fix jaraba_lms.services.yml (support_agent â†’ smart_marketing_agent). Regla de oro #55. Aprendizaje #136. |
| 2026-02-26 | **83.0.0** | **Meta-Sitios Analytics Stack â€” GTM/GA4 + A/B Testing + i18n Hreflang + Heatmap:** 5 reglas nuevas: GTM-GA4-001 (P0, Consent Mode v2 GDPR + GTM desde theme_settings + GA4 fallback + dataLayer context push), AB-EXPERIMENT-001 (P1, cookie 30d con pesos, DOM manipulation, ExperimentApiController, dataLayer experiment_view/conversion), HREFLANG-SEO-001 (P1, tags hreflang ES/EN/x-default en head), HEATMAP-TRACKER-001 (P1, jaraba_heatmap/tracker activado en meta-sites), METASITE-ANALYTICS-001 (P0, 4 capas analytics unificadas condicionadas con meta_site). Archivos: `_gtm-analytics.html.twig`, `_hreflang-meta.html.twig`, `metasite-experiments.js` (150+ ln), librerÃ­a registrada en `.libraries.yml`. Verificado: HTTP 200, dataLayer YES, tracking LOADED en PED+JI. Sprint 14 PWA preexistente (manifest.json + sw.js). Aprendizaje #135. |
| 2026-02-26 | **82.0.0** | **Auditoria IA Clase Mundial â€” 25 Gaps hacia Paridad con Lideres del Mercado:** 6 reglas nuevas: COMMAND-BAR-001 (P1, Command Bar Cmd+K con CommandRegistryService tagged service collector, 4 providers, Drupal.checkPlain(), debounce, Theme Settings toggle), INLINE-AI-001 (P1, sparkle buttons en PremiumEntityFormBase via getInlineAiFields(), InlineAiService fast tier, GrapesJS plugin), PROACTIVE-INSIGHT-001 (P1, ContentEntity con QueueWorker cron, bell icon, severity, tenant isolation), A2A-PROTOCOL-001 (P1, Agent Card /.well-known/agent.json + task lifecycle + Bearer auth + HMAC), PROMPT-REGRESSION-001 (P1, golden fixtures en PromptRegressionTestBase, suite phpunit). 25 gaps auditados contra Salesforce/HubSpot/Shopify/Intercom: 7 refinamiento + 16 nuevos + 2 infraestructura. 4 sprints (320-440h). Regla de oro #54. Aprendizaje #134. |
| 2026-02-26 | **81.0.0** | **Elevacion IA 10 GAPs â€” Streaming Real + MCP Server + Native Tools:** 7 reglas nuevas: STREAMING-REAL-001 (P1, streaming real token-by-token via PHP Generator + SSE, buffer 80 chars, fallback a buffered), NATIVE-TOOLS-001 (P1, native function calling via ChatInput::setChatTools, ToolsInput/ToolsFunctionInput/ToolsPropertyInput, fallback a text-based), MCP-SERVER-001 (P1, endpoint POST /api/v1/mcp con JSON-RPC 2.0 dispatch, tools/list + tools/call + initialize + ping, PII sanitization), TRACE-CONTEXT-001 (P1, distributed tracing con trace_id UUID + span_id propagados a observability/cache/guardrails/SSE done event), STREAMING-PII-001 (P0, buffer acumulativo para PII masking durante streaming â€” detecta PIIs que cruzan boundaries de chunks), AGENT-MEMORY-001 (P1, AgentLongTermMemoryService con Qdrant semantic recall + BD structured facts, types fact/preference/interaction_summary/correction). 10 GAPs implementados en 3 fases: Fase A seguridad/fiabilidad (GAP-03, GAP-10, GAP-04, GAP-05, GAP-06), Fase B capacidades avanzadas (GAP-02, GAP-07, GAP-01), Fase C integracion nativa (GAP-09, GAP-08). Regla de oro #52, #53. Aprendizaje #133. |
| 2026-02-26 | **80.0.0** | **Meta-Sitio plataformadeecosistemas.es â€” Hub Corporativo PED S.L.:** 3 reglas nuevas: TENANT-DOMAIN-FQDN-001 (P1, campo domain del Tenant SIEMPRE FQDN con punto, nunca prefijo corto), SPT-FIELD-NAMES-001 (P0, SitePageTree usa tenant_id/page_id/nav_title â€” Drupal ignora campos desconocidos silenciosamente), LANDO-PROXY-001 (P1, cada meta-sitio necesita entrada proxy en .lando.yml). Creacion completa del tercer meta-sitio corporativo: Tenant 7, Group 7, SiteConfig 3, 13 PageContent (IDs 78-90), 13 SitePageTree (IDs 20-32). 7 paginas en nav principal, 3 legales en footer, 3 internas. Design tokens: Primary #1B4F72, Secondary #17A589, Accent #E67E22, prefix `ped-`. Creacion batch via PHP scripts (dramaticamente mas eficiente que browser UI). Regla de oro #48. Aprendizaje #132. |
| 2026-02-26 | **79.0.0** | **Canvas Editor en Content Hub â€” Articulos Visuales con GrapesJS:** 1 regla nueva: CANVAS-ARTICLE-001 (P1, integracion del Canvas Editor GrapesJS del Page Builder en articulos del Content Hub via shared library dependency + bridge JS + endpoints API propios). 3 campos nuevos en ContentArticle (layout_mode, canvas_data, rendered_html). Retrocompatibilidad total: articulos legacy siguen usando textarea body. Canvas mode bifurca renderizado con CSS inyectado. Sanitizacion HTML/CSS replicada del Page Builder. Update hook 10001 para schema migration. ArticleCanvasEditorController + ArticleCanvasApiController. Template article-canvas-editor.html.twig simplificado del Page Builder (sin sections/multipage). JS bridge reconfigura StorageManager a endpoints de articulos. 14 ficheros (7 creados + 7 modificados). 0 errores PHP/SCSS. Regla de oro #51. Aprendizaje #131. |
| 2026-02-26 | **78.0.0** | **Auditoria Post-Implementacion IA â€” 3 Bugs Criticos + 3 Schemas:** 1 regla nueva: SERVICE-CALL-CONTRACT-001 (P0, toda llamada a metodo de servicio inyectado DEBE coincidir exactamente con la firma: numero, orden y tipo de args). Auditoria de los 23 FIX items revelo: (1) SemanticCacheService no registrado en services.yml (Layer 2 semantic cache silenciosamente deshabilitado), (2) `CopilotCacheService::get()` llamaba a `SemanticCacheService::get()` con 2 args en vez de 3 (faltaba `$mode`), (3) `CopilotCacheService::set()` tenia args en orden incorrecto (tenantId en posicion 2, response en posicion 3), (4) reranking config section faltaba en jaraba_rag.settings.yml (LlmReRankerService unconfigurable), (5) 3 config schemas faltantes (provider_fallback, agent_type_mapping, jaraba_matching.settings) â€” SchemaIncompleteException en Kernel tests. 4 ficheros modificados, 1 creado. 35 PHP + 14 YAML validados 0 errores. Regla de oro #50. Aprendizaje #130. |
| 2026-02-26 | **77.0.0** | **Elevacion IA Nivel 5/5 â€” 23 FIX Items:** 8 reglas nuevas: SMART-AGENT-DI-001 (P0, constructor 10 args con 3 opcionales @?), PROVIDER-FALLBACK-001 (P0, circuit breaker 3 fallos/5min + cadena fallback por tier en YAML), JAILBREAK-DETECT-001 (P0, deteccion prompt injection bilingue ES/EN con accion BLOCK), OUTPUT-PII-MASK-001 (P0, masking PII en output LLM con [DATO PROTEGIDO]), TOOL-USE-AGENT-001 (P1, loop iterativo max 5 tool calls con ToolRegistry), SEMANTIC-CACHE-001 (P1, cache 2 capas exact+Qdrant threshold 0.92), REACT-LOOP-001 (P1, razonamiento multi-paso PLANâ†’EXECUTEâ†’REFLECT), y AGENT-BRIDGE-001 implicitamente via SMART-AGENT-DI-001. 23 FIX items (FIX-029 a FIX-051) en 3 fases: Fase 1 conectar infraestructura existente, Fase 2 capacidades autonomas, Fase 3 inteligencia por vertical. ~25 ficheros nuevos, ~20 modificados. 7 agentes Gen 2, 3 migrados de Gen 1. Reglas de oro #48, #49. Aprendizaje #129. |
| 2026-02-26 | **76.0.0** | **Meta-Site Nav Fix + Copilot Link Buttons:** 3 reglas nuevas: META-SITE-NAV-001 (P1, page--page-builder.html.twig DEBE incluir _header.html.twig partial cuando meta_site es truthy para que la navegacion se renderice), COPILOT-LINK-001 (P1, sugerencias del copilot soportan `{label, url}` con renderizado como `<a>` link con estilo naranja, backend genera CTAs contextuales por rol), HEADER-LAYOUT-NAV-001 (P1, SiteConfig header_type `classic` para nav visible, `minimal` solo hamburguesa). Fix de navegacion invisible en meta-sitios: root cause era header hardcodeado inline en page template que ignoraba theme_settings. Fix de header_type: cambiado de `minimal` a `classic` en SiteConfig para ambos tenants. Copilot v1+v2 JS enhanced con soporte dual string/objeto. SCSS compilado para ambos modulos. Reglas de oro #46, #47. Aprendizaje #128. |
| 2026-02-26 | **75.0.0** | **AI Remediation Plan â€” 28 Fixes, 3 Phases:** 5 reglas nuevas: AI-GUARDRAILS-PII-001 (P0, PII espanol: DNI/NIE/IBAN ES/NIF-CIF/+34 en guardrails), AI-OBSERVABILITY-001 (P0, todo servicio IA DEBE loguear ejecuciones con agent_id/action/tier/model/tokens/duration), VERTICAL-CANONICAL-001 (P0, 10 nombres canonicos de vertical con normalizacion de aliases legacy), MODEL-ROUTING-CONFIG-001 (P1, modelos y pricing en YAML config actualizable sin code deploy), AI-STREAMING-001 (P1, SSE con MIME correcto, eventos tipados, chunking semantico por parrafos, sin usleep). 28 fixes implementados: AIIdentityRule centralizada, SmartBaseAgent pipeline restaurado, AIOpsService metricas reales, feedback widget alineado, Gen 0/1 annotations, @? optional DI. Regla de oro #45. Aprendizaje #127. |
| 2026-02-26 | **74.0.0** | **Blog Clase Mundial â€” Content Hub Elevation:** 2 reglas nuevas: ENTITY-PREPROCESS-001 (P1, toda ContentEntity custom DEBE tener `template_preprocess_{entity_type}()` que extraiga datos para Twig) y PRESAVE-RESILIENCE-001 (P1, presave hooks con servicios opcionales DEBEN usar `hasService()` + try-catch). Elevacion integral del blog publico: `template_preprocess_content_article()` creado (author bio, responsive images srcset, category data), paginacion server-side con sliding window, N+1 query fix con GROUP BY, barra de progreso de lectura (requestAnimationFrame + prefers-reduced-motion), share buttons sin JS SDKs (Clipboard API + fallback), prosa 720px, `ContentCategoryAccessControlHandler`, OG tags fix, 2 SVGs nuevos (social/facebook, ui/sparkles). SCSS: reading-progress, author-bio, blog-pagination, share enhancements, print/reduced-motion. Reglas de oro #43, #44. Aprendizaje #126. |
| 2026-02-25 | **73.0.0** | **Premium Forms Migration 237 + USR-004 User Edit Redirect:** 1 regla nueva: PREMIUM-FORMS-PATTERN-001 (P1, todo formulario de entidad ContentEntity DEBE extender PremiumEntityFormBase con secciones, iconos, glass-card UI). 237 formularios migrados en 8 fases, 50 modulos. 4 patrones de migracion: A (Simple), B (Computed Fields), C (DI), D (Custom Logic). Fix USR-004: redirect user edit form a perfil canonico en lugar de recargar la pagina de edicion. Regla de oro #42. Aprendizaje #125. |
| 2026-02-25 | **72.0.0** | **Icon Emoji Remediation + Canvas Data Conventions:** 2 reglas nuevas: ICON-EMOJI-001 (P0, prohibicion emojis Unicode en canvas_data de Page Builder) y ICON-CANVAS-INLINE-001 (P0, SVGs inline en canvas_data DEBEN usar hex del brand, NUNCA currentColor). Regla de oro #38 (meta-sitios como ciudadanos de primera clase del icon system). 11 emojis eliminados de 4 paginas del meta-sitio pepejaraba.com, reemplazados por SVGs inline duotone. 12 iconos SVG nuevos en categoria `business/`. Aprendizaje #124. |
| 2026-02-25 | **71.0.0** | **Elevacion Empleabilidad + Andalucia EI Plan Maestro + Meta-Site Rendering:** Elevacion del perfil de candidato: `CandidateProfileForm` premium con secciones (personal, profesional, ubicacion, preferencias, online, privacidad), `ProfileSectionForm` generico para CRUD slide-panel, campo `photo` migrado de entity_reference a image, campos date migrados a datetime, 5 CV preview PNGs, seccion idiomas. Andalucia EI Plan Maestro 8 fases: P0/P1 fixes, 11 bloques Page Builder verticales, landing de conversion `/andalucia-ei/programa`, portal participante `/andalucia-ei/mi-participacion`, entidad `ExpedienteDocumento` (19 categorias, vault cifrado, revision IA), integracion mensajeria, AI automation (CopilotContextProvider, AdaptiveDifficultyEngine, 4 nudges proactivos), SEO (sitemap, lead magnet). CRM: 5 formularios migrados a `PremiumEntityFormBase`. Meta-Site: Schema.org tenant-aware via MetaSiteResolverService, title tag con meta_title_suffix, header/footer/nav override desde SiteConfig. Aprendizaje #123. |
| 2026-02-25 | **70.0.0** | **Remediacion Tenant 11 Fases:** Nuevo `TenantBridgeService` (4 metodos) para resolucion Tenantâ†”Group. 14 correcciones de billing entity type en 6 ficheros (`QuotaManagerService` usa bridge, `BillingController`/`BillingService`/`StripeWebhookController`/`SaasPlan` usan `getStorage('tenant')`). `PageContentAccessControlHandler` con DI + `isSameTenant()` para tenant isolation. `DefaultEntityAccessControlHandler` renombrado desde `DefaultAccessControlHandler`. `PathProcessorPageContent` tenant-aware con `TenantContextService` enhanced (nullable group). CI pipeline con job `kernel-test` (MariaDB 10.11). 5 tests nuevos (3 Unit + 2 Kernel). Scripts de mantenimiento movidos a `scripts/maintenance/`. 3 reglas nuevas: TENANT-BRIDGE-001, TENANT-ISOLATION-ACCESS-001, CI-KERNEL-001. Reglas de oro #35, #36, #37. Aprendizaje #122. |
| 2026-02-24 | **69.0.0** | **Meta-Sitio jarabaimpact.com â€” PathProcessor + Content:** Nuevo `PathProcessorPageContent` que resuelve `path_alias` de entidades PageContent a rutas `/page/{id}` (prioridad 200, sin filtro status, skip list de prefijos, static cache). 7 paginas institucionales creadas con GrapesJS. 1 regla nueva: PATH-ALIAS-PROCESSOR-001. Regla de oro #34 (PathProcessor para aliases custom). Aprendizaje #120. |
| 2026-02-24 | **68.0.0** | **Auditoria Horizontal â€” Strict Equality + CAN-SPAM MJML:** 5 reglas nuevas: ACCESS-STRICT-001 (strict equality `(int) === (int)` en access handlers), EMAIL-PREVIEW-001 (mj-preview obligatorio), EMAIL-POSTAL-001 (direccion postal CAN-SPAM), BRAND-FONT-001 (Outfit como primer font en emails), BRAND-COLOR-001 (solo colores de tokens de marca en MJML). Regla de oro #33 (auditorias horizontales periodicas). 52 instancias corregidas en 39 access handlers, 28 plantillas MJML con compliance completo. Aprendizaje #119. |
| 2026-02-24 | **67.0.0** | **Empleabilidad Profile Premium â€” Fase Final:** Nueva entidad `CandidateEducation` (ContentEntity completa con AdminHtmlRouteProvider, field_ui_base_route, 6 rutas admin, SettingsForm, collection tab, update hook 10002, permiso admin). Fix XSS `\|raw` â†’ `\|safe_html` en template de perfil (TWIG-XSS-001). Controller cleanup: HTML hardcodeado reemplazado por render array con template premium. 3 ficheros creados, 6 modificados. Aprendizaje #118. |
| 2026-02-24 | **66.0.0** | **Icon System â€” Zero Chinchetas:** Auditoria completa de 305 pares unicos `jaraba_icon()` en todo el codebase. 0 chinchetas restantes. Creados ~170 SVGs/symlinks nuevos en 8 bridge categories (achievement, finance, general, legal, navigation, status, tools, media, users). Corregidas 32 llamadas con convencion rota en 4 modulos (jaraba_interactive 17, jaraba_i18n 9, jaraba_facturae 8, jaraba_resources 13): path-style, args invertidos, args posicionales. 177 templates de Page Builder verificados (1 symlink circular corregido). 3 reglas nuevas: ICON-CONVENTION-001 (P0), ICON-DUOTONE-001 (P1), ICON-COLOR-001 (P1). Aprendizaje #117. |
| 2026-02-24 | **65.0.0** | **Empleabilidad Audit â€” 105 Hallazgos, 10 Corregidos (7 P0 + 1 P1 + 2 P2):** Auditoria multidimensional (15 roles senior) del vertical Empleabilidad. P0 corregidos: (1) Fraude tier Starter con limites identicos al Free, (2) XSS via innerHTML en 8 puntos de agent-fab.js, (3) CSRF tokens ausentes en 6 endpoints POST/DELETE, (4) Bypass de acceso en EmployerController sin verificacion de ownership, (5) API field injection sin whitelist en updateProfile(), (6) CAN-SPAM compliance en 7 emails MJML, (7) Color primario inconsistente (3 colores diferentes unificados a #1565C0). P1: 31 strings de interfaz sin traducir â†’ `\|t`. P2: 2 templates con `\|raw` â†’ `\|safe_html`. 4 reglas nuevas: FREEMIUM-TIER-001, INNERHTML-XSS-001, CSRF-JS-CACHE-001, API-WHITELIST-001. 22 ficheros modificados. Aprendizaje #113. |
| 2026-02-23 | **62.2.0** | **Sticky Header Global:** Regla CSS-STICKY-001 â€” `.landing-header` migrado de `position: fixed` a `position: sticky` por defecto. Solo `body.landing-page`/`body.page-front` mantienen `fixed` para hero fullscreen. Eliminados todos los `padding-top` compensatorios de `.main-content` (80px), `.user-main` (120px), `.error-page` (80px). Toolbar admin ajustado globalmente con `top: 39px/79px`. Regla de oro #27. Aprendizaje #109. |
| 2026-02-23 | **64.0.0** | **Andalucia +ei Launch Readiness:** Fix critico de formulario que tragaba errores silenciosamente (`{{ messages }}` + preprocess hook). 6 emojis â†’ `jaraba_icon()`. 5 paginas legales/informativas nuevas con rutas canonicas en espanol. Footer actualizado. Badge "6 verticales". TAB 14 en theme settings. 3 reglas nuevas: FORM-MSG-001 (mensajes en templates custom), LEGAL-ROUTE-001 (URLs canonicas), LEGAL-CONFIG-001 (contenido legal desde UI). 13 ficheros modificados. Aprendizaje #110. |
| 2026-02-23 | **63.0.0** | **AI Identity Enforcement + Competitor Isolation:** 2 reglas nuevas: AI-IDENTITY-001 (identidad IA inquebrantable â€” todos los agentes y copilotos DEBEN identificarse como Jaraba, NUNCA como Claude/ChatGPT/Gemini) y AI-COMPETITOR-001 (aislamiento de competidores â€” ningun prompt DEBE mencionar ni recomendar plataformas competidoras ni modelos de IA externos). Implementado en BaseAgent.buildSystemPrompt(), CopilotOrchestratorService, PublicCopilotController, FaqBotService, ServiciosConectaCopilotAgent, CoachIaService y AiContentController. Eliminadas menciones de ChatGPT, Perplexity, HubSpot, LinkedIn y Zapier de 5 prompts/datos de IA. Reglas de oro #25, #26. Aprendizaje #108. |
| 2026-02-23 | **62.1.0** | **Config Schema Fix:** Regla CONFIG-SCHEMA-001 â€” ConfigEntities con campos de keys dinamicos (ej. `limits` por vertical) DEBEN usar `type: sequence` en schema, no `type: mapping` con keys fijos. Fix del `SchemaIncompleteException` en Kernel test `PlanConfigContractTest::testFeaturesCascade`. Regla de oro #24. |
| 2026-02-23 | **62.0.0** | **Precios Configurables v2.1:** 2 ConfigEntities (`SaasPlanTier` con aliases + Stripe Price IDs, `SaasPlanFeatures` con features + limites por vertical+tier). `PlanResolverService` como broker central con cascade especificoâ†’defaultâ†’NULL. Integracion en QuotaManagerService, PlanValidator y BillingWebhookController via inyeccion opcional `@?`. 2 reglas nuevas: PLAN-CASCADE-001 (cascade resolution), PLAN-RESOLVER-001 (alias normalization). Reglas de oro #22 (cascade ConfigEntities), #23 (normalizacion via aliases). Aprendizaje #107. |
| 2026-02-20 | **61.0.0** | **Secure Messaging Implementado (Doc 178):** Modulo `jaraba_messaging` implementado con 104 archivos. 3 reglas nuevas: MSG-ENC-001 (cifrado AES-256-GCM server-side con Argon2id KDF), MSG-WS-001 (autenticacion WebSocket con JWT middleware), MSG-RATE-001 (rate limiting por usuario y conversacion). Patrones: custom schema tables con DTOs readonly, hash chain SHA-256 para audit inmutable, optional DI con `@?`, cursor-based pagination, ECA plugins por codigo. Aprendizaje #106. |
| 2026-02-20 | 60.0.0 | **ServiciosConecta Sprint S3 â€” Booking API & State Machine Fix:** Correccion de `createBooking()` (field mapping, validaciones). Fix state machine y cron. 3 reglas: API-FIELD-001, STATE-001, CRON-FLAG-001. Aprendizaje #105. |
| 2026-02-20 | 59.0.0 | **Page Builder Preview Audit:** AuditorÃ­a de 4 escenarios del Page Builder. 66 imÃ¡genes premium glassmorphism 3D generadas para 6 verticales (AgroConecta, ComercioConecta, Empleabilidad, Emprendimiento, ServiciosConecta, JarabaLex). 219 bloques inventariados, 31 categorÃ­as, 4 duplicados detectados. Reglas PB-PREVIEW-002, PB-DUP-001. Aprendizaje #103. |
| 2026-02-20 | 58.0.0 | **Vertical Retention Playbooks (Doc 179):** Implementacion completa del motor de retencion verticalizado. 2 entidades nuevas (VerticalRetentionProfile, SeasonalChurnPrediction), 2 servicios (VerticalRetentionService, SeasonalChurnService), 7 endpoints API REST, 1 dashboard FOC, 5 perfiles verticales, QueueWorker cron. 25 archivos nuevos + 11 modificados. Reglas ENTITY-APPEND-001, CONFIG-SEED-001. Aprendizaje #104. |
| 2026-02-20 | 56.0.0 | **Gemini Remediation:** Auditoria y correccion de ~40 archivos modificados por otra IA. 21 archivos revertidos, 15 corregidos manualmente (CSRF, XSS, PWA, roles, i18n). Reglas CSRF-API-001, TWIG-XSS-001, TM-CAST-001, PWA-META-001. Aprendizaje #102. |
| 2026-02-18 | 55.0.0 | **Page Builder Template Consistency:** Resync de 129 templates con preview_image, metadatos corregidos (tildes, labels), preview_data rico para 55 verticales, pipelines Canvas/Picker unificados. Fix de `applyUpdates()` en Legal Intelligence. Reglas PB-PREVIEW-001, PB-DATA-001, PB-CAT-001, DRUPAL-ENTUP-001. |
| 2026-02-18 | 54.0.0 | **CI/CD Hardening:** Fix de config Trivy (`scan.skip-dirs`), deploy resiliente con fallback SSH. Nuevas reglas CICD-TRIVY-001 y CICD-DEPLOY-001. |
| 2026-02-18 | 53.0.0 | **The Unified & Stabilized SaaS:** ConsolidaciÃ³n final de las 5 fases. EstabilizaciÃ³n de 370+ tests en 17 mÃ³dulos. RefactorizaciÃ³n masiva de DI para clases final de IA y estandarizaciÃ³n de mocks para PHPUnit 11. |
| 2026-02-18 | 52.0.0 | **The Living SaaS:** ImplementaciÃ³n de las fronteras finales. Bloque O (ZKP) y Bloque P (Liquid UI). Nuevas reglas de privacidad matemÃ¡tica y adaptabilidad de interfaz. |
| 2026-02-18 | 51.0.0 | EconomÃ­a AgÃ©ntica Implementada: Bloques M y N completados. |
| 2026-02-18 | 50.0.0 | SaaS Golden Master Candidate: ConsolidaciÃ³n final de todos los bloques. |
