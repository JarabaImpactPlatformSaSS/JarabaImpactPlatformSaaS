; GAP-AUD-025: Supervisor configuration for horizontal scaling of AI workloads.
;
; This configuration runs dedicated queue workers for AI-intensive tasks,
; separate from the web request queue. Each worker processes items from
; the dedicated AI queues, allowing horizontal scaling by increasing numprocs.
;
; Installation:
;   1. Copy to /etc/supervisor/conf.d/jaraba-ai-workers.conf
;   2. Run: supervisorctl reread && supervisorctl update
;
; Queue routing in settings.php:
;   $settings['queue_service_a2a_task_worker'] = 'queue.redis_reliable';
;   $settings['queue_service_proactive_insight_engine'] = 'queue.redis_reliable';
;   $settings['queue_service_quality_evaluation'] = 'queue.redis_reliable';
;   $settings['queue_service_scheduled_agent'] = 'queue.redis_reliable';

[program:jaraba-ai-a2a]
command=/var/www/html/vendor/bin/drush queue:run a2a_task_worker --time-limit=300
directory=/var/www/html
user=www-data
numprocs=2
process_name=%(program_name)s_%(process_num)02d
autostart=true
autorestart=true
startsecs=5
startretries=3
stderr_logfile=/var/log/jaraba/ai-a2a-%(process_num)02d.err.log
stdout_logfile=/var/log/jaraba/ai-a2a-%(process_num)02d.out.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3
priority=100

[program:jaraba-ai-insights]
command=/var/www/html/vendor/bin/drush queue:run proactive_insight_engine --time-limit=300
directory=/var/www/html
user=www-data
numprocs=1
process_name=%(program_name)s_%(process_num)02d
autostart=true
autorestart=true
startsecs=5
startretries=3
stderr_logfile=/var/log/jaraba/ai-insights-%(process_num)02d.err.log
stdout_logfile=/var/log/jaraba/ai-insights-%(process_num)02d.out.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3
priority=200

[program:jaraba-ai-quality]
command=/var/www/html/vendor/bin/drush queue:run quality_evaluation --time-limit=300
directory=/var/www/html
user=www-data
numprocs=1
process_name=%(program_name)s_%(process_num)02d
autostart=true
autorestart=true
startsecs=5
startretries=3
stderr_logfile=/var/log/jaraba/ai-quality-%(process_num)02d.err.log
stdout_logfile=/var/log/jaraba/ai-quality-%(process_num)02d.out.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3
priority=300

[program:jaraba-ai-scheduled]
command=/var/www/html/vendor/bin/drush queue:run scheduled_agent --time-limit=600
directory=/var/www/html
user=www-data
numprocs=1
process_name=%(program_name)s_%(process_num)02d
autostart=true
autorestart=true
startsecs=5
startretries=3
stderr_logfile=/var/log/jaraba/ai-scheduled-%(process_num)02d.err.log
stdout_logfile=/var/log/jaraba/ai-scheduled-%(process_num)02d.out.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile_backups=3
priority=400

[group:jaraba-ai]
programs=jaraba-ai-a2a,jaraba-ai-insights,jaraba-ai-quality,jaraba-ai-scheduled
priority=999
