# =============================================================================
# Jaraba Impact Platform - HAProxy Configuration
# N3 Enterprise Class - Doc 197 - High Availability Infrastructure
# =============================================================================
# L7 load balancer in front of 3+ Drupal application servers.
# Handles TLS termination, health checking, session affinity, rate limiting,
# and blue-green deployment weight shifting.
# =============================================================================

# ---------------------------------------------------------------------------
# Global
# ---------------------------------------------------------------------------
global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    maxconn 4096
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
    ssl-default-server-options ssl-min-ver TLSv1.2

# ---------------------------------------------------------------------------
# Defaults
# ---------------------------------------------------------------------------
defaults
    log global
    mode http
    option httplog
    option dontlognull
    option forwardfor
    option http-server-close
    option redispatch
    retries 3
    timeout connect 5000
    timeout client 50000
    timeout server 50000
    timeout queue 30000
    timeout http-request 10000
    timeout http-keep-alive 10000
    default-server inter 3s fall 3 rise 2
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# ---------------------------------------------------------------------------
# Frontend: HTTP -> HTTPS redirect
# ---------------------------------------------------------------------------
frontend http-in
    bind *:80
    http-request redirect scheme https code 301 if !{ ssl_fc }

# ---------------------------------------------------------------------------
# Frontend: HTTPS (main entry point)
# ---------------------------------------------------------------------------
frontend https-in
    bind *:443 ssl crt /etc/haproxy/certs/jaraba.pem alpn h2,http/1.1
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Request-ID %[uuid()]

    # --- Security headers ---
    http-response set-header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-Frame-Options SAMEORIGIN
    http-response set-header Referrer-Policy strict-origin-when-cross-origin

    # --- Rate limiting (stick table) ---
    stick-table type ip size 200k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # --- ACLs ---
    acl is_health path /health
    acl is_static path_beg /sites/default/files/
    acl is_static path_beg /core/assets/
    acl is_static path_end .css .js .png .jpg .jpeg .gif .svg .woff .woff2 .ico .webp .avif
    acl is_admin path_beg /admin /user/login
    acl is_cron path /cron

    # Health check bypass - lightweight, no cookie
    use_backend health_check if is_health

    # Default traffic to Drupal app pool
    default_backend drupal_servers

# ---------------------------------------------------------------------------
# Backend: Drupal Application Servers (blue-green ready)
# ---------------------------------------------------------------------------
backend drupal_servers
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    cookie SERVERID insert indirect nocache httponly secure

    # Blue environment (active)
    server app1 app1.jaraba.io:8080 check cookie app1 weight 100 maxconn 500
    server app2 app2.jaraba.io:8080 check cookie app2 weight 100 maxconn 500
    server app3 app3.jaraba.io:8080 check cookie app3 weight 100 maxconn 500

    # Green environment (standby - weight 0 until deployment activates them)
    server app1-green app1-green.jaraba.io:8080 check cookie app1g weight 0 maxconn 500
    server app2-green app2-green.jaraba.io:8080 check cookie app2g weight 0 maxconn 500
    server app3-green app3-green.jaraba.io:8080 check cookie app3g weight 0 maxconn 500

# ---------------------------------------------------------------------------
# Backend: Health Check (local)
# ---------------------------------------------------------------------------
backend health_check
    server local 127.0.0.1:8080

# ---------------------------------------------------------------------------
# Stats Dashboard
# ---------------------------------------------------------------------------
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats realm Jaraba\ HAProxy\ Statistics
    stats auth ${HAPROXY_STATS_USER}:${HAPROXY_STATS_PASSWORD}
    stats refresh 10s
    stats show-legends
    stats show-node
