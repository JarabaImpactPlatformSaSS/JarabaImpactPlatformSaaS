# =============================================================================
# Jaraba Impact Platform - MariaDB Galera Cluster Configuration
# N3 Enterprise Class - Doc 197 - High Availability Infrastructure
# =============================================================================
# 3-node synchronous multi-master cluster with automatic node provisioning.
# Deploy identical config to all nodes; per-node identity comes from env vars.
# =============================================================================

[mysqld]
# ---------------------------------------------------------------------------
# Galera Provider
# ---------------------------------------------------------------------------
wsrep_on=ON
wsrep_provider=/usr/lib/galera/libgalera_smm.so
wsrep_cluster_name="jaraba_cluster"
wsrep_cluster_address="gcomm://node1.db.jaraba.io,node2.db.jaraba.io,node3.db.jaraba.io"
wsrep_node_name="${HOSTNAME}"
wsrep_node_address="${NODE_IP}"
wsrep_sst_method=mariabackup
wsrep_sst_auth="${REPLICATION_USER}:${REPLICATION_PASSWORD}"

# ---------------------------------------------------------------------------
# Galera Replication Tuning
# ---------------------------------------------------------------------------
wsrep_slave_threads=4
wsrep_certify_nonPK=1
wsrep_max_ws_rows=0
wsrep_max_ws_size=2147483647
wsrep_auto_increment_control=1
wsrep_causal_reads=0
wsrep_retry_autocommit=3

# GCache - keeps write-sets for Incremental State Transfer (IST).
# 1 GB covers ~24 h of normal Drupal write traffic so short node
# outages can rejoin without a full SST.
wsrep_provider_options="gcache.size=1G; gcache.recover=yes"

# ---------------------------------------------------------------------------
# InnoDB - optimised for Galera
# ---------------------------------------------------------------------------
# lock_mode=2 is mandatory for Galera (interleaved auto-increment).
innodb_autoinc_lock_mode=2
# flush=2 trades a tiny durability window for 10x write throughput;
# Galera's synchronous replication compensates.
innodb_flush_log_at_trx_commit=2
innodb_buffer_pool_size=4G
innodb_buffer_pool_instances=4
innodb_log_file_size=512M
innodb_log_buffer_size=64M
innodb_file_per_table=1
innodb_open_files=4000
innodb_io_capacity=2000
innodb_io_capacity_max=4000
innodb_read_io_threads=8
innodb_write_io_threads=8

# ---------------------------------------------------------------------------
# Connections
# ---------------------------------------------------------------------------
max_connections=500
wait_timeout=600
interactive_timeout=600
thread_cache_size=128
table_open_cache=4000
table_definition_cache=4000

# ---------------------------------------------------------------------------
# Binary Log (required for Galera)
# ---------------------------------------------------------------------------
binlog_format=ROW
default_storage_engine=InnoDB
log_bin=mysql-bin
expire_logs_days=3
sync_binlog=0

# ---------------------------------------------------------------------------
# Character Set
# ---------------------------------------------------------------------------
character_set_server=utf8mb4
collation_server=utf8mb4_unicode_ci

# ---------------------------------------------------------------------------
# Slow Query Log - essential for production diagnostics
# ---------------------------------------------------------------------------
slow_query_log=1
slow_query_log_file=/var/log/mysql/slow.log
long_query_time=1
log_queries_not_using_indexes=1

# ---------------------------------------------------------------------------
# Security Hardening
# ---------------------------------------------------------------------------
local_infile=0
symbolic_links=0
skip_name_resolve=1
