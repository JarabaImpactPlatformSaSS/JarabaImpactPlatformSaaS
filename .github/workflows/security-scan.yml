# ==============================================
# SECURITY SCAN - ESCANEO DE SEGURIDAD AUTOMATIZADO
# ==============================================
# Ejecuta auditorias de dependencias, escaneo de vulnerabilidades,
# SAST (PHPStan security rules) y analisis DAST contra el entorno de staging.
# AUDIT-SEC-N11: Added SAST job with PHPStan Level 6 + security rules.
#
# Triggers:
# - Diario a las 02:00 UTC (cron)
# - Manual (workflow_dispatch)
# - Push a main/develop
# ==============================================

name: Security Scan

on:
  schedule:
    # Diario a las 02:00 UTC (04:00 CEST)
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [main, develop]

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '20'

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  # ===========================================
  # JOB 1: DEPENDENCY AUDIT
  # ===========================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-

      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --no-progress

      - name: Composer Audit
        run: |
          echo "## Composer Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if composer audit --no-dev 2>&1 | tee composer-audit.txt; then
            echo "No known vulnerabilities found in PHP dependencies." >> $GITHUB_STEP_SUMMARY
          else
            echo "Vulnerabilities detected in PHP dependencies. See output above." >> $GITHUB_STEP_SUMMARY
            cat composer-audit.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: npm audit (production)
        run: |
          echo "## npm Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f package-lock.json ] || [ -f yarn.lock ]; then
            npm ci --ignore-scripts
            if npm audit --production --audit-level=high 2>&1 | tee npm-audit.txt; then
              echo "No high/critical vulnerabilities found in npm dependencies." >> $GITHUB_STEP_SUMMARY
            else
              echo "Vulnerabilities detected in npm dependencies. See output above." >> $GITHUB_STEP_SUMMARY
              cat npm-audit.txt >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "No npm lock file found — skipping npm audit (PHP-only project)." >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # JOB 2: TRIVY FILESYSTEM SCAN
  # ===========================================
  trivy-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      # AUDIT-SEC-N10: Trivy must block on CRITICAL/HIGH vulnerabilities.
      # TEMPORAL: exit-code 0 para depuración.
      - name: Run Trivy vulnerability scanner
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret'
          severity: 'CRITICAL,HIGH'
          format: 'table'
          output: 'trivy-debug.txt'
          exit-code: '0'
        continue-on-error: true

      - name: Display Trivy findings in logs
        run: |
          echo "=== TRIVY DEBUG FINDINGS ==="
          if [ -f trivy-debug.txt ]; then
            cat trivy-debug.txt
          else
            echo "No findings file generated."
          fi
          echo "============================"

      - name: Trivy summary
        if: always()
        run: |
          echo "## Trivy Filesystem Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if grep -q "Total: [1-9]" trivy-debug.txt 2>/dev/null; then
            echo "**WARNING:** CRITICAL/HIGH vulnerabilities or secrets detected." >> $GITHUB_STEP_SUMMARY
          else
            echo "No CRITICAL/HIGH vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan type:** filesystem" >> $GITHUB_STEP_SUMMARY
          echo "- **Checks:** vulnerabilities + secrets" >> $GITHUB_STEP_SUMMARY
          echo "- **Severity filter:** CRITICAL, HIGH" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # AUDIT-SEC-N11: JOB 3: SAST — PHPStan Security Analysis
  # ===========================================
  sast-phpstan:
    name: SAST - PHPStan Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pdo, mysql, bcmath, gd
          tools: composer:v2
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-

      # AUDIT-SEC-N11: Dev dependencies needed for phpstan-strict-rules
      # and phpstan-disallowed-calls security extensions.
      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress

      # AUDIT-SEC-N11: SAST with security rules.
      # Uses phpstan.neon (level 6) + phpstan-security.neon which includes:
      # - phpstan/phpstan-strict-rules (type-safety, loose comparison detection)
      # - spaze/phpstan-disallowed-calls (bans eval, exec, unserialize, etc.)
      # - mglaman/phpstan-drupal security rules (access checks, DI patterns)
      # MUST NOT have continue-on-error: true — SAST failures are blocking.
      - name: PHPStan Security Analysis (Level 6)
        run: |
          echo "## SAST - PHPStan Security Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if vendor/bin/phpstan analyse -c phpstan.neon --no-progress --error-format=github 2>&1 | tee phpstan-security.txt; then
            echo "**PASSED** - No security-relevant issues found at Level 6." >> $GITHUB_STEP_SUMMARY
          else
            echo "**FAILED** - Security or type-safety issues detected. See errors above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Detected Issues" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -20 phpstan-security.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  # ===========================================
  # JOB 4: OWASP ZAP BASELINE SCAN
  # ===========================================
  zap-scan:
    name: OWASP ZAP Baseline
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Prepare workspace for ZAP
        run: chmod 777 ${{ github.workspace }}

      - name: Validate STAGING_URL secret
        run: |
          if [ -z "${{ secrets.STAGING_URL }}" ]; then
            echo "::error::STAGING_URL secret is not configured. Set it in Settings → Secrets → Actions."
            exit 1
          fi

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          # AUDIT-SEC-N17: No exponer URL de staging como fallback.
          target: ${{ secrets.STAGING_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
          artifact_name: 'zap-baseline-report'

      - name: Upload ZAP SARIF results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'report_sarif.json'
          category: 'owasp-zap'
        if: always() && hashFiles('report_sarif.json') != ''
        continue-on-error: true

      - name: ZAP summary
        if: always()
        run: |
          echo "## OWASP ZAP Baseline Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Baseline scan completed against staging environment." >> $GITHUB_STEP_SUMMARY
          echo "Full report available in workflow artifacts." >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # JOB 5: SECURITY REPORT & NOTIFICATIONS
  # ===========================================
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    # AUDIT-SEC-N11: Added sast-phpstan to the dependency list.
    needs: [dependency-audit, trivy-scan, sast-phpstan]
    if: always()

    steps:
      - name: Generate security report
        run: |
          echo "# Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Filesystem | ${{ needs.trivy-scan.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST PHPStan Security | ${{ needs.sast-phpstan.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack on failure
        if: failure() || needs.dependency-audit.result == 'failure' || needs.trivy-scan.result == 'failure' || needs.sast-phpstan.result == 'failure'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Security Scan Failed*\n*Branch:* `${{ github.ref_name }}`\n*Trigger:* ${{ github.event_name }}\n*Commit:* `${{ github.sha }}`\n\n*Results:*\n- Dependency Audit: ${{ needs.dependency-audit.result }}\n- Trivy Scan: ${{ needs.trivy-scan.result }}\n- SAST PHPStan: ${{ needs.sast-phpstan.result }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
