# ==============================================
# SECURITY SCAN - ESCANEO DE SEGURIDAD AUTOMATIZADO
# ==============================================
# Ejecuta auditorias de dependencias, escaneo de vulnerabilidades
# y analisis DAST contra el entorno de staging.
#
# Triggers:
# - Diario a las 02:00 UTC (cron)
# - Manual (workflow_dispatch)
# - Push a main/develop
# ==============================================

name: Security Scan

on:
  schedule:
    # Diario a las 02:00 UTC (04:00 CEST)
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches: [main, develop]

env:
  PHP_VERSION: '8.4'
  NODE_VERSION: '20'

permissions:
  contents: read
  actions: read
  security-events: write

jobs:
  # ===========================================
  # JOB 1: DEPENDENCY AUDIT
  # ===========================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-

      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --no-progress

      - name: Composer Audit
        run: |
          echo "## Composer Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if composer audit --no-dev 2>&1 | tee composer-audit.txt; then
            echo "No known vulnerabilities found in PHP dependencies." >> $GITHUB_STEP_SUMMARY
          else
            echo "Vulnerabilities detected in PHP dependencies. See output above." >> $GITHUB_STEP_SUMMARY
            cat composer-audit.txt >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: npm audit (production)
        run: |
          echo "## npm Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f package-lock.json ] || [ -f yarn.lock ]; then
            npm ci --ignore-scripts
            if npm audit --production --audit-level=high 2>&1 | tee npm-audit.txt; then
              echo "No high/critical vulnerabilities found in npm dependencies." >> $GITHUB_STEP_SUMMARY
            else
              echo "Vulnerabilities detected in npm dependencies. See output above." >> $GITHUB_STEP_SUMMARY
              cat npm-audit.txt >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          else
            echo "No npm lock file found — skipping npm audit (PHP-only project)." >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # JOB 2: TRIVY FILESYSTEM SCAN
  # ===========================================
  trivy-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'
          # AUDIT-SEC-N10: exit-code 1 detecta vulnerabilidades.
          # continue-on-error: las dependencias de terceros (Drupal core,
          # Symfony) pueden tener CVEs pendientes de upstream que no
          # podemos resolver inmediatamente. Los resultados se suben
          # al Security tab de GitHub para seguimiento.
          exit-code: '1'
        continue-on-error: true

      - name: Upload Trivy SARIF to GitHub Security tab
        # NOTE: Requires GitHub Advanced Security (GHAS). For private repos
        # on personal accounts this step will silently fail. Results are
        # printed in the step summary below as a fallback.
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-filesystem'
        if: always()
        continue-on-error: true

      - name: Trivy table output (fallback for repos without GHAS)
        if: always()
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          scanners: 'vuln,secret'
          severity: 'CRITICAL,HIGH'
          format: 'table'
          output: 'trivy-table.txt'
          exit-code: '0'

      - name: Append Trivy table to step summary
        if: always()
        run: |
          if [ -f trivy-table.txt ] && [ -s trivy-table.txt ]; then
            echo '## Trivy Detailed Results' >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat trivy-table.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Trivy summary
        if: always()
        run: |
          echo "## Trivy Filesystem Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.trivy.outcome }}" == "failure" ]; then
            echo "**WARNING:** CRITICAL/HIGH vulnerabilities detected in dependencies." >> $GITHUB_STEP_SUMMARY
            echo "Review findings in the **Security** tab and update affected packages." >> $GITHUB_STEP_SUMMARY
          else
            echo "No CRITICAL/HIGH vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan type:** filesystem" >> $GITHUB_STEP_SUMMARY
          echo "- **Checks:** vulnerabilities + secrets" >> $GITHUB_STEP_SUMMARY
          echo "- **Severity filter:** CRITICAL, HIGH" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # JOB 3: OWASP ZAP BASELINE SCAN
  # ===========================================
  zap-scan:
    name: OWASP ZAP Baseline
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Prepare workspace for ZAP
        run: chmod 777 ${{ github.workspace }}

      - name: Validate STAGING_URL secret
        run: |
          if [ -z "${{ secrets.STAGING_URL }}" ]; then
            echo "::error::STAGING_URL secret is not configured. Set it in Settings → Secrets → Actions."
            exit 1
          fi

      - name: OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          # AUDIT-SEC-N17: No exponer URL de staging como fallback.
          target: ${{ secrets.STAGING_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
          artifact_name: 'zap-baseline-report'

      - name: Upload ZAP SARIF results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'report_sarif.json'
          category: 'owasp-zap'
        if: always() && hashFiles('report_sarif.json') != ''
        continue-on-error: true

      - name: ZAP summary
        if: always()
        run: |
          echo "## OWASP ZAP Baseline Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Baseline scan completed against staging environment." >> $GITHUB_STEP_SUMMARY
          echo "Full report available in workflow artifacts." >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # JOB 4: SECURITY REPORT & NOTIFICATIONS
  # ===========================================
  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [dependency-audit, trivy-scan]
    if: always()

    steps:
      - name: Generate security report
        run: |
          echo "# Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Filesystem | ${{ needs.trivy-scan.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify Slack on failure
        if: failure() || needs.dependency-audit.result == 'failure' || needs.trivy-scan.result == 'failure'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Security Scan Failed*\n*Branch:* `${{ github.ref_name }}`\n*Trigger:* ${{ github.event_name }}\n*Commit:* `${{ github.sha }}`\n\n*Results:*\n- Dependency Audit: ${{ needs.dependency-audit.result }}\n- Trivy Scan: ${{ needs.trivy-scan.result }}\n\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
